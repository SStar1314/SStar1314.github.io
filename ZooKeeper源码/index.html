<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>ZooKeeper源码 | SStar1314</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ZooKeeper Eclipse 编译：1.源码下载：git clone https://github.com/apache/zookeeper.git1git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习) 2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的">
<meta name="keywords" content="ZooKeeper">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper源码">
<meta property="og:url" content="http://yoursite.com/ZooKeeper源码/index.html">
<meta property="og:site_name" content="SStar1314">
<meta property="og:description" content="ZooKeeper Eclipse 编译：1.源码下载：git clone https://github.com/apache/zookeeper.git1git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习) 2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/ZooKeeper_Code_1.png">
<meta property="og:updated_time" content="2017-07-19T05:04:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZooKeeper源码">
<meta name="twitter:description" content="ZooKeeper Eclipse 编译：1.源码下载：git clone https://github.com/apache/zookeeper.git1git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习) 2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的">
<meta name="twitter:image" content="http://yoursite.com/images/ZooKeeper_Code_1.png">
  
    <link rel="alternative" href="/atom.xml" title="SStar1314" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/images/favicon.ico" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Xia, MingXing</a></h1>
		</hgroup>

		
		<p class="header-subtitle">研发</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/archives">主页</a></li>
	        
				<li><a href="/archives">所有文章</a></li>
	        
				<li><a href="/categories">目录</a></li>
	        
				<li><a href="/tags">标签</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Xia, MingXing</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/images/favicon.ico" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Xia, MingXing</h1>
			</hgroup>
			
			<p class="header-subtitle">研发</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/archives">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories">目录</a></li>
		        
					<li><a href="/tags">标签</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-ZooKeeper源码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ZooKeeper源码
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ZooKeeper-Eclipse-编译："><a href="#ZooKeeper-Eclipse-编译：" class="headerlink" title="ZooKeeper Eclipse 编译："></a>ZooKeeper Eclipse 编译：</h2><p>1.源码下载：git clone <a href="https://github.com/apache/zookeeper.git" target="_blank" rel="external">https://github.com/apache/zookeeper.git</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习)</div></pre></td></tr></table></figure></p>
<p>2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的位置，java project 创建成果之后，右键build.xml run as Ant build，会自动下载build project的jar包。<br>多个文件目录下都有build.xml文件，都可以尝试run as Ant build，下载build project所需要的jar包。<br>3.运行build.xml之后，jar包或许仍不完整，需要自己下载jar包，目录截图如下：<br><img src="/images/ZooKeeper_Code_1.png" alt=""><br>4.至此，zookeeper java工程的编译任务完成。</p>
<h3 id="Linux-下同样需要ant编译："><a href="#Linux-下同样需要ant编译：" class="headerlink" title="Linux 下同样需要ant编译："></a>Linux 下同样需要ant编译：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get install openjdk-7-jdk</div><div class="line"><span class="built_in">cd</span> /root/zookeeper-3.4.8</div><div class="line">ant</div></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p><strong>RestAPI源码入门：</strong><br>RestAPI 入口main函数所在文件： org.apache.zookeeper.server.jersey.RestMain</p>
<p><strong>ZooKeeper Source Code 解析：</strong><br>1.zkServer 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nohup &quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line">-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=7778 \                         （此行是用作java remote debug使用的，是我后加的）</div><div class="line">-cp &quot;$CLASSPATH&quot; $JVMFLAGS $ZOOMAIN &quot;$ZOOCFG&quot; &gt; &quot;$_ZOO_DAEMON_OUT&quot; 2&gt;&amp;1 &lt; /dev/null &amp;</div><div class="line"> ZOOMAIN=&quot;-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;</div></pre></td></tr></table></figure></p>
<p>2.zkCli 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line"> -cp &quot;$CLASSPATH&quot; $CLIENT_JVMFLAGS $JVMFLAGS \</div><div class="line"> org.apache.zookeeper.ZooKeeperMain &quot;$@&quot;</div></pre></td></tr></table></figure></p>
<p>由上可知， ZooKeeper的server启动入口函数为 <strong>QuorumPeerMain</strong> ，而client的启动入口函数为 <strong>ZooKeeperMain</strong>。</p>
<h3 id="QuorumPeerMain解析源码："><a href="#QuorumPeerMain解析源码：" class="headerlink" title="QuorumPeerMain解析源码："></a>QuorumPeerMain解析源码：</h3><p>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line">—&gt; QuorumPeerMain main = new QuorumPeerMain()</div><div class="line">—&gt; main.initializeAndRun(args)</div><div class="line">          —&gt; QuorumPeerConfig config = new QuorumPeerConfig()</div><div class="line">          —&gt; config.parse(args)</div><div class="line">                    —&gt; parseProperties(cfg)</div><div class="line">          —&gt; DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config)</div><div class="line">          —&gt; purgeMgr.start()</div><div class="line">                    —&gt; timer = new Timer(“PurgeTask<span class="string">")</span></div><div class="line">                    —&gt; TimerTask task = new PurgeTask(dataLogDir, snapDir)     —&gt; PurgeTxnLog.purge(dataLogDir, snapDir)</div><div class="line">                    —&gt; timer.scheduleAtFixedRate(task)</div><div class="line">          —&gt; runFromConfig(config)</div><div class="line">                    —&gt; ServerCnxnFactory cnxnFactory =  ServerCnxnFactory.createFactory()               NIOServerCnxnfactory</div><div class="line">                    —&gt; cnxnFactory.configure</div><div class="line">                              —&gt; thread = new ZooKeeperThread (Runnable)     参数Runnable是一个线程，传入的是cnxnFactory</div><div class="line">                              —&gt; ServerSocketChannel.open()</div><div class="line">                    —&gt; quorumPeer = new QuorumPeer()          是一个线程</div><div class="line">                    —&gt; quorumPeer.setZKDatabase (new ZKDatabase(quorumPeer.getTxnFactory()) )</div><div class="line">                              —&gt; new ZKDatabase()</div><div class="line">                                        —&gt; dataTree = new DataTree()</div><div class="line">                    —&gt; quorumPeer.start()</div><div class="line">                              —&gt; loadDataBase()</div><div class="line">                                        —&gt; zkDb.loadDataBase()</div><div class="line">                                                  —&gt; zxid = snapLog.restore(dataTree, listener)</div><div class="line">                                                            —&gt; processTransaction (hdr, dt, txnLog.itor)</div><div class="line">                                                                      —&gt; switch (hdr)</div><div class="line">                                                                                —&gt; OpCode.createSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                                                                                    —&gt; switch (header.getType())</div><div class="line">                                                                                                              —&gt; OpCode.create</div><div class="line">                                                                                                              —&gt; OpCode.delete</div><div class="line">                                                                                                              —&gt; OpCode.setData</div><div class="line">                                                                                                              —&gt; OpCode.setACL</div><div class="line">                                                                                                              —&gt; OpCode.closeSession</div><div class="line">                                                                                                              —&gt; OpCode.error</div><div class="line">                                                                                                              —&gt; OpCode.check</div><div class="line">                                                                                                              —&gt; OpCode.multi</div><div class="line">                                                                                —&gt; OpCode.closeSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                        —&gt; currentEpoch = readLongFromFile(“currentEpoch")</div><div class="line">                                        —&gt; acceptedEpoch = readLongFromFile(“acceptEpoch<span class="string">")</span></div><div class="line">                              —&gt; cnxnFactory.start()</div><div class="line">                                        —&gt; thread.start()</div><div class="line">                              —&gt; startLeaderElection()</div><div class="line">                              —&gt; super.start()</div><div class="line"></div><div class="line">NIOServerCnxnfactory.run()</div><div class="line">     —&gt; while (! ServerSockChannel.socket().isClosed())</div><div class="line">               —&gt; selector.select(1000)</div><div class="line">               —&gt; selectedList = selector.selectedKeys()</div><div class="line">               —&gt; for (SelectedKey k : selectedList)</div><div class="line">                         —&gt; if ( k.readyOps() &amp; SelectionKey.OP_ACCEPT != 0)</div><div class="line">                                   —&gt; socketChannel = ((ServerSocketChannel) key.channel()).accept()</div><div class="line">                                   —&gt; NIOServerCnxn cnxn =  createConnection(socketChannel, k)</div><div class="line">                         —&gt; else if (k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE) != 0)</div><div class="line">                                   —&gt; NIOServerCnxn cnxn = (NIOServerCnxn) k.attachment()</div><div class="line">                                   —&gt; cnxn.doIO(k)</div><div class="line">                                             —&gt; if (k.isReadable())</div><div class="line">                                                       —&gt; socketChannel.read (incomingBuffer)</div><div class="line">                                                       —&gt; zkServer.processPacket (incomingBuffer)</div><div class="line">                                                                 —&gt; OpCode.auth                                             解析incomingBuffer，判断请求类型</div><div class="line">                                                                 —&gt; OpCode.sasl</div><div class="line">                                                                 —&gt; req = new Request (incomingBuffer, ServerCnxn)</div><div class="line">                                                                 —&gt; processRequest(req)</div><div class="line">                                                                           —&gt; submittedRequest.add(req)</div><div class="line">                                             —&gt; if (k.isWritable())</div><div class="line">                                                       —&gt; if (outgoingBuffer.size() &gt; 0)</div><div class="line">                                                                 —&gt; sockChannel.write(outgoingBuffer)</div><div class="line">               —&gt; selector.clear()</div><div class="line"></div><div class="line">quorumPeer.run()</div><div class="line">     —&gt; jmxQuorumBean = new QuorumBean(this)</div><div class="line">     —&gt; MBeanRegistry.getInstance().register(jmxQuorumBean)</div><div class="line">     —&gt; while (running)</div><div class="line">               —&gt; switch (peerState)</div><div class="line">                         —&gt; case LOOKING:</div><div class="line">                                   —&gt; if (readOnly)</div><div class="line">                                             —&gt; roZk = new ReadOnlyZooKeeperServer (logFactory, this, new ZooKeeperServer.BasicDataTreeBuilder(), this.zkDb)</div><div class="line">                                             —&gt; roZkMgr = new Thread()</div><div class="line">                                             —&gt; roZkMgr.start()</div><div class="line">                                                       —&gt; roZk.startup()</div><div class="line">                                                                 —&gt; registerJMX()</div><div class="line">                                                                 —&gt; startSessionTracker()</div><div class="line">                                                                 —&gt; setupRequestProcessors()</div><div class="line">                                                                 —&gt; state = RUNNING</div><div class="line">                                   —&gt; setBCVote</div><div class="line">                                   —&gt; setCurrentVote</div><div class="line">                         —&gt; case OBSERVING:</div><div class="line">                                   —&gt; setObserver (makeObserver (logFactory) )</div><div class="line">                                             —&gt; new ZooKeeperServer.BasicDataTreeBuilder()</div><div class="line">                                             —&gt; new ObserverZooKeeperServer(logFactory, zkDatabase)</div><div class="line">                                             —&gt; new Observer()</div><div class="line">                                   —&gt; observer.observeLeader()</div><div class="line">                                             —&gt; zk.registerJMX</div><div class="line">                                             —&gt; addr = findLeader()</div><div class="line">                                             —&gt; connectToLeader (addr)          socket连接leader</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                                       —&gt; synchronized (zk)</div><div class="line">                                                                 —&gt; zk.getZKDatabase.deserializeSnapshot(leaderIs)</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case FOLLOWING:</div><div class="line">                                   —&gt; setFollower( makeFollower(logFactory) )</div><div class="line">                                   —&gt; follower.followLeader()</div><div class="line">                                             —&gt; connectToLeader()</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case LEADING:</div><div class="line">                                   —&gt; setLeader ( makeLeader(logFactory) )</div><div class="line">                                   —&gt; leader.lead()</div><div class="line">                                             —&gt; zk.registerJMX()</div><div class="line">                                             —&gt; cnxAccepter = new LearnerAcceptor()</div><div class="line">                                             —&gt; cnxAccepter.run()</div><div class="line">                                                       —&gt; LearnerHandler.run()</div><div class="line">                                             —&gt; zk.setZxid(ZxidUtils.makeZxid(epoch))</div><div class="line">                                             —&gt; startZkServer()</div><div class="line">                                                       —&gt; zk.startup ()</div><div class="line">                                                                 —&gt; CommitProcessor.run()                     处理已完成的客户端请求</div><div class="line">                                                                 —&gt; PrepRequestProcessor.run()               处理未完成客户端请求</div><div class="line">                                                                           —&gt; while (true)</div><div class="line">                                                                                     —&gt; request = submittedRequests.take()</div><div class="line">                                                                                     —&gt; pRequest (request)</div><div class="line">                                                                                               —&gt; switch (request.type)</div><div class="line">                                                                                                         —&gt; case OpCode.create:          pRequest2Txn(处理所有的请求)</div><div class="line">                                                                                                         —&gt; case OpCode.delete:          pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setData:       pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setACL:        pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.check:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.multi:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; …...</div><div class="line">                                   —&gt; setLeader(null)</div><div class="line"></div><div class="line">QuorumPeer :</div><div class="line">    public Follower follower;          Follower extends Leader</div><div class="line">    public Leader leader;</div><div class="line">    public Observer observer;          Obsearver extends Learner</div><div class="line"></div><div class="line">class Leader &#123;</div><div class="line">    final LeaderZooKeeperServer zk;</div><div class="line">    final QuorumPeer self;</div><div class="line">    private boolean quorumFormed = false;</div><div class="line">    // the follower acceptor thread</div><div class="line">    LearnerCnxAcceptor cnxAcceptor;</div><div class="line">    // list of all the followers</div><div class="line">    private final HashSet&lt;LearnerHandler&gt; learners = new HashSet&lt;LearnerHandler&gt;();</div><div class="line">&#125;</div><div class="line">class Follower extends Learner&#123;</div><div class="line">    private long lastQueued;</div><div class="line">    // This is the same object as this.zk, but we cache the downcast op</div><div class="line">    final FollowerZooKeeperServer fzk;</div><div class="line">&#125;</div><div class="line">class Learner &#123;</div><div class="line">    QuorumPeer self;</div><div class="line">    LearnerZooKeeperServer zk;</div><div class="line">    protected BufferedOutputStream bufferedOutput;</div><div class="line">    protected Socket sock;</div><div class="line">    protected InputArchive leaderIs;</div><div class="line">    protected OutputArchive leaderOs;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br><strong>ZooKeeperMain解析源码：</strong><br>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">—&gt; main = new ZooKeeperMain</div><div class="line">             —&gt; parseOptions (-server, -timeout, -<span class="built_in">readonly</span>)</div><div class="line">             —&gt; connectToZk</div><div class="line">                         —&gt; zk = new ZooKeeper</div><div class="line">                                        —&gt; new ConnectStringParser (属性：chrootPath, serverAddress)</div><div class="line">                                        —&gt; new StaticHostProvider (属性：serverAddress)</div><div class="line">                                        —&gt; getClientCnxnSocket (返回 ClientCnxnSocket的子类ClientCnxnSocketNIO对象 (属性：selector, sockKey) )</div><div class="line">                                        —&gt; new ClientCnxn (参数：chrootPath, hostProvider, zookeeper, watchManager, clientCnxnSocket, 属性：authInfo, pendingQueue, outgoingQueue, zookeeper, clientWatchManager)</div><div class="line">                                                        —&gt;  SendThread (参数：ClientCnxnSocketNIO对象，属性：clientCnxnSocket, lastPingSentNs, isFirstConnect)</div><div class="line">                                                        —&gt;  EventThread (属性： waitingEvents, sessionState)</div><div class="line">                                        —&gt; ClientCnxn.start()</div><div class="line">—&gt; main.run()</div><div class="line">          —&gt; processCmd (cl)</div><div class="line">                    —&gt; processZKCmd (co)</div><div class="line">                              —&gt; cmd equals create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                              —&gt; zk.  create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                                        —&gt; cnxn. submitRequest (request, response)</div><div class="line">                                                  —&gt; queuePacket (request, response)</div><div class="line">                                                            —&gt; synchronized (outgoingQueue)</div><div class="line">                                                                      —&gt; outgoingQueue.add ( new Packet(request, response) )</div><div class="line">                                                            —&gt; sendThread.getClientCnxnScoket().wakeupCnxn()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>SendThred run函数：</strong><br>属性： state: socket连接状态，isFirstConnect: socket连接是否为第一次初始化连接，zookeeerSaslClient: SASL用户认证机制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">     —&gt; <span class="keyword">while</span> (state.isAlive)</div><div class="line">                    |—&gt; <span class="keyword">if</span> (! clientCnxnSocket.isConnected)</div><div class="line">                    |           —&gt;  startConnect</div><div class="line">                    |                    —&gt;  state = CONNECTING</div><div class="line">                    |                    —&gt; zookeeerSaslClient 认证</div><div class="line">                    |                    —&gt; ClientCnxnSocketNIO.connect</div><div class="line">                    |                              —&gt; SocketChannel.register(selector, OP_CONNECT)</div><div class="line">                    |                              —&gt; sock.connect(addr)</div><div class="line">                    |                              <span class="keyword">if</span> (immediateConnect)</div><div class="line">                    |                                        —&gt; sendThread.primeConnection</div><div class="line">                    |                                                  —&gt; new ConnectRequest(lastZxid)</div><div class="line">                    |                                                  —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                            <span class="keyword">if</span> (! disabledAutoWatchReset)</div><div class="line">                    |                                                                      —&gt; 将zookeeper 的属性 dataWatches, existWatchs, childWatchs 组装成 SetWatchs (递增Zxid)</div><div class="line">                    |                                                                      —&gt; new RequestHeader (Xid=-8, OpCode.setWatches)</div><div class="line">                    |                                                                      —&gt; new Packet, 将requestHeader和setWatchs 一起组装成Packet</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (packet)</div><div class="line">                    |                                                            <span class="keyword">for</span> (id : authInfo)</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (new Packet(new RequestHeader(Xid=-4, OpCode.auth), new AuthPacket(id.schema, id.data)))</div><div class="line">          |                               outgoingQueue.addFirst (new Packet(ConnectRequest))</div><div class="line">                    |                                                            clientCnxnSocket.enableReadWriteOnly()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (zookeeperSaslClient != null)</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getSaslState == ZookeeperSaslClient.SaslState.INITIAL)</div><div class="line">                    |                               —&gt; zookeeperSaslClient.initialize</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.AuthFailed)</div><div class="line">                    |                               —&gt; state = States.AUTH_FAILED</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.SaslAuthenticated)</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (sendAuthEvent == <span class="literal">true</span>)</div><div class="line">                    |                               —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, zookeeperSaslClient.getKeeperState) )</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (clientCnxnSocket.getIdleSend  &gt;  MAX_SEND_PING_INTERVAL)</div><div class="line">                    |                    —&gt; sendPing</div><div class="line">                    |                              —&gt;  queuePacket (new RequestHeader (Xid=-2, OpCode.ping) )</div><div class="line">                    |                                        —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                  —&gt; new Packet (RequestHeader)</div><div class="line">                    |                                                  —&gt; <span class="keyword">if</span> (RequestHeader != OpCode.closeSession)</div><div class="line">                    |                                                            —&gt; outgoingQueue.add(packet)</div><div class="line">                    |                                        —&gt; sendThread.getClientCnxnSocket().wakeupCnxn()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state == States.CONNECTEDREADONLY)</div><div class="line">                    |          —&gt; pingRwServer()</div><div class="line">                    |                    —&gt; new Socket</div><div class="line">                    |                    —&gt; new BufferedReader (new InputStreamReader(socket.getInputStream() ) )</div><div class="line">                    |                    —&gt; BufferedReader.readLine()</div><div class="line">                    |—&gt; clientCnxnSocket.doTransport (pendingQueue, outgoingQueue)</div><div class="line">                    |          —&gt; synchronize (clientCnxnSocket)</div><div class="line">                    |                    —&gt; selected = selector.selectedKeys()</div><div class="line">                    |          —&gt; <span class="keyword">for</span> (SelectionKey key : selected)</div><div class="line">                    |                     —&gt; <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_CONNECT) != 0)</div><div class="line">                    |                              —&gt; <span class="keyword">if</span> ((SocketChannel)key.channel().finishConnect() )</div><div class="line">                    |                                         —&gt; sendThread.primeConnection</div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> ((key.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != 0)</div><div class="line">                    |                              —&gt; doIO (pendingQueue, outgoingQueue)</div><div class="line">                    |                                        —&gt; socketChannel = socketKey.channel()</div><div class="line">                    |                                        —&gt; <span class="keyword">if</span> (socketKey.isReadable())</div><div class="line">                    |                                                  —&gt; socketChannel.read(incomingBuffer)</div><div class="line">                    |                                                            —&gt; <span class="keyword">if</span> (! initialized)</div><div class="line">                    |                                                                      —&gt; readConnectResult()</div><div class="line">                    |                                                                                —&gt; ConnectResponse response = new ConnectResponse()</div><div class="line">                    |                                                                                —&gt; response.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)) , “connect<span class="string">")</span></div><div class="line">                    |                                                                                —&gt; sendThread.onConnectd(response.getTimeout, response.getSessionId, response.getPasswd)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent(new WatchedEvent(Watcher.Event.EventType.None, eventState)  )</div><div class="line">                    |                                                                      —&gt; enableRead()</div><div class="line">                    |                                                            —&gt; else</div><div class="line">                    |                                                                      —&gt; sendThread.readResponse(incomingBuffer)</div><div class="line">                    |                                                                                —&gt; ReplyHeader replyHeader = new ReplyHeader()</div><div class="line">                    |                                                                                —&gt; replyHeader.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “header")</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -2)    pings</div><div class="line">                    |                                                                                          —&gt; debug</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -4)    AuthPacket</div><div class="line">                    |                                                                                          —&gt; <span class="keyword">if</span> (replyHeader.getErr() == KeeperException.Code.AUTHFAILED)</div><div class="line">                    |                                                                                                    —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, Watcher.Event.KeeperState.AuthFailed) )</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -1)    notification</div><div class="line">                    |                                                                                          —&gt; WatcherEvent event = new WatcherEvent()</div><div class="line">                    |                                                                                          —&gt; event.deserialize(BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “response<span class="string">")</span></div><div class="line">                    |                                                                                          —&gt; event.setPath (chrootPath)</div><div class="line">                    |                                                                                          —&gt; WatchedEvent we = new WatchedEvent(event)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent (we)</div><div class="line">                    |                                                                      —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                                —&gt; packet = pendingQueue.remove()</div><div class="line">                    |                                                                      —&gt; packet.replyHeader.setXid/setErr/setZxid</div><div class="line">                    |                                                                      —&gt; finishPacket (packet)</div><div class="line">                    |                                                                                —&gt; eventThread.queuePacket(packet)</div><div class="line">                    |                                                                                          —&gt; waitingEvents.add (packet)</div><div class="line">                    |                                        —&gt; if (socketKey.isWritable())</div><div class="line">                    |                                                  —&gt; Packet packet = findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress)</div><div class="line">                    |                                                  —&gt; packet.createBB          byteBuffer</div><div class="line">                    |                                                  —&gt; socketChannel.write(packet.bb)</div><div class="line">                    |                                                  —&gt; outgoingQueue.removeFirstOccurrence(packet)</div><div class="line">                    |                                                  —&gt; if (packet.hasRemaining)</div><div class="line">                    |                                                            —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                      —&gt; pendingQueue.add(packet)</div><div class="line">                    |          —&gt; if (sendThread.getZkState().isConnected)</div><div class="line">                    |                    —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                              —&gt; if (findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != null )</div><div class="line">                    |                                        —&gt; enableWrite()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>EventThred run函数：</strong><br>属性： waitingEvents<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">      —&gt; isRunning = <span class="literal">true</span></div><div class="line">      —&gt; <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">               —&gt; event = waitingEvents.take()</div><div class="line">                         —&gt; <span class="keyword">if</span> (event == eventOfDeath)</div><div class="line">                                   —&gt; wasKilled = <span class="literal">true</span></div><div class="line">                         —&gt; <span class="keyword">else</span></div><div class="line">                                   —&gt; processEvent(event)</div><div class="line">                                        —&gt; <span class="keyword">if</span> (event instanceof WatcherSetEventPair)</div><div class="line">                                                       —&gt; <span class="keyword">for</span> (Watcher watcher : ((WatcherSetEventPair)event).watchers )</div><div class="line">                                                                 —&gt; watcher.process( ((WatcherSetEventPair)event).event )</div><div class="line">                                             —&gt; <span class="keyword">else</span></div><div class="line">                                                       —&gt; Packet p = (Packet) event</div><div class="line">                                                       —&gt; <span class="keyword">if</span> (p.response instanceof ExistsResponse || p.response instanceof SetDataResponse || p.response instanceof SetACLResponse)</div><div class="line">                                                                 —&gt; StatCallback cb = (StatCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult ( clientPath, ((ExistsResponse/SetDataResponse/SetACLResponse) p.response).getStat )</div><div class="line">                                                                           —&gt; decOutstanding ()</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetDataResponse)</div><div class="line">                                                                 —&gt; DataCallback cb = (DataCallback) p.cb</div><div class="line">                                                                 —&gt; GetDataResponse response = (GetDataResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getData(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetACLResponse)</div><div class="line">                                                                 —&gt; ACLCallback cb = (ACLCallback) p.cb</div><div class="line">                                                                 —&gt; GetACLResponse response = (GetACLResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getAcl(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildrenResponse)</div><div class="line">                                                                 —&gt; ChildrenCallback cb = (ChildrenCallback) p.cb</div><div class="line">                                                                 —&gt; GetChildrenResponse response = (GetChildrenResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildren2Response)</div><div class="line">                                                                 —&gt; Children2Callback cb = (Children2Callback) p.cb</div><div class="line">                                                                 —&gt; GetChildren2Response response = (GetChildren2Response) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof CreateResponse)</div><div class="line">                                                                 —&gt; StringCallback cb = (StringCallback) p.cb</div><div class="line">                                                                 —&gt; CreateResponse response = (CreateResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getPath())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof MultiResponse)</div><div class="line">                                                                 —&gt; MultiCallback cb = (MultiCallback) p.cb</div><div class="line">                                                                 —&gt; MultiResponse response = (MultiResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getResultList())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb instanceof VoidCallback)</div><div class="line">                                                                 —&gt; VoidCallback cb = (VoidCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult (clientPath)</div></pre></td></tr></table></figure></p>
<p><strong>ClinetCnxn是核心函数：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ClientCnxn</span><span class="params">(String chrootPath, HostProvider hostProvider, intsessionTimeout, ZooKeeper zooKeeper,</span></span></div><div class="line">            ClientWatchManager watcher, ClientCnxnSocket clientCnxnSocket,</div><div class="line">            <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly) &#123;</div><div class="line">        <span class="keyword">this</span>.zooKeeper = zooKeeper;</div><div class="line">        <span class="keyword">this</span>.watcher = watcher;</div><div class="line">        <span class="keyword">this</span>.hostProvider = hostProvider;</div><div class="line">        <span class="keyword">this</span>.chrootPath = chrootPath;</div><div class="line"></div><div class="line">        sendThread = <span class="keyword">new</span> SendThread(clientCnxnSocket);</div><div class="line">        eventThread = <span class="keyword">new</span> EventThread();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">enum</span> States &#123;</div><div class="line">        CONNECTING, ASSOCIATING, CONNECTED, CONNECTEDREADONLY,</div><div class="line">        CLOSED, AUTH_FAILED, NOT_CONNECTED;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAlive</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> != CLOSED &amp;&amp; <span class="keyword">this</span> != AUTH_FAILED;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> == CONNECTED || <span class="keyword">this</span> == CONNECTEDREADONLY;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        Packet(RequestHeader requestHeader, ReplyHeader replyHeader,</div><div class="line">               Record request, Record response,</div><div class="line">               WatchRegistration watchRegistration, <span class="keyword">boolean</span> readOnly) &#123;</div><div class="line">            <span class="keyword">this</span>.requestHeader = requestHeader;</div><div class="line">            <span class="keyword">this</span>.replyHeader = replyHeader;</div><div class="line">            <span class="keyword">this</span>.request = request;</div><div class="line">            <span class="keyword">this</span>.response = response;</div><div class="line">            <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">            <span class="keyword">this</span>.watchRegistration = watchRegistration;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataTree</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">/* Rather than fight it, let root have an alias */</span></div><div class="line">        nodes.put(<span class="string">""</span>, root);</div><div class="line">        nodes.put(rootZookeeper, root);</div><div class="line"></div><div class="line">        <span class="comment">/** add the proc node and quota node */</span></div><div class="line">        root.addChild(procChildZookeeper);</div><div class="line">        nodes.put(procZookeeper, procDataNode);</div><div class="line"></div><div class="line">        procDataNode.addChild(quotaChildZookeeper);</div><div class="line">        nodes.put(quotaZookeeper, quotaDataNode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></div><div class="line">        <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</div><div class="line">    &#123;</div><div class="line">        request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</div><div class="line">                                    zks.getTime(), type);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (type) &#123;</div><div class="line">            <span class="keyword">case</span> OpCode.create:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CreateRequest createRequest = (CreateRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);</div><div class="line">                String path = createRequest.getPath();</div><div class="line">                <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span> || failCreate) &#123;</div><div class="line">                    LOG.info(<span class="string">"Invalid path "</span> + path + <span class="string">" with session 0x"</span> +</div><div class="line">                            Long.toHexString(request.sessionId));</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                String parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                ChangeRecord parentRecord = getRecordForPath(parentPath);</div><div class="line"></div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> parentCVersion = parentRecord.stat.getCversion();</div><div class="line">                CreateMode createMode =</div><div class="line">                    CreateMode.fromFlag(createRequest.getFlags());</div><div class="line">                <span class="keyword">if</span> (createMode.isSequential()) &#123;</div><div class="line">                    path = path + String.format(Locale.ENGLISH, <span class="string">"%010d"</span>, parentCVersion);</div><div class="line">                &#125;</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (getRecordForPath(path) != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NodeExistsException(path);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</div><div class="line">                    <span class="comment">// ignore this one</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">boolean</span> ephemeralParent = parentRecord.stat.getEphemeralOwner() != <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (ephemeralParent) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoChildrenForEphemeralsException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> newCversion = parentRecord.stat.getCversion()+<span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CreateTxn(path, createRequest.getData(),</div><div class="line">                        listACL,</div><div class="line">                        createMode.isEphemeral(), newCversion);</div><div class="line">                StatPersisted s = <span class="keyword">new</span> StatPersisted();</div><div class="line">                <span class="keyword">if</span> (createMode.isEphemeral()) &#123;</div><div class="line">                    s.setEphemeralOwner(request.sessionId);</div><div class="line">                &#125;</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount++;</div><div class="line">                parentRecord.stat.setCversion(newCversion);</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path, s,</div><div class="line">                        <span class="number">0</span>, listACL));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.delete:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                DeleteRequest deleteRequest = (DeleteRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, deleteRequest);</div><div class="line">                path = deleteRequest.getPath();</div><div class="line">                lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span></div><div class="line">                        || zks.getZKDatabase().isSpecialPath(path)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                parentRecord = getRecordForPath(parentPath);</div><div class="line">                ChangeRecord nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.DELETE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> version = deleteRequest.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; nodeRecord.stat.getVersion() != version) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (nodeRecord.childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NotEmptyException(path);</div><div class="line">                &#125;</div><div class="line">                request.txn = <span class="keyword">new</span> DeleteTxn(path);</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount--;</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path,</div><div class="line">                        <span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setData:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetDataRequest setDataRequest = (SetDataRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setDataRequest);</div><div class="line">                path = setDataRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.WRITE,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setDataRequest.getVersion();</div><div class="line">                <span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetDataTxn(path, setDataRequest.getData(), version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setVersion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setACL:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetACLRequest setAclRequest = (SetACLRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setAclRequest);</div><div class="line">                path = setAclRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                listACL = removeDuplicates(setAclRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.ADMIN,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setAclRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getAversion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetACLTxn(path, listACL, version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setAversion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.createSession:</div><div class="line">                request.request.rewind();</div><div class="line">                <span class="keyword">int</span> to = request.request.getInt();</div><div class="line">                request.txn = <span class="keyword">new</span> CreateSessionTxn(to);</div><div class="line">                request.request.rewind();</div><div class="line">                zks.sessionTracker.addSession(request.sessionId, to);</div><div class="line">                zks.setOwner(request.sessionId, request.getOwner());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.closeSession:</div><div class="line">                <span class="comment">// We don't want to do this check since the session expiration thread</span></div><div class="line">                <span class="comment">// queues up this operation without being the session owner.</span></div><div class="line">                <span class="comment">// this request is the last of the session so it should be ok</span></div><div class="line">                <span class="comment">//zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span></div><div class="line">                HashSet&lt;String&gt; es = zks.getZKDatabase()</div><div class="line">                        .getEphemerals(request.sessionId);</div><div class="line">                <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123;</div><div class="line">                    <span class="keyword">for</span> (ChangeRecord c : zks.outstandingChanges) &#123;</div><div class="line">                        <span class="keyword">if</span> (c.stat == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Doing a delete</span></div><div class="line">                            es.remove(c.path);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.stat.getEphemeralOwner() == request.sessionId) &#123;</div><div class="line">                            es.add(c.path);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">for</span> (String path2Delete : es) &#123;</div><div class="line">                        addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(),</div><div class="line">                                path2Delete, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    zks.sessionTracker.setSessionClosing(request.sessionId);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                LOG.info(<span class="string">"Processed session termination for sessionid: 0x"</span></div><div class="line">                        + Long.toHexString(request.sessionId));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.check:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CheckVersionRequest checkVersionRequest = (CheckVersionRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, checkVersionRequest);</div><div class="line">                path = checkVersionRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.READ,</div><div class="line">                        request.authInfo);</div><div class="line">                version = checkVersionRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CheckVersionTxn(path, version);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">        <span class="keyword">switch</span> (qp.getType()) &#123;</div><div class="line">        <span class="keyword">case</span> Leader.PING:</div><div class="line">            ping(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.PROPOSAL:</div><div class="line">            LOG.warn(<span class="string">"Ignoring proposal"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.COMMIT:</div><div class="line">            LOG.warn(<span class="string">"Ignoring commit"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.UPTODATE:</div><div class="line">            LOG.error(<span class="string">"Received an UPTODATE message after Observer started"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.REVALIDATE:</div><div class="line">            revalidate(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.SYNC:</div><div class="line">            ((ObserverZooKeeperServer)zk).sync();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.INFORM:</div><div class="line">            TxnHeader hdr = <span class="keyword">new</span> TxnHeader();</div><div class="line">            Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);</div><div class="line">            Request request = <span class="keyword">new</span> Request (<span class="keyword">null</span>, hdr.getClientId(),</div><div class="line">                                           hdr.getCxid(),</div><div class="line">                                           hdr.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">            request.txn = txn;</div><div class="line">            request.hdr = hdr;</div><div class="line">            ObserverZooKeeperServer obs = (ObserverZooKeeperServer)zk;</div><div class="line">            obs.commitRequest(request);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">switch</span> (packetType) &#123;</div><div class="line">        <span class="keyword">case</span> DIFF:</div><div class="line">            <span class="keyword">return</span> <span class="string">"DIFF"</span>;</div><div class="line">        <span class="keyword">case</span> TRUNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"TRUNC"</span>;</div><div class="line">        <span class="keyword">case</span> SNAP:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SNAP"</span>;</div><div class="line">        <span class="keyword">case</span> OBSERVERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"OBSERVERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> NEWLEADER:</div><div class="line">            <span class="keyword">return</span> <span class="string">"NEWLEADER"</span>;</div><div class="line">        <span class="keyword">case</span> FOLLOWERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"FOLLOWERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> UPTODATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UPTODATE"</span>;</div><div class="line">        <span class="keyword">case</span> LEADERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"LEADERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> ACKEPOCH:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACKEPOCH"</span>;</div><div class="line">        <span class="keyword">case</span> REQUEST:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REQUEST"</span>;</div><div class="line">        <span class="keyword">case</span> PROPOSAL:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PROPOSAL"</span>;</div><div class="line">        <span class="keyword">case</span> ACK:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACK"</span>;</div><div class="line">        <span class="keyword">case</span> COMMIT:</div><div class="line">            <span class="keyword">return</span> <span class="string">"COMMIT"</span>;</div><div class="line">        <span class="keyword">case</span> PING:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PING"</span>;</div><div class="line">        <span class="keyword">case</span> REVALIDATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REVALIDATE"</span>;</div><div class="line">        <span class="keyword">case</span> SYNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SYNC"</span>;</div><div class="line">        <span class="keyword">case</span> INFORM:</div><div class="line">            <span class="keyword">return</span> <span class="string">"INFORM"</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UNKNOWN"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper源码/" class="archive-article-date">
  	<time datetime="2016-11-10T05:15:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/etcd介绍及源码分析/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          etcd介绍及源码解析
        
      </div>
    </a>
  
  
    <a href="/ZooKeeper简介/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">ZooKeeper简介</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>









      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Xia, MingXing
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: false
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Cassandra/" style="font-size: 10px;">Cassandra</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Hadoop/" style="font-size: 20px;">Hadoop</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Kafka/" style="font-size: 12.5px;">Kafka</a> <a href="/tags/Libvirt/" style="font-size: 10px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 12.5px;">Linux</a> <a href="/tags/Linux-Networking-Internals/" style="font-size: 15px;">Linux Networking Internals</a> <a href="/tags/Linux-Source-Code/" style="font-size: 10px;">Linux Source Code</a> <a href="/tags/Linux-Special-File-System/" style="font-size: 10px;">Linux Special File System</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/Mesos/" style="font-size: 10px;">Mesos</a> <a href="/tags/NoSQL/" style="font-size: 10px;">NoSQL</a> <a href="/tags/Openstack/" style="font-size: 10px;">Openstack</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Spring/" style="font-size: 12.5px;">Spring</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/ZooKeeper/" style="font-size: 12.5px;">ZooKeeper</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/lxc/" style="font-size: 10px;">lxc</a> <a href="/tags/lxcfs/" style="font-size: 10px;">lxcfs</a> <a href="/tags/介绍/" style="font-size: 10px;">介绍</a> <a href="/tags/分布式协同/" style="font-size: 10px;">分布式协同</a> <a href="/tags/大数据/" style="font-size: 17.5px;">大数据</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">平均每天保证几小时的学习时间，用一万小时定律激励自己</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>