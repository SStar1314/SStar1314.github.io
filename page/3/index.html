<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>SStar1314</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="SStar1314">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="SStar1314">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SStar1314">
  
    <link rel="alternative" href="/atom.xml" title="SStar1314" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/favicon.ico" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Xia,MingXing</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives">所有文章</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Xia,MingXing</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/favicon.ico" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Xia,MingXing</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-etcd介绍及源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/etcd介绍及源码分析/">etcd介绍及源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="etcd-相关网站"><a href="#etcd-相关网站" class="headerlink" title="etcd 相关网站"></a>etcd 相关网站</h3><p><a href="https://coreos.com/etcd/docs/latest/" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/</a><br><a href="https://coreos.com/etcd/docs/latest/api.html" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/api.html</a><br><a href="https://coreos.com/etcd/docs/latest/libraries-and-tools.html" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/libraries-and-tools.html</a></p>
<h3 id="Eclipse安装golang语言plugin："><a href="#Eclipse安装golang语言plugin：" class="headerlink" title="Eclipse安装golang语言plugin："></a>Eclipse安装golang语言plugin：</h3><p>Installation Requirements:</p>
<ul>
<li>Java VM version 8 or later.</li>
<li>Eclipse 4.6 (Neon) or later.</li>
<li>CDT 9.0 or later (this will be installed or updated automatically as part of the steps below).</li>
</ul>
<p>Instructions:</p>
<ul>
<li>Use your existing Eclipse, or download a new Eclipse package from <a href="http://www.eclipse.org/downloads/" target="_blank" rel="external">http://www.eclipse.org/downloads/</a>.<ul>
<li>For an Eclipse package without any other IDEs or extras (such a VCS tools), download the “Platform Runtime Binary”.</li>
</ul>
</li>
<li>Start Eclipse, go to Help -&gt; Install New Software…</li>
<li>Click the Add… button, then enter the Update Site URL: <a href="http://goclipse.github.io/releases/" target="_blank" rel="external">http://goclipse.github.io/releases/</a> in the Location field, click OK.</li>
<li>Select the recently added update site in the Work with: dropdown. Type GoClipse in the filter box. Now the Goclipse feature should appear below.</li>
<li>Select the GoClipse feature, and complete the wizard.<ul>
<li>Dependencies such as CDT will automatically be added during installation.</li>
</ul>
</li>
<li>Restart Eclipse.</li>
<li>Follow the instructions from the User Guide’s Configuration section to configure the required external tools. It is recommended you read the rest of the guide too.</li>
</ul>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><p><strong>客户端：client.go</strong></p>
<p>etcdmain/main.go  Main():<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">—&gt; etcdmain/etcd.go  startEtcdOrProxyV2():</div><div class="line">          —&gt; etcdmain/config.go  cfg := newConfig():               etcd初始化对象配置</div><div class="line">          —&gt; etcdmain/config.go  cfg.parse(Args[1:]):               解析etcd启动参数</div><div class="line">          —&gt; etcdmain/etcd.go  setupLogging(cfg)</div><div class="line">          —&gt; etcdmain/etcd.go  which := identifyDataDirOrDie(cfg.Dir)       分析Dir参数，解析etcd启动方式，如果Dir参数为空，也会走下面2个分支</div><div class="line">                    —&gt; case dirMember:</div><div class="line">                              —&gt; etcdmain/etcd.go  startEtcd(&amp;cfg.Config)</div><div class="line">                                        —&gt; embed/etcd.go  e, err := embed.StartEtcd(cfg)                         启动etcd服务</div><div class="line">                                                  —&gt; embed/config.go  cfg.Validate()                                             验证config值</div><div class="line">                                                  —&gt; embed/etcd.go  e.Peers := startPeerListeners(cfg)</div><div class="line">                                                            —&gt; plns = make([]net.Listener, len(cfg.LPUrls))</div><div class="line">                                                            —&gt; for i, u := range cfg.LPUrls</div><div class="line">                                                                      —&gt; pkg/transport/listener.go  tlscfg = cfg.PeerTLSInfo.ServerConfig()               CA file config</div><div class="line">                                                                      —&gt; rafthttp/util.go  plns[i] = rafthttp.NewListener(u, tlscfg)</div><div class="line">                                                                                —&gt; transport/timeout_listener.go  transport.NewTimeoutListener(u.Host, u.Scheme, tlscfg, ConnReadTimeout, ConnWriteTimeout)</div><div class="line">                                                                                          —&gt; pkg/transport/listener.go  ln := newListener(u.Host, u.Scheme)</div><div class="line">                                                                                                    —&gt; unix_listener.go       if (u.Scheme == “unix” | “unixs”)     return NewUnixListener(u.Host)               unix socket via unix://laddr</div><div class="line">                                                                                                    —&gt; dial.go                         else      return net.Listen(“tcp”, u.Host)                                        tcp socket</div><div class="line">                                                                                          —&gt; transport/timeout_listener.go  ln = &amp;rwTimeoutListener&#123;&#125;</div><div class="line">                                                                                          —&gt; pkg/transport/listener.go  ln = wrapTLS(u.Host, u.Scheme, tlscfg, ln)</div><div class="line">                                                                                                    —&gt; tls.go  tlscfg.NewListener(ln, tlscfg)                                                  创建listener，该listener接受inner连接               tls：Transport Layer Security 传输层安全协议</div><div class="line">                                                  —&gt; embed/etcd.go  e.sctxs := startClientListeners(cfg)</div><div class="line">                                                            —&gt; if  cfg.ClientAutoTLS &amp;&amp; cfg.ClientTLSInfo.Empty()     cfg.ClientTLSInfo = transport.SelfCert(path.Join(cfg.Dir, “fixtures/client"), cfg.LCurls)               配置tls信息</div><div class="line">                                                            —&gt; sctxs = make(map[string] *serveCtx)</div><div class="line">                                                            —&gt; sctx.l = net.Listen(proto, cfg.LCurls)                         proto=“tcp|unix|unixs"      创建socket 进行listen</div><div class="line">                                                            —&gt; sctx.l = transport.LimitListener(sctx.l, int(fdLimit - reservedInternalFDNum))                    设置listen limit上限值</div><div class="line">                                                            —&gt; pkg/transport/keepalive_listener.go  sctx.l = transport.NewKeepAliveListener(sctx.l, “tcp”, cfg)                                             创建socket</div><div class="line">                                                                      —&gt; newTLSKeepaliveListener(sctx.l, cfg)</div><div class="line">                                                  —&gt; e.Clients = append(e.Clients, e.sctxs.l)</div><div class="line">                                                  —&gt; srvcfg := &amp;etcdserver.ServerConfig&#123;cfg&#125;</div><div class="line">                                                  —&gt; etcdserver/server.go  e.Server = etcdserver.NewServer(srvcfg)</div><div class="line">                                                            —&gt; store/store.go  st := store.New(StoreClusterPrefix, StoreKeysPrefix)</div><div class="line">                                                                      —&gt; store/store.go  s := newStore(namespaces ...)</div><div class="line">                                                                                —&gt; s := new(store)</div><div class="line">                                                                                —&gt; s.Root = newDir(s, “/“, s.CurrentIndex, Permanent)</div><div class="line">                                                                                —&gt; for namespace := range namespaces        s.Root.Add(newDir(s, namespace, s.CurrentIndex, s.Root, Permanent))</div><div class="line">                                                                                —&gt; s.Stats = newStats()</div><div class="line">                                                                                —&gt; s.WatcherHub = newWatchHub(1000)</div><div class="line">                                                                                —&gt; s.ttlKeyHeap = newTtlKeyHeap()</div><div class="line">                                                                                —&gt; s.readonlySet =  types.NewUnsafeSet(append(namespaces, “/“) ...)</div><div class="line">                                                                      —&gt; s.clock = clockwork.NewRealClock()</div><div class="line">                                                            —&gt; haveWAL := wal.Exist(cfg.WALDir())</div><div class="line">                                                            —&gt; ss := snap.New(cfg.SnapDir())</div><div class="line">                                                            —&gt; bepath := path.Join(cfg.SnapDir(), databaseFilename)</div><div class="line">                                                            —&gt; mvcc/backend/backend.go  be := backend.NewDefaultBackend(bepath)</div><div class="line">                                                                      —&gt; newBackend(bepath, defaultBatchInterval, defaultBatchLimit)</div><div class="line">                                                                                —&gt; db := bolt.Open(bepath, 0600, boltOpenOptions)</div><div class="line">                                                                                —&gt; b := &amp;backend&#123;&#125;</div><div class="line">                                                                                —&gt; mvcc/backend/batch_tx.go  b.batchTx = newBatchTx(b)</div><div class="line">                                                                                          —&gt; tx := &amp;batchTx&#123;b&#125;</div><div class="line">                                                                                          —&gt; tx.Commit()</div><div class="line">                                                                                —&gt; go b.run()</div><div class="line">                                                                                          —&gt; t := time.NewTimer(b.batchInterval)</div><div class="line">                                                                                          —&gt; for</div><div class="line">                                                                                                    —&gt; select</div><div class="line">                                                                                                              —&gt; case &lt;- t,C:</div><div class="line">                                                                                                              —&gt; case &lt;- b.stopc:</div><div class="line">                                                                                                                        —&gt; b.batchTx.CommitAndStop()</div><div class="line">                                                                                                    —&gt; b.batchTx.Commit()</div><div class="line">                                                                                                    —&gt; b.Reset(b.batchInterval)</div><div class="line">                                                            —&gt; rafthttp/util.go  prt := rafthttp.NewRoundTripper(cfg.PeerTLSInfo, cfg.peerDialTimeout())</div><div class="line">                                                                      —&gt; pkg/transport/timeout_transport.go  transport.NewTimoutTransport(cfg.PeerTLSInfo, cfg.peerDialTimeout())</div><div class="line">                                                                                —&gt; tr := NewTransport(info, dialtimeoutd)</div><div class="line">                                                                                —&gt; tr.Dial =(&amp;rwTimeoutDialer&#123;&#125;).Dial</div><div class="line">                                                            —&gt; swith</div><div class="line">                                                                      —&gt; case !haveWAL &amp;&amp; !cfg.NewCluster</div><div class="line">                                                                                —&gt; cfg.VerifyJoinExisting()</div><div class="line">                                                                                —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitialClusterToken, cfg.InitialPeerURLsMap)</div><div class="line">                                                                                —&gt; existingCluster = GetClusterFromRemotePeers(getRemotePeerURLs(cl, cfg.Name), prt)</div><div class="line">                                                                                —&gt; membership.ValidateClusterAndAssignIDs(cl, existingCluster)</div><div class="line">                                                                                —&gt; isCompatibleWithCluster(cl, cl.MemberByName(cfg.Name).ID, prt)</div><div class="line">                                                                                —&gt; remotes = existingCluster.Members()</div><div class="line">                                                                                —&gt; cl.SetID(existingCluster.ID())</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cfg.Print()</div><div class="line">                                                                                —&gt; id, n, s, w = startNode(cfg, cl)</div><div class="line">                                                                      —&gt; case !haveWAL &amp;&amp; cfg.NewCluster</div><div class="line">                                                                                —&gt; cfg.VerifyBootstrape()</div><div class="line">                                                                                —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitialClusterToken, cfg.InitialPeerURLsMap)</div><div class="line">                                                                                —&gt; m := cl.MemberByName(cfg.Name)</div><div class="line">                                                                                —&gt; isMemberBootstrapped(cl, cfg.Name, prt, cfg.bootstrapTimeout())</div><div class="line">                                                                                —&gt; if cfg.ShouldDiscover()</div><div class="line">                                                                                          —&gt; str = discovery.JoinCluster(cfg.DiscoveryURL, cfg.DiscoveryProxy, m.ID, cfg.InitialPeerURLsMap.String())</div><div class="line">                                                                                          —&gt; urlsmap = types.NewURLsMap(str)</div><div class="line">                                                                                          —&gt; checkDuplicateURL(urlsmap)</div><div class="line">                                                                                          —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitoalClusterToken, urlsmap)</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cfg.PrintWithInitial()</div><div class="line">                                                                                —&gt; id, n, s, w = startNode(cfg, cl, cl.MemberIDs())</div><div class="line">                                                                      —&gt; case haveWAL:</div><div class="line">                                                                                —&gt; fileutil.IsDirWriteable(cfg.MemberDir())</div><div class="line">                                                                                —&gt; fileutil.IsDirWriteable(cfg.WALDir())</div><div class="line">                                                                                —&gt; snapshot = ss.Load()</div><div class="line">                                                                                —&gt; st.Recovery(snapshot.Data)</div><div class="line">                                                                                —&gt; cfg.Print()</div><div class="line">                                                                                —&gt; if !cfg.ForceNewCluster</div><div class="line">                                                                                          —&gt; id, cl, n, s, w = restartNode(cfg, snapshot)</div><div class="line">                                                                                —&gt; else</div><div class="line">                                                                                          —&gt; id, cl, n, s, w = restartAsStandaloneNode(cfg, snapshot)</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cl.Recover()</div><div class="line">                                                            —&gt; sstats := &amp;stats.ServerStats&#123;&#125;</div><div class="line">                                                            —&gt; sstats.Initialize()</div><div class="line">                                                            —&gt; lstats := stats.NewLeaderStats(id.String())</div><div class="line">                                                            —&gt; srv = &amp;EtcdServer&#123;&#125;</div><div class="line">                                                            —&gt; srv.applyV2 = &amp;applierV2store&#123;&#125;</div><div class="line">                                                            —&gt; srv.be = be</div><div class="line">                                                            —&gt; srv.lessor = lease.NewLessor(srv.be)</div><div class="line">                                                            —&gt; srv.kv = mvcc.New(src.be, srv.lessor, &amp;srv.consistIndex)</div><div class="line">                                                            —&gt; srv.consistIndex.setConsistentIndex(srv.kv.ConsistentIndex())</div><div class="line">                                                            —&gt; srv.authStore = auth.NewAuthStore(srv.be)</div><div class="line">                                                            —&gt; h := cfg.AutoCompactionRetention</div><div class="line">                                                            —&gt; srv.compactor = compactor.NewPeriodic(h, srv,kv, srv)</div><div class="line">                                                            —&gt; tr := &amp;rafthttp.Transport&#123;&#125;</div><div class="line">                                                            —&gt; tr.Start()</div><div class="line">                                                            —&gt; for m := range  remotes      tr.AddRemote(m.ID, m.PeerURLs)</div><div class="line">                                                            —&gt; for m := range  cl.Members()      tr.AddPeer(m.ID, m.PeerURLs)</div><div class="line">                                                            —&gt; srv.r.transport = tr</div><div class="line">                                                  —&gt; etcdserver/server.go  e.Server.Start()</div><div class="line">                                        —&gt; interrupt_unix.go  osutil.RegisterInterruptHandler(e.Server.Stop)               向系统注册中断事件</div><div class="line">                    —&gt; case dirProxy:</div><div class="line">                              —&gt; etcdmain/etcd.go  startProxy(&amp;cfg.Config)</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/etcd介绍及源码分析/" class="archive-article-date">
  	<time datetime="2016-11-10T05:31:40.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/etcd/">etcd</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ZooKeeper源码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ZooKeeper源码/">ZooKeeper源码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ZooKeeper-Eclipse-编译："><a href="#ZooKeeper-Eclipse-编译：" class="headerlink" title="ZooKeeper Eclipse 编译："></a>ZooKeeper Eclipse 编译：</h2><p>1.源码下载：git clone <a href="https://github.com/apache/zookeeper.git" target="_blank" rel="external">https://github.com/apache/zookeeper.git</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习)</div></pre></td></tr></table></figure></p>
<p>2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的位置，java project 创建成果之后，右键build.xml run as Ant build，会自动下载build project的jar包。<br>多个文件目录下都有build.xml文件，都可以尝试run as Ant build，下载build project所需要的jar包。<br>3.运行build.xml之后，jar包或许仍不完整，需要自己下载jar包，目录截图如下：<br><img src="/images/ZooKeeper_Code_1.png" alt=""><br>4.至此，zookeeper java工程的编译任务完成。</p>
<h3 id="Linux-下同样需要ant编译："><a href="#Linux-下同样需要ant编译：" class="headerlink" title="Linux 下同样需要ant编译："></a>Linux 下同样需要ant编译：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get install openjdk-7-jdk</div><div class="line"><span class="built_in">cd</span> /root/zookeeper-3.4.8</div><div class="line">ant</div></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p><strong>RestAPI源码入门：</strong><br>RestAPI 入口main函数所在文件： org.apache.zookeeper.server.jersey.RestMain</p>
<p><strong>ZooKeeper Source Code 解析：</strong><br>1.zkServer 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nohup &quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line">-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=7778 \                         （此行是用作java remote debug使用的，是我后加的）</div><div class="line">-cp &quot;$CLASSPATH&quot; $JVMFLAGS $ZOOMAIN &quot;$ZOOCFG&quot; &gt; &quot;$_ZOO_DAEMON_OUT&quot; 2&gt;&amp;1 &lt; /dev/null &amp;</div><div class="line"> ZOOMAIN=&quot;-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;</div></pre></td></tr></table></figure></p>
<p>2.zkCli 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line"> -cp &quot;$CLASSPATH&quot; $CLIENT_JVMFLAGS $JVMFLAGS \</div><div class="line"> org.apache.zookeeper.ZooKeeperMain &quot;$@&quot;</div></pre></td></tr></table></figure></p>
<p>由上可知， ZooKeeper的server启动入口函数为 <strong>QuorumPeerMain</strong> ，而client的启动入口函数为 <strong>ZooKeeperMain</strong>。</p>
<h3 id="QuorumPeerMain解析源码："><a href="#QuorumPeerMain解析源码：" class="headerlink" title="QuorumPeerMain解析源码："></a>QuorumPeerMain解析源码：</h3><p>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line">—&gt; QuorumPeerMain main = new QuorumPeerMain()</div><div class="line">—&gt; main.initializeAndRun(args)</div><div class="line">          —&gt; QuorumPeerConfig config = new QuorumPeerConfig()</div><div class="line">          —&gt; config.parse(args)</div><div class="line">                    —&gt; parseProperties(cfg)</div><div class="line">          —&gt; DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config)</div><div class="line">          —&gt; purgeMgr.start()</div><div class="line">                    —&gt; timer = new Timer(“PurgeTask<span class="string">")</span></div><div class="line">                    —&gt; TimerTask task = new PurgeTask(dataLogDir, snapDir)     —&gt; PurgeTxnLog.purge(dataLogDir, snapDir)</div><div class="line">                    —&gt; timer.scheduleAtFixedRate(task)</div><div class="line">          —&gt; runFromConfig(config)</div><div class="line">                    —&gt; ServerCnxnFactory cnxnFactory =  ServerCnxnFactory.createFactory()               NIOServerCnxnfactory</div><div class="line">                    —&gt; cnxnFactory.configure</div><div class="line">                              —&gt; thread = new ZooKeeperThread (Runnable)     参数Runnable是一个线程，传入的是cnxnFactory</div><div class="line">                              —&gt; ServerSocketChannel.open()</div><div class="line">                    —&gt; quorumPeer = new QuorumPeer()          是一个线程</div><div class="line">                    —&gt; quorumPeer.setZKDatabase (new ZKDatabase(quorumPeer.getTxnFactory()) )</div><div class="line">                              —&gt; new ZKDatabase()</div><div class="line">                                        —&gt; dataTree = new DataTree()</div><div class="line">                    —&gt; quorumPeer.start()</div><div class="line">                              —&gt; loadDataBase()</div><div class="line">                                        —&gt; zkDb.loadDataBase()</div><div class="line">                                                  —&gt; zxid = snapLog.restore(dataTree, listener)</div><div class="line">                                                            —&gt; processTransaction (hdr, dt, txnLog.itor)</div><div class="line">                                                                      —&gt; switch (hdr)</div><div class="line">                                                                                —&gt; OpCode.createSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                                                                                    —&gt; switch (header.getType())</div><div class="line">                                                                                                              —&gt; OpCode.create</div><div class="line">                                                                                                              —&gt; OpCode.delete</div><div class="line">                                                                                                              —&gt; OpCode.setData</div><div class="line">                                                                                                              —&gt; OpCode.setACL</div><div class="line">                                                                                                              —&gt; OpCode.closeSession</div><div class="line">                                                                                                              —&gt; OpCode.error</div><div class="line">                                                                                                              —&gt; OpCode.check</div><div class="line">                                                                                                              —&gt; OpCode.multi</div><div class="line">                                                                                —&gt; OpCode.closeSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                        —&gt; currentEpoch = readLongFromFile(“currentEpoch")</div><div class="line">                                        —&gt; acceptedEpoch = readLongFromFile(“acceptEpoch<span class="string">")</span></div><div class="line">                              —&gt; cnxnFactory.start()</div><div class="line">                                        —&gt; thread.start()</div><div class="line">                              —&gt; startLeaderElection()</div><div class="line">                              —&gt; super.start()</div><div class="line"></div><div class="line">NIOServerCnxnfactory.run()</div><div class="line">     —&gt; while (! ServerSockChannel.socket().isClosed())</div><div class="line">               —&gt; selector.select(1000)</div><div class="line">               —&gt; selectedList = selector.selectedKeys()</div><div class="line">               —&gt; for (SelectedKey k : selectedList)</div><div class="line">                         —&gt; if ( k.readyOps() &amp; SelectionKey.OP_ACCEPT != 0)</div><div class="line">                                   —&gt; socketChannel = ((ServerSocketChannel) key.channel()).accept()</div><div class="line">                                   —&gt; NIOServerCnxn cnxn =  createConnection(socketChannel, k)</div><div class="line">                         —&gt; else if (k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE) != 0)</div><div class="line">                                   —&gt; NIOServerCnxn cnxn = (NIOServerCnxn) k.attachment()</div><div class="line">                                   —&gt; cnxn.doIO(k)</div><div class="line">                                             —&gt; if (k.isReadable())</div><div class="line">                                                       —&gt; socketChannel.read (incomingBuffer)</div><div class="line">                                                       —&gt; zkServer.processPacket (incomingBuffer)</div><div class="line">                                                                 —&gt; OpCode.auth                                             解析incomingBuffer，判断请求类型</div><div class="line">                                                                 —&gt; OpCode.sasl</div><div class="line">                                                                 —&gt; req = new Request (incomingBuffer, ServerCnxn)</div><div class="line">                                                                 —&gt; processRequest(req)</div><div class="line">                                                                           —&gt; submittedRequest.add(req)</div><div class="line">                                             —&gt; if (k.isWritable())</div><div class="line">                                                       —&gt; if (outgoingBuffer.size() &gt; 0)</div><div class="line">                                                                 —&gt; sockChannel.write(outgoingBuffer)</div><div class="line">               —&gt; selector.clear()</div><div class="line"></div><div class="line">quorumPeer.run()</div><div class="line">     —&gt; jmxQuorumBean = new QuorumBean(this)</div><div class="line">     —&gt; MBeanRegistry.getInstance().register(jmxQuorumBean)</div><div class="line">     —&gt; while (running)</div><div class="line">               —&gt; switch (peerState)</div><div class="line">                         —&gt; case LOOKING:</div><div class="line">                                   —&gt; if (readOnly)</div><div class="line">                                             —&gt; roZk = new ReadOnlyZooKeeperServer (logFactory, this, new ZooKeeperServer.BasicDataTreeBuilder(), this.zkDb)</div><div class="line">                                             —&gt; roZkMgr = new Thread()</div><div class="line">                                             —&gt; roZkMgr.start()</div><div class="line">                                                       —&gt; roZk.startup()</div><div class="line">                                                                 —&gt; registerJMX()</div><div class="line">                                                                 —&gt; startSessionTracker()</div><div class="line">                                                                 —&gt; setupRequestProcessors()</div><div class="line">                                                                 —&gt; state = RUNNING</div><div class="line">                                   —&gt; setBCVote</div><div class="line">                                   —&gt; setCurrentVote</div><div class="line">                         —&gt; case OBSERVING:</div><div class="line">                                   —&gt; setObserver (makeObserver (logFactory) )</div><div class="line">                                             —&gt; new ZooKeeperServer.BasicDataTreeBuilder()</div><div class="line">                                             —&gt; new ObserverZooKeeperServer(logFactory, zkDatabase)</div><div class="line">                                             —&gt; new Observer()</div><div class="line">                                   —&gt; observer.observeLeader()</div><div class="line">                                             —&gt; zk.registerJMX</div><div class="line">                                             —&gt; addr = findLeader()</div><div class="line">                                             —&gt; connectToLeader (addr)          socket连接leader</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                                       —&gt; synchronized (zk)</div><div class="line">                                                                 —&gt; zk.getZKDatabase.deserializeSnapshot(leaderIs)</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case FOLLOWING:</div><div class="line">                                   —&gt; setFollower( makeFollower(logFactory) )</div><div class="line">                                   —&gt; follower.followLeader()</div><div class="line">                                             —&gt; connectToLeader()</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case LEADING:</div><div class="line">                                   —&gt; setLeader ( makeLeader(logFactory) )</div><div class="line">                                   —&gt; leader.lead()</div><div class="line">                                             —&gt; zk.registerJMX()</div><div class="line">                                             —&gt; cnxAccepter = new LearnerAcceptor()</div><div class="line">                                             —&gt; cnxAccepter.run()</div><div class="line">                                                       —&gt; LearnerHandler.run()</div><div class="line">                                             —&gt; zk.setZxid(ZxidUtils.makeZxid(epoch))</div><div class="line">                                             —&gt; startZkServer()</div><div class="line">                                                       —&gt; zk.startup ()</div><div class="line">                                                                 —&gt; CommitProcessor.run()                     处理已完成的客户端请求</div><div class="line">                                                                 —&gt; PrepRequestProcessor.run()               处理未完成客户端请求</div><div class="line">                                                                           —&gt; while (true)</div><div class="line">                                                                                     —&gt; request = submittedRequests.take()</div><div class="line">                                                                                     —&gt; pRequest (request)</div><div class="line">                                                                                               —&gt; switch (request.type)</div><div class="line">                                                                                                         —&gt; case OpCode.create:          pRequest2Txn(处理所有的请求)</div><div class="line">                                                                                                         —&gt; case OpCode.delete:          pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setData:       pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setACL:        pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.check:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.multi:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; …...</div><div class="line">                                   —&gt; setLeader(null)</div><div class="line"></div><div class="line">QuorumPeer :</div><div class="line">    public Follower follower;          Follower extends Leader</div><div class="line">    public Leader leader;</div><div class="line">    public Observer observer;          Obsearver extends Learner</div><div class="line"></div><div class="line">class Leader &#123;</div><div class="line">    final LeaderZooKeeperServer zk;</div><div class="line">    final QuorumPeer self;</div><div class="line">    private boolean quorumFormed = false;</div><div class="line">    // the follower acceptor thread</div><div class="line">    LearnerCnxAcceptor cnxAcceptor;</div><div class="line">    // list of all the followers</div><div class="line">    private final HashSet&lt;LearnerHandler&gt; learners = new HashSet&lt;LearnerHandler&gt;();</div><div class="line">&#125;</div><div class="line">class Follower extends Learner&#123;</div><div class="line">    private long lastQueued;</div><div class="line">    // This is the same object as this.zk, but we cache the downcast op</div><div class="line">    final FollowerZooKeeperServer fzk;</div><div class="line">&#125;</div><div class="line">class Learner &#123;</div><div class="line">    QuorumPeer self;</div><div class="line">    LearnerZooKeeperServer zk;</div><div class="line">    protected BufferedOutputStream bufferedOutput;</div><div class="line">    protected Socket sock;</div><div class="line">    protected InputArchive leaderIs;</div><div class="line">    protected OutputArchive leaderOs;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br><strong>ZooKeeperMain解析源码：</strong><br>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">—&gt; main = new ZooKeeperMain</div><div class="line">             —&gt; parseOptions (-server, -timeout, -<span class="built_in">readonly</span>)</div><div class="line">             —&gt; connectToZk</div><div class="line">                         —&gt; zk = new ZooKeeper</div><div class="line">                                        —&gt; new ConnectStringParser (属性：chrootPath, serverAddress)</div><div class="line">                                        —&gt; new StaticHostProvider (属性：serverAddress)</div><div class="line">                                        —&gt; getClientCnxnSocket (返回 ClientCnxnSocket的子类ClientCnxnSocketNIO对象 (属性：selector, sockKey) )</div><div class="line">                                        —&gt; new ClientCnxn (参数：chrootPath, hostProvider, zookeeper, watchManager, clientCnxnSocket, 属性：authInfo, pendingQueue, outgoingQueue, zookeeper, clientWatchManager)</div><div class="line">                                                        —&gt;  SendThread (参数：ClientCnxnSocketNIO对象，属性：clientCnxnSocket, lastPingSentNs, isFirstConnect)</div><div class="line">                                                        —&gt;  EventThread (属性： waitingEvents, sessionState)</div><div class="line">                                        —&gt; ClientCnxn.start()</div><div class="line">—&gt; main.run()</div><div class="line">          —&gt; processCmd (cl)</div><div class="line">                    —&gt; processZKCmd (co)</div><div class="line">                              —&gt; cmd equals create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                              —&gt; zk.  create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                                        —&gt; cnxn. submitRequest (request, response)</div><div class="line">                                                  —&gt; queuePacket (request, response)</div><div class="line">                                                            —&gt; synchronized (outgoingQueue)</div><div class="line">                                                                      —&gt; outgoingQueue.add ( new Packet(request, response) )</div><div class="line">                                                            —&gt; sendThread.getClientCnxnScoket().wakeupCnxn()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>SendThred run函数：</strong><br>属性： state: socket连接状态，isFirstConnect: socket连接是否为第一次初始化连接，zookeeerSaslClient: SASL用户认证机制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">     —&gt; <span class="keyword">while</span> (state.isAlive)</div><div class="line">                    |—&gt; <span class="keyword">if</span> (! clientCnxnSocket.isConnected)</div><div class="line">                    |           —&gt;  startConnect</div><div class="line">                    |                    —&gt;  state = CONNECTING</div><div class="line">                    |                    —&gt; zookeeerSaslClient 认证</div><div class="line">                    |                    —&gt; ClientCnxnSocketNIO.connect</div><div class="line">                    |                              —&gt; SocketChannel.register(selector, OP_CONNECT)</div><div class="line">                    |                              —&gt; sock.connect(addr)</div><div class="line">                    |                              <span class="keyword">if</span> (immediateConnect)</div><div class="line">                    |                                        —&gt; sendThread.primeConnection</div><div class="line">                    |                                                  —&gt; new ConnectRequest(lastZxid)</div><div class="line">                    |                                                  —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                            <span class="keyword">if</span> (! disabledAutoWatchReset)</div><div class="line">                    |                                                                      —&gt; 将zookeeper 的属性 dataWatches, existWatchs, childWatchs 组装成 SetWatchs (递增Zxid)</div><div class="line">                    |                                                                      —&gt; new RequestHeader (Xid=-8, OpCode.setWatches)</div><div class="line">                    |                                                                      —&gt; new Packet, 将requestHeader和setWatchs 一起组装成Packet</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (packet)</div><div class="line">                    |                                                            <span class="keyword">for</span> (id : authInfo)</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (new Packet(new RequestHeader(Xid=-4, OpCode.auth), new AuthPacket(id.schema, id.data)))</div><div class="line">          |                               outgoingQueue.addFirst (new Packet(ConnectRequest))</div><div class="line">                    |                                                            clientCnxnSocket.enableReadWriteOnly()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (zookeeperSaslClient != null)</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getSaslState == ZookeeperSaslClient.SaslState.INITIAL)</div><div class="line">                    |                               —&gt; zookeeperSaslClient.initialize</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.AuthFailed)</div><div class="line">                    |                               —&gt; state = States.AUTH_FAILED</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.SaslAuthenticated)</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (sendAuthEvent == <span class="literal">true</span>)</div><div class="line">                    |                               —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, zookeeperSaslClient.getKeeperState) )</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (clientCnxnSocket.getIdleSend  &gt;  MAX_SEND_PING_INTERVAL)</div><div class="line">                    |                    —&gt; sendPing</div><div class="line">                    |                              —&gt;  queuePacket (new RequestHeader (Xid=-2, OpCode.ping) )</div><div class="line">                    |                                        —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                  —&gt; new Packet (RequestHeader)</div><div class="line">                    |                                                  —&gt; <span class="keyword">if</span> (RequestHeader != OpCode.closeSession)</div><div class="line">                    |                                                            —&gt; outgoingQueue.add(packet)</div><div class="line">                    |                                        —&gt; sendThread.getClientCnxnSocket().wakeupCnxn()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state == States.CONNECTEDREADONLY)</div><div class="line">                    |          —&gt; pingRwServer()</div><div class="line">                    |                    —&gt; new Socket</div><div class="line">                    |                    —&gt; new BufferedReader (new InputStreamReader(socket.getInputStream() ) )</div><div class="line">                    |                    —&gt; BufferedReader.readLine()</div><div class="line">                    |—&gt; clientCnxnSocket.doTransport (pendingQueue, outgoingQueue)</div><div class="line">                    |          —&gt; synchronize (clientCnxnSocket)</div><div class="line">                    |                    —&gt; selected = selector.selectedKeys()</div><div class="line">                    |          —&gt; <span class="keyword">for</span> (SelectionKey key : selected)</div><div class="line">                    |                     —&gt; <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_CONNECT) != 0)</div><div class="line">                    |                              —&gt; <span class="keyword">if</span> ((SocketChannel)key.channel().finishConnect() )</div><div class="line">                    |                                         —&gt; sendThread.primeConnection</div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> ((key.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != 0)</div><div class="line">                    |                              —&gt; doIO (pendingQueue, outgoingQueue)</div><div class="line">                    |                                        —&gt; socketChannel = socketKey.channel()</div><div class="line">                    |                                        —&gt; <span class="keyword">if</span> (socketKey.isReadable())</div><div class="line">                    |                                                  —&gt; socketChannel.read(incomingBuffer)</div><div class="line">                    |                                                            —&gt; <span class="keyword">if</span> (! initialized)</div><div class="line">                    |                                                                      —&gt; readConnectResult()</div><div class="line">                    |                                                                                —&gt; ConnectResponse response = new ConnectResponse()</div><div class="line">                    |                                                                                —&gt; response.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)) , “connect<span class="string">")</span></div><div class="line">                    |                                                                                —&gt; sendThread.onConnectd(response.getTimeout, response.getSessionId, response.getPasswd)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent(new WatchedEvent(Watcher.Event.EventType.None, eventState)  )</div><div class="line">                    |                                                                      —&gt; enableRead()</div><div class="line">                    |                                                            —&gt; else</div><div class="line">                    |                                                                      —&gt; sendThread.readResponse(incomingBuffer)</div><div class="line">                    |                                                                                —&gt; ReplyHeader replyHeader = new ReplyHeader()</div><div class="line">                    |                                                                                —&gt; replyHeader.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “header")</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -2)    pings</div><div class="line">                    |                                                                                          —&gt; debug</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -4)    AuthPacket</div><div class="line">                    |                                                                                          —&gt; <span class="keyword">if</span> (replyHeader.getErr() == KeeperException.Code.AUTHFAILED)</div><div class="line">                    |                                                                                                    —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, Watcher.Event.KeeperState.AuthFailed) )</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -1)    notification</div><div class="line">                    |                                                                                          —&gt; WatcherEvent event = new WatcherEvent()</div><div class="line">                    |                                                                                          —&gt; event.deserialize(BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “response<span class="string">")</span></div><div class="line">                    |                                                                                          —&gt; event.setPath (chrootPath)</div><div class="line">                    |                                                                                          —&gt; WatchedEvent we = new WatchedEvent(event)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent (we)</div><div class="line">                    |                                                                      —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                                —&gt; packet = pendingQueue.remove()</div><div class="line">                    |                                                                      —&gt; packet.replyHeader.setXid/setErr/setZxid</div><div class="line">                    |                                                                      —&gt; finishPacket (packet)</div><div class="line">                    |                                                                                —&gt; eventThread.queuePacket(packet)</div><div class="line">                    |                                                                                          —&gt; waitingEvents.add (packet)</div><div class="line">                    |                                        —&gt; if (socketKey.isWritable())</div><div class="line">                    |                                                  —&gt; Packet packet = findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress)</div><div class="line">                    |                                                  —&gt; packet.createBB          byteBuffer</div><div class="line">                    |                                                  —&gt; socketChannel.write(packet.bb)</div><div class="line">                    |                                                  —&gt; outgoingQueue.removeFirstOccurrence(packet)</div><div class="line">                    |                                                  —&gt; if (packet.hasRemaining)</div><div class="line">                    |                                                            —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                      —&gt; pendingQueue.add(packet)</div><div class="line">                    |          —&gt; if (sendThread.getZkState().isConnected)</div><div class="line">                    |                    —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                              —&gt; if (findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != null )</div><div class="line">                    |                                        —&gt; enableWrite()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>EventThred run函数：</strong><br>属性： waitingEvents<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">      —&gt; isRunning = <span class="literal">true</span></div><div class="line">      —&gt; <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">               —&gt; event = waitingEvents.take()</div><div class="line">                         —&gt; <span class="keyword">if</span> (event == eventOfDeath)</div><div class="line">                                   —&gt; wasKilled = <span class="literal">true</span></div><div class="line">                         —&gt; <span class="keyword">else</span></div><div class="line">                                   —&gt; processEvent(event)</div><div class="line">                                        —&gt; <span class="keyword">if</span> (event instanceof WatcherSetEventPair)</div><div class="line">                                                       —&gt; <span class="keyword">for</span> (Watcher watcher : ((WatcherSetEventPair)event).watchers )</div><div class="line">                                                                 —&gt; watcher.process( ((WatcherSetEventPair)event).event )</div><div class="line">                                             —&gt; <span class="keyword">else</span></div><div class="line">                                                       —&gt; Packet p = (Packet) event</div><div class="line">                                                       —&gt; <span class="keyword">if</span> (p.response instanceof ExistsResponse || p.response instanceof SetDataResponse || p.response instanceof SetACLResponse)</div><div class="line">                                                                 —&gt; StatCallback cb = (StatCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult ( clientPath, ((ExistsResponse/SetDataResponse/SetACLResponse) p.response).getStat )</div><div class="line">                                                                           —&gt; decOutstanding ()</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetDataResponse)</div><div class="line">                                                                 —&gt; DataCallback cb = (DataCallback) p.cb</div><div class="line">                                                                 —&gt; GetDataResponse response = (GetDataResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getData(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetACLResponse)</div><div class="line">                                                                 —&gt; ACLCallback cb = (ACLCallback) p.cb</div><div class="line">                                                                 —&gt; GetACLResponse response = (GetACLResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getAcl(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildrenResponse)</div><div class="line">                                                                 —&gt; ChildrenCallback cb = (ChildrenCallback) p.cb</div><div class="line">                                                                 —&gt; GetChildrenResponse response = (GetChildrenResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildren2Response)</div><div class="line">                                                                 —&gt; Children2Callback cb = (Children2Callback) p.cb</div><div class="line">                                                                 —&gt; GetChildren2Response response = (GetChildren2Response) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof CreateResponse)</div><div class="line">                                                                 —&gt; StringCallback cb = (StringCallback) p.cb</div><div class="line">                                                                 —&gt; CreateResponse response = (CreateResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getPath())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof MultiResponse)</div><div class="line">                                                                 —&gt; MultiCallback cb = (MultiCallback) p.cb</div><div class="line">                                                                 —&gt; MultiResponse response = (MultiResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getResultList())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb instanceof VoidCallback)</div><div class="line">                                                                 —&gt; VoidCallback cb = (VoidCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult (clientPath)</div></pre></td></tr></table></figure></p>
<p><strong>ClinetCnxn是核心函数：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ClientCnxn</span><span class="params">(String chrootPath, HostProvider hostProvider, intsessionTimeout, ZooKeeper zooKeeper,</span></span></div><div class="line">            ClientWatchManager watcher, ClientCnxnSocket clientCnxnSocket,</div><div class="line">            <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly) &#123;</div><div class="line">        <span class="keyword">this</span>.zooKeeper = zooKeeper;</div><div class="line">        <span class="keyword">this</span>.watcher = watcher;</div><div class="line">        <span class="keyword">this</span>.hostProvider = hostProvider;</div><div class="line">        <span class="keyword">this</span>.chrootPath = chrootPath;</div><div class="line"></div><div class="line">        sendThread = <span class="keyword">new</span> SendThread(clientCnxnSocket);</div><div class="line">        eventThread = <span class="keyword">new</span> EventThread();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">enum</span> States &#123;</div><div class="line">        CONNECTING, ASSOCIATING, CONNECTED, CONNECTEDREADONLY,</div><div class="line">        CLOSED, AUTH_FAILED, NOT_CONNECTED;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAlive</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> != CLOSED &amp;&amp; <span class="keyword">this</span> != AUTH_FAILED;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> == CONNECTED || <span class="keyword">this</span> == CONNECTEDREADONLY;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        Packet(RequestHeader requestHeader, ReplyHeader replyHeader,</div><div class="line">               Record request, Record response,</div><div class="line">               WatchRegistration watchRegistration, <span class="keyword">boolean</span> readOnly) &#123;</div><div class="line">            <span class="keyword">this</span>.requestHeader = requestHeader;</div><div class="line">            <span class="keyword">this</span>.replyHeader = replyHeader;</div><div class="line">            <span class="keyword">this</span>.request = request;</div><div class="line">            <span class="keyword">this</span>.response = response;</div><div class="line">            <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">            <span class="keyword">this</span>.watchRegistration = watchRegistration;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataTree</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">/* Rather than fight it, let root have an alias */</span></div><div class="line">        nodes.put(<span class="string">""</span>, root);</div><div class="line">        nodes.put(rootZookeeper, root);</div><div class="line"></div><div class="line">        <span class="comment">/** add the proc node and quota node */</span></div><div class="line">        root.addChild(procChildZookeeper);</div><div class="line">        nodes.put(procZookeeper, procDataNode);</div><div class="line"></div><div class="line">        procDataNode.addChild(quotaChildZookeeper);</div><div class="line">        nodes.put(quotaZookeeper, quotaDataNode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></div><div class="line">        <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</div><div class="line">    &#123;</div><div class="line">        request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</div><div class="line">                                    zks.getTime(), type);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (type) &#123;</div><div class="line">            <span class="keyword">case</span> OpCode.create:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CreateRequest createRequest = (CreateRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);</div><div class="line">                String path = createRequest.getPath();</div><div class="line">                <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span> || failCreate) &#123;</div><div class="line">                    LOG.info(<span class="string">"Invalid path "</span> + path + <span class="string">" with session 0x"</span> +</div><div class="line">                            Long.toHexString(request.sessionId));</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                String parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                ChangeRecord parentRecord = getRecordForPath(parentPath);</div><div class="line"></div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> parentCVersion = parentRecord.stat.getCversion();</div><div class="line">                CreateMode createMode =</div><div class="line">                    CreateMode.fromFlag(createRequest.getFlags());</div><div class="line">                <span class="keyword">if</span> (createMode.isSequential()) &#123;</div><div class="line">                    path = path + String.format(Locale.ENGLISH, <span class="string">"%010d"</span>, parentCVersion);</div><div class="line">                &#125;</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (getRecordForPath(path) != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NodeExistsException(path);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</div><div class="line">                    <span class="comment">// ignore this one</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">boolean</span> ephemeralParent = parentRecord.stat.getEphemeralOwner() != <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (ephemeralParent) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoChildrenForEphemeralsException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> newCversion = parentRecord.stat.getCversion()+<span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CreateTxn(path, createRequest.getData(),</div><div class="line">                        listACL,</div><div class="line">                        createMode.isEphemeral(), newCversion);</div><div class="line">                StatPersisted s = <span class="keyword">new</span> StatPersisted();</div><div class="line">                <span class="keyword">if</span> (createMode.isEphemeral()) &#123;</div><div class="line">                    s.setEphemeralOwner(request.sessionId);</div><div class="line">                &#125;</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount++;</div><div class="line">                parentRecord.stat.setCversion(newCversion);</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path, s,</div><div class="line">                        <span class="number">0</span>, listACL));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.delete:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                DeleteRequest deleteRequest = (DeleteRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, deleteRequest);</div><div class="line">                path = deleteRequest.getPath();</div><div class="line">                lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span></div><div class="line">                        || zks.getZKDatabase().isSpecialPath(path)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                parentRecord = getRecordForPath(parentPath);</div><div class="line">                ChangeRecord nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.DELETE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> version = deleteRequest.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; nodeRecord.stat.getVersion() != version) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (nodeRecord.childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NotEmptyException(path);</div><div class="line">                &#125;</div><div class="line">                request.txn = <span class="keyword">new</span> DeleteTxn(path);</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount--;</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path,</div><div class="line">                        <span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setData:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetDataRequest setDataRequest = (SetDataRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setDataRequest);</div><div class="line">                path = setDataRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.WRITE,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setDataRequest.getVersion();</div><div class="line">                <span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetDataTxn(path, setDataRequest.getData(), version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setVersion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setACL:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetACLRequest setAclRequest = (SetACLRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setAclRequest);</div><div class="line">                path = setAclRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                listACL = removeDuplicates(setAclRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.ADMIN,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setAclRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getAversion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetACLTxn(path, listACL, version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setAversion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.createSession:</div><div class="line">                request.request.rewind();</div><div class="line">                <span class="keyword">int</span> to = request.request.getInt();</div><div class="line">                request.txn = <span class="keyword">new</span> CreateSessionTxn(to);</div><div class="line">                request.request.rewind();</div><div class="line">                zks.sessionTracker.addSession(request.sessionId, to);</div><div class="line">                zks.setOwner(request.sessionId, request.getOwner());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.closeSession:</div><div class="line">                <span class="comment">// We don't want to do this check since the session expiration thread</span></div><div class="line">                <span class="comment">// queues up this operation without being the session owner.</span></div><div class="line">                <span class="comment">// this request is the last of the session so it should be ok</span></div><div class="line">                <span class="comment">//zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span></div><div class="line">                HashSet&lt;String&gt; es = zks.getZKDatabase()</div><div class="line">                        .getEphemerals(request.sessionId);</div><div class="line">                <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123;</div><div class="line">                    <span class="keyword">for</span> (ChangeRecord c : zks.outstandingChanges) &#123;</div><div class="line">                        <span class="keyword">if</span> (c.stat == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Doing a delete</span></div><div class="line">                            es.remove(c.path);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.stat.getEphemeralOwner() == request.sessionId) &#123;</div><div class="line">                            es.add(c.path);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">for</span> (String path2Delete : es) &#123;</div><div class="line">                        addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(),</div><div class="line">                                path2Delete, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    zks.sessionTracker.setSessionClosing(request.sessionId);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                LOG.info(<span class="string">"Processed session termination for sessionid: 0x"</span></div><div class="line">                        + Long.toHexString(request.sessionId));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.check:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CheckVersionRequest checkVersionRequest = (CheckVersionRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, checkVersionRequest);</div><div class="line">                path = checkVersionRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.READ,</div><div class="line">                        request.authInfo);</div><div class="line">                version = checkVersionRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CheckVersionTxn(path, version);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">        <span class="keyword">switch</span> (qp.getType()) &#123;</div><div class="line">        <span class="keyword">case</span> Leader.PING:</div><div class="line">            ping(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.PROPOSAL:</div><div class="line">            LOG.warn(<span class="string">"Ignoring proposal"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.COMMIT:</div><div class="line">            LOG.warn(<span class="string">"Ignoring commit"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.UPTODATE:</div><div class="line">            LOG.error(<span class="string">"Received an UPTODATE message after Observer started"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.REVALIDATE:</div><div class="line">            revalidate(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.SYNC:</div><div class="line">            ((ObserverZooKeeperServer)zk).sync();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.INFORM:</div><div class="line">            TxnHeader hdr = <span class="keyword">new</span> TxnHeader();</div><div class="line">            Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);</div><div class="line">            Request request = <span class="keyword">new</span> Request (<span class="keyword">null</span>, hdr.getClientId(),</div><div class="line">                                           hdr.getCxid(),</div><div class="line">                                           hdr.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">            request.txn = txn;</div><div class="line">            request.hdr = hdr;</div><div class="line">            ObserverZooKeeperServer obs = (ObserverZooKeeperServer)zk;</div><div class="line">            obs.commitRequest(request);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">switch</span> (packetType) &#123;</div><div class="line">        <span class="keyword">case</span> DIFF:</div><div class="line">            <span class="keyword">return</span> <span class="string">"DIFF"</span>;</div><div class="line">        <span class="keyword">case</span> TRUNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"TRUNC"</span>;</div><div class="line">        <span class="keyword">case</span> SNAP:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SNAP"</span>;</div><div class="line">        <span class="keyword">case</span> OBSERVERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"OBSERVERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> NEWLEADER:</div><div class="line">            <span class="keyword">return</span> <span class="string">"NEWLEADER"</span>;</div><div class="line">        <span class="keyword">case</span> FOLLOWERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"FOLLOWERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> UPTODATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UPTODATE"</span>;</div><div class="line">        <span class="keyword">case</span> LEADERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"LEADERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> ACKEPOCH:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACKEPOCH"</span>;</div><div class="line">        <span class="keyword">case</span> REQUEST:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REQUEST"</span>;</div><div class="line">        <span class="keyword">case</span> PROPOSAL:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PROPOSAL"</span>;</div><div class="line">        <span class="keyword">case</span> ACK:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACK"</span>;</div><div class="line">        <span class="keyword">case</span> COMMIT:</div><div class="line">            <span class="keyword">return</span> <span class="string">"COMMIT"</span>;</div><div class="line">        <span class="keyword">case</span> PING:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PING"</span>;</div><div class="line">        <span class="keyword">case</span> REVALIDATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REVALIDATE"</span>;</div><div class="line">        <span class="keyword">case</span> SYNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SYNC"</span>;</div><div class="line">        <span class="keyword">case</span> INFORM:</div><div class="line">            <span class="keyword">return</span> <span class="string">"INFORM"</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UNKNOWN"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper源码/" class="archive-article-date">
  	<time datetime="2016-11-10T05:15:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ZooKeeper简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ZooKeeper简介/">ZooKeeper简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ZooKeeper导图"><a href="#ZooKeeper导图" class="headerlink" title="ZooKeeper导图"></a>ZooKeeper导图</h2><p><strong>ZooKeeper 服务:</strong><br><img src="/images/ZooKeeper_1.png" alt=""></p>
<p><strong>ZooKeeper 名字空间:</strong><br><img src="/images/ZooKeeper_2.png" alt=""></p>
<h2 id="推荐一本书"><a href="#推荐一本书" class="headerlink" title="推荐一本书"></a>推荐一本书</h2><p>《ZooKeeper分布式过程协同技术详解》</p>
<h2 id="基于-Paxos-算法"><a href="#基于-Paxos-算法" class="headerlink" title="基于 Paxos 算法"></a>基于 Paxos 算法</h2><p>wiki: <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science" target="_blank" rel="external">https://en.wikipedia.org/wiki/Paxos_(computer_science</a>)</p>
<h2 id="ZooKeeper-支持的api"><a href="#ZooKeeper-支持的api" class="headerlink" title="ZooKeeper 支持的api"></a>ZooKeeper 支持的api</h2><p><strong>ZooKeeper API:</strong><br>1.create /path data<br>2.delete /path<br>3.exists /path<br>4.setData /path data<br>5.getData /path<br>6.getChildren /path</p>
<h2 id="单点ZooKeeper-与-ZooKeeper集群"><a href="#单点ZooKeeper-与-ZooKeeper集群" class="headerlink" title="单点ZooKeeper 与 ZooKeeper集群"></a>单点ZooKeeper 与 ZooKeeper集群</h2><p><strong>ZooKeeper服务器的两种工作模式： 独立模式(standalone)和仲裁模式(quorum)</strong><br><strong>独立模式(standalone)</strong>: 单独的ZooKeeper服务器。<br><strong>仲裁模式(quorum)</strong>: ZooKeeper集合(ZooKeeper ensemble)。 仲裁模式中，为减少ZooKeeper Server数据同步的延迟，法定人数 的概念被使用，法定人数的大小设置非常重要。</p>
<p><strong>仲裁模式试验：</strong><br><strong>configure 文件：</strong><br><em>z1.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z1/data</div><div class="line">clientPort=2181</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>z2.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z2/data</div><div class="line">clientPort=2182</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>z3.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z3/data</div><div class="line">clientPort=2183</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>启动3个节点命令：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z1/z1.cfg</div><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z2/z2.cfg</div><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z3/z3.cfg</div></pre></td></tr></table></figure></p>
<p><em>连接集群：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</div></pre></td></tr></table></figure></p>
<p>创建 <strong>ephemeral</strong> 节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create -e /master &quot;master.example.com&quot;</div></pre></td></tr></table></figure></p>
<p>创建 <strong>sequential</strong> 节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create -s /master/task-  “cmd&quot;</div></pre></td></tr></table></figure></p>
<p><strong>WatchedEvent</strong> 数据结构包含以下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ZooKeeper会话状态(KeeperState)：Disconnected, SyncConnected, AuthFailed, ConnectedReadOnly, SaslAuthenticated, Expired.</div><div class="line">事件类型(EventType)：NodeCreated, NodeDeleted, NodeDataChanged, NodeChildrenChanged, None.</div><div class="line">如果事件类型不是None时，返回一个znode路径.</div><div class="line">Watch监视点设置：</div><div class="line">NodeCreated：通过exists调用设置监视点。</div><div class="line">NodeDeleted：通过exists或getData调用设置监视点。</div><div class="line">NodeDataChanged：通过exists或getData调用设置监视点。</div><div class="line">NodeChildrenChanged：通过getChildren调用设置监视点。</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper简介/" class="archive-article-date">
  	<time datetime="2016-11-09T03:08:50.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark Streaming SQL MLlib GraphX" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark Streaming SQL MLlib GraphX/">Spark Streaming/SQL/MLlib/GraphX</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spark-Streaming-SQL-MLlib-GraphX"><a href="#Spark-Streaming-SQL-MLlib-GraphX" class="headerlink" title="Spark Streaming/SQL/MLlib/GraphX"></a>Spark Streaming/SQL/MLlib/GraphX</h2><p>Spark 这一大数据分析框架，包含了：</p>
<ul>
<li>流计算： Streaming</li>
<li>图计算： GraphX</li>
<li>数据挖掘： MLlib</li>
<li>SQL</li>
</ul>
<h2 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h2><p>参考： <a href="http://spark.apache.org/docs/latest/streaming-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/streaming-programming-guide.html</a></p>
<p><img src="/images/Spark_Streaming_1.png" alt=""></p>
<p><img src="/images/Spark_Streaming_2.png" alt=""></p>
<p><img src="/images/Spark_Streaming_3.png" alt=""></p>
<p><img src="/images/Spark_Streaming_4.png" alt=""></p>
<h3 id="Spark-Streaming-Example"><a href="#Spark-Streaming-Example" class="headerlink" title="Spark Streaming Example"></a>Spark Streaming Example</h3><p><strong>StreamingContext:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark._</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming._</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming.<span class="type">StreamingContext</span>._ <span class="comment">// not necessary since Spark 1.3</span></div><div class="line"><span class="comment">// Create a local StreamingContext with two working thread and batch interval of 1 second.</span></div><div class="line"><span class="comment">// The master requires 2 cores to prevent from a starvation scenario.</span></div><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local[2]"</span>).setAppName(<span class="string">"NetworkWordCount"</span>)</div><div class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p><strong>socket:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create a DStream that will connect to hostname:port, like localhost:9999</span></div><div class="line"><span class="keyword">val</span> lines = ssc.socketTextStream(<span class="string">"localhost"</span>, <span class="number">9999</span>)</div><div class="line"><span class="comment">// Split each line into words</span></div><div class="line"><span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming.<span class="type">StreamingContext</span>._ <span class="comment">// not necessary since Spark 1.3</span></div><div class="line"><span class="comment">// Count each word in each batch</span></div><div class="line"><span class="keyword">val</span> pairs = words.map(word =&gt; (word, <span class="number">1</span>))</div><div class="line"><span class="keyword">val</span> wordCounts = pairs.reduceByKey(_ + _)</div><div class="line"><span class="comment">// Print the first ten elements of each RDD generated in this DStream to the console</span></div><div class="line">wordCounts.print()</div><div class="line">ssc.start()             <span class="comment">// Start the computation</span></div><div class="line">ssc.awaitTermination()  <span class="comment">// Wait for the computation to terminate</span></div></pre></td></tr></table></figure></p>
<p><strong>往9999端口里面输入：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ nc -lk 9999</div><div class="line">$ ./bin/run-example streaming.NetworkWordCount localhost 9999</div></pre></td></tr></table></figure></p>
<h2 id="Spark-GraphX"><a href="#Spark-GraphX" class="headerlink" title="Spark GraphX"></a>Spark GraphX</h2><p>参考： <a href="http://spark.apache.org/docs/latest/graphx-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/graphx-programming-guide.html</a></p>
<p><img src="/images/Spark_GraphX_1.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark._</div><div class="line"><span class="keyword">import</span> org.apache.spark.graphx._</div><div class="line"><span class="comment">// To make some of the examples work we will also need RDD</span></div><div class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VertexProperty</span>(<span class="params"></span>)</span></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProperty</span>(<span class="params">val name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">VertexProperty</span></span></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductProperty</span>(<span class="params">val name: <span class="type">String</span>, val price: <span class="type">Double</span></span>) <span class="keyword">extends</span> <span class="title">VertexProperty</span></span></div><div class="line"><span class="comment">// The graph might then have the type:</span></div><div class="line"><span class="keyword">var</span> graph: <span class="type">Graph</span>[<span class="type">VertexProperty</span>, <span class="type">String</span>] = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Graph</span>[<span class="type">VD</span>, <span class="type">ED</span>] </span>&#123;</div><div class="line">  <span class="keyword">val</span> vertices: <span class="type">VertexRDD</span>[<span class="type">VD</span>]</div><div class="line">  <span class="keyword">val</span> edges: <span class="type">EdgeRDD</span>[<span class="type">ED</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/Spark_GraphX_2.png" alt=""></p>
<p><strong>构建graph的代码：</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> userGraph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>]</div><div class="line"></div><div class="line"><span class="comment">// Assume the SparkContext has already been constructed</span></div><div class="line"><span class="keyword">val</span> sc: <span class="type">SparkContext</span></div><div class="line"><span class="comment">// Create an RDD for the vertices</span></div><div class="line"><span class="keyword">val</span> users: <span class="type">RDD</span>[(<span class="type">VertexId</span>, (<span class="type">String</span>, <span class="type">String</span>))] =</div><div class="line">  sc.parallelize(<span class="type">Array</span>((<span class="number">3</span>L, (<span class="string">"rxin"</span>, <span class="string">"student"</span>)), (<span class="number">7</span>L, (<span class="string">"jgonzal"</span>, <span class="string">"postdoc"</span>)),</div><div class="line">                       (<span class="number">5</span>L, (<span class="string">"franklin"</span>, <span class="string">"prof"</span>)), (<span class="number">2</span>L, (<span class="string">"istoica"</span>, <span class="string">"prof"</span>))))</div><div class="line"><span class="comment">// Create an RDD for edges</span></div><div class="line"><span class="keyword">val</span> relationships: <span class="type">RDD</span>[<span class="type">Edge</span>[<span class="type">String</span>]] =</div><div class="line">  sc.parallelize(<span class="type">Array</span>(<span class="type">Edge</span>(<span class="number">3</span>L, <span class="number">7</span>L, <span class="string">"collab"</span>),    <span class="type">Edge</span>(<span class="number">5</span>L, <span class="number">3</span>L, <span class="string">"advisor"</span>),</div><div class="line">                       <span class="type">Edge</span>(<span class="number">2</span>L, <span class="number">5</span>L, <span class="string">"colleague"</span>), <span class="type">Edge</span>(<span class="number">5</span>L, <span class="number">7</span>L, <span class="string">"pi"</span>)))</div><div class="line"><span class="comment">// Define a default user in case there are relationship with missing user</span></div><div class="line"><span class="keyword">val</span> defaultUser = (<span class="string">"John Doe"</span>, <span class="string">"Missing"</span>)</div><div class="line"><span class="comment">// Build the initial Graph</span></div><div class="line"><span class="keyword">val</span> graph = <span class="type">Graph</span>(users, relationships, defaultUser)</div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>] <span class="comment">// Constructed from above</span></div><div class="line"><span class="comment">// Count all users which are postdocs</span></div><div class="line">graph.vertices.filter &#123; <span class="keyword">case</span> (id, (name, pos)) =&gt; pos == <span class="string">"postdoc"</span> &#125;.count</div><div class="line"><span class="comment">// Count all the edges where src &gt; dst</span></div><div class="line">graph.edges.filter(e =&gt; e.srcId &gt; e.dstId).count</div><div class="line">graph.edges.filter &#123; <span class="keyword">case</span> <span class="type">Edge</span>(src, dst, prop) =&gt; src &gt; dst &#125;.count</div><div class="line"></div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>] <span class="comment">// Constructed from above</span></div><div class="line"><span class="comment">// Use the triplets view to create an RDD of facts.</span></div><div class="line"><span class="keyword">val</span> facts: <span class="type">RDD</span>[<span class="type">String</span>] =</div><div class="line">  graph.triplets.map(triplet =&gt;</div><div class="line">    triplet.srcAttr._1 + <span class="string">" is the "</span> + triplet.attr + <span class="string">" of "</span> + triplet.dstAttr._1)</div><div class="line">facts.collect.foreach(println(_))</div></pre></td></tr></table></figure></p>
<p><strong>Graph  Operators:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>]</div><div class="line"><span class="comment">// Use the implicit GraphOps.inDegrees operator</span></div><div class="line"><span class="keyword">val</span> inDegrees: <span class="type">VertexRDD</span>[<span class="type">Int</span>] = graph.inDegrees</div></pre></td></tr></table></figure></p>
<p><strong>Shortest Path:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark.graphx.&#123;<span class="type">Graph</span>, <span class="type">VertexId</span>&#125;</div><div class="line"><span class="keyword">import</span> org.apache.spark.graphx.util.<span class="type">GraphGenerators</span></div><div class="line"></div><div class="line"><span class="comment">// A graph with edge attributes containing distances</span></div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[<span class="type">Long</span>, <span class="type">Double</span>] =</div><div class="line">  <span class="type">GraphGenerators</span>.logNormalGraph(sc, numVertices = <span class="number">100</span>).mapEdges(e =&gt; e.attr.toDouble)</div><div class="line"><span class="keyword">val</span> sourceId: <span class="type">VertexId</span> = <span class="number">42</span> <span class="comment">// The ultimate source</span></div><div class="line"><span class="comment">// Initialize the graph such that all vertices except the root have distance infinity.</span></div><div class="line"><span class="keyword">val</span> initialGraph = graph.mapVertices((id, _) =&gt;</div><div class="line">    <span class="keyword">if</span> (id == sourceId) <span class="number">0.0</span> <span class="keyword">else</span> <span class="type">Double</span>.<span class="type">PositiveInfinity</span>)</div><div class="line"><span class="keyword">val</span> sssp = initialGraph.pregel(<span class="type">Double</span>.<span class="type">PositiveInfinity</span>)(</div><div class="line">  (id, dist, newDist) =&gt; math.min(dist, newDist), <span class="comment">// Vertex Program</span></div><div class="line">  triplet =&gt; &#123;  <span class="comment">// Send Message</span></div><div class="line">    <span class="keyword">if</span> (triplet.srcAttr + triplet.attr &lt; triplet.dstAttr) &#123;</div><div class="line">      <span class="type">Iterator</span>((triplet.dstId, triplet.srcAttr + triplet.attr))</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="type">Iterator</span>.empty</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  (a, b) =&gt; math.min(a, b) <span class="comment">// Merge Message</span></div><div class="line">)</div><div class="line">println(sssp.vertices.collect.mkString(<span class="string">"\n"</span>))</div></pre></td></tr></table></figure></p>
<h2 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h2><p>参考： <a href="http://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/sql-programming-guide.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">val jdbcDF = spark.read</div><div class="line">  .format(&quot;jdbc&quot;)</div><div class="line">  .option(&quot;url&quot;, &quot;jdbc:postgresql:dbserver&quot;)</div><div class="line">  .option(&quot;dbtable&quot;, &quot;schema.tablename&quot;)</div><div class="line">  .option(&quot;user&quot;, &quot;username&quot;)</div><div class="line">  .option(&quot;password&quot;, &quot;password&quot;)</div><div class="line">  .load()</div></pre></td></tr></table></figure>
<p><strong>Running the Thrift JDBC/ODBC server:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">./sbin/start-thriftserver.sh</div><div class="line">export HIVE_SERVER2_THRIFT_PORT=&lt;listening-port&gt;</div><div class="line">export HIVE_SERVER2_THRIFT_BIND_HOST=&lt;listening-host&gt;</div><div class="line">./sbin/start-thriftserver.sh \</div><div class="line">  --master &lt;master-uri&gt; \</div><div class="line">  ...</div></pre></td></tr></table></figure></p>
<p><strong>Running the Spark SQL CLI:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-sql</div></pre></td></tr></table></figure></p>
<h2 id="Spark-MLlib"><a href="#Spark-MLlib" class="headerlink" title="Spark MLlib"></a>Spark MLlib</h2><p>参考： <a href="http://spark.apache.org/docs/latest/ml-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/ml-guide.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark Streaming SQL MLlib GraphX/" class="archive-article-date">
  	<time datetime="2016-11-09T02:44:54.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark Quick Start" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark Quick Start/">Spark Quick Start examples</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spark-Quick-Start"><a href="#Spark-Quick-Start" class="headerlink" title="Spark Quick Start"></a>Spark Quick Start</h3><p><strong>Scala:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">./bin/spark-shell</div><div class="line">scala&gt; <span class="keyword">val</span> textFile = sc.textFile(<span class="string">"README.md"</span>)</div><div class="line">scala&gt; textFile.count()</div><div class="line">scala&gt; textFile.first()</div><div class="line">scala&gt; <span class="keyword">val</span> linesWithSpark = textFile.filter(line =&gt; line.contains(<span class="string">"Spark"</span>))</div><div class="line">scala&gt; textFile.filter(line =&gt; line.contains(<span class="string">"Spark"</span>)).count()</div></pre></td></tr></table></figure></p>
<p>more on RDD operations:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">scala&gt; textFile.map(line =&gt; line.split(<span class="string">" "</span>).size).reduce((a, b) =&gt; <span class="keyword">if</span> (a &gt; b) a <span class="keyword">else</span> b)</div><div class="line">scala&gt; <span class="keyword">import</span> java.lang.<span class="type">Math</span></div><div class="line">scala&gt; textFile.map(line =&gt; line.split(<span class="string">" "</span>).size).reduce((a, b) =&gt; <span class="type">Math</span>.max(a, b))</div><div class="line">scala&gt; <span class="keyword">val</span> wordCounts = textFile.flatMap(line =&gt; line.split(<span class="string">" "</span>)).map(word =&gt; (word, <span class="number">1</span>)).reduceByKey((a, b) =&gt; a + b)</div><div class="line">scala&gt; wordCounts.collect()</div></pre></td></tr></table></figure></p>
<p>Self-Contained  Applications:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></div><div class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span>._</div><div class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">SimpleApp</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">    <span class="keyword">val</span> logFile = <span class="string">"YOUR_SPARK_HOME/README.md"</span> <span class="comment">// Should be some file on your system</span></div><div class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"Simple Application"</span>)</div><div class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line">    <span class="keyword">val</span> logData = sc.textFile(logFile, <span class="number">2</span>).cache()</div><div class="line">    <span class="keyword">val</span> numAs = logData.filter(line =&gt; line.contains(<span class="string">"a"</span>)).count()</div><div class="line">    <span class="keyword">val</span> numBs = logData.filter(line =&gt; line.contains(<span class="string">"b"</span>)).count()</div><div class="line">    println(<span class="string">"Lines with a: %s, Lines with b: %s"</span>.format(numAs, numBs))</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SparkConf:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">name := &quot;Simple Project&quot;</div><div class="line">version := &quot;1.0&quot;</div><div class="line">scalaVersion := &quot;2.11.7&quot;</div><div class="line">libraryDependencies += &quot;org.apache.spark&quot; %% &quot;spark-core&quot; % &quot;2.0.1&quot;</div></pre></td></tr></table></figure></p>
<p><strong>Python:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">./bin/pyspark</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile = sc.textFile(<span class="string">"README.md"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile.count()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile.first()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>linesWithSpark = textFile.filter(<span class="keyword">lambda</span> line: <span class="string">"Spark"</span> <span class="keyword">in</span> line)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile.filter(<span class="keyword">lambda</span> line: <span class="string">"Spark"</span> <span class="keyword">in</span> line).count()</div></pre></td></tr></table></figure></p>
<p>more on RDD operations:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile.map(<span class="keyword">lambda</span> line: len(line.split())).reduce(<span class="keyword">lambda</span> a, b: a <span class="keyword">if</span> (a &gt; b) <span class="keyword">else</span> b)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(a, b)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> a &gt; b:</div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> a</div><div class="line"><span class="meta">... </span>    <span class="keyword">else</span>:</div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> b</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>textFile.map(<span class="keyword">lambda</span> line: len(line.split())).reduce(max)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>wordCounts = textFile.flatMap(<span class="keyword">lambda</span> line: line.split()).map(<span class="keyword">lambda</span> word: (word, <span class="number">1</span>)).reduceByKey(<span class="keyword">lambda</span> a, b: a+b)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>wordCounts.collect()</div></pre></td></tr></table></figure></p>
<p>Self-Contained  Applications:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkContext</div><div class="line"></div><div class="line">logFile = <span class="string">"YOUR_SPARK_HOME/README.md"</span>  <span class="comment"># Should be some file on your system</span></div><div class="line">sc = SparkContext(<span class="string">"local"</span>, <span class="string">"Simple App"</span>)</div><div class="line">logData = sc.textFile(logFile).cache()</div><div class="line">numAs = logData.filter(<span class="keyword">lambda</span> s: <span class="string">'a'</span> <span class="keyword">in</span> s).count()</div><div class="line">numBs = logData.filter(<span class="keyword">lambda</span> s: <span class="string">'b'</span> <span class="keyword">in</span> s).count()</div><div class="line">print(<span class="string">"Lines with a: %i, lines with b: %i"</span> % (numAs, numBs))</div><div class="line"></div><div class="line">$ YOUR_SPARK_HOME/bin/spark-submit \</div><div class="line">  --master local[<span class="number">4</span>] \</div><div class="line">  SimpleApp.py</div></pre></td></tr></table></figure></p>
<h2 id="Spark-Programming-Guide"><a href="#Spark-Programming-Guide" class="headerlink" title="Spark Programming Guide"></a>Spark Programming Guide</h2><p>参考： <a href="http://spark.apache.org/docs/latest/programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/programming-guide.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark Quick Start/" class="archive-article-date">
  	<time datetime="2016-11-09T02:32:10.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark Cluster三种模式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark Cluster三种模式/">Spark Cluster 三种模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spark-Cluster-三种模式"><a href="#Spark-Cluster-三种模式" class="headerlink" title="Spark Cluster 三种模式"></a>Spark Cluster 三种模式</h2><ul>
<li><strong>Standalone</strong> – a simple cluster manager included with Spark that makes it easy to set up a cluster.</li>
<li><strong>Apache Mesos</strong> – a general cluster manager that can also run Hadoop MapReduce and service applications.</li>
<li><strong>Hadoop YARN</strong> – the resource manager in Hadoop 2.</li>
</ul>
<h3 id="Standalone-模式："><a href="#Standalone-模式：" class="headerlink" title="Standalone 模式："></a>Standalone 模式：</h3><p>start Master:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./sbin/start-master.sh</div></pre></td></tr></table></figure></p>
<p>start Slave:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./sbin/start-slave.sh &lt;master-spark-URL&gt;</div></pre></td></tr></table></figure></p>
<ul>
<li>sbin/start-master.sh - Starts a master instance on the machine the script is executed on.</li>
<li>sbin/start-slaves.sh - Starts a slave instance on each machine specified in the conf/slaves file.</li>
<li>sbin/start-slave.sh - Starts a slave instance on the machine the script is executed on.</li>
<li>sbin/start-all.sh - Starts both a master and a number of slaves as described above.</li>
<li>sbin/stop-master.sh - Stops the master that was started via the bin/start-master.sh script.</li>
<li>sbin/stop-slaves.sh - Stops all slave instances on the machines specified in the conf/slaves file.</li>
<li>sbin/stop-all.sh - Stops both the master and the slaves as described above.</li>
</ul>
<p>Connecting an Application to the Cluster:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-shell --master spark://IP:PORT</div></pre></td></tr></table></figure></p>
<p>Launching Spark Applications:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-class org.apache.spark.deploy.Client <span class="built_in">kill</span> &lt;master url&gt; &lt;driver ID&gt;</div></pre></td></tr></table></figure></p>
<p>Resource Scheduling:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</div><div class="line">             .setMaster(...)</div><div class="line">             .setAppName(...)</div><div class="line">             .set(<span class="string">"spark.cores.max"</span>, <span class="string">"10"</span>)</div><div class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div></pre></td></tr></table></figure></p>
<h3 id="Running-Spark-on-Mesos-模式："><a href="#Running-Spark-on-Mesos-模式：" class="headerlink" title="Running Spark on Mesos 模式："></a>Running Spark on Mesos 模式：</h3><p>参考： <a href="http://spark.apache.org/docs/latest/running-on-mesos.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/running-on-mesos.html</a></p>
<p><strong>Installing Mesos:</strong></p>
<ul>
<li>Spark 2.0.1 is designed for use with Mesos 0.21.0. <a href="http://mesos.apache.org/gettingstarted/" target="_blank" rel="external">http://mesos.apache.org/gettingstarted/</a><br><strong>Connecting  Spark  to  Mesos:</strong></li>
<li>To use Mesos from Spark, you need a Spark binary package available in a place accessible by Mesos, and a Spark driver program configured to connect to Mesos.<br><strong>Uploading  Spark Package:</strong></li>
<li>Download a Spark binary package from the Spark download page</li>
<li>Upload to hdfs/http/s3<br><strong>To host on HDFS, use the Hadoop fs put command:</strong><br><code>hadoop fs -put spark-2.0.1.tar.gz /path/to/spark-2.0.1.tar.gz</code><br><strong>Using a  Mesos Master URL:</strong></li>
<li>The Master URLs for Mesos are in the form <code>mesos://host:5050</code> for a single-master Mesos cluster, or <code>mesos://zk://host1:2181,host2:2181,host3:2181/mesos</code> for a multi-master Mesos cluster using ZooKeeper.<br><strong>Client Mode:</strong><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</div><div class="line">       .setMaster(<span class="string">"mesos://HOST:5050"</span>)</div><div class="line">       .setAppName(<span class="string">"My app"</span>)</div><div class="line">       .set(<span class="string">"spark.executor.uri"</span>, <span class="string">"&lt;path to spark-2.0.1.tar.gz uploaded above&gt;"</span>)</div><div class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line">     ./bin/spark-shell --master mesos:<span class="comment">//host:5050</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>Cluster Mode:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">./bin/spark-submit \</div><div class="line">       --class org.apache.spark.examples.SparkPi \</div><div class="line">       --master mesos://207.184.161.138:7077 \</div><div class="line">       --deploy-mode cluster \</div><div class="line">       --supervise \</div><div class="line">       --executor-memory 20G \</div><div class="line">       --total-executor-cores 100 \</div><div class="line">       http://path/to/examples.jar \</div><div class="line">       1000 \</div></pre></td></tr></table></figure></p>
<h3 id="Running-Spark-on-YARN-模式："><a href="#Running-Spark-on-YARN-模式：" class="headerlink" title="Running Spark on YARN 模式："></a>Running Spark on YARN 模式：</h3><p><strong>Cluster mode:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ./bin/spark-submit --class path.to.your.Class --master yarn --deploy-mode cluster [options] &lt;app jar&gt; [app options]</div><div class="line"></div><div class="line">$ ./bin/spark-submit --class org.apache.spark.examples.SparkPi \</div><div class="line">    --master yarn \</div><div class="line">    --deploy-mode cluster \</div><div class="line">    --driver-memory 4g \</div><div class="line">    --executor-memory 2g \</div><div class="line">    --executor-cores 1 \</div><div class="line">    --queue thequeue \</div><div class="line">    lib/spark-examples*.jar \</div><div class="line">    10</div></pre></td></tr></table></figure></p>
<p><strong>Client mode:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/spark-shell --master yarn --deploy-mode client</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark Cluster三种模式/" class="archive-article-date">
  	<time datetime="2016-11-09T02:11:16.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark介绍/">Spark介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spark-运行架构"><a href="#Spark-运行架构" class="headerlink" title="Spark 运行架构"></a>Spark 运行架构</h3><p><img src="/images/Spark_Arch.png" alt=""></p>
<p><img src="/images/Spark_Arch_1.png" alt=""></p>
<p>Spark架构采用了分布式计算中的Master-Slave模型。Master是对应集群中的含有Master进程的节点，Slave是集群中含有Worker进程的节点。Master作为整个集群的控制器，负责整个集群的正常运行；Worker相当于计算节点，接收主节点命令与进行状态汇报；Executor负责任务的执行；Client作为用户的客户端负责提交应用，Driver负责控制一个应用的执行。</p>
<p>Spark集群部署后，需要在主节点和从节点分别启动Master进程和Worker进程，对整个集群进行控制。在一个Spark应用的执行过程中，Driver和Worker是两个重要角色。<strong>Driver 程序是应用逻辑执行的起点，负责作业的调度，即Task任务的分发，而多个Worker用来管理计算节点和创建Executor并行处理任务。在执行阶段，Driver会将Task和Task所依赖的file和jar序列化后传递给对应的Worker机器，同时Executor对相应数据分区的任务进行处理。</strong></p>
<h3 id="Spark-组件"><a href="#Spark-组件" class="headerlink" title="Spark 组件"></a>Spark 组件</h3><ul>
<li>ClusterManager：在Standalone模式中即为Master（主节点），控制整个集群，监控Worker。在YARN模式中为资源管理器。</li>
<li>Worker：从节点，负责控制计算节点，启动Executor或Driver。在YARN模式中为NodeManager，负责计算节点的控制。</li>
<li>Driver：运行Application的main()函数并创建SparkContext。</li>
<li>Executor：执行器，在worker node上执行任务的组件、用于启动线程池运行任务。每个Application拥有独立的一组Executors。</li>
<li>SparkContext：整个应用的上下文，控制应用的生命周期。</li>
<li>RDD：Spark的基本计算单元，一组RDD可形成执行的有向无环图RDD Graph。</li>
<li>DAG Scheduler：根据作业（Job）构建基于Stage的DAG，并提交Stage给TaskScheduler。</li>
<li>TaskScheduler：将任务（Task）分发给Executor执行。</li>
<li>SparkEnv：线程级别的上下文，存储运行时的重要组件的引用。</li>
<li>SparkConf：负责存储配置信息。</li>
</ul>
<h3 id="Spark-提交Job"><a href="#Spark-提交Job" class="headerlink" title="Spark 提交Job"></a>Spark 提交Job</h3><p>参考： <a href="http://spark.apache.org/docs/latest/submitting-applications.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/submitting-applications.html</a><br>可向 本地 或 集群 提交。</p>
<h3 id="推荐一本书"><a href="#推荐一本书" class="headerlink" title="推荐一本书"></a>推荐一本书</h3><p>《Advanced Analytics with Spark. 2015.4》</p>
<h3 id="生态"><a href="#生态" class="headerlink" title="生态"></a>生态</h3><p><img src="/images/Spark_Eco.jpg" alt=""></p>
<p>Spark can integaration with Hadoop ecosystem.</p>
<ul>
<li>1.Avro and Parquet can store data on Hadoop.</li>
<li>2.Can read and write to NoSQL databases like HBase and Cassandra.</li>
<li>3.Spark Streaming can ingest data from Flume and Kafka.</li>
<li>4.SparkSQL can interact with Hive Metastore.</li>
<li>5.It can run inside YARN, Hadoop’s scheduler and resource manager.</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark介绍/" class="archive-article-date">
  	<time datetime="2016-11-09T01:48:14.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Cassandra" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Cassandra/">Cassandra 数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Cassandra-数据库"><a href="#Cassandra-数据库" class="headerlink" title="Cassandra 数据库"></a>Cassandra 数据库</h3><p>Apache Cassandra是一套开源分布式NoSQL数据库系统。它最初由Facebook开发，用于储存收件箱等简单格式数据，集Google BigTable的数据模型与AmazonDynamo的完全分布式架构于一身。Facebook于2008将 Cassandra 开源，此后，由于Cassandra良好的可扩展性和性能，被Apple, Comcast,Instagram, Spotify, eBay, Rackspace, Netflix等知名网站所采用，成为了一种流行的分布式结构化数据存储方案。</p>
<p>在数据库排行榜“DB-Engines Ranking”中，Cassandra排在第七位，是非关系型数据库中排名第二高的（仅次于MongoDB）。</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>Cassandra使用了Google 设计的 BigTable的数据模型，Cassandra使用的是宽列存储模型(Wide Column Stores)，每行数据由row key唯一标识之后，可以有最多20亿个列，每个列由一个column key标识，每个column key下对应若干value。这种模型可以理解为是一个二维的key-value存储，即整个数据模型被定义成一个类似 map&lt; key1, map&lt; key2,value&gt;&gt;的类型。</p>
<h3 id="存储模型"><a href="#存储模型" class="headerlink" title="存储模型"></a>存储模型</h3><p>与BigTable和其模仿者HBase不同，Cassandra的数据并不存储在分布式文件系统如GFS或HDFS中，而是直接存于本地。与BigTable一样，Cassandra也是日志型数据库，即把新写入的数据存储在内存的Memtable中并通过磁盘中的CommitLog来做持久化，内存填满后将数据按照key的顺序写进一个只读文件SSTable中，每次读取数据时将所有SSTable和内存中的数据进行查找和合并。这种系统的特点是写入比读取更快，因为写入一条数据是顺序计入commit log中，不需要随机读取磁盘以及搜索。</p>
<h3 id="与类似开源系统的比较"><a href="#与类似开源系统的比较" class="headerlink" title="与类似开源系统的比较"></a>与类似开源系统的比较</h3><p>HBase是Apache Hadoop项目的一个子项目，是Google BigTable的一个克隆，与Cassandra一样，它们都使用了BigTable的列族式的数据模型，但是：</p>
<ul>
<li>Cassandra只有一种节点，而HBase有多种不同角色，除了处理读写请求的region server之外，其架构在一套完整的HDFS分布式文件系统之上，并需要ZooKeeper来同步集群状态，部署上Cassandra更简单。</li>
<li>Cassandra的数据一致性策略是可配置的，可选择是强一致性还是性能更高的最终一致性；而HBase总是强一致性的。</li>
<li>Cassandra通过一致性哈希来决定一行数据存储在哪些节点，靠概率上的平均来实现负载均衡；而HBase每段数据(region)只有一个节点负责处理，由master来动态分配一个region是否大到需要拆分成两个，同时会将过热的节点上的一些region动态的分配给负载较低的节点，因此实现动态的负载均衡。</li>
<li>因为每个region同时只能有一个节点处理，一旦这个节点无响应，在系统将这个节点的所有region转移到其他节点之前这些数据便无法读写，加上master也只有一个节点，备用master的恢复也需要时间，因此HBase在一定程度上有单点问题；而Cassandra无单点问题。</li>
<li>Cassandra的读写性能优于HBase。</li>
</ul>
<h3 id="Cassandra-服务启动"><a href="#Cassandra-服务启动" class="headerlink" title="Cassandra 服务启动"></a>Cassandra 服务启动</h3><ul>
<li><p>1.启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./cassandra   </div><div class="line">org.apache.cassandra.service.CassandraDaemon</div></pre></td></tr></table></figure>
</li>
<li><p>2.启动用户交互              实际启动cqlsh.py来进行交互</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./cqlsh</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Cassandra Shell 命令：  <a href="http://www.w3ii.com/cassandra/cassandra_shell_commands.html" target="_blank" rel="external">http://www.w3ii.com/cassandra/cassandra_shell_commands.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cassandra -f           前台启动 cassandra</div></pre></td></tr></table></figure></p>
<ul>
<li>3.停止服务<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill  pid</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Cql-使用"><a href="#Cql-使用" class="headerlink" title="Cql 使用"></a>Cql 使用</h3><p><strong>创建使用Cqlsh一个密钥空间</strong><br><a href="http://www.w3ii.com/cassandra/cassandra_create_keyspace.html" target="_blank" rel="external">http://www.w3ii.com/cassandra/cassandra_create_keyspace.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CREATE KEYSPACE tutorialspoint</div><div class="line">WITH replication = &#123;&apos;class&apos;:&apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 3&#125;;</div><div class="line">DESCRIBE keyspaces;</div></pre></td></tr></table></figure></p>
<p><strong>使用Java创建API密钥空间一</strong><br><a href="http://www.w3ii.com/cassandra/cassandra_create_keyspace.html" target="_blank" rel="external">http://www.w3ii.com/cassandra/cassandra_create_keyspace.html</a></p>
<p><strong>改变使用Cqlsh KEYSPACE</strong><br><a href="http://www.w3ii.com/cassandra/cassandra_alter_keyspace.html" target="_blank" rel="external">http://www.w3ii.com/cassandra/cassandra_alter_keyspace.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ALTER KEYSPACE “KeySpace Name”</div><div class="line">WITH replication = &#123;&apos;class&apos;: ‘Strategy name’, &apos;replication_factor&apos; : ‘No.Of  replicas’&#125;;</div><div class="line"></div><div class="line">ALTER KEYSPACE tutorialspoint</div><div class="line">WITH replication = &#123;&apos;class’:&apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 2&#125;;</div></pre></td></tr></table></figure></p>
<p><strong>测试密钥空间的durable_writes属性</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cqlsh&gt; SELECT * FROM system_schema.keyspaces;</div><div class="line">ALTER KEYSPACE test</div><div class="line">WITH REPLICATION = &#123;&apos;class&apos; : &apos;NetworkTopologyStrategy&apos;, &apos;datacenter1&apos; : 3&#125;</div><div class="line"></div><div class="line">AND DURABLE_WRITES = true;</div></pre></td></tr></table></figure></p>
<p><strong>删除使用Cqlsh一个密钥空间</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DROP KEYSPACE tutorialspoint;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra创建表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">USE tutorialspoint;</div><div class="line">cqlsh:tutorialspoint&gt;; CREATE TABLE emp(</div><div class="line">   emp_id int PRIMARY KEY,</div><div class="line">   emp_name text,</div><div class="line">   emp_city text,</div><div class="line">   emp_sal varint,</div><div class="line">   emp_phone varint</div><div class="line">   );</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; select * from emp;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra修改表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; ALTER TABLE emp</div><div class="line">   ... ADD emp_email text;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra删除表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; DROP TABLE emp;</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; DESCRIBE COLUMNFAMILIES;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra截断表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cqlsh:tp&gt; TRUNCATE student;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra创建索引</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; CREATE INDEX name ON emp1 (emp_name);</div><div class="line"></div><div class="line">Cassandra DROP INDEX</div><div class="line">cqlsh:tp&gt; drop index name;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra批量</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; BEGIN BATCH</div><div class="line">     INSERT INTO emp (emp_id, emp_city, emp_name, emp_phone, emp_sal) values(  4,&apos;Pune&apos;,&apos;rajeev&apos;,9848022331, 30000);</div><div class="line">     UPDATE emp SET emp_sal = 50000 WHERE emp_id =3;</div><div class="line">     DELETE emp_city FROM emp WHERE emp_id = 2;</div><div class="line">     APPLY BATCH;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra创建数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO emp (emp_id, emp_name, emp_city,</div><div class="line">   emp_phone, emp_sal) VALUES(1,&apos;ram&apos;, &apos;Hyderabad&apos;, 9848022338, 50000);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO emp (emp_id, emp_name, emp_city,</div><div class="line">   emp_phone, emp_sal) VALUES(2,&apos;robin&apos;, &apos;Hyderabad&apos;, 9848022339, 40000);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO emp (emp_id, emp_name, emp_city,</div><div class="line">   emp_phone, emp_sal) VALUES(3,&apos;rahman&apos;, &apos;Chennai&apos;, 9848022330, 45000);</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra更新数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; UPDATE emp SET emp_city=&apos;Delhi&apos;,emp_sal=50000</div><div class="line">   WHERE emp_id=2;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra删除数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; DELETE emp_sal FROM emp WHERE emp_id=3;</div></pre></td></tr></table></figure></p>
<p><strong>Cassandra CQL集合</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">cqlsh:tutorialspoint&gt; CREATE TABLE data(name text PRIMARY KEY, email list&lt;text&gt;);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO data(name, email) VALUES (&apos;ramu&apos;,</div><div class="line">[&apos;abc@gmail.com&apos;,&apos;cba@yahoo.com&apos;])</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; UPDATE data</div><div class="line">... SET email = email +[&apos;xyz@w3ii.com&apos;]</div><div class="line">... where name = &apos;ramu&apos;;</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; CREATE TABLE data2 (name text PRIMARY KEY, phone set&lt;varint&gt;);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO data2(name, phone)VALUES (&apos;rahman&apos;,    &#123;9848022338,9848022339&#125;);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; UPDATE data2</div><div class="line">  ... SET phone = phone + &#123;9848022330&#125;</div><div class="line">  ... where name = &apos;rahman&apos;;</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; CREATE TABLE data3 (name text PRIMARY KEY, address map&lt;timestamp, text&gt;);</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; INSERT INTO data3 (name, address)</div><div class="line">   VALUES (&apos;robin&apos;, &#123;&apos;home&apos; : &apos;hyderabad&apos; , &apos;office&apos; : &apos;Delhi&apos; &#125; );</div><div class="line"></div><div class="line">cqlsh:tutorialspoint&gt; UPDATE data3</div><div class="line">   ... SET address = address+&#123;&apos;office&apos;:&apos;mumbai&apos;&#125;</div><div class="line">   ... WHERE name = &apos;robin&apos;;</div></pre></td></tr></table></figure></p>
<h3 id="Cassandra-安装-及-源代码分析"><a href="#Cassandra-安装-及-源代码分析" class="headerlink" title="Cassandra 安装 及 源代码分析"></a>Cassandra 安装 及 源代码分析</h3><p><strong>service 启动入口函数：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">org.apache.cassandra.service.CassandraDaemon</div></pre></td></tr></table></figure></p>
<p><strong>installation:</strong><br><a href="http://cassandra.apache.org/doc/latest/getting_started/installing.html" target="_blank" rel="external">http://cassandra.apache.org/doc/latest/getting_started/installing.html</a></p>
<p><strong>import源代码进Eclipse：</strong></p>
<ul>
<li>1.ant build</li>
<li>2.ant generate-eclipse-files</li>
</ul>
<p>还有其它操作：</p>
<ul>
<li>执行ant avro-generate</li>
<li>执行ant gen-thrift-java</li>
<li>执行ant generate-eclipse-files</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Cassandra/" class="archive-article-date">
  	<time datetime="2016-11-08T13:09:51.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-08</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cassandra/">Cassandra</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/NoSQL/">NoSQL</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-NoSQL介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/NoSQL介绍/">NoSQL参考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="NoSQL-参考"><a href="#NoSQL-参考" class="headerlink" title="NoSQL 参考"></a>NoSQL 参考</h3><p><img src="/images/NoSQL.png" alt=""></p>
<h3 id="NoSQL-对比"><a href="#NoSQL-对比" class="headerlink" title="NoSQL 对比"></a>NoSQL 对比</h3><p><img src="/images/NoSQL_Compare.png" alt=""></p>
<h3 id="CAP-原理"><a href="#CAP-原理" class="headerlink" title="CAP 原理"></a>CAP 原理</h3><p><img src="/images/CAP.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/NoSQL介绍/" class="archive-article-date">
  	<time datetime="2016-11-08T12:49:48.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-08</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NoSQL/">NoSQL</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/NoSQL/">NoSQL</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Storm介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Storm介绍/">Storm(流计算)介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Storm-简介"><a href="#Storm-简介" class="headerlink" title="Storm 简介"></a>Storm 简介</h2><p>参考： <a href="http://storm.apache.org/releases/0.10.2/index.html" target="_blank" rel="external">http://storm.apache.org/releases/0.10.2/index.html</a><br>Storm是一个分布式计算框架，主要由Clojure编程语言编写。最初是由Nathan Marz[1]及其团队创建于BackType，[2]该项目在被Twitter取得后开源。[3]它使用用户创建的“管（spouts）”和“螺栓（bolts）”来定义信息源和操作来允许批量、分布式处理流式数据。</p>
<h3 id="Storm-源代码导入-Eclipse"><a href="#Storm-源代码导入-Eclipse" class="headerlink" title="Storm 源代码导入 Eclipse"></a>Storm 源代码导入 Eclipse</h3><p>下载源代码并导入Eclipse： （可参考网页：<a href="http://ylzhj02.iteye.com/blog/2162197）" target="_blank" rel="external">http://ylzhj02.iteye.com/blog/2162197）</a></p>
<ul>
<li>1.git clone git://github.com/apache/storm.git</li>
<li>2.mvn clean package install -DskipTests=true</li>
<li>3.mvn eclipse:eclipse</li>
</ul>
<h3 id="Storm-Topology-架构"><a href="#Storm-Topology-架构" class="headerlink" title="Storm Topology 架构"></a>Storm Topology 架构</h3><p><img src="/images/Storm_Topology.png" alt=""></p>
<ul>
<li>Topology：storm中运行的一个实时应用程序，因为各个组件间的消息流动形成逻辑上的一个拓扑结构。</li>
<li>Spout：在一个topology中产生源数据流的组件。通常情况下spout会从外部数据源中读取数据，然后转换为topology内部的源数据。Spout是一个主动的角色，其接口中有个nextTuple()函数，storm框架会不停地调用此函数，用户只要在其中生成源数据即可。</li>
<li>Bolt：在一个topology中接受数据然后执行处理的组件。Bolt可以执行过滤、函数操作、合并、写数据库等任何操作。Bolt是一个被动的角色，其接口中有个execute(Tuple input)函数,在接受到消息后会调用此函数，用户可以在其中执行自己想要的操作。</li>
<li>Tuple：一次消息传递的基本单元。本来应该是一个key-value的map，但是由于各个组件间传递的tuple的字段名称已经事先定义好，所以tuple中只要按序填入各个value就行了，所以就是一个value list.</li>
<li>Stream：源源不断传递的tuple就组成了stream。</li>
</ul>
<h3 id="Storm-Detail"><a href="#Storm-Detail" class="headerlink" title="Storm Detail"></a>Storm Detail</h3><p>在Storm的集群里面有两种节点： 控制节点(master node)和工作节点(worker node)。控制节点上面运行一个叫Nimbus后台程序，它的作用类似Hadoop里面的JobTracker。Nimbus负责在集群里面分发代码，分配计算任务给机器，并且监控状态。<br>每一个工作节点上面运行一个叫做Supervisor的节点。Supervisor会监听分配给它那台机器的工作，根据需要启动/关闭工作进程。每一个工作进程执行一个topology的一个子集；一个运行的topology由运行在很多机器上的很多工作进程组成。<br><img src="/images/Storm1.png" alt="">  <img src="/images/Storm2.jpg" alt="">  <img src="/images/Storm3.png" alt=""></p>
<ul>
<li>Storm提供的最基本的处理stream的原语是spout和bolt。你可以实现spout和bolt提供的接口来处理你的业务逻辑。</li>
<li>消息源spout是Storm里面一个topology里面的消息生产者。一般来说消息源会从一个外部源读取数据并且向topology里面发出消息：tuple。Spout可以是可靠的也可以是不可靠的。如果这个tuple没有被storm成功处理，可靠的消息源spouts可以重新发射一个tuple， 但是不可靠的消息源spouts一旦发出一个tuple就不能重发了。</li>
<li>消息源可以发射多条消息流stream。使用OutputFieldsDeclarer.declareStream来定义多个stream，然后使用SpoutOutputCollector来发射指定的stream。</li>
<li>Spout类里面最重要的方法是nextTuple。要么发射一个新的tuple到topology里面或者简单的返回如果已经没有新的tuple。要注意的是nextTuple方法不能阻塞，因为storm在同一个线程上面调用所有消息源spout的方法。</li>
<li>另外两个比较重要的spout方法是ack和fail。storm在检测到一个tuple被整个topology成功处理的时候调用ack，否则调用fail。storm只对可靠的spout调用ack和fail。</li>
<li>所有的消息处理逻辑被封装在bolts里面。Bolts可以做很多事情：过滤，聚合，查询数据库等等。</li>
<li>Bolts可以简单的做消息流的传递。复杂的消息流处理往往需要很多步骤，从而也就需要经过很多bolts。比如算出一堆图片里面被转发最多的图片就至少需要两步：第一步算出每个图片的转发数量。第二步找出转发最多的前10个图片。(如果要把这个过程做得更具有扩展性那么可能需要更多的步骤)。</li>
<li>Bolts可以发射多条消息流， 使用OutputFieldsDeclarer.declareStream定义stream，使用OutputCollector.emit来选择要发射的stream。</li>
<li>Bolts的主要方法是execute, 它以一个tuple作为输入，bolts使用OutputCollector来发射tuple，bolts必须要为它处理的每一个tuple调用OutputCollector的ack方法，以通知Storm这个tuple被处理完成了，从而通知这个tuple的发射者spouts。 一般的流程是： bolts处理一个输入tuple, 发射0个或者多个tuple, 然后调用ack通知storm自己已经处理过这个tuple了。storm提供了一个IBasicBolt会自动调用ack。</li>
<li>定义一个topology的其中一步是定义每个bolt接收什么样的流作为输入。stream grouping就是用来定义一个stream应该如果分配数据给bolts上面的多个tasks。</li>
</ul>
<h3 id="Storm里面有7种类型的stream-grouping"><a href="#Storm里面有7种类型的stream-grouping" class="headerlink" title="Storm里面有7种类型的stream grouping"></a>Storm里面有7种类型的stream grouping</h3><ul>
<li>　　Shuffle Grouping: 随机分组， 随机派发stream里面的tuple，保证每个bolt接收到的tuple数目大致相同。</li>
<li>　　Fields Grouping：按字段分组， 比如按userid来分组， 具有同样userid的tuple会被分到相同的Bolts里的一个task， 而不同的userid则会被分配到不同的bolts里的task。</li>
<li>　　All Grouping：广播发送，对于每一个tuple，所有的bolts都会收到。</li>
<li>　　Global Grouping：全局分组， 这个tuple被分配到storm中的一个bolt的其中一个task。再具体一点就是分配给id值最低的那个task。</li>
<li>　　Non Grouping：不分组，这个分组的意思是说stream不关心到底谁会收到它的tuple。目前这种分组和Shuffle grouping是一样的效果， 有一点不同的是storm会把这个bolt放到这个bolt的订阅者同一个线程里面去执行。</li>
<li>　　Direct Grouping： 直接分组， 这是一种比较特别的分组方法，用这种分组意味着消息的发送者指定由消息接收者的哪个task处理这个消息。 只有被声明为Direct Stream的消息流可以声明这种分组方法。而且这种消息tuple必须使用emitDirect方法来发射。消息处理者可以通过TopologyContext来获取处理它的消息的task的id (OutputCollector.emit方法也会返回task的id)。</li>
<li>　　Local or shuffle grouping：如果目标bolt有一个或者多个task在同一个工作进程中，tuple将会被随机发生给这些tasks。否则，和普通的Shuffle Grouping行为一致。</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Storm介绍/" class="archive-article-date">
  	<time datetime="2016-11-08T12:27:38.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-08</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Xia,MingXing
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: false
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Cassandra/" style="font-size: 10px;">Cassandra</a> <a href="/tags/Hadoop/" style="font-size: 20px;">Hadoop</a> <a href="/tags/Kafka/" style="font-size: 12.5px;">Kafka</a> <a href="/tags/NoSQL/" style="font-size: 10px;">NoSQL</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/ZooKeeper/" style="font-size: 12.5px;">ZooKeeper</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/介绍/" style="font-size: 10px;">介绍</a> <a href="/tags/分布式协同/" style="font-size: 10px;">分布式协同</a> <a href="/tags/大数据/" style="font-size: 17.5px;">大数据</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">平均每天保证几小时的学习时间，用一万小时定律激励自己，每年多13/14两个月就好</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>