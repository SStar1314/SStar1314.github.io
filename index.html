<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>SStar1314</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="西安">
<meta property="og:type" content="website">
<meta property="og:title" content="SStar1314">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="SStar1314">
<meta property="og:description" content="西安">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SStar1314">
<meta name="twitter:description" content="西安">
  
    <link rel="alternative" href="/atom.xml" title="SStar1314" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/images/favicon.ico" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Xia, MingXing</a></h1>
		</hgroup>

		
		<p class="header-subtitle">研发</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/archives">主页</a></li>
	        
				<li><a href="/archives">所有文章</a></li>
	        
				<li><a href="/categories">目录</a></li>
	        
				<li><a href="/tags">标签</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Xia, MingXing</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/images/favicon.ico" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Xia, MingXing</h1>
			</hgroup>
			
			<p class="header-subtitle">研发</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/archives">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories">目录</a></li>
		        
					<li><a href="/tags">标签</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/SStar1314/" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="/xaxiamx@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-openstack_install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/openstack_install/">Openstack 安装截图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Openstack"><a href="#Openstack" class="headerlink" title="Openstack"></a>Openstack</h2><p><img src="/images/keystone-create-service-project.png" alt=""><br><img src="/images/keystone-create-demo-project.png" alt=""><br><img src="/images/keystone-create-demo-user.png" alt=""><br><img src="/images/openstack-create-user-role.png" alt=""><br><img src="/images/openstack-add-user-role-to-project-and-user.png" alt=""><br><img src="/images/openstack-admin-user-request-authentication-token.png" alt=""><br><img src="/images/openstack-demo-user-request-authentication-token.png" alt=""><br><img src="/images/openstack-create-user-glance.png" alt=""><br><img src="/images/openstack-add-glance-to-admin-and-service-project.png" alt=""><br><img src="/images/openstack-create-image-service.png" alt=""><br><img src="/images/openstack-create-public-endpoint-for-image-service.png" alt=""><br><img src="/images/openstack-create-internal-endpoint-for-image-service.png" alt=""><br><img src="/images/openstack-create-admin-endpoint-for-image-service.png" alt=""><br><img src="/images/openstack-create-image-named-cirros.png" alt=""><br><img src="/images/openstack-image-list.png" alt=""><br><img src="/images/openstack-create-user-nova.png" alt=""><br><img src="/images/openstack-add-nova-to-admin-and-service-project.png" alt=""><br><img src="/images/openstack-create-compute-service.png" alt=""><br><img src="/images/openstack-create-public-endpoint-for-compute-service.png" alt=""><br><img src="/images/openstack-create-internal-endpoint-for-compute-service.png" alt=""><br><img src="/images/openstack-create-admin-endpoint-for-compute-service.png" alt=""><br><img src="/images/openstack-create-user-placement.png" alt=""><br><img src="/images/openstack-add-placement-to-admin-and-service-project.png" alt=""><br><img src="/images/openstack-create-placement-api-service.png" alt=""><br><img src="/images/openstack-create-public-endpoint-for-placement-api.png" alt=""><br><img src="/images/openstack-create-internal-endpoint-for-placement-api.png" alt=""><br><img src="/images/openstack-create-admin-endpoint-for-placement-api.png" alt=""><br><img src="/images/nova-manage-list-cells.png" alt=""><br><img src="/images/openstack-list-hypervisor-after-nova-compute-installed.png" alt=""><br><img src="/images/openstack-compute-service-list.png" alt=""><br><img src="/images/openstack-catalog-or-endpoint-list.png" alt=""><br><img src="/images/check-cells-and-placement-api-working-success.png" alt=""><br><img src="/images/openstack-create-user-neutron.png" alt=""><br><img src="/images/openstack-add-neutron-to-admin-and-service-project.png" alt=""><br><img src="/images/openstack-create-network-service.png" alt=""><br><img src="/images/openstack-create-public-endpoint-for-network-service.png" alt=""><br><img src="/images/openstack-create-internal-endpoint-for-network-service.png" alt=""><br><img src="/images/openstack-create-admin-endpoint-for-network-service.png" alt=""><br><img src="/images/openstack-re-create-network-endpoints.png" alt=""><br><img src="/images/openstack-verify-neutron-install-correct.png" alt=""><br><img src="/images/openstack-create-flavor.png" alt=""><br><img src="/images/openstack-create-keypair-and-add-one-public-key.png" alt=""><br><img src="/images/openstack-add-icmp-rules-to-default-security-group.png" alt=""><br><img src="/images/openstack-add-ssh-rules-to-default-security-group.png" alt=""><br><img src="/images/openstack-list-flavor-and-image.png" alt=""><br><img src="/images/openstack-create-selfservice-network.png" alt=""><br><img src="/images/openstack-create-subnet-for-selfservice.png" alt=""><br><img src="/images/openstack-create-router.png" alt=""><br><img src="/images/openstack-create-provider-network.png" alt=""><br><img src="/images/openstack-create-subnet-for-provider.png" alt=""><br><img src="/images/openstack-router-gateway-set-to-provider.png" alt=""><br><img src="/images/list-ip-namespace-on-neutron.png" alt=""><br><img src="/images/neutron-list-router-and-port.png" alt=""><br><img src="/images/ping-router-ip-on-neutron-node-for-verify.png" alt=""><br><img src="/images/openstack-network-list.png" alt=""><br><img src="/images/openstack-create-instance-on-provider-network.png" alt=""><br><img src="/images/openstack-create-instance-use-selfservice-network.png" alt=""><br><img src="/images/openstack-list-all-servers.png" alt=""><br><img src="/images/vnc-viewer-success.png" alt=""><br><img src="/images/openstack-vnc-view-success-pic2.png" alt=""><br><img src="/images/openstack-create-floating-ip-from-provider-net.png" alt=""><br><img src="/images/openstack-bind-floating-ip-to-selfservice-instance.png" alt=""><br><img src="/images/openstack-create-cinder-user.png" alt=""><br><img src="/images/openstack-create-service-cinderv2-cinderv3.png" alt=""><br><img src="/images/openstack-dashboar-permission-error-and-web-timeout-solve-method.png" alt=""><br><img src="/images/openstack-create-endpoint-for-volumev2.png" alt=""><br><img src="/images/openstack-create-endpoint-for-volumev3.png" alt=""><br><img src="/images/vgcreate-cinder-volumes-sdb.png" alt=""><br><img src="/images/openstack-volume-service-list-for-verify.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/openstack_install/" class="archive-article-date">
  	<time datetime="2017-07-23T13:57:47.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-23</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Openstack/">Openstack</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Openstack/">Openstack</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spring_3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spring_3/">Spring AOP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><p>refer:  <a href="http://wiki.jikexueyuan.com/project/spring/aop-with-spring-framenwork/xml-schema-based-aop-with-spring.html" target="_blank" rel="external">http://wiki.jikexueyuan.com/project/spring/aop-with-spring-framenwork/xml-schema-based-aop-with-spring.html</a></p>
<p>Spring 框架的一个关键组件是面向方面的编程(AOP)框架。面向方面的编程需要把程序逻辑分解成不同的部分称为所谓的关注点。跨一个应用程序的多个点的功能被称为横切关注点，这些横切关注点在概念上独立于应用程序的业务逻辑。有各种各样的常见的很好的方面的例子，如日志记录、审计、声明式事务、安全性和缓存等。</p>
<h4 id="AOP-术语："><a href="#AOP-术语：" class="headerlink" title="AOP 术语："></a>AOP 术语：</h4><ul>
<li>Aspect    一个模块具有一组提供横切需求的 APIs。例如，一个日志模块为了记录日志将被 AOP 方面调用。应用程序可以拥有任意数量的方面，这取决于需求。</li>
<li>Join point    在你的应用程序中它代表一个点，你可以在插件 AOP 方面。你也能说，它是在实际的应用程序中，其中一个操作将使用 Spring AOP 框架。</li>
<li>Advice    这是实际行动之前或之后执行的方法。这是在程序执行期间通过 Spring AOP 框架实际被调用的代码。</li>
<li>Pointcut    这是一组一个或多个连接点，通知应该被执行。你可以使用表达式或模式指定切入点正如我们将在 AOP 的例子中看到的。</li>
<li>Introduction    引用允许你添加新方法或属性到现有的类中。</li>
<li>Target object    被一个或者多个方面所通知的对象，这个对象永远是一个被代理对象。也称为被通知对象。</li>
<li>Weaving    Weaving 把方面连接到其它的应用程序类型或者对象上，并创建一个被通知的对象。这些可以在编译时，类加载时和运行时完成。</li>
</ul>
<h4 id="通知的类型"><a href="#通知的类型" class="headerlink" title="通知的类型"></a>通知的类型</h4><p>Spring 方面可以使用下面提到的五种通知工作：</p>
<ul>
<li>前置通知    在一个方法执行之前，执行通知。</li>
<li>后置通知    在一个方法执行之后，不考虑其结果，执行通知。</li>
<li>返回后通知    在一个方法执行之后，只有在方法成功完成时，才能执行通知。</li>
<li>抛出异常后通知    在一个方法执行之后，只有在方法退出抛出异常时，才能执行通知。</li>
<li>环绕通知    在建议方法调用之前和之后，执行通知。</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spring_3/" class="archive-article-date">
  	<time datetime="2017-07-22T15:24:38.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Spring/">Spring</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spring_2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spring_2/">Spring JDBC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-JDBC"><a href="#Spring-JDBC" class="headerlink" title="Spring JDBC"></a>Spring JDBC</h3><p>Database Driver:</p>
<ul>
<li>mysql-connector-java (com.mysql.jdbc.Driver)</li>
<li>commons-dbcp (org.apache.commons.dbcp)</li>
<li>spring-jdbc (org.springframework.jdbc.datasource [DriverManagerDataSource] + org.springframework.jdbc.core [JdbcTemplate])</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--数据源的配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql:///spring"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDao"</span> <span class="attr">class</span>=<span class="string">"com.curd.spring.impl.UserDAOImpl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="JdbcTemplate主要提供下列方法："><a href="#JdbcTemplate主要提供下列方法：" class="headerlink" title="JdbcTemplate主要提供下列方法："></a>JdbcTemplate主要提供下列方法：</h4><p>　　1、execute方法：可以用于执行任何SQL语句，一般用于执行DDL语句；</p>
<p>　　2、update方法及batchUpdate方法：update方法用于执行新增、修改、删除等语句；batchUpdate方法用于执行批处理相关语句；</p>
<p>　　3、query方法及queryForXXX方法：用于执行查询相关语句；</p>
<p>　　4、call方法：用于执行存储过程、函数相关语句。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spring_2/" class="archive-article-date">
  	<time datetime="2017-07-22T15:17:48.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Spring/">Spring</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spring_1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spring_1/">Spring IoC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-IoC-容器："><a href="#Spring-IoC-容器：" class="headerlink" title="Spring IoC 容器："></a>Spring IoC 容器：</h3><p>Spring 容器是 Spring 框架的核心。容器将创建对象，把它们连接在一起，配置它们，并管理他们的整个生命周期从创建到销毁。Spring 容器使用依赖注入（DI）来管理组成一个应用程序的组件。这些对象被称为 Spring Beans.</p>
<p>通过阅读配置元数据提供的指令，容器知道对哪些对象进行实例化，配置和组装。配置元数据可以通过 XML，Java 注释或 Java 代码来表示。下图是 Spring 如何工作的高级视图。 Spring IoC 容器利用 Java 的 POJO 类和配置元数据来生成完全配置和可执行的系统或应用程序。<br><img src="/images/spring_1.png" alt=""></p>
<h4 id="Spring-BeanFactory-容器"><a href="#Spring-BeanFactory-容器" class="headerlink" title="Spring BeanFactory 容器"></a>Spring BeanFactory 容器</h4><p>它是最简单的容器，给 DI 提供了基本的支持，它用 org.springframework.beans.factory.BeanFactory 接口来定义。BeanFactory 或者相关的接口，如 BeanFactoryAware，InitializingBean，DisposableBean，在 Spring 中仍然存在具有大量的与 Spring 整合的第三方框架的反向兼容性的目的。</p>
<h4 id="Spring-ApplicationContext-容器"><a href="#Spring-ApplicationContext-容器" class="headerlink" title="Spring ApplicationContext 容器"></a>Spring ApplicationContext 容器</h4><p>该容器添加了更多的企业特定的功能，例如从一个属性文件中解析文本信息的能力，发布应用程序事件给感兴趣的事件监听器的能力。该容器是由org.springframework.context.ApplicationContext 接口定义。</p>
<h3 id="Spring-Bean"><a href="#Spring-Bean" class="headerlink" title="Spring Bean:"></a>Spring Bean:</h3><p>被称作 bean 的对象是构成应用程序的支柱也是由 Spring IoC 容器管理的。bean 是一个被实例化，组装，并通过 Spring IoC 容器所管理的对象。这些 bean 是由用容器提供的配置元数据创建的.</p>
<bean id="..." class="..." init-method="..."><br>       <!-- collaborators and configuration for this bean go here --><br>   </bean>

<ul>
<li>class    这个属性是强制性的，并且指定用来创建 bean 的 bean 类。</li>
<li>name    这个属性指定唯一的 bean 标识符。在基于 XML 的配置元数据中，你可以使用 ID 和/或 name 属性来指定 bean 标识符。</li>
<li>scope    这个属性指定由特定的 bean 定义创建的对象的作用域，它将会在 bean 作用域的章节中进行讨论。</li>
<li>constructor-arg    它是用来注入依赖关系的，并会在接下来的章节中进行讨论。</li>
<li>properties    它是用来注入依赖关系的，并会在接下来的章节中进行讨论。</li>
<li>autowiring mode    它是用来注入依赖关系的，并会在接下来的章节中进行讨论。</li>
<li>lazy-initialization mode    延迟初始化的 bean 告诉 IoC 容器在它第一次被请求时，而不是在启动时去创建一个 bean 实例。</li>
<li>initialization 方法    在 bean 的所有必需的属性被容器设置之后，调用回调方法。它将会在 bean 的生命周期章节中进行讨论。</li>
<li>destruction 方法    当包含该 bean 的容器被销毁时，使用回调方法。它将会在 bean 的生命周期章节中进行讨论。</li>
</ul>
<h4 id="Bean-作用域："><a href="#Bean-作用域：" class="headerlink" title="Bean 作用域："></a>Bean 作用域：</h4><p>作用域    描述<br>singleton    该作用域将 bean 的定义的限制在每一个 Spring IoC 容器中的一个单一实例(默认)。<br>prototype    该作用域将单一 bean 的定义限制在任意数量的对象实例。<br>request    该作用域将 bean 的定义限制为 HTTP 请求。只在 web-aware Spring ApplicationContext 的上下文中有效。<br>session    该作用域将 bean 的定义限制为 HTTP 会话。 只在web-aware Spring ApplicationContext的上下文中有效。<br>global-session    该作用域将 bean 的定义限制为全局 HTTP 会话。只在 web-aware Spring ApplicationContext 的上下文中有效。</p>
<h4 id="singleton-作用域："><a href="#singleton-作用域：" class="headerlink" title="singleton 作用域："></a>singleton 作用域：</h4><p>如果作用域设置为 singleton，那么 Spring IoC 容器刚好创建一个由该 bean 定义的对象的实例。该单一实例将存储在这种单例 bean 的高速缓存中，以及针对该 bean 的所有后续的请求和引用都返回缓存对象。</p>
<h4 id="prototype-作用域"><a href="#prototype-作用域" class="headerlink" title="prototype 作用域"></a>prototype 作用域</h4><p>如果作用域设置为 prototype，那么每次特定的 bean 发出请求时 Spring IoC 容器就创建对象的新的 Bean 实例。一般说来，满状态的 bean 使用 prototype 作用域和没有状态的 bean 使用 singleton 作用域。</p>
<h4 id="Bean-生命周期："><a href="#Bean-生命周期：" class="headerlink" title="Bean 生命周期："></a>Bean 生命周期：</h4><p>理解 Spring bean 的生命周期很容易。当一个 bean 被实例化时，它可能需要执行一些初始化使它转换成可用状态。同样，当 bean 不再需要，并且从容器中移除时，可能需要做一些清除工作。</p>
<h4 id="初始化回调"><a href="#初始化回调" class="headerlink" title="初始化回调"></a>初始化回调</h4><p>org.springframework.beans.factory.InitializingBean 接口指定一个单一的方法：</p>
<p>void afterPropertiesSet() throws Exception;</p>
<h4 id="销毁回调"><a href="#销毁回调" class="headerlink" title="销毁回调"></a>销毁回调</h4><p>org.springframework.beans.factory.DisposableBean 接口指定一个单一的方法：</p>
<p>void destroy() throws Exception;</p>
<h4 id="默认的初始化和销毁方法"><a href="#默认的初始化和销毁方法" class="headerlink" title="默认的初始化和销毁方法"></a>默认的初始化和销毁方法</h4><p>如果你有太多具有相同名称的初始化或者销毁方法的 Bean，那么你不需要在每一个 bean 上声明初始化方法和销毁方法。框架使用 元素中的 default-init-method 和 default-destroy-method 属性提供了灵活地配置这种情况.</p>
<h4 id="Spring——Bean-后置处理器"><a href="#Spring——Bean-后置处理器" class="headerlink" title="Spring——Bean 后置处理器"></a>Spring——Bean 后置处理器</h4><p>BeanPostProcessor 接口定义回调方法，你可以实现该方法来提供自己的实例化逻辑，依赖解析逻辑等。你也可以在 Spring 容器通过插入一个或多个 BeanPostProcessor 的实现来完成实例化，配置和初始化一个bean之后实现一些自定义逻辑回调方法。</p>
<p>ApplicationContext 会自动检测由 BeanPostProcessor 接口的实现定义的 bean，注册这些 bean 为后置处理器，然后通过在容器中创建 bean，在适当的时候调用它。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.tutorialspoint;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitHelloWorld</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</div><div class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">      System.out.println(<span class="string">"BeforeInitialization : "</span> + beanName);</div><div class="line">      <span class="keyword">return</span> bean;  <span class="comment">// you can return any other object as well</span></div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">      System.out.println(<span class="string">"AfterInitialization : "</span> + beanName);</div><div class="line">      <span class="keyword">return</span> bean;  <span class="comment">// you can return any other object as well</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你需要注册一个在 AbstractApplicationContext 类中声明的关闭 hook 的 registerShutdownHook() 方法。它将确保正常关闭，并且调用相关的 destroy 方法。</p>
<h3 id="Autowiring-Autowired-default-autowire"><a href="#Autowiring-Autowired-default-autowire" class="headerlink" title="Autowiring + @Autowired + default-autowire"></a>Autowiring + @Autowired + default-autowire</h3><p>为避免 Spring 注入的人为工作很麻烦， 可以设置 bean Autowiring， 搜寻 appContext 进行 自动注入。</p>
<h4 id="Autowiring"><a href="#Autowiring" class="headerlink" title="Autowiring:"></a>Autowiring:</h4><p>可选值    功能说明<br>no    默认不使用autowiring。 必须显示的使用”“标签明确地指定bean。<br>byName    根据属性名自动装配。此选项将检查容器并根据名字查找与属性完全一致的bean，并将其与属性自动装配。<br>byType    如果容器中存在一个与指定属性类型相同的bean，那么将与该属性自动装配。如果存在多个该类型的bean，那么将会抛出异常，并指出不能使用byType方式进行自动装配。若没有找到相匹配的bean，则什么事都不发生，属性也不会被设置。如果你不希望这样，那么可以通过设置 dependency-check=”objects”让Spring抛出异常。<br>constructor    与byType的方式类似，不同之处在于它应用于构造器参数。如果在容器中没有找到与构造器参数类型一致的bean，那么将会抛出异常。<br>autodetect    通过bean类的自省机制（introspection）来决定是使用constructor还是byType方式进行自动装配。如果发现默认的构造器，那么将使用byType方式。</p>
<p>@Autowired注解注入　<br>　　@Autowired往往用在类中注解注入，在配置xml需要配置才能使用@Autowired标识<br>    <context:annotation-config><br>@Autowired<br>@Qualifier(“teacher”)<br>private Teacher teacher;<br>public void setTeacher(Teacher teacher)<br>{this.teacher = teacher; }<br>beans标签设置default-autowire参数</context:annotation-config></p>
<p>　　在spring的配置文件中可以参照如下设置default-autowire参数</p>
<pre><code>default-autowire=&quot;byName&quot;
</code></pre><h4 id="Spring-注解-配置"><a href="#Spring-注解-配置" class="headerlink" title="Spring 注解 配置"></a>Spring 注解 配置</h4><pre><code>1    @Required
@Required 注解应用于 bean 属性的 setter 方法。

2    @Autowired
@Autowired 注解可以应用到 bean 属性的 setter 方法，非 setter 方法，构造函数和属性。

3    @Qualifier
通过指定确切的将被连线的 bean，@Autowired 和 @Qualifier 注解可以用来删除混乱。

4    JSR-250 Annotations
Spring 支持 JSR-250 的基础的注解，其中包括了 @Resource，@PostConstruct 和 @PreDestroy 注解。
</code></pre>
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spring_1/" class="archive-article-date">
  	<time datetime="2017-07-22T15:09:20.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Spring/">Spring</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-tomcat_1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/tomcat_1/">Tomcat 生命周期管理 及 源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="几个问题"><a href="#几个问题" class="headerlink" title="几个问题"></a>几个问题</h2><p>Java 编写的 Web Application 为什么 能够监听一个port？<br>Web Application 都没有main函数, 那么该web从哪个入口函数启动的呢？</p>
<p>答案都是 依据 tomact 或 Websphere 这些server实现的， 以Tomcat为例，最重要的就是Tomcat的生命周期管理特性.</p>
<h3 id="Tomcat-生命周期管理"><a href="#Tomcat-生命周期管理" class="headerlink" title="Tomcat 生命周期管理"></a>Tomcat 生命周期管理</h3><p><img src="/images/tomcat_1.png" alt=""></p>
<h3 id="Tomcat-startup-源代码解析"><a href="#Tomcat-startup-源代码解析" class="headerlink" title="Tomcat startup 源代码解析"></a>Tomcat startup 源代码解析</h3><p>主要顺序: Bootstrap.java#main()  —&gt; init()  —&gt;  load()  —&gt;  start()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">init():</div><div class="line">1. initClassLoaders</div><div class="line">2.  Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">"org.apache.catalina.startup.Catalina"</span>);</div><div class="line">   Object startupInstance = startupClass.newInstance();</div><div class="line"></div><div class="line">load():</div><div class="line">1. Method method = catalinaDaemon.getClass().getMethod(<span class="string">"load"</span>, paramTypes);</div><div class="line">    method.invoke(catalinaDaemon, param);</div><div class="line">2. Catalina.load()</div><div class="line">    Digester digester = createStartDigester();   //very important</div><div class="line">        inputSource.setByteStream(<span class="string">"conf/server.xml"</span>);        在该位置解析server.xml,根据xml生成Server/Service/Listener/Context/Executor/Connector/Engine等,执行相应配置的class.</div><div class="line">        digester.push(this);</div><div class="line">        digester.parse(inputSource);</div><div class="line">    getServer().init();</div><div class="line"></div><div class="line">StandardContext  will parser web.xml and config context.</div><div class="line"></div><div class="line">start():</div><div class="line">1. Method method = catalinaDaemon.getClass().getMethod(<span class="string">"start"</span>, (Class [] )null);</div><div class="line">        method.invoke(catalinaDaemon, (Object [])null);</div><div class="line">2.  getServer().start();    ==&gt;  LifecycleBase.start()    or   WebappClassLoaderBase.start()</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Create and configure the Digester we will be using for startup.</div><div class="line"> * @return the main digester to parse server.xml</div><div class="line"> */</div><div class="line">protected Digester createStartDigester() &#123;            // 解析server.xml并初始化的主要入口函数</div><div class="line">    long t1=System.currentTimeMillis();</div><div class="line">    // Initialize the digester</div><div class="line">    Digester digester = new Digester();</div><div class="line">    digester.setValidating(false);</div><div class="line">    digester.setRulesValidation(true);</div><div class="line">    Map&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = new HashMap&lt;&gt;();</div><div class="line">    List&lt;String&gt; attrs = new ArrayList&lt;&gt;();</div><div class="line">    attrs.add("className");</div><div class="line">    fakeAttributes.put(Object.class, attrs);</div><div class="line">    digester.setFakeAttributes(fakeAttributes);</div><div class="line">    digester.setUseContextClassLoader(true);</div><div class="line"></div><div class="line">    // Configure the actions we will be using</div><div class="line">    digester.addObjectCreate("Server",</div><div class="line">                             "org.apache.catalina.core.StandardServer",</div><div class="line">                             "className");</div><div class="line">    digester.addSetProperties("Server");</div><div class="line">    digester.addSetNext(“Server",</div><div class="line">                        "setServer",</div><div class="line">                        "org.apache.catalina.Server");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/GlobalNamingResources",</div><div class="line">                             "org.apache.catalina.deploy.NamingResourcesImpl");</div><div class="line">    digester.addSetProperties("Server/GlobalNamingResources");</div><div class="line">    digester.addSetNext("Server/GlobalNamingResources",</div><div class="line">                        "setGlobalNamingResources",</div><div class="line">                        "org.apache.catalina.deploy.NamingResourcesImpl");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Listener",</div><div class="line">                             null, // MUST be specified in the element</div><div class="line">                             "className");</div><div class="line">    digester.addSetProperties("Server/Listener");</div><div class="line">    digester.addSetNext("Server/Listener",</div><div class="line">                        "addLifecycleListener",</div><div class="line">                        "org.apache.catalina.LifecycleListener");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Service",</div><div class="line">                             "org.apache.catalina.core.StandardService",</div><div class="line">                             "className");</div><div class="line">    digester.addSetProperties("Server/Service");</div><div class="line">    digester.addSetNext("Server/Service",</div><div class="line">                        "addService",</div><div class="line">                        "org.apache.catalina.Service");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Service/Listener",</div><div class="line">                             null, // MUST be specified in the element</div><div class="line">                             "className");</div><div class="line">    digester.addSetProperties("Server/Service/Listener");</div><div class="line">    digester.addSetNext("Server/Service/Listener",</div><div class="line">                        "addLifecycleListener",</div><div class="line">                        "org.apache.catalina.LifecycleListener");</div><div class="line"></div><div class="line">    //Executor</div><div class="line">    digester.addObjectCreate("Server/Service/Executor",</div><div class="line">                     "org.apache.catalina.core.StandardThreadExecutor",</div><div class="line">                     "className");</div><div class="line">    digester.addSetProperties("Server/Service/Executor");</div><div class="line"></div><div class="line">    digester.addSetNext("Server/Service/Executor",</div><div class="line">                        "addExecutor",</div><div class="line">                        "org.apache.catalina.Executor");</div><div class="line"></div><div class="line"></div><div class="line">    digester.addRule("Server/Service/Connector",</div><div class="line">                     new ConnectorCreateRule());</div><div class="line">    digester.addRule("Server/Service/Connector", new SetAllPropertiesRule(</div><div class="line">            new String[]&#123;"executor", "sslImplementationName", "protocol"&#125;));</div><div class="line">    digester.addSetNext("Server/Service/Connector",</div><div class="line">                        "addConnector",</div><div class="line">                        "org.apache.catalina.connector.Connector");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Service/Connector/SSLHostConfig",</div><div class="line">                             "org.apache.tomcat.util.net.SSLHostConfig");</div><div class="line">    digester.addSetProperties("Server/Service/Connector/SSLHostConfig");</div><div class="line">    digester.addSetNext("Server/Service/Connector/SSLHostConfig",</div><div class="line">            "addSslHostConfig",</div><div class="line">            "org.apache.tomcat.util.net.SSLHostConfig");</div><div class="line"></div><div class="line">    digester.addRule("Server/Service/Connector/SSLHostConfig/Certificate",</div><div class="line">                     new CertificateCreateRule());</div><div class="line">    digester.addRule("Server/Service/Connector/SSLHostConfig/Certificate",</div><div class="line">                     new SetAllPropertiesRule(new String[]&#123;"type"&#125;));</div><div class="line">    digester.addSetNext("Server/Service/Connector/SSLHostConfig/Certificate",</div><div class="line">                        "addCertificate",</div><div class="line">                        "org.apache.tomcat.util.net.SSLHostConfigCertificate");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Service/Connector/Listener",</div><div class="line">                             null, // MUST be specified in the element</div><div class="line">                             "className");</div><div class="line">    digester.addSetProperties("Server/Service/Connector/Listener");</div><div class="line">    digester.addSetNext("Server/Service/Connector/Listener",</div><div class="line">                        "addLifecycleListener",</div><div class="line">                        "org.apache.catalina.LifecycleListener");</div><div class="line"></div><div class="line">    digester.addObjectCreate("Server/Service/Connector/UpgradeProtocol",</div><div class="line">                              null, // MUST be specified in the element</div><div class="line">                              "className");</div><div class="line">    digester.addSetProperties("Server/Service/Connector/UpgradeProtocol");</div><div class="line">    digester.addSetNext("Server/Service/Connector/UpgradeProtocol",</div><div class="line">                        "addUpgradeProtocol",</div><div class="line">                        "org.apache.coyote.UpgradeProtocol");</div><div class="line"></div><div class="line">    // Add RuleSets for nested elements</div><div class="line">    digester.addRuleSet(new NamingRuleSet("Server/GlobalNamingResources/"));</div><div class="line">    digester.addRuleSet(new EngineRuleSet("Server/Service/"));</div><div class="line">    digester.addRuleSet(new HostRuleSet("Server/Service/Engine/"));</div><div class="line">    digester.addRuleSet(new ContextRuleSet("Server/Service/Engine/Host/"));</div><div class="line">    addClusterRuleSet(digester, "Server/Service/Engine/Host/Cluster/");</div><div class="line">    digester.addRuleSet(new NamingRuleSet("Server/Service/Engine/Host/Context/"));</div><div class="line"></div><div class="line">    // When the 'engine' is found, set the parentClassLoader.</div><div class="line">    digester.addRule("Server/Service/Engine",</div><div class="line">                     new SetParentClassLoaderRule(parentClassLoader));</div><div class="line">    addClusterRuleSet(digester, "Server/Service/Engine/Cluster/");</div><div class="line"></div><div class="line">    long t2=System.currentTimeMillis();</div><div class="line">    if (log.isDebugEnabled()) &#123;</div><div class="line">        log.debug("Digester for server.xml created " + ( t2-t1 ));</div><div class="line">    &#125;</div><div class="line">    return digester;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/tomcat_1/" class="archive-article-date">
  	<time datetime="2017-07-22T13:37:37.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/">Tomcat</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Tomcat/">Tomcat</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-mesos_installation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/mesos_installation/">Mesos</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Mesos-Installation"><a href="#Mesos-Installation" class="headerlink" title="Mesos Installation"></a>Mesos Installation</h2><p><img src="/images/mesos_1.png" alt=""></p>
<p>获取Mesos源码或者tar包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ wget http://www.apache.org/dist/mesos/0.28.2/mesos-0.28.2.tar.gz</div><div class="line">$ tar -zxf mesos-0.28.2.tar.gz</div><div class="line">$ git <span class="built_in">clone</span> https://git-wip-us.apache.org/repos/asf/mesos.git</div></pre></td></tr></table></figure></p>
<p>Mesos 安装（Ubuntu14.04）：</p>
<h4 id="Update-the-packages"><a href="#Update-the-packages" class="headerlink" title="Update the packages."></a>Update the packages.</h4><p>$ sudo apt-get update</p>
<h4 id="Install-a-few-utility-tools"><a href="#Install-a-few-utility-tools" class="headerlink" title="Install a few utility tools."></a>Install a few utility tools.</h4><p>$ sudo apt-get install -y tar wget git</p>
<h4 id="Install-the-latest-OpenJDK"><a href="#Install-the-latest-OpenJDK" class="headerlink" title="Install the latest OpenJDK."></a>Install the latest OpenJDK.</h4><p>$ sudo apt-get install -y openjdk-7-jdk</p>
<h4 id="Install-autotools-Only-necessary-if-building-from-git-repository"><a href="#Install-autotools-Only-necessary-if-building-from-git-repository" class="headerlink" title="Install autotools (Only necessary if building from git repository)."></a>Install autotools (Only necessary if building from git repository).</h4><p>$ sudo apt-get install -y autoconf libtool</p>
<h4 id="Install-other-Mesos-dependencies"><a href="#Install-other-Mesos-dependencies" class="headerlink" title="Install other Mesos dependencies."></a>Install other Mesos dependencies.</h4><p>$ sudo apt-get -y install build-essential python-dev libcurl4-nss-dev libsasl2-dev libsasl2-modules maven libapr1-dev libsvn-dev</p>
<p>Building Mesos(如果下载了tar.gz的Mesos包，此步可以被跳过)：</p>
<h4 id="Change-working-directory"><a href="#Change-working-directory" class="headerlink" title="Change working directory."></a>Change working directory.</h4><p>$ cd mesos</p>
<h4 id="Bootstrap-Only-required-if-building-from-git-repository"><a href="#Bootstrap-Only-required-if-building-from-git-repository" class="headerlink" title="Bootstrap (Only required if building from git repository)."></a>Bootstrap (Only required if building from git repository).</h4><p>$ ./bootstrap</p>
<h4 id="Configure-and-build"><a href="#Configure-and-build" class="headerlink" title="Configure and build."></a>Configure and build.</h4><p>$ mkdir build<br>$ cd build<br>$ ../configure<br>$ make</p>
<h4 id="Run-test-suite"><a href="#Run-test-suite" class="headerlink" title="Run test suite."></a>Run test suite.</h4><p>$ make check</p>
<h4 id="Install-Optional"><a href="#Install-Optional" class="headerlink" title="Install (Optional)."></a>Install (Optional).</h4><p>$ make install</p>
<h3 id="搭建Mesos-Cluster命令："><a href="#搭建Mesos-Cluster命令：" class="headerlink" title="搭建Mesos Cluster命令："></a>搭建Mesos Cluster命令：</h3><h4 id="Change-into-build-directory"><a href="#Change-into-build-directory" class="headerlink" title="Change into build directory."></a>Change into build directory.</h4><p>$ cd build</p>
<h4 id="Start-mesos-master-Ensure-work-directory-exists-and-has-proper-permissions"><a href="#Start-mesos-master-Ensure-work-directory-exists-and-has-proper-permissions" class="headerlink" title="Start mesos master (Ensure work directory exists and has proper permissions)."></a>Start mesos master (Ensure work directory exists and has proper permissions).</h4><p>$ ./bin/mesos-master.sh —ip=$(ip) –work_dir=/var/lib/mesos</p>
<h4 id="Start-mesos-agent"><a href="#Start-mesos-agent" class="headerlink" title="Start mesos agent."></a>Start mesos agent.</h4><p>$ ./bin/mesos-agent.sh —master=$(master_ip):5050 –work_dir=/var/lib/mesos</p>
<h4 id="Visit-the-mesos-web-page"><a href="#Visit-the-mesos-web-page" class="headerlink" title="Visit the mesos web page."></a>Visit the mesos web page.</h4><p>$ <a href="http://$(master_ip):5050" target="_blank" rel="external">http://$(master_ip):5050</a></p>
<h4 id="Run-C-framework-Exits-after-successfully-running-some-tasks"><a href="#Run-C-framework-Exits-after-successfully-running-some-tasks" class="headerlink" title="Run C++ framework (Exits after successfully running some tasks.)."></a>Run C++ framework (Exits after successfully running some tasks.).</h4><p>$ ./src/test-framework –master=$(master_ip):5050</p>
<h4 id="Run-Java-framework-Exits-after-successfully-running-some-tasks"><a href="#Run-Java-framework-Exits-after-successfully-running-some-tasks" class="headerlink" title="Run Java framework (Exits after successfully running some tasks.)."></a>Run Java framework (Exits after successfully running some tasks.).</h4><p>$ ./src/examples/java/test-framework $(master_ip):5050</p>
<h4 id="Run-Python-framework-Exits-after-successfully-running-some-tasks"><a href="#Run-Python-framework-Exits-after-successfully-running-some-tasks" class="headerlink" title="Run Python framework (Exits after successfully running some tasks.)."></a>Run Python framework (Exits after successfully running some tasks.).</h4><p>$ ./src/examples/python/test-framework $(master_ip):5050</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/mesos_installation/" class="archive-article-date">
  	<time datetime="2017-07-22T13:30:47.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mesos/">Mesos</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Mesos/">Mesos</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-kubernetes_1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/kubernetes_1/">kubernetes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><h3 id="Kubernetes组件功能介绍："><a href="#Kubernetes组件功能介绍：" class="headerlink" title="Kubernetes组件功能介绍："></a>Kubernetes组件功能介绍：</h3><ul>
<li>kube-apiserver：作为kubernetes系统的入口，封装了核心对象的增删改查操作，以RESTFul接口方式提供给外部客户和内部组件调用。它维护的REST对象将持久化到etcd（一个分布式强一致性的key/value存储）。</li>
<li>kube-scheduler：负责集群的资源调度，为新建的pod分配机器。这部分工作分出来变成一个组件，意味着可以很方便地替换成其他的调度器。</li>
<li><p>kube-controller-manager：负责执行各种控制器，目前有两类：</p>
<ul>
<li>endpoint-controller：定期关联service和pod(关联信息由endpoint对象维护)，保证service到pod的映射总是最新的。</li>
<li>replication-controller：定期关联replicationController和pod，保证replicationController定义的复制数量与实际运行pod的数量总是一致的。</li>
</ul>
</li>
<li>kube-proxy：负责为pod提供代理。它会定期从etcd获取所有的service，并根据service信息创建代理。当某个客户pod要访问其他pod时，访问请求会经过本机proxy做转发。</li>
<li>kubelet：负责管控docker容器，如启动/停止、监控运行状态等。它会定期从etcd获取分配到本机的pod，并根据pod信息启动或停止相应的容器。同时，它也会接收apiserver的HTTP请求，汇报pod的运行状态。</li>
</ul>
<h3 id="Kubernetes安装过程中注意事项："><a href="#Kubernetes安装过程中注意事项：" class="headerlink" title="Kubernetes安装过程中注意事项："></a>Kubernetes安装过程中注意事项：</h3><p>1.Kubernetes解压之后，进入kubernetes/server目录下，再次解压kubernetes-server-linux-amd64.tar.gz文件，再进入kubernetes/server/kubernetes/server/bin目录下，才能发现kubernetes对应的很多命令。<br>2.命令list：<br>Master：<br>./etcd &gt; /var/log/etcd.log 2&gt;&amp;1 &amp;<br>./kube-apiserver  –insecure-bind-address=9.21.62.27 –insecure-port=8080 –service-cluster-ip-range=172.17.0.0/16 –etcd_servers=<a href="http://127.0.0.1:4001" target="_blank" rel="external">http://127.0.0.1:4001</a> –logtostderr=true –v=0 –log_dir=/home/kubernetes/logs/kube</p>
<p>./kube-controller-manager –v=0 –logtostderr=false –log_dir=/var/log/kube  –master=9.21.62.27:8080<br>./kube-scheduler  –master=’9.21.62.27:8080’   –v=0    –log_dir=/var/log/kube<br>Slave:<br>./kube-proxy  –logtostderr=false    –v=0     –master=<a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a><br>./kubelet  –logtostderr=false –v=0 –allow-privileged=false  –log_dir=/var/log/kube  –address=0.0.0.0  –port=10250 –hostname_override=172.30.13.0  –api_servers=<a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a><br>Test: ./kubectl -s <a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a> get services</p>
<p>创建kubernetes Dashboard：./kubectl -s <a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a> create -f ../../../../cluster/addons/dashboard/dashboard-service.yaml  –namespace=kube-system<br>访问地址为： <a href="http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/dashboard/" target="_blank" rel="external">http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/dashboard/</a></p>
<p>基于influxdb,grafana,heapster创建日志分析性能监控：  ./kubectl -s <a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a> create -f ../../../../../kubernetes/cluster/addons/cluster-monitoring/influxdb/</p>
<p>显示cluster-info信息：<br>./kubectl -s <a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a> –namespace=”kube-system”   cluster-info<br>Kubernetes master is running at <a href="http://9.21.62.27:8080" target="_blank" rel="external">http://9.21.62.27:8080</a><br>Heapster is running at <a href="http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/heapster" target="_blank" rel="external">http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/heapster</a><br>Grafana is running at <a href="http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana" target="_blank" rel="external">http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana</a><br>InfluxDB is running at <a href="http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb" target="_blank" rel="external">http://9.21.62.27:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb</a></p>
<h2 id="Kubernetes安装："><a href="#Kubernetes安装：" class="headerlink" title="Kubernetes安装："></a>Kubernetes安装：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cmd/kube-dns</div><div class="line">cmd/kube-proxy</div><div class="line">cmd/kube-apiserver</div><div class="line">cmd/kube-controller-manager</div><div class="line">cmd/kubelet</div><div class="line">cmd/kubeadm</div><div class="line">cmd/hyperkube</div><div class="line">cmd/kube-discovery</div><div class="line">plugin/cmd/kube-scheduler</div></pre></td></tr></table></figure>
<h3 id="方式一：-通过Docker在本地来安装Kubernetes-Single-node-Kubernetes-cluster-using-Docker"><a href="#方式一：-通过Docker在本地来安装Kubernetes-Single-node-Kubernetes-cluster-using-Docker" class="headerlink" title="方式一：  通过Docker在本地来安装Kubernetes, Single node Kubernetes cluster using Docker."></a>方式一：  通过Docker在本地来安装Kubernetes, Single node Kubernetes cluster using Docker.</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> K8S_VERSION=$(curl -sS https://storage.googleapis.com/kubernetes-release/release/stable.txt)</div><div class="line"><span class="built_in">export</span> ARCH=amd64</div><div class="line">docker run -d \</div><div class="line">    --volume=/:/rootfs:ro \</div><div class="line">    --volume=/sys:/sys:rw \</div><div class="line">    --volume=/var/lib/docker/:/var/lib/docker:rw \</div><div class="line">    --volume=/var/lib/kubelet/:/var/lib/kubelet:rw \</div><div class="line">    --volume=/var/run:/var/run:rw \</div><div class="line">    --net=host \</div><div class="line">    --pid=host \</div><div class="line">    --privileged \</div><div class="line">    gcr.io/google_containers/hyperkube-<span class="variable">$&#123;ARCH&#125;</span>:<span class="variable">$&#123;K8S_VERSION&#125;</span> \</div><div class="line">    /hyperkube kubelet \</div><div class="line">        --containerized \</div><div class="line">        --hostname-override=127.0.0.1 \</div><div class="line">        --api-servers=http://localhost:8080 \</div><div class="line">        --config=/etc/kubernetes/manifests \</div><div class="line">        --allow-privileged --v=2</div></pre></td></tr></table></figure>
<p>安装kubectl：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -sSL <span class="string">"http://storage.googleapis.com/kubernetes-release/release/v1.2.0/bin/linux/amd64/kubectl"</span> &gt; /usr/bin/kubectl</div><div class="line">chmod +x /usr/bin/kubectl</div></pre></td></tr></table></figure></p>
<p>通过kubectl来配置本地kubernetes cluster：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl config <span class="built_in">set</span>-cluster <span class="built_in">test</span>-doc --server=http://localhost:8080</div><div class="line">kubectl config <span class="built_in">set</span>-context <span class="built_in">test</span>-doc --cluster=<span class="built_in">test</span>-doc</div><div class="line">kubectl config use-context <span class="built_in">test</span>-doc</div></pre></td></tr></table></figure></p>
<p>Test本地Cluster：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl get nodes</div><div class="line">Run an application：</div><div class="line">kubectl run nginx --image=nginx --port=80</div></pre></td></tr></table></figure></p>
<h3 id="方式二：通过Minikube在本地创建Kubernetes-Cluster"><a href="#方式二：通过Minikube在本地创建Kubernetes-Cluster" class="headerlink" title="方式二：通过Minikube在本地创建Kubernetes Cluster"></a>方式二：通过Minikube在本地创建Kubernetes Cluster</h3><ol>
<li>机器必须支持虚拟化：<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /proc/cpuinfo | grep <span class="string">'vmx\|svm'</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>2.需要安装VirtualBox环境：<br>ubuntu14.04:   wget <a href="http://download.virtualbox.org/virtualbox/5.0.22/virtualbox-5.0_5.0.22-108108~Ubuntu~trusty_amd64.deb" target="_blank" rel="external">http://download.virtualbox.org/virtualbox/5.0.22/virtualbox-5.0_5.0.22-108108~Ubuntu~trusty_amd64.deb</a><br>Redhat 7.1: wget <a href="http://download.virtualbox.org/virtualbox/5.0.22/VirtualBox-5.0-5.0.22_108108_el7-1.x86_64.rpm" target="_blank" rel="external">http://download.virtualbox.org/virtualbox/5.0.22/VirtualBox-5.0-5.0.22_108108_el7-1.x86_64.rpm</a><br>3.本地利用virtualbox搭建Kubernetes Cluster：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">minikube start</div><div class="line">kubectl get pods --all-namespaces</div><div class="line">minikube dashboard</div></pre></td></tr></table></figure></p>
<p>4.Test 搭建的环境：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get nodes</div></pre></td></tr></table></figure></p>
<h3 id="方式三：Installation-Kubernetes-Locally-with-No-VM："><a href="#方式三：Installation-Kubernetes-Locally-with-No-VM：" class="headerlink" title="方式三：Installation Kubernetes Locally with No VM："></a>方式三：Installation Kubernetes Locally with No VM：</h3><p>Requirements:<br>Docker 1.8.3+ : <a href="https://docs.docker.com/engine/installation/#installation" target="_blank" rel="external">https://docs.docker.com/engine/installation/#installation</a><br>etcd : <a href="https://github.com/coreos/etcd/releases" target="_blank" rel="external">https://github.com/coreos/etcd/releases</a><br>go : <a href="https://golang.org/doc/install" target="_blank" rel="external">https://golang.org/doc/install</a></p>
<p>etcd安装与Test：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -L  https://github.com/coreos/etcd/releases/download/v2.3.7/etcd-v2.3.7-linux-amd64.tar.gz -o etcd-v2.3.7-linux-amd64.tar.gz</div><div class="line">tar xzvf etcd-v2.3.7-linux-amd64.tar.gz</div><div class="line"><span class="built_in">cd</span> etcd-v2.3.7-linux-amd64</div><div class="line">./etcd</div></pre></td></tr></table></figure></p>
<p>Open another terminal:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./etcdctl <span class="built_in">set</span> mykey <span class="string">"this is awesome"</span></div><div class="line">./etcdctl get mykey</div><div class="line"></div><div class="line">docker run --name etcd quay.io/coreos/etcd:v2.3.7</div><div class="line">docker <span class="built_in">exec</span> etcd /etcdctl <span class="built_in">set</span> foo bar</div><div class="line"></div><div class="line">rkt run --volume data-dir,kind=host,<span class="built_in">source</span>=/tmp --mds-register=<span class="literal">false</span> coreos.com/etcd:v2.3.7</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/kubernetes_1/" class="archive-article-date">
  	<time datetime="2017-07-22T09:27:18.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-22</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/容器技术/">容器技术</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-docker_1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/docker_1/">Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="Docker-内核特性"><a href="#Docker-内核特性" class="headerlink" title="Docker 内核特性"></a>Docker 内核特性</h3><p>容器 ＝ Cgroup ＋ Namespace ＋ rootfs ＋ 容器引擎</p>
<p><strong>Docker 内核特性：</strong></p>
<ol>
<li>Namespace：访问隔离。</li>
<li>Cgroup：资源控制。</li>
<li>rootfs：文件系统隔离。</li>
<li>容器引擎：生命周期控制。</li>
</ol>
<h4 id="Cgroup-实现子系统："><a href="#Cgroup-实现子系统：" class="headerlink" title="Cgroup 实现子系统："></a>Cgroup 实现子系统：</h4><p>1.devices：设备权限控制。<br>2.cpuset：分配制定的CPU和内存节点。<br>3.cpu：控制CPU占用率。<br>4.cpuacct：统计CPU使用情况。<br>5.memory：限制内存的使用上限。<br>6.freezer：冻结（暂停）Cgroup中的进程。<br>7.net_cls：配合tc（traffic controller）限制网络带宽。<br>8.net_prio：设置进程的网络流量优先级。<br>9.huge_tlb：限制HugeTLB的使用。<br>10.perf_event：运行Perf工具基于Cgroup分组做性能检测。</p>
<h4 id="Linux内核中的6种Namespace："><a href="#Linux内核中的6种Namespace：" class="headerlink" title="Linux内核中的6种Namespace："></a>Linux内核中的6种Namespace：</h4><p>1.IPC：隔离System V IPC和POSIX消息队列。<br>2.Network：隔离网络资源。<br>3.Mount：隔离文件系统挂载点。<br>4.PID：隔离进程ID。<br>5.UTS：隔离主机名和域名。<br>6.User：隔离用户ID和组ID。</p>
<h3 id="Docker-镜像命令"><a href="#Docker-镜像命令" class="headerlink" title="Docker 镜像命令"></a>Docker 镜像命令</h3><p>Docker镜像：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">docker images</div><div class="line">docker images --<span class="built_in">help</span>, docker images --filter</div><div class="line">docker search image-name</div><div class="line">dockviz images -t    需要先调用：<span class="built_in">alias</span> dockviz=<span class="string">"docker run --rm -v /var/run/docker.sock:/var/run/docker.sock nate/dockviz"</span></div><div class="line">docker pull image-name     下载镜像</div><div class="line">docker save -o image-name.tar image-name   导出镜像</div><div class="line">docker load -i image-name.tar      导入镜像</div><div class="line">docker inspect image-name          查看容器和镜像详细信息</div><div class="line">docker commit           增量式的生产镜像</div><div class="line">docker <span class="built_in">history</span> image-name           查看image layer纪录</div><div class="line">docker push           上传镜像   （docker push localhost:5000/official/ubuntu:14.04）</div></pre></td></tr></table></figure></p>
<p>从image repositories中查看所有images信息： cat /var/lib/docker/image/aufs/repositories.json  | python -m json.tool<br>启动Docker daemon，测试image layer之间的关系：docker daemon -D -s overlay -g /var/lib/docker/</p>
<h3 id="部署docker私有仓库："><a href="#部署docker私有仓库：" class="headerlink" title="部署docker私有仓库："></a>部署docker私有仓库：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d --hostname localhost --name registry-v2 -v /opt/data/distribution:/var/lib/registry/docker/registry/v2 -p 5000:5000 registry:2.0</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">向私有仓库push image：</div><div class="line">docker tag [OPTIONS] IMAGE[:TAG] [REGISTRYHOST/][USERNAME/]NAME[:TAG]</div><div class="line">docker push NAME[:TAG]</div><div class="line">docker tag 8dbd9e392a96 localhost.localdomain:5000/ubuntu</div><div class="line">docker push localhost.localdomain:5000/ubuntu</div><div class="line">docker pull localhost:5000/ubuntu</div><div class="line">docker stop registry &amp;&amp; docker rm -v registry</div><div class="line">验证私有仓库：curl -X GET http://localhost:5000/v2/</div><div class="line">查找镜像： curl -X GET http://localhost:5000/v2/foo/bar/tags/list  </div><div class="line">     例如：  curl -X GET http://localhost:5000/v2/busybox/tags/list</div><div class="line">            &#123;<span class="string">"name"</span>:<span class="string">"busybox"</span>,<span class="string">"tags"</span>:[<span class="string">"latest"</span>]&#125;</div><div class="line">     通过tags查找manifest： curl -X GET http://localhost:5000/v2/busybox/manifests/latest</div><div class="line">创建带Auth的私有仓库：</div><div class="line">docker run -d -p 5000:5000 --restart=always --name registry</div><div class="line">     \ -v `<span class="built_in">pwd</span>`/auth:/auth</div><div class="line">     \-e<span class="string">"REGISTRY_AUTH=htpasswd"</span></div><div class="line">     \-e<span class="string">"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"</span></div><div class="line">     \-eREGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd</div><div class="line">     \ -v `<span class="built_in">pwd</span>`/certs:/certs</div><div class="line">     \-eREGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt</div><div class="line">     \-eREGISTRY_HTTP_TLS_KEY=/certs/domain.key</div><div class="line">     \ registry:2</div><div class="line">登录registry：docker login myregistrydomain.com:5000</div><div class="line">registry yml文件内容：</div><div class="line">registry:</div><div class="line">     restart:always</div><div class="line">     image:registry:2</div><div class="line">     ports:</div><div class="line">          -5000:5000</div><div class="line">     environment:</div><div class="line">          REGISTRY_HTTP_TLS_CERTIFICATE:/certs/domain.crt</div><div class="line">          REGISTRY_HTTP_TLS_KEY:/certs/domain.key</div><div class="line">          REGISTRY_AUTH:htpasswd</div><div class="line">          REGISTRY_AUTH_HTPASSWD_PATH:/auth/htpasswd</div><div class="line">          REGISTRY_AUTH_HTPASSWD_REALM:Registry Realm</div><div class="line">     volumes:</div><div class="line">          -/path/data:/var/lib/registry</div><div class="line">          -/path/certs:/certs</div><div class="line">          -/path/auth:/auth</div><div class="line">docker-compose up -d</div></pre></td></tr></table></figure>
<h3 id="Build-my-own-Docker-image"><a href="#Build-my-own-Docker-image" class="headerlink" title="Build my own Docker image:"></a>Build my own Docker image:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1.Write a Dockerfile:</div><div class="line">FROM docker/whalesay:latest</div><div class="line">RUN apt-get -y update &amp;&amp; apt-get install -y fortunes</div><div class="line">CMD /usr/games/fortune -a | cowsay</div><div class="line">2.Build an image from my Dockerfile:</div><div class="line">docker build -t docker-whale .</div><div class="line">3.Run new docker-whale:</div><div class="line">docker images</div><div class="line">docker run docker-whale</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/docker_1/" class="archive-article-date">
  	<time datetime="2017-07-20T15:13:06.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/容器技术/">容器技术</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-lxcfs(FUSE)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/lxcfs(FUSE)/">容器技术 lxcfs(FUSE文件系统)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="LXCFS"><a href="#LXCFS" class="headerlink" title="LXCFS"></a>LXCFS</h3><p>refer: <a href="https://linuxcontainers.org/lxcfs/introduction/" target="_blank" rel="external">https://linuxcontainers.org/lxcfs/introduction/</a><br>refer :   <a href="http://www.voidcn.com/blog/kc58236582/article/p-4505115.html" target="_blank" rel="external">http://www.voidcn.com/blog/kc58236582/article/p-4505115.html</a></p>
<h3 id="FUSE-Filesystem-in-Userspace"><a href="#FUSE-Filesystem-in-Userspace" class="headerlink" title="FUSE :  Filesystem in Userspace"></a>FUSE :  Filesystem in Userspace</h3><p><img src="/images/fuse_1.png" alt=""></p>
<p><img src="/images/fuse_2.png" alt=""></p>
<p><img src="/images/fuse_3.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/lxcfs(FUSE)/" class="archive-article-date">
  	<time datetime="2017-07-20T15:09:06.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lxcfs/">lxcfs</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/容器技术/">容器技术</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-lxc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/lxc/">容器技术 lxc</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="LXC"><a href="#LXC" class="headerlink" title="LXC"></a>LXC</h3><p>LXC is a userspace interface for the Linux kernel containment features.Through a powerful API and simple tools, it lets Linux users easily create and manage system or application containers.</p>
<h3 id="online-try"><a href="#online-try" class="headerlink" title="online try"></a>online try</h3><p>online try: <a href="https://linuxcontainers.org/lxd/try-it/" target="_blank" rel="external">https://linuxcontainers.org/lxd/try-it/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@tryit-vast:/proc<span class="comment"># lxc launch ubuntu:16.04 first  </span></div><div class="line"></div><div class="line">root@tryit-vast:/proc<span class="comment"># lxc launch ubuntu:16.04 first                                                          </span></div><div class="line">Creating first   </div><div class="line">Retrieving image: rootfs: 100% (139.92MB/s)        </div><div class="line">Starting first            </div><div class="line">root@tryit-vast:/proc<span class="comment">#</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@tryit-vast:/proc<span class="comment"># lxc list                                                         </span></div><div class="line">+-------+---------+---------------------+----------------------------------------------+------------+-----------+               </div><div class="line">| NAME  |  STATE  |        IPV4         |                     IPV6                     |    TYPE    | SNAPSHOTS |                                                           </div><div class="line">+-------+---------+---------------------+----------------------------------------------+------------+-----------+               </div><div class="line">| first | RUNNING | 10.59.94.107 (eth0) | 2001:470:b368:1070:216:3eff:fee3:b5ae (eth0) | PERSISTENT | 0         |                                                           </div><div class="line">+-------+---------+---------------------+----------------------------------------------+------------+-----------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">root@tryit-vast:/proc<span class="comment"># lxc  info  first</span></div><div class="line"></div><div class="line">root@tryit-vast:/proc<span class="comment"># lxc config show first</span></div><div class="line"></div><div class="line">root@tryit-vast:/proc<span class="comment"># lxc remote list           </span></div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+                                </div><div class="line">|      NAME       |                   URL                    |   PROTOCOL    | PUBLIC | STATIC |</div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+                                </div><div class="line">| images          | https://images.linuxcontainers.org       | simplestreams | YES    | NO     |</div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+                                </div><div class="line">| <span class="built_in">local</span> (default) | unix://                                  | lxd           | NO     | YES    |</div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+                                </div><div class="line">| ubuntu          | https://cloud-images.ubuntu.com/releases | simplestreams | YES    | YES    |</div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+                                </div><div class="line">| ubuntu-daily    | https://cloud-images.ubuntu.com/daily    | simplestreams | YES    | YES    |</div><div class="line">+-----------------+------------------------------------------+---------------+--------+--------+</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/lxc/" class="archive-article-date">
  	<time datetime="2017-07-20T15:03:39.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lxc/">lxc</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/容器技术/">容器技术</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-虚拟化QEMU" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/虚拟化QEMU/">虚拟化QEMU</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><p>神人 Fabrice Bellard最开始创立： <a href="https://bellard.org/" target="_blank" rel="external">https://bellard.org/</a><br>refer :  <a href="https://wiki.archlinux.org/index.php/QEMU_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">https://wiki.archlinux.org/index.php/QEMU_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87</a>)</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>创建硬盘镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ qemu-img create -f raw image_file 4G</div></pre></td></tr></table></figure></p>
<p>执行 qemu-img 带 resize 选项调整硬盘驱动镜像的大小.它适用于 raw 和 qcow2. 例如, 增加镜像 10 GB 大小, 运行:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ qemu-img resize disk_image +10G</div></pre></td></tr></table></figure></p>
<p>qemu-system-* 程序 (例如 qemu-system-i386 或 qemu-system-x86_64, 取决于客户机架构)用来运行虚拟化的客户机. 用法是:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ qemu-system-i386 options disk_image</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/虚拟化QEMU/" class="archive-article-date">
  	<time datetime="2017-07-20T14:58:25.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/虚拟化/">虚拟化</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-虚拟化Libvirt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/虚拟化Libvirt/">虚拟化Libvirt</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Libvirt"><a href="#Libvirt" class="headerlink" title="Libvirt"></a>Libvirt</h3><p>refer :  <a href="https://wiki.archlinux.org/index.php/libvirt_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">https://wiki.archlinux.org/index.php/libvirt_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87</a>)<br>refer :  <a href="https://www.ibm.com/developerworks/cn/linux/l-libvirt/index.html" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-libvirt/index.html</a></p>
<h3 id="Libvirt架构"><a href="#Libvirt架构" class="headerlink" title="Libvirt架构"></a>Libvirt架构</h3><p><img src="/images/libvirt_1.png" alt=""></p>
<h3 id="Libvirtd"><a href="#Libvirtd" class="headerlink" title="Libvirtd"></a>Libvirtd</h3><p><img src="/images/libvirt_2.png" alt=""></p>
<h3 id="Libvirt-Driver"><a href="#Libvirt-Driver" class="headerlink" title="Libvirt Driver"></a>Libvirt Driver</h3><p><img src="/images/libvirt_3.png" alt=""></p>
<h3 id="libvirt-支持的Driver程序"><a href="#libvirt-支持的Driver程序" class="headerlink" title="libvirt 支持的Driver程序"></a>libvirt 支持的Driver程序</h3><ul>
<li>Xen    面向 IA-32，IA-64 和 PowerPC 970 架构的虚拟机监控程序</li>
<li>QEMU    面向各种架构的平台仿真器</li>
<li>Kernel-based Virtual Machine (KVM)    Linux 平台仿真器</li>
<li>Linux Containers（LXC）    用于操作系统虚拟化的 Linux（轻量级）容器</li>
<li>OpenVZ    基于 Linux 内核的操作系统级虚拟化</li>
<li>VirtualBox    x86 虚拟化虚拟机监控程序</li>
<li>User Mode Linux    面向各种架构的 Linux 平台仿真器</li>
<li>Storage    存储池驱动器（本地磁盘，网络磁盘，iSCSI 卷）</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/虚拟化Libvirt/" class="archive-article-date">
  	<time datetime="2017-07-20T14:53:41.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Libvirt/">Libvirt</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/虚拟化/">虚拟化</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Maven" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Maven/">Maven</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="使用maven创建一个project："><a href="#使用maven创建一个project：" class="headerlink" title="使用maven创建一个project："></a>使用maven创建一个project：</h3><p>mvn archetype:generate -DgroupId=com.mycompany.app -DartifactId=my-app -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false<br>groupId 指: project名称，及生成的war包名称。<br>artifactId 指: 不携带version的war包名称。</p>
<p>Build project：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package</div></pre></td></tr></table></figure></p>
<h3 id="Running-Maven-Tools"><a href="#Running-Maven-Tools" class="headerlink" title="Running Maven Tools:"></a>Running Maven Tools:</h3><p>Maven Phases:</p>
<ul>
<li>validate: validate the project is correct and all necessary information is available</li>
<li>compile: compile the source code of the project</li>
<li>test: test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed</li>
<li>package: take the compiled code and package it in its distributable format, such as a JAR.</li>
<li>integration-test: process and deploy the package if necessary into an environment where integration tests can be run</li>
<li>verify: run any checks to verify the package is valid and meets quality criteria</li>
<li>install: install the package into the local repository, for use as a dependency in other projects locally</li>
<li>deploy: done in an integration or release environment, copies the final package to the remote repository for sharing with other developers and projects.</li>
</ul>
<p>There are two other Maven lifecycles of note beyond the default list above</p>
<ul>
<li>clean: cleans up artifacts created by prior builds</li>
<li>site: generates site documentation for this project</li>
</ul>
<p>Detail usage: <a href="http://maven.apache.org/guides/getting-started/index.html" target="_blank" rel="external">http://maven.apache.org/guides/getting-started/index.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Maven/" class="archive-article-date">
  	<time datetime="2017-07-20T14:24:08.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maven/">Maven</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Special File System" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Special File System/">Linux Special File System</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Pseudo-and-virtual-file-systems"><a href="#Pseudo-and-virtual-file-systems" class="headerlink" title="Pseudo- and virtual file systems"></a>Pseudo- and virtual file systems</h3><ul>
<li>devfs – Virtual file system in Unix-like operating systems for managing devices on-the-fly</li>
<li>debugfs –Virtual file system in Linux for accessing and controlling kernel debugging.</li>
<li>procfs – Pseudo-file system, used to access kernel information about processes</li>
<li>tmpfs – in-memory temporary file system (on Linux platforms).</li>
<li>specfs – Special File System for device files</li>
<li>sysfs – Virtual file system in Unix-like operating systems holding information about buses, devices, firmware, filesystems, etc.</li>
<li>wikifs – a server application for Plan 9’s virtual, wiki, file system</li>
<li>WinFS – Windows Future Storage, was planned as the successor to NTFS for Windows Vista.</li>
</ul>
<h3 id="File-system-interfaces"><a href="#File-system-interfaces" class="headerlink" title="File system interfaces"></a>File system interfaces</h3><p>These are not really file systems; they allow access to file systems from an operating system standpoint.</p>
<ul>
<li>FUSE (file system in userspace, like LUFS but better maintained)</li>
<li>LUFS (Linux userland file system – seems to be abandoned in favour of FUSE)</li>
<li>VFS Virtual Filesystem</li>
<li>Callback File System – the SDK to build custom filesystems and plug them to Windows OS.</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Special File System/" class="archive-article-date">
  	<time datetime="2017-07-20T14:22:05.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Special-File-System/">Linux Special File System</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-JVM" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/JVM/">JVM 源码阅读(OpenJDK8)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Java-启动执行的源代码跟踪-OpenJDK8"><a href="#Java-启动执行的源代码跟踪-OpenJDK8" class="headerlink" title="Java 启动执行的源代码跟踪(OpenJDK8)"></a>Java 启动执行的源代码跟踪(OpenJDK8)</h2><p>main.c —&gt; java.c(JLI_Launch函数) 文件:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">1. CreateExecutionEnvironment    ==&gt;    GetJREPath   +   GetJVMPath  </div><div class="line">            GetJREPath   :    获取 libjava.so 文件路径,  赋值给 jrepath .</div><div class="line">            GetJVMPath  :   获取  libjvm.dylib  文件路径, 赋值给 jvmpath.</div><div class="line">2. LoadJavaVM     ==&gt;      libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);            加载链接文件 libjvm.dylib,  将以下3个函数指向链接文件中的函数</div><div class="line">                                           CreateJavaVM = (CreateJavaVM_t)dlsym(libjvm, <span class="string">"JNI_CreateJavaVM”);           </span></div><div class="line">                                              GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)dlsym(libjvm, "JNI_GetDefaultJavaVMInitArgs”);</div><div class="line">                                              GetCreatedJavaVMs = (GetCreatedJavaVMs_t)dlsym(libjvm, <span class="string">"JNI_GetCreatedJavaVMs"</span>);</div><div class="line">3. SetJavaCommandLineProp       ==&gt;    JLI_StrCCmp(str, <span class="string">"-Xss”)  JLI_StrCCmp(str, "</span>-Xmx”)  JLI_StrCCmp(str, <span class="string">"-Xms”)       jvm 堆栈大小</span></div><div class="line">4. JVMInit   ==&gt;   ContinueInNewThread(InvocationFunctions* ifn)</div><div class="line">                                                ==&gt;   ifn-&gt;GetDefaultJavaVMInitArgs(&amp;args1_1);</div><div class="line">                                                    ==&gt;    ContinueInNewThread0(JavaMain, threadStackSize, (void*)&amp;args);   create new thread, and execute JavaMain function</div><div class="line">                                                     主要函数:  ==&gt;   JavaMain  函数   执行下列过程</div><div class="line"> JavaMain  函数     ==&gt;   RegisterThread()  +  InitializeJVM(&amp;vm, &amp;env, &amp;ifn) &#123; =&gt; (ifn-&gt;CreateJavaVM(pvm, (void **)penv, &amp;args);) &#125;   +  LoadMainClass(env, mode, what)   +  GetApplicationClass(env)  +  PostJVMInit(env, appClass, vm) (for GUI purpose)</div><div class="line">                        +    mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, "main”, <span class="string">"([Ljava/lang/String;)V”);</span></div><div class="line">          + mainArgs = CreateApplicationArgs(env, argv, argc);                  build platform specific argument array</div><div class="line">          + (*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs);     invoke main thread</div><div class="line">//  InitializeJVM -&gt; CreateJavaVM 函数</div><div class="line">ifn-&gt;CreateJavaVM(pvm, (void **)penv, &amp;args); ==&gt; 会调用 jni.cpp 的 JNI_CreateJavaVM 函数.  </div><div class="line">    JNI_CreateJavaVM   ==&gt;   Threads::create_vm((JavaVMInitArgs*) args, &amp;can_try_again);</div><div class="line"></div><div class="line">// java.c -&gt; LoadMainClass(env, mode, what) 函数 ,  env 为load 进的 jni 函数环境.              通过class loader 取 load class 进来</div><div class="line">==&gt;   jclass cls = GetLauncherHelperClass(env);   </div><div class="line">                   GetLuncherHelperClass 函数会:  return  helperClass = FindBootStrapClass(env, "sun/launcher/LauncherHelper”) load jni: JVM_FindClassFromBootLoader</div><div class="line">==&gt;  NULL_CHECK0(mid = (*env)-&gt;GetStaticMethodID(env, cls,</div><div class="line">                <span class="string">"checkAndLoadMain"</span>,</div><div class="line">                <span class="string">"(ZILjava/lang/String;)Ljava/lang/Class;"</span>));  </div><div class="line">==&gt; str = NewPlatformString(env, name);    str 为组装后的java 启动 main函数类名</div><div class="line">==&gt;  result = (*env)-&gt;CallStaticObjectMethod(env, cls, mid, USE_STDERR, mode, str); 调用 LauncherHelper.java的checkAndLoadMain函数,返回 mainclass.</div><div class="line"></div><div class="line">// java.c  -&gt;  GetApplicationClass(env) 函数</div><div class="line">    /*</div><div class="line">     * In some cases when launching an application that needs a helper, e.g., a</div><div class="line">     * JavaFX application with no main method, the mainClass will not be the</div><div class="line">     * applications own main class but rather a helper class. To keep things</div><div class="line">     * consistent <span class="keyword">in</span> the UI we need to track and report the application main class.</div><div class="line">     */</div><div class="line">==&gt;  jclass cls = GetLauncherHelperClass(env);</div><div class="line">==&gt;   NULL_CHECK0(mid = (*env)-&gt;GetStaticMethodID(env, cls,</div><div class="line">                <span class="string">"getApplicationClass"</span>,</div><div class="line">                <span class="string">"()Ljava/lang/Class;”));</span></div><div class="line">==&gt;  return (*env)-&gt;CallStaticObjectMethod(env, cls, mid);   调用 LauncherHelper.java的getApplicationClass函数,返回 appclass.</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CreateJavaVM_t CreateJavaVM;</div><div class="line">    GetDefaultJavaVMInitArgs_t GetDefaultJavaVMInitArgs;</div><div class="line">    GetCreatedJavaVMs_t GetCreatedJavaVMs;</div><div class="line">&#125; InvocationFunctions;</div></pre></td></tr></table></figure>
<h3 id="JVM-依赖的两个-lib库"><a href="#JVM-依赖的两个-lib库" class="headerlink" title="JVM 依赖的两个 lib库"></a>JVM 依赖的两个 lib库</h3><p>libjava.so<br>libjvm.so</p>
<h3 id="java-class-与-jni-mapping-表"><a href="#java-class-与-jni-mapping-表" class="headerlink" title="java class 与 jni mapping 表"></a>java class 与 jni mapping 表</h3><p>See   openjdk8/hotspot/src/share/vm/classfile/vmSymbols.hpp   </p>
<h3 id="jni-cpp-文件-JNI-CreateJavaVM-函数"><a href="#jni-cpp-文件-JNI-CreateJavaVM-函数" class="headerlink" title="jni.cpp 文件 JNI_CreateJavaVM 函数:"></a>jni.cpp 文件 JNI_CreateJavaVM 函数:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div></pre></td><td class="code"><pre><div class="line">1. HS_DTRACE_PROBE3(hotspot_jni, CreateJavaVM__entry, vm, penv, args);</div><div class="line">2.  result = Threads::create_vm((JavaVMInitArgs*) args, &amp;can_try_again);</div><div class="line">3.    JavaThread *thread = JavaThread::current();</div><div class="line">    /* thread is thread_in_vm here */</div><div class="line">    *vm = (JavaVM *)(&amp;main_vm);</div><div class="line">4.  *(JNIEnv**)penv = thread-&gt;jni_environment();</div><div class="line">    // Tracks the time application was running before GC</div><div class="line">5.  RuntimeService::record_application_start();          track runtime application <span class="keyword">for</span> gc</div><div class="line">    // Notify JVMTI</div><div class="line">6.  <span class="keyword">if</span> (JvmtiExport::should_post_thread_life()) &#123;</div><div class="line">       JvmtiExport::post_thread_start(thread);</div><div class="line">    &#125;</div><div class="line">    EventThreadStart event;</div><div class="line">    <span class="keyword">if</span> (event.should_commit()) &#123;</div><div class="line">7.    event.set_javalangthread(java_lang_Thread::thread_id(thread-&gt;threadObj()));</div><div class="line">      event.commit();</div><div class="line">    &#125;</div><div class="line">    // Check <span class="keyword">if</span> we should compile all classes on bootclasspath</div><div class="line">8.  <span class="keyword">if</span> (CompileTheWorld) ClassLoader::compile_the_world();        <span class="keyword">do</span> compile work</div><div class="line">9.  <span class="keyword">if</span> (ReplayCompiles) ciReplay::replay(thread);                 replay compile work</div><div class="line">    // Since this is not a JVM_ENTRY we have to <span class="built_in">set</span> the thread state manually before leaving.</div><div class="line">10. ThreadStateTransition::transition_and_fence(thread, _thread_in_vm, _thread_in_native);      </div><div class="line"></div><div class="line"></div><div class="line">openjdk8/hotspot/src/share/vm/runtime/thread.cpp:</div><div class="line">thread.cpp 文件 create_vm 函数:</div><div class="line"></div><div class="line">jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) &#123;</div><div class="line"></div><div class="line">  extern void JDK_Version_init();</div><div class="line">  // Check version</div><div class="line">  <span class="keyword">if</span> (!is_supported_jni_version(args-&gt;version)) <span class="built_in">return</span> JNI_EVERSION;</div><div class="line"></div><div class="line">  // Initialize the output stream module</div><div class="line">  ostream_init();</div><div class="line"></div><div class="line">  // Process java launcher properties.</div><div class="line">  Arguments::process_sun_java_launcher_properties(args);</div><div class="line"></div><div class="line">  // Initialize the os module before using TLS</div><div class="line">  os::init();</div><div class="line"></div><div class="line">  // Initialize system properties.</div><div class="line">  Arguments::init_system_properties();</div><div class="line"></div><div class="line">  // So that JDK version can be used as a discrimintor when parsing arguments</div><div class="line">  JDK_Version_init();</div><div class="line"></div><div class="line">  // Update/Initialize System properties after JDK version number is known</div><div class="line">  Arguments::init_version_specific_system_properties();</div><div class="line"></div><div class="line">  // Parse arguments</div><div class="line">  jint parse_result = Arguments::parse(args);        arguments.cpp 文件中, 支持的所以参数都列举在这.</div><div class="line">  <span class="keyword">if</span> (parse_result != JNI_OK) <span class="built_in">return</span> parse_result;</div><div class="line"></div><div class="line">  os::init_before_ergo();</div><div class="line"></div><div class="line">  jint ergo_result = Arguments::apply_ergo();</div><div class="line">  <span class="keyword">if</span> (ergo_result != JNI_OK) <span class="built_in">return</span> ergo_result;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (PauseAtStartup) &#123;</div><div class="line">    os::pause();</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">#ifndef USDT2</span></div><div class="line">  HS_DTRACE_PROBE(hotspot, vm__init__begin);</div><div class="line"><span class="comment">#else /* USDT2 */</span></div><div class="line">  HOTSPOT_VM_INIT_BEGIN();</div><div class="line"><span class="comment">#endif /* USDT2 */</span></div><div class="line"></div><div class="line">  // Record VM creation timing statistics</div><div class="line">  TraceVmCreationTime create_vm_timer;</div><div class="line">  create_vm_timer.start();</div><div class="line"></div><div class="line">  // Timing (must come after argument parsing)</div><div class="line">  TraceTime timer(<span class="string">"Create VM"</span>, TraceStartupTime);</div><div class="line"></div><div class="line">  // Initialize the os module after parsing the args</div><div class="line">  jint os_init_2_result = os::init_2();</div><div class="line">  <span class="keyword">if</span> (os_init_2_result != JNI_OK) <span class="built_in">return</span> os_init_2_result;</div><div class="line"></div><div class="line">  jint adjust_after_os_result = Arguments::adjust_after_os();</div><div class="line">  <span class="keyword">if</span> (adjust_after_os_result != JNI_OK) <span class="built_in">return</span> adjust_after_os_result;</div><div class="line"></div><div class="line">  // intialize TLS</div><div class="line">  ThreadLocalStorage::init();</div><div class="line"></div><div class="line">  // Bootstrap native memory tracking, so it can start recording memory</div><div class="line">  // activities before worker thread is started. This is the first phase</div><div class="line">  // of bootstrapping, VM is currently running <span class="keyword">in</span> single-thread mode.</div><div class="line">  MemTracker::bootstrap_single_thread();</div><div class="line"></div><div class="line">  // Initialize output stream logging</div><div class="line">  ostream_init_log();</div><div class="line"></div><div class="line">  // Convert -Xrun to -agentlib: <span class="keyword">if</span> there is no JVM_OnLoad</div><div class="line">  // Must be before create_vm_init_agents()</div><div class="line">  <span class="keyword">if</span> (Arguments::init_libraries_at_startup()) &#123;</div><div class="line">    convert_vm_init_libraries_to_agents();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Launch -agentlib/-agentpath and converted -Xrun agents</div><div class="line">  <span class="keyword">if</span> (Arguments::init_agents_at_startup()) &#123;</div><div class="line">    create_vm_init_agents();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Initialize Threads state</div><div class="line">  _thread_list = NULL;</div><div class="line">  _number_of_threads = 0;</div><div class="line">  _number_of_non_daemon_threads = 0;</div><div class="line"></div><div class="line">  // Initialize global data structures and create system classes <span class="keyword">in</span> heap</div><div class="line">  vm_init_globals();</div><div class="line"></div><div class="line">  // Attach the main thread to this os thread</div><div class="line">  JavaThread* main_thread = new JavaThread();</div><div class="line">  main_thread-&gt;set_thread_state(_thread_in_vm);</div><div class="line">  // must <span class="keyword">do</span> this before set_active_handles and initialize_thread_local_storage</div><div class="line">  // Note: on solaris initialize_thread_local_storage() will (indirectly)</div><div class="line">  // change the stack size recorded here to one based on the java thread</div><div class="line">  // stacksize. This adjusted size is what is used to figure the placement</div><div class="line">  // of the guard pages.</div><div class="line">  main_thread-&gt;record_stack_base_and_size();</div><div class="line">  main_thread-&gt;initialize_thread_local_storage();</div><div class="line"></div><div class="line">  main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!main_thread-&gt;set_as_starting_thread()) &#123;</div><div class="line">    vm_shutdown_during_initialization(</div><div class="line">      <span class="string">"Failed necessary internal allocation. Out of swap space"</span>);</div><div class="line">    delete main_thread;</div><div class="line">    *canTryAgain = <span class="literal">false</span>; // don<span class="string">'t let caller call JNI_CreateJavaVM again</span></div><div class="line">    return JNI_ENOMEM;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Enable guard page *after* os::create_main_thread(), otherwise it would</div><div class="line">  // crash Linux VM, see notes in os_linux.cpp.</div><div class="line">  main_thread-&gt;create_stack_guard_pages();</div><div class="line"></div><div class="line">  // Initialize Java-Level synchronization subsystem</div><div class="line">  ObjectMonitor::Initialize() ;</div><div class="line"></div><div class="line">  // Second phase of bootstrapping, VM is about entering multi-thread mode</div><div class="line">  MemTracker::bootstrap_multi_thread();</div><div class="line"></div><div class="line">  // Initialize global modules</div><div class="line">  jint status = init_globals();</div><div class="line">  if (status != JNI_OK) &#123;</div><div class="line">    delete main_thread;</div><div class="line">    *canTryAgain = false; // don't <span class="built_in">let</span> <span class="built_in">caller</span> call JNI_CreateJavaVM again</div><div class="line">    <span class="built_in">return</span> status;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Should be <span class="keyword">done</span> after the heap is fully created</div><div class="line">  main_thread-&gt;cache_global_variables();</div><div class="line"></div><div class="line">  HandleMark hm;</div><div class="line"></div><div class="line">  &#123; MutexLocker mu(Threads_lock);</div><div class="line">    Threads::add(main_thread);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Any JVMTI raw monitors entered <span class="keyword">in</span> onload will transition into</div><div class="line">  // real raw monitor. VM is setup enough here <span class="keyword">for</span> raw monitor enter.</div><div class="line">  JvmtiExport::transition_pending_onload_raw_monitors();</div><div class="line"></div><div class="line">  // Fully start NMT</div><div class="line">  MemTracker::start();</div><div class="line"></div><div class="line">  // Create the VMThread</div><div class="line">  &#123; TraceTime timer(<span class="string">"Start VMThread"</span>, TraceStartupTime);</div><div class="line">    VMThread::create();</div><div class="line">    Thread* vmthread = VMThread::vm_thread();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!os::create_thread(vmthread, os::vm_thread))</div><div class="line">      vm_exit_during_initialization(<span class="string">"Cannot create VM thread. Out of system resources."</span>);</div><div class="line"></div><div class="line">    // Wait <span class="keyword">for</span> the VM thread to become ready, and VMThread::run to initialize</div><div class="line">    // Monitors can have spurious returns, must always check another state flag</div><div class="line">    &#123;</div><div class="line">      MutexLocker ml(Notify_lock);</div><div class="line">      os::start_thread(vmthread);</div><div class="line">      <span class="keyword">while</span> (vmthread-&gt;active_handles() == NULL) &#123;</div><div class="line">        Notify_lock-&gt;<span class="built_in">wait</span>();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  assert (Universe::is_fully_initialized(), <span class="string">"not initialized"</span>);</div><div class="line">  <span class="keyword">if</span> (VerifyDuringStartup) &#123;</div><div class="line">    // Make sure we<span class="string">'re starting with a clean slate.</span></div><div class="line">    VM_Verify verify_op;</div><div class="line">    VMThread::execute(&amp;verify_op);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  EXCEPTION_MARK;</div><div class="line"></div><div class="line">  // At this point, the Universe is initialized, but we have not executed</div><div class="line">  // any byte code.  Now is a good time (the only time) to dump out the</div><div class="line">  // internal state of the JVM for sharing.</div><div class="line">  if (DumpSharedSpaces) &#123;</div><div class="line">    MetaspaceShared::preload_and_dump(CHECK_0);</div><div class="line">    ShouldNotReachHere();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Always call even when there are not JVMTI environments yet, since environments</div><div class="line">  // may be attached late and JVMTI must track phases of VM execution</div><div class="line">  JvmtiExport::enter_start_phase();</div><div class="line"></div><div class="line">  // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.</div><div class="line">  JvmtiExport::post_vm_start();</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    TraceTime timer("Initialize java.lang classes", TraceStartupTime);</div><div class="line"></div><div class="line">    if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) &#123;</div><div class="line">      create_vm_init_libraries();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    initialize_class(vmSymbols::java_lang_String(), CHECK_0);</div><div class="line"></div><div class="line">    // Initialize java_lang.System (needed before creating the thread)</div><div class="line">    initialize_class(vmSymbols::java_lang_System(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK_0);</div><div class="line">    Handle thread_group = create_initial_thread_group(CHECK_0);</div><div class="line">    Universe::set_main_thread_group(thread_group());</div><div class="line">    initialize_class(vmSymbols::java_lang_Thread(), CHECK_0);</div><div class="line">    oop thread_object = create_initial_thread(thread_group, main_thread, CHECK_0);</div><div class="line">    main_thread-&gt;set_threadObj(thread_object);</div><div class="line">    // Set thread status to running since main thread has</div><div class="line">    // been started and running.</div><div class="line">    java_lang_Thread::set_thread_status(thread_object,</div><div class="line">                                        java_lang_Thread::RUNNABLE);</div><div class="line"></div><div class="line">    // The VM creates &amp; returns objects of this class. Make sure it's initialized.</div><div class="line">    initialize_class(vmSymbols::java_lang_Class(), CHECK_0);</div><div class="line"></div><div class="line">    // The VM preresolves methods to these classes. Make sure that they get initialized</div><div class="line">    initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_ref_Finalizer(),  CHECK_0);</div><div class="line">    call_initializeSystemClass(CHECK_0);</div><div class="line"></div><div class="line">    // get the Java runtime name after java.lang.System is initialized</div><div class="line">    JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));</div><div class="line">    JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));</div><div class="line"></div><div class="line">    // an instance of OutOfMemory exception has been allocated earlier</div><div class="line">    initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK_0);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // See        : bugid 4211085.</div><div class="line">  // Background : the static initializer of java.lang.Compiler tries to <span class="built_in">read</span></div><div class="line">  //              property<span class="string">"java.compiler"</span> and <span class="built_in">read</span> &amp; write property <span class="string">"java.vm.info"</span>.</div><div class="line">  //              When a security manager is installed through the <span class="built_in">command</span> line</div><div class="line">  //              option <span class="string">"-Djava.security.manager"</span>, the above properties are not</div><div class="line">  //              readable and the static initializer <span class="keyword">for</span> java.lang.Compiler fails</div><div class="line">  //              resulting <span class="keyword">in</span> a NoClassDefFoundError.  This can happen <span class="keyword">in</span> any</div><div class="line">  //              user code <span class="built_in">which</span> calls methods <span class="keyword">in</span> java.lang.Compiler.</div><div class="line">  // Hack :       the hack is to pre-load and initialize this class, so that only</div><div class="line">  //              system domains are on the stack when the properties are <span class="built_in">read</span>.</div><div class="line">  //              Currently even the AWT code has calls to methods <span class="keyword">in</span> java.lang.Compiler.</div><div class="line">  //              On the classic VM, java.lang.Compiler is loaded very early to load the JIT.</div><div class="line">  // Future Fix : the best fix is to grant everyone permissions to <span class="built_in">read</span> <span class="string">"java.compiler"</span> and</div><div class="line">  //              <span class="built_in">read</span> and write<span class="string">"java.vm.info"</span> <span class="keyword">in</span> the default policy file. See bugid 4211383</div><div class="line">  //              Once that is <span class="keyword">done</span>, we should remove this hack.</div><div class="line">  initialize_class(vmSymbols::java_lang_Compiler(), CHECK_0);</div><div class="line"></div><div class="line">  // More hackery - the static initializer of java.lang.Compiler adds the string <span class="string">"nojit"</span> to</div><div class="line">  // the java.vm.info property <span class="keyword">if</span> no jit gets loaded through java.lang.Compiler (the hotspot</div><div class="line">  // compiler does not get loaded through java.lang.Compiler).  <span class="string">"java -version"</span> with the</div><div class="line">  // hotspot vm says <span class="string">"nojit"</span> all the time <span class="built_in">which</span> is confusing.  So, we reset it here.</div><div class="line">  // This should also be taken out as soon as 4211383 gets fixed.</div><div class="line">  reset_vm_info_property(CHECK_0);</div><div class="line"></div><div class="line">  quicken_jni_functions();</div><div class="line"></div><div class="line">  // Must be run after init_ft <span class="built_in">which</span> initializes ft_enabled</div><div class="line">  <span class="keyword">if</span> (TRACE_INITIALIZE() != JNI_OK) &#123;</div><div class="line">    vm_exit_during_initialization(<span class="string">"Failed to initialize tracing backend"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Set flag that basic initialization has completed. Used by exceptions and various</div><div class="line">  // debug stuff, that does not work until all basic classes have been initialized.</div><div class="line">  set_init_completed();</div><div class="line"></div><div class="line"><span class="comment">#ifndef USDT2</span></div><div class="line">  HS_DTRACE_PROBE(hotspot, vm__init__end);</div><div class="line"><span class="comment">#else /* USDT2 */</span></div><div class="line">  HOTSPOT_VM_INIT_END();</div><div class="line"><span class="comment">#endif /* USDT2 */</span></div><div class="line"></div><div class="line">  // record VM initialization completion time</div><div class="line"><span class="comment">#if INCLUDE_MANAGEMENT</span></div><div class="line">  Management::record_vm_init_completed();</div><div class="line"><span class="comment">#endif // INCLUDE_MANAGEMENT</span></div><div class="line"></div><div class="line">  // Compute system loader. Note that this has to occur after set_init_completed, since</div><div class="line">  // valid exceptions may be thrown <span class="keyword">in</span> the process.</div><div class="line">  // Note that we <span class="keyword">do</span> not use CHECK_0 here since we are inside an EXCEPTION_MARK and</div><div class="line">  // set_init_completed has just been called, causing exceptions not to be shortcut</div><div class="line">  // anymore. We call vm_exit_during_initialization directly instead.</div><div class="line">  SystemDictionary::compute_java_system_loader(THREAD);</div><div class="line">  <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</div><div class="line">    vm_exit_during_initialization(Handle(THREAD, PENDING_EXCEPTION));</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">#if INCLUDE_ALL_GCS</span></div><div class="line">  // Support <span class="keyword">for</span> ConcurrentMarkSweep. This should be cleaned up</div><div class="line">  // and better encapsulated. The ugly nested <span class="keyword">if</span> <span class="built_in">test</span> would go away</div><div class="line">  // once things are properly refactored. XXX YSR</div><div class="line">  <span class="keyword">if</span> (UseConcMarkSweepGC || UseG1GC) &#123;</div><div class="line">    <span class="keyword">if</span> (UseConcMarkSweepGC) &#123;</div><div class="line">      ConcurrentMarkSweepThread::makeSurrogateLockerThread(THREAD);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      ConcurrentMarkThread::makeSurrogateLockerThread(THREAD);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</div><div class="line">      vm_exit_during_initialization(Handle(THREAD, PENDING_EXCEPTION));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"><span class="comment">#endif // INCLUDE_ALL_GCS</span></div><div class="line"></div><div class="line">  // Always call even when there are not JVMTI environments yet, since environments</div><div class="line">  // may be attached late and JVMTI must track phases of VM execution</div><div class="line">  JvmtiExport::enter_live_phase();</div><div class="line"></div><div class="line">  // Signal Dispatcher needs to be started before VMInit event is posted</div><div class="line">  os::signal_init();</div><div class="line"></div><div class="line">  // Start Attach Listener <span class="keyword">if</span> +StartAttachListener or it can<span class="string">'t be started lazily</span></div><div class="line">  if (!DisableAttachMechanism) &#123;</div><div class="line">    AttachListener::vm_start();</div><div class="line">    if (StartAttachListener || AttachListener::init_at_startup()) &#123;</div><div class="line">      AttachListener::init();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Launch -Xrun agents</div><div class="line">  // Must be done in the JVMTI live phase so that for backward compatibility the JDWP</div><div class="line">  // back-end can launch with -Xdebug -Xrunjdwp.</div><div class="line">  if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) &#123;</div><div class="line">    create_vm_init_libraries();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Notify JVMTI agents that VM initialization is complete - nop if no agents.</div><div class="line">  JvmtiExport::post_vm_initialized();</div><div class="line"></div><div class="line">  if (TRACE_START() != JNI_OK) &#123;</div><div class="line">    vm_exit_during_initialization("Failed to start tracing backend.");</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (CleanChunkPoolAsync) &#123;</div><div class="line">    Chunk::start_chunk_pool_cleaner_task();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // initialize compiler(s)</div><div class="line">#if defined(COMPILER1) || defined(COMPILER2) || defined(SHARK)</div><div class="line">  CompileBroker::compilation_init();</div><div class="line">#endif</div><div class="line"></div><div class="line">  if (EnableInvokeDynamic) &#123;</div><div class="line">    // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.</div><div class="line">    // It is done after compilers are initialized, because otherwise compilations of</div><div class="line">    // signature polymorphic MH intrinsics can be missed</div><div class="line">    // (see SystemDictionary::find_method_handle_intrinsic).</div><div class="line">    initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK_0);</div><div class="line">    initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK_0);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">#if INCLUDE_MANAGEMENT</div><div class="line">  Management::initialize(THREAD);</div><div class="line">#endif // INCLUDE_MANAGEMENT</div><div class="line"></div><div class="line">  if (HAS_PENDING_EXCEPTION) &#123;</div><div class="line">    // management agent fails to start possibly due to</div><div class="line">    // configuration problem and is responsible for printing</div><div class="line">    // stack trace if appropriate. Simply exit VM.</div><div class="line">    vm_exit(1);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (Arguments::has_profile())       FlatProfiler::engage(main_thread, true);</div><div class="line">  if (MemProfiling)                   MemProfiler::engage();</div><div class="line">  StatSampler::engage();</div><div class="line">  if (CheckJNICalls)                  JniPeriodicChecker::engage();</div><div class="line"></div><div class="line">  BiasedLocking::init();</div><div class="line"></div><div class="line">  if (JDK_Version::current().post_vm_init_hook_enabled()) &#123;</div><div class="line">    call_postVMInitHook(THREAD);</div><div class="line">    // The Java side of PostVMInitHook.run must deal with all</div><div class="line">    // exceptions and provide means of diagnosis.</div><div class="line">    if (HAS_PENDING_EXCEPTION) &#123;</div><div class="line">      CLEAR_PENDING_EXCEPTION;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  &#123;</div><div class="line">      MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);</div><div class="line">      // Make sure the watcher thread can be started by WatcherThread::start()</div><div class="line">      // or by dynamic enrollment.</div><div class="line">      WatcherThread::make_startable();</div><div class="line">      // Start up the WatcherThread if there are any periodic tasks</div><div class="line">      // NOTE:  All PeriodicTasks should be registered by now. If they</div><div class="line">      //   aren't, late joiners might appear to start slowly (we might</div><div class="line">      //   take a <span class="keyword">while</span> to process their first tick).</div><div class="line">      <span class="keyword">if</span> (PeriodicTask::num_tasks() &gt; 0) &#123;</div><div class="line">          WatcherThread::start();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Give os specific code one last chance to start</div><div class="line">  os::init_3();</div><div class="line"></div><div class="line">  create_vm_timer.end();</div><div class="line"><span class="comment">#ifdef ASSERT</span></div><div class="line">  _vm_complete = <span class="literal">true</span>;</div><div class="line"><span class="comment">#endif</span></div><div class="line">  <span class="built_in">return</span> JNI_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/JVM/" class="archive-article-date">
  	<time datetime="2017-07-20T14:15:13.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/">JVM</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Networking Internals5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Networking Internals5/">Linux Networking Internals 5 - Network Device Notification Chains</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Network-Device-Notification-Chains"><a href="#Network-Device-Notification-Chains" class="headerlink" title="Network Device Notification Chains"></a>Network Device Notification Chains</h2><p>publish  -vs-   subscribe</p>
<p>notifier_block 结构体<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">struct notifier_block</div><div class="line">&#123;</div><div class="line">    int (*notifier_call)(struct notifier_block *self, unsigned long, void *);</div><div class="line">    struct notifier_block *next;</div><div class="line">    int priority;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>注册函数：  notifier_chain_register</p>
<p>网络相关的 chain： inetaddr_chain , inet6addr_chain , and netdev_chain.</p>
<p><img src="/images/Linux_network_internal_netdevice_notification_chain.png" alt=""></p>
<h3 id="Notifying-Events-on-a-Chain"><a href="#Notifying-Events-on-a-Chain" class="headerlink" title="Notifying Events on a Chain:"></a>Notifying Events on a Chain:</h3><p>函数 notifier_call_chain    <kernel sys.c=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">int notifier_call_chain(struct notifier_block **n, unsigned long val, void *v)</div><div class="line">&#123;</div><div class="line">    int ret = NOTIFY_DONE;</div><div class="line">    struct notifier_block *nb = *n;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (nb)</div><div class="line">    &#123;</div><div class="line">        ret = nb-&gt;notifier_call(nb, val, v);</div><div class="line">        <span class="keyword">if</span> (ret &amp; NOTIFY_STOP_MASK)</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">return</span> ret;</div><div class="line">        &#125;</div><div class="line">        nb = nb-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></kernel></p>
<p>该函数返回值 类型 位于  include/linux/notifier.h 文件中。</p>
<h3 id="Notification-Chains-for-the-Networking-Subsystems"><a href="#Notification-Chains-for-the-Networking-Subsystems" class="headerlink" title="Notification  Chains  for the Networking Subsystems:"></a>Notification  Chains  for the Networking Subsystems:</h3><p>inetaddr_chain        netdev_chain</p>
<p>inetaddr_chain: sends notifications about insertion/removal/change of an IPv4 address on a local interface.<br>netdev_chain: sends notifications about the registration status of network devices.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">int register_netdevice_notifier(struct notifier_block *nb)</div><div class="line">&#123;</div><div class="line">        <span class="built_in">return</span> notifier_chain_register(&amp;netdev_chain, nb);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Common names for wrappers include [un]register_xxx<em>notifier, xxx</em>[un]register<em>notifier, and xxx</em>[un]register.</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Networking Internals5/" class="archive-article-date">
  	<time datetime="2017-07-20T14:10:10.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Networking-Internals/">Linux Networking Internals</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Networking Internals4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Networking Internals4/">Linux Networking Internals 4 - Network Device Statistics</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Network-Device-Statistics"><a href="#Network-Device-Statistics" class="headerlink" title="Network Device Statistics"></a>Network Device Statistics</h2><p>netdev_rx_stat, its elements are of type netif_rx_stats        <include linux="" netdevice.h=""></include></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">struct netif_rx_stats netdev_rx_stat[NR_CPUS];</div><div class="line"></div><div class="line">struct netif_rx_stats</div><div class="line">&#123;</div><div class="line">        unsigned total;</div><div class="line">        unsigned dropped;</div><div class="line">        unsigned time_squeeze;</div><div class="line">        unsigned throttled;</div><div class="line">        unsigned fastroute_hit;</div><div class="line">        unsigned fastroute_success;</div><div class="line">        unsigned fastroute_defer;</div><div class="line">        unsigned fastroute_deferred_out;</div><div class="line">        unsigned fastroute_latency_reduction;</div><div class="line">        unsigned cpu_collision;</div><div class="line">&#125; __ _  _cacheline_aligned;</div></pre></td></tr></table></figure>
<p><img src="/images/Linux_network_internal_netdevice_Statistics.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Networking Internals4/" class="archive-article-date">
  	<time datetime="2017-07-20T14:06:01.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Networking-Internals/">Linux Networking Internals</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Networking Internals3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Networking Internals3/">Linux Networking Internals 3 - Network Device Initialize</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="网络设备的初始化-："><a href="#网络设备的初始化-：" class="headerlink" title="网络设备的初始化 ："></a>网络设备的初始化 ：</h2><pre><code>包括2个阶段：
</code></pre><ol>
<li>作为常规device，初始化</li>
<li>作为network device，初始化</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Kernel boot up  —&gt;  start_kernel (initializes bunch of subsystems)</div><div class="line">                                        —&gt;  invokes  init kernel thread   (takes care of the rest of  initializations)</div><div class="line">                                                —&gt;  do_basic_setup()        —&gt;  deriver_init/sock_init/ ….</div><div class="line">                                                —&gt;  free_init_mem()</div><div class="line">                                                —&gt;  run_init_process()</div><div class="line"></div><div class="line">Three mainly interested points:</div><div class="line">1. Boot-time options               parse_args   handle configuration parameters that a boot loader(LILO/GRUB) has passed to kernel at boot time</div><div class="line">2. Interrupts and timers        init_IRQ(hardware interrupts)/softirq_init(software interrupts)     </div><div class="line">3. Initialization routines        do_initcalls will initialize kernel subsystems and built-in device drivers        </div><div class="line"></div><div class="line">run_init_process determines the first process(PID 1) run on the system, through the init=  boot time option</div></pre></td></tr></table></figure>
<p><img src="/images/Linux_network_internal_system_start.png" alt=""></p>
<h3 id="Initialization-Options"><a href="#Initialization-Options" class="headerlink" title="Initialization  Options:"></a>Initialization  Options:</h3><p>Both components built into the kernel and components loaded as modules can be passed input parameters so that users can fine-tune the functionality implemented by the components, override defaults compiled into them, or change them from one system boot to the next, kernel provides two kinds of macros to define options:</p>
<ol>
<li>Module options                module_param  family</li>
<li>Boot-time kernel options        _ _setup  family<br>drivers/block/loop.c</li>
</ol>
<p>Module options.                      <include linux="" moduleparam.h=""><br><strong>module_param</strong><br>The module parameters are listed in the module’s directory “/sys/modules”. The subdirectory /sys/modules/module/parameters holds a file for each parameter exported by module.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost src]<span class="comment"># ls -la /sys/module/sis900/parameters/</span></div><div class="line">total 0</div><div class="line">drwxr-xr-x  2 root root    0 Apr  9 18:31 .</div><div class="line">drwxr-xr-x  4 root root    0 Apr  9 18:31 ..</div><div class="line">-r--r--r--  1 root root    0 Apr  9 18:31 debug</div><div class="line">-r--r--r--  1 root root 4096 Apr  9 18:31 max_interrupt_work</div><div class="line">-r--r--r--  1 root root 4096 Apr  9 18:31 multicast_filter_limit</div><div class="line">[root@localhost src]<span class="comment">#</span></div></pre></td></tr></table></figure></include></p>
<h3 id="Initializing-the-Device-Handling-Layer-net-dev-init"><a href="#Initializing-the-Device-Handling-Layer-net-dev-init" class="headerlink" title="Initializing the Device Handling Layer: net_dev_init"></a>Initializing the Device Handling Layer: net_dev_init</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">net_dev_init defined <span class="keyword">in</span> net/core/dev.c</div><div class="line">static int _ _init net_dev_init(void)                    _ _init  macro</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>subsys_initcall(net_dev_init);<br>subsys_initcall   macros ensure net_dev_init runs before any NIC device drivers register themselves.<br>main parts of  net_dev_init:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">1. the per-CPU data structures used by two networking software interrupts(softirqs) are initialized.</div><div class="line">2. when kernel is compiled with support <span class="keyword">for</span> /proc filesystem, a few files are added to /proc with dev_proc_init and dev_mcast_init.</div><div class="line">3. netdev_sysfs_init registers the net class with sysfs. This creates directory /sys/class/net,  under this you can find a subdirectory <span class="keyword">for</span> each registered network device.</div><div class="line">4. net_random_init initializes a per-CPU vector of seeds that will be used when generating random numbers with net_random routine.</div><div class="line">5. The protocol-independent destination cache(DST) is initialized with dst_init.</div><div class="line">6. The protocol handler vector ptype_base, used to demultiplex ingress traffic, is initialized.</div><div class="line">7. When OFFLINE_SAMPLE symbol is defined, the kernel sets up a <span class="keyword">function</span> to run at regular intervals to collect statistics about the devices’ queue lengths.</div><div class="line">8. A callback handler is registered with the notification chain that issues notifications about CPU hotplug events. Callback used is dev_cpu_callback.</div></pre></td></tr></table></figure></p>
<p><strong>/proc/net</strong>  is created by net_dev_init, via <strong>dev_proc_init</strong> and <strong>dev_mcast_init</strong>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1. dev                   <span class="keyword">for</span> each network device registered with kernel, a few statistics about reception and transmission.</div><div class="line">2. dev_mcast     <span class="keyword">for</span> each network device registered with kernel, the values of a few parameters used by IP multicast.</div><div class="line">3. wireless          <span class="keyword">for</span> each wireless device, prints the value of a few parameters from the wireless block.</div><div class="line">4. softnet_stat       exports statistics about the software interrupts used by networking code.</div></pre></td></tr></table></figure></p>
<h3 id="User-Space-工具"><a href="#User-Space-工具" class="headerlink" title="User-Space 工具"></a>User-Space 工具</h3><ul>
<li><p>/sbin/modprobe</p>
<pre><code>Invoke when the kernel needs to load a module.
</code></pre></li>
<li><p>/sbin/hotplug</p>
<pre><code>Invoke when the kernel detects that a new device has been plugged or unplugged from system.
</code></pre></li>
</ul>
<p>The kernel provides a function named call_usermodehelper to execute such user-space helper.<br>Two kernel routines, request_module and kobject_hotplug , invoke call_usermodehelper to invoke /sbin/modprobe and /sbin/hotplug<br><img src="/images/Linux_network_internal_event_propagation_from_user_space.png" alt=""></p>
<p><strong>kmod</strong> is the kernel module loader that allows kernel components to request the loading of module. call  request_module   </p>
<p>Hotplug was introduced into the kernel to implement popular consuer feature known as Plug and Play (PnP). When compile the kernel modules, the object files are placed by default in directory: /lib/modules/kernel_version/.  kobject_hotplug function is invoked by the kernel to respond to insertion and removal of a device.   </p>
<p><strong>modprobe</strong> and <strong>hotplug</strong> create file/directory in /proc/sys/kernel  </p>
<h3 id="When-a-Device-is-Registered"><a href="#When-a-Device-is-Registered" class="headerlink" title="When a Device is Registered:"></a>When a Device is Registered:</h3><p>The  registration of a network device takes place in the following situations:</p>
<ol>
<li>Loading an NIC’s device driver</li>
<li>Inserting a hot-pluggable network device</li>
</ol>
<h3 id="When-a-Device-is-Unregistered"><a href="#When-a-Device-is-Unregistered" class="headerlink" title="When a Device is Unregistered:"></a>When a Device is Unregistered:</h3><p>Two main conditions trigger the unregisteration of a device:</p>
<ol>
<li>Unloading an NIC device driver</li>
<li>Removing a hot-pluggable network device</li>
</ol>
<h3 id="Allocating-net-device-Structures"><a href="#Allocating-net-device-Structures" class="headerlink" title="Allocating net_device Structures:"></a>Allocating net_device Structures:</h3><p>Network devices are defined with net_device structures.             <net core="" dev.c=""><br>include 3 input parameters:</net></p>
<ol>
<li>Size of private data structure</li>
<li>Device name</li>
<li>Setup routine</li>
</ol>
<p><img src="/images/Linux_network_internal_netdevice_register.png" alt=""></p>
<h3 id="Device-Initialization"><a href="#Device-Initialization" class="headerlink" title="Device Initialization:"></a>Device Initialization:</h3><p>net_device structure is pretty bug, its fields are initialized in chunks by different routines.</p>
<ol>
<li>Device drivers :   Parameters such as IRQ, I/O memory, and I/O port, those values depend on hardware configuration, are taken care of by device driver.      xxx_probe</li>
<li>Device type :     the type family is taken care by xxx_setup routines.</li>
<li>Features:           Mandatory and optional features also need to be initialized.</li>
</ol>
<p><img src="/images/Linux_network_internal_netdevice_initialization.png" alt=""></p>
<h4 id="Device-Type-Initialization-xxx-setup-Functions"><a href="#Device-Type-Initialization-xxx-setup-Functions" class="headerlink" title="Device Type Initialization: xxx_setup Functions"></a>Device Type Initialization: xxx_setup Functions</h4><p>alloc_ xxxdev  function pass right xxx_setup routine to alloc_netdev .<br>void ether_setup(struct net_device *dev)<br>{<br>    dev-&gt;change_mtu           = eth_change_mtu;<br>    dev-&gt;hard_header          = eth_header;<br>    dev-&gt;rebuild_header       = eth_rebuild_header;<br>    dev-&gt;set_mac_address      = eth_mac_addr;<br>    dev-&gt;hard_header_cache    = eth_header_cache;<br>    dev-&gt;header_cache_update  = eth_header_cache_update;<br>    dev-&gt;hard_header_parse    = eth_header_parse;</p>
<pre><code>dev-&gt;type                 = ARPHRD_ETHER;
dev-&gt;hard_header_len      = ETH_HLEN;
dev-&gt;mtu                  = 1500;
dev-&gt;addr_len             = ETH_ALEN;
dev-&gt;tx_queue_len         = 1000;
dev-&gt;flags                = IFF_BROADCAST|IFF_MULTICAST;

memset(dev-&gt;broadcast,0xFF, ETH_ALEN);
</code></pre><p>}</p>
<h4 id="Organization-of-net-device-Structures"><a href="#Organization-of-net-device-Structures" class="headerlink" title="Organization of net_device Structures:"></a>Organization of net_device Structures:</h4><p><img src="/images/Linux_network_internal_netdevice_registerd_device_list.png" alt=""></p>
<h4 id="Device-State"><a href="#Device-State" class="headerlink" title="Device State:"></a>Device State:</h4><p><strong>net_device</strong> include:</p>
<ol>
<li>flags                    bitmap used to store different flags.</li>
<li>reg_state  device registration state</li>
<li>state      device state with regard to its queuing discipline.</li>
</ol>
<h4 id="Net-Device-Queuing-Discipline-State"><a href="#Net-Device-Queuing-Discipline-State" class="headerlink" title="Net Device Queuing Discipline State:"></a>Net Device Queuing Discipline State:</h4><p>Each network device is assigned a queuing discipline, used by Traffic Control to implement its QoS mechanisms.      <include linux="" netdevice.h=""></include></p>
<p>LINK_STATE_START<br>LINK_STATE_PRESENT<br>LINK_STATE_NOCARRIER<br>LINK_STATE_LINKWATCH_EVENT<br>LINK_STATE_XOFF<br>LINK_STATE_SHED<br>LINK_STATE_RX_SCHED</p>
<h4 id="Net-Device-Registration-State"><a href="#Net-Device-Registration-State" class="headerlink" title="Net Device Registration State:"></a>Net Device Registration State:</h4><p>The state of a device with regard to its registration with the network stack is saved in reg_state field of the net_device structure.      <include linux="" netdevice.h=""><br>NETREG_UNINITIALIZED<br>NETREG_REGISTERING<br>NETREG_REGISTERED<br>NETREG_UNREGISTERING<br>NETREG_UNREGISTERED<br>NETREG_RELEASED</include></p>
<p><img src="/images/Linux_network_internal_netdevice_registration_state.png" alt=""></p>
<h4 id="Net-Device-register-unregister"><a href="#Net-Device-register-unregister" class="headerlink" title="Net Device register + unregister"></a>Net Device register + unregister</h4><p><img src="/images/Linux_network_internal_netdevice_register_unregister.png" alt=""></p>
<h4 id="Device-Registration-Status-Notification"><a href="#Device-Registration-Status-Notification" class="headerlink" title="Device Registration Status Notification:"></a>Device Registration Status Notification:</h4><p>Both kernel components and user-space applications are interested in knowing when a network device is registered, unregistered, goes down, or comes up.</p>
<p>netdev_chain: kernel components can register with this notification chain.    <net core="" dev.c=""><br>All the NETDEV_XXX events that are reported via neTDev_chain are listed in <include linux="" notifier.h="">.<br>Notification event list:<br>NETDEV_UP<br>NETDEV_GOING_DOWN<br>NETDEV_DOWN<br>NETDEV_REGISTER<br>NETDEV_UNREGISTER<br>NETDEV_REBOOT<br>NETDEV_CHANGEADDR<br>NETDEV_CHANGENAME<br>NETDEV_CHANGE</include></net></p>
<p>Quite a few kernel components register to <strong>netdev_chain</strong>  List:</p>
<ol>
<li>Routing</li>
<li>Firewall</li>
<li>Protocol code</li>
<li>Virtual device</li>
<li>RTnetlink</li>
</ol>
<h4 id="Enabling-and-Disabling-a-Network-Device"><a href="#Enabling-and-Disabling-a-Network-Device" class="headerlink" title="Enabling and Disabling a Network Device:"></a>Enabling and Disabling a Network Device:</h4><p><img src="/images/Linux_network_internal_netdevice_enable_disabler.png" alt=""></p>
<h4 id="Virtual-Devices"><a href="#Virtual-Devices" class="headerlink" title="Virtual Devices:"></a>Virtual Devices:</h4><p>The virtual devices need to be registered and enabled just like real ones, to be used.<br>register_netdevice/unregister_netdevice</p>
<h4 id="Device-initialization-phases"><a href="#Device-initialization-phases" class="headerlink" title="Device initialization phases:"></a>Device initialization phases:</h4><ol>
<li>Hardware initialization      this is done by the device driver in cooperation with the generic bus layer(PCI or USB).      </li>
<li>Software initialization        before the device can be used, it may need to provide some configuration parameters     </li>
<li>Feature initialization          configure some options     </li>
</ol>
<p>net_device data structure include a set of function pointers, that kernel uses to interact with the device driver and special kernel features</p>
<h4 id="Basic-Goals-of-NIC-Initialization"><a href="#Basic-Goals-of-NIC-Initialization" class="headerlink" title="Basic Goals of NIC Initialization:"></a>Basic Goals of NIC Initialization:</h4><p>establish  device/kernel  communication. such as:</p>
<ol>
<li>IRQ line             the /proc/interrupts file can be used to view the status of the current assignments.</li>
<li>I/O ports and memory registration         map an area of device’s memory into system memory.     I/O ports and memory are registered and released with request_region/release_region</li>
</ol>
<h4 id="Interaction-Between-Devices-and-Kernel"><a href="#Interaction-Between-Devices-and-Kernel" class="headerlink" title="Interaction Between Devices and Kernel:"></a>Interaction Between Devices and Kernel:</h4><p>nearly all devices interact with kernel in two ways:</p>
<ol>
<li>Polling                driven on the kernel side, the kernel check device status at regular intervals.</li>
<li>Interrupt            driven on the device side, the device sends a hardware signal to kernel.</li>
</ol>
<h4 id="Hardware-Interrupts"><a href="#Hardware-Interrupts" class="headerlink" title="Hardware Interrupts:"></a>Hardware Interrupts:</h4><p>every interrupt runs a  function called an interrupt handler. IRQ are defined in kernel/irq/manage.c and are overridden by arch/XXX/kernel/irq.c.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">int request_irq(unsigned int irq, void (*handler)(int, void*, struct pt_regs*), unsigned long irqflags, const char * devname, void *dev_id)</div><div class="line">void free_irq(unsigned_int irq, void *dev_id)</div></pre></td></tr></table></figure></p>
<h4 id="NIC-Inteerrupt-Types"><a href="#NIC-Inteerrupt-Types" class="headerlink" title="NIC  Inteerrupt Types:"></a>NIC  Inteerrupt Types:</h4><ol>
<li>Reception of a frame</li>
<li>Transmission failure</li>
<li>DMA transfer has completed successfully</li>
<li>Device has enough memory to handle a new transmission<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">drivers/net/3c509.c:</div><div class="line">static int</div><div class="line">el3_start_xmit(struct sk_buff *skb, struct net_device *dev)</div><div class="line">&#123;</div><div class="line">    ... ... ...</div><div class="line">    netif_stop_queue (dev);</div><div class="line">    ... ... ...</div><div class="line">    <span class="keyword">if</span> (inw(ioaddr + TX_FREE) &gt; 1536)</div><div class="line">        netif_start_queue(dev);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        outw(SetTxThreshold + 1536, ioaddr + EL3_CMD);</div><div class="line">    ... ... ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Organization-of-IRQs-to-handler-mappings"><a href="#Organization-of-IRQs-to-handler-mappings" class="headerlink" title="Organization of IRQs to handler mappings:"></a>Organization of IRQs to handler mappings:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kernel/irq/handler.c</div><div class="line">irqaction data structure:</div><div class="line">void (*handler)(int irq, void *dev_id, struct pt_regs *regs)</div><div class="line">int irq</div><div class="line">void *dev_id</div><div class="line">...</div></pre></td></tr></table></figure>
<p><img src="/images/Linux_network_internal_netdevice_IRQ_handler.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Networking Internals3/" class="archive-article-date">
  	<time datetime="2017-07-20T13:08:38.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Networking-Internals/">Linux Networking Internals</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Networking Internals2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Networking Internals2/">Linux Networking Internals 2 - 网络相关的 procfs vs sysctl vs sysfs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="网络相关的-procfs-vs-sysctl-vs-sysfs"><a href="#网络相关的-procfs-vs-sysctl-vs-sysfs" class="headerlink" title="网络相关的 procfs vs sysctl vs sysfs"></a>网络相关的 procfs vs sysctl vs sysfs</h2><p><strong>/proc</strong> 目录 被 proc_mkdir 函数创建。<br><strong>/proc/net</strong>  目录 被 <strong>proc_net_fops_create/proc_net_remove</strong> (调用 create_proc_entry/remove_proc_entry) 创建及删除。  <include linux="" proc_fs.h=""><br><strong>/proc/sys</strong> 实际上是内核变量，可以read／write。 /proc/sys 被定义在 <strong>ctl_table</strong> 结构体中， 通过 <strong>register_sysctl_table</strong> 和 <strong>unregister_sysctl_table</strong> 来注册和取消注册。   <kernel sysctl.c=""><br>某些目录在系统启动的时候就被创建，某些在运行时刻才被添加。</kernel></include></p>
<h3 id="proc-net-sys-创建流程图"><a href="#proc-net-sys-创建流程图" class="headerlink" title="/proc/net/sys 创建流程图"></a>/proc/net/sys 创建流程图</h3><p><img src="/images/Linux_network_internal_proc_sys_net_creation.png" alt=""></p>
<h3 id="Dispatching-ioctl-commands"><a href="#Dispatching-ioctl-commands" class="headerlink" title="Dispatching ioctl commands"></a>Dispatching ioctl commands</h3><p><strong>ioctl</strong> 是主要管理net_device的调用函数.<br><img src="/images/Linux_network_internal_ioctl_dispatch.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Networking Internals2/" class="archive-article-date">
  	<time datetime="2017-07-20T12:20:35.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Networking-Internals/">Linux Networking Internals</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Networking Internals1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Networking Internals1/">Linux Networking Internals 1 - Critical Data Structures</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="本系列是阅读《Linux-Networking-Internals》书籍的总结"><a href="#本系列是阅读《Linux-Networking-Internals》书籍的总结" class="headerlink" title="本系列是阅读《Linux Networking Internals》书籍的总结"></a>本系列是阅读《Linux Networking Internals》书籍的总结</h2><p>《Linux Networking Internals》 是基于Linux解释network的书籍, 文章内容还是不错的.<br>另推荐一本书《Understanding the Linux Kernel》, 阅读本系列之前更加推荐之前的文章, 关于该文章的记录也会放在博客上.</p>
<h3 id="Critical-Data-Structures"><a href="#Critical-Data-Structures" class="headerlink" title="Critical Data Structures"></a>Critical Data Structures</h3><ul>
<li>struct <strong>sk_buff</strong><br>存放packet的结构体</li>
<li>struct <strong>net_device</strong><br>linux kernel中指代网络设备的结构体</li>
<li>struct <strong>sock</strong><br>存放socket信息的结构体</li>
</ul>
<h4 id="sk-buff"><a href="#sk-buff" class="headerlink" title="sk_buff"></a>sk_buff</h4><p>Sock Buffer: <strong>sk_buff</strong>    <include linux="" skbuff.h=""><br>包括以下内容：</include></p>
<ol>
<li>Layout</li>
<li>General</li>
<li>Feature-specific</li>
<li>Management functions:  skb_put, skb_push, skb_pull, skb_reserve</li>
</ol>
<p>alloc_skb -&gt; dev_alloc_skb<br><img src="/images/Linux_network_internal_skbuff.png" alt=""></p>
<p>kfree_skb -&gt; dev_kfree_skb<br><img src="/images/Linux_netwirk_internal_skbuff_kfree.png" alt=""></p>
<p>skb_reserve<br><img src="/images/Linux_network_internal_skbuff_reserve.png" alt=""></p>
<h4 id="net-device"><a href="#net-device" class="headerlink" title="net_device"></a>net_device</h4><p><strong>net_device</strong> structure include:</p>
<ol>
<li>Configuration</li>
<li>Statistics</li>
<li>Device status</li>
<li>List management</li>
<li>Traffic management</li>
<li>Feature specific</li>
<li>Generic</li>
<li>Function pointers (or VFT)</li>
</ol>
<p>tips: <strong>ifconfig/route</strong> 通过 <strong>ioctl</strong> 系统调用来实现； <strong>ip/IPROUTE2</strong> 使用Netlink socket 来实现.</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Networking Internals1/" class="archive-article-date">
  	<time datetime="2017-07-20T03:12:53.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-20</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Networking-Internals/">Linux Networking Internals</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux系统启动源代码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux系统启动源代码分析/">Linux 系统启动源代码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Linux-系统启动源代码"><a href="#Linux-系统启动源代码" class="headerlink" title="Linux 系统启动源代码"></a>Linux 系统启动源代码</h2><p>以x86_64 arch机器为例：</p>
<p>—————————————————— 内核load进内存阶段 （arch/*/boot/）—————————————————-</p>
<p>入口文件是：  <strong>arch/x86/boot/compressed/head_64.S</strong>  注意：  kernel 代码不是以 main 函数为入口的。<br>head_64.S 是 汇编 代码文件， 该文件会 call  verify_cpu + make_boot_params(初始化boot_params) + efi_main(处理并返回boot_params)，最终里面  call  extract_kernel 会调用 入口函数 extract_kernel, 该 函数 位于 arch/x86/boot/compressed/misc.c 会：</p>
<pre><code>1. 拿到 boot_params , 由汇编代码传入该参数      该 参数的结构体 位于 arch/x86/include/uapi/asm/bootparam.h .
2. 通过 sanitize_boot_params 函数  初始化 boot_params 参数部分内容， 代码位于 arch/x86/include/asm/bootparam_utils.h .
3. 通过 boot_params-&gt;screen_info 内容，  调用 arch/x86/boot/compressed/console.c  文件中的 console_init 函数, 初始化 tty 的console .
4. (arch/x86/boot/compressed/kaslr.c) choose_random_location 函数 会随机挑选一段内存地址， 用于解压内核 压缩文件。
5. 调用 (lib/decompress_bunzip2.c) __decompress 函数解压缩内核压缩文件, 根据不同的压缩文件类型，调用不同的解压缩函数， 压缩文件区分应该是发生在 编译内核时。
6. 内核文件解压之后会成为 elf 文件， 位于内存中， 通过调用 parse_elf 函数 load 进 内核内容,  parse_elf 位于 arch/x86/boot/compressed/misc.c 中。
7. 判断是否 需要重新 分配内存地址， 调用 handle_relocations 函数。
</code></pre><p>arch/x86/boot/compressed/head_64.S 在解压缩内核之后会执行解压缩之后的内核代码！！！</p>
<p>而 与arch 无关， 较为 common(legacy) 的 文件  arch/x86/boot/header.S  会 最终调用 (arch/x86/boot/main.c) main 函数 ， 该函数会：</p>
<pre><code>1. copy_boot_params   拷贝启动参数
2. console_init  初始化console
3. init_heap
4. validate_cpu
5. set_bios_mode
6. detect_memory
7. keyboard_init
8. query_ist
9. query_apm_bios (if  config_apm)
10. query_edd  (if config_edd)
11. set_video
12. go_to_protected_mode
</code></pre><p>—————————————————— 内核启动阶段 （init/main.c） —————————————————-</p>
<p>入口文件是 ： init/main.c        启动函数是：  start_kernel   该函数会：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">1. 调用 (kernel/fork.c)  set_task_stack_end_magic(&amp;init_task) 函数， 注册系统内核启动后的 idle(PID=0)  进程。 该 init_task 在 init_task.h 文件中定义，在 fork.c 文件中设置栈边界。</div><div class="line">2. smp_setup_processor_id 函数, 检查cpu是否为多处理器，获取当前处理器逻辑号。</div><div class="line">3. 调用(debugobjects.c)debug_objects_early_init 函数,  初始化debug对象的锁，并将debug对象链接成链表。</div><div class="line">4. 调用(stackprotector.h)boot_init_stack_canary函数, 尽可能早地进行stack protect，防止 栈越界 canary 攻击，关于canary attack 可以参照： https://hardenedlinux.github.io/2016/11/27/canary.html</div><div class="line">5.  调用(group.c)group_init_early 函数,  初始化 group_root 结构体， 并且将每一个 cgroup_subsys 加入到 group_root 对象中，并初始化每一个 cgroup_subsys 对象。 支持的 cgroup_subsys 位于 include/linux/cgroup_subsys.h 文件中。</div><div class="line">6. local_irq_disable() 函数 将本地中断暂时disabled。</div><div class="line">7. 调用(kernel/cpu.c)boot_cpu_init函数，  设置 获得 cpu 第一个处理器标志对象， 标志 该处理器对象为 online+active+present+possible.</div><div class="line">8. 调用 (mm/highmem.c)page_address_init 函数,  初始化 高端内存页表 page_address_htable 对象 .</div><div class="line">9. 调用 pr_notice 函数 打印 Linux 版本信息(linux_banner) .</div><div class="line">10. 调用 setup_arch(command_line) 函数， 设置与 硬件架构相关的 配置,  command_line 为内核启动参数。 相关结构体有：  hwrpb_struct， notifier_block(中断处理结构体,注册形成notifier_chain)，alpha_using_srm/alpha_using_qemu(使用 srm或者qemu), callback_init(初始化 kernel_page + kernel_PCB + third_level_PTE)  </div><div class="line">11. 调用 mm_types.h(mm_init_cpumask)函数， 初始化 init_mm 对象，init_mm 是 mm_struct 结构体对象，位于 init-mm.c 文件中.</div><div class="line">12. 调用 setup_command_line 函数，保存 原始的 command_line 对象， 保存给以后分析。    </div><div class="line">13. cpu 相关的4个函数(不太明白)： setup_nr_cpu_ids + setup_per_cpu_areas + boot_cpu_state_init + smp_prepare_boot_cpu</div><div class="line">14. 调用 (page_alloc.c)build_all_zonelists 函数 初始化 页表区， 建立系统内存页表链表 .</div><div class="line">15. 调用 (page_alloc.c)page_alloc_init 函数 初始化页表， 初始化内存页表。</div><div class="line">16. 调用 parse_early_param 函数, 解析 command_line 对象，拿到 早期 参数, 参数以 kernel_param 结构体保存 。</div><div class="line">17. 调用 pase_args 函数， 解析不能被 pase_early_param 函数解析的参数。</div><div class="line">18. 调用 (pid.c)pidhash_init 函数,  call  (page_alloc.c)alloc_large_system_hash 函数, allocate 一个大的系统 <span class="built_in">hash</span> table，名字为 PID .</div><div class="line">19. 调用 (dcache.c)bfs_caches_init_early 函数, call 两次 alloc_large_system_hash 函数, allocate 两个大的系统 <span class="built_in">hash</span> table，名字为 Dentry Cache + Inode-Cache .</div><div class="line">20. 调用 (eatable.c)sort_main_extable 函数, 对异常处理函数table进行排序。</div><div class="line">21. 调用 (arch/x86/kernel/traps.c)trap_init 函数,  初始化 硬件中断.</div><div class="line">22. 调用 (main.c)mm_init 函数, 建立内存分配器.   该函数会调用  page_ext_init_flatmem + mem_init + kmem_cache_init + percpu_init_late + pgtable_init + vmalloc_init + ioremap_huge_init  .</div><div class="line">23. 调用 (core.c)sched_init 函数， 初始化 调度器 .  该调度器会处理各种中断.  很复杂.</div><div class="line">24. preempt_disable 函数， 禁止调度抢占.</div><div class="line">25. 调用 idr_init_cache 函数， call  kmem_cache_create 函数 创建 kmem_cache , 该cache 名为 idr_layer_cache .</div><div class="line">26. 调用 (workqueue.c)workqueue_init_early 函数,  该函数 建立 各种数据结构／系统workqueue，  调用 多次 alloc_workqueque 函数 构建 各种事件队列.</div><div class="line">27. rcu_init 函数， 初始化互斥访问机制.</div><div class="line">28. (tiny.c/tree.c)trace_init 函数,   trace printk 调用.</div><div class="line">29. (context_tracking.c)context_tracking_init 函数,   tracking context 在哪个cpu上运行.</div><div class="line">30. (radix-tree.c)radix_tree_init函数,  call  kmem_cache_create 创建 kmem_cache， 该cache 名为 radix_tree_node .  radix tree 为 基数树.</div><div class="line">31. (irq.c)early_irq_init 函数, 调用 arch_early_irq_init 函数, 构建 irq_domain 结构体.</div><div class="line">32. (irqinit.c)init_IRQ 函数,  调用  arch/x86/kernel/irqinit.c init_IRQ 函数， 初始化中断向量. 关键结构体 有 x86_init_ops .</div><div class="line">33. (tick-common.c)tick_init 函数, 初始化 时钟控制.</div><div class="line">34. rcu_init_nohz 函数.</div><div class="line">35. (timer.c)init_timers 函数, 初始化 定时器. 原理是： 通过 调用 open_softirq 软中断， 注册中断处理函数为 run_timer_softirq.</div><div class="line">36. hrtimers_init 函数， 初始化 高精度定时器.</div><div class="line">37. (softer_init.c)softirq_init 函数，  软中断 初始化.  调用 open_softirq 注册2个级别 TASKLET_SOFTIRQ + HI_SOFTIRQ  中断 向量， 关键对象 softirq_vec .   可以学习:  soft_irq 与 tasklet 区别。</div><div class="line">38. timekeeping_init : 初始化资源和普通计时器,  初始化 clocksource 和 common timekeeping values.</div><div class="line">39. time_init :    call  (arch/x86/kernel/time.c) x86_late_time_init 函数, 注册 结构体 x86_init_ops 对象的  timer 属性.   以及 时钟中断, 在后面的 late_time_init 函数中调用.           </div><div class="line">40. sched_clock_postinit :  初始化 clock_data 结构体, 更新 调度 计时器.   </div><div class="line">41. printk_safe_init: 调用 init_irq_work 函数 初始化中断栈, 将 pending 的 所有 message 全都<span class="built_in">print</span> 出去.</div><div class="line">42. (core.c)perf_event_init:  初始化 idr 结构体, call perf_pmu_function 注册 performance monitoring unit(pmu) 各类事件，   pmu 事件类型有：perf_swevent +   perf_tracepoint + perf_cpu_clock + perf_task_clock + perf_breakpoint .</div><div class="line">43. (profile.c)profile_init : kernel profiling 工具 初始化.  初始化 内核调优 的代码, 与内核启动的传入参数有关.  CPU_PROFILING + SCHED_PROFILING + SLEEP_PROFILING + KVM_PROFILING .</div><div class="line">44.  call_function_init: 不知道做啥.</div><div class="line">45.  (slab.c)kmem_cache_init_late : 调.整 cpu cache大小, 并且 注册 一段 memory 用于 hotplug 回调.</div><div class="line">46. (tty_io.h)console_init : 初始化 console  device. 可以显示 printk 的内容.</div><div class="line">47. (locked.c)lockdep_info :  打印 一些 依赖 信息.</div><div class="line">48. (locking-selftest.c)locking_selftest : self-test  <span class="keyword">for</span>  hard/soft-irqs.</div><div class="line">49. (ifdef  CONFIG_BLK_DEV_INITRD)initrd_start :  kernel启动时是否传入 initrd 参数， 传入的话 会进入 raw disk.</div><div class="line">50. (page_ext.c)page_ext_init : 防止高位内存出界, 出界的内存可能没有被初始化，重新初始化, 并且 设置 回调 函数.</div><div class="line">51. (debugobjects.c) debug_objects_mem_init :  debug 内存 是否 越界.</div><div class="line">52. (kmemleak.c)kmemleak_init : 内核内存 分配 泄漏 检测 逻辑 初始化.</div><div class="line">53. (page_alloc.c)setup_per_cpu_pageset :  为每一个 cpu 分配内存 页表 及 页表区.  在此函数调用之前, 可被使用的内存 仅为 boot memory.     </div><div class="line">54. (mempolicy.c)numa_policy_init : 设置内存 numa(Non-uniform memory access, 非统一内存访问架构) 规则. 关键结构体: mempolicy</div><div class="line">55. (arch/x86/kernel/time.c)later_time_init : 执行 time_init 函数初始化的内容.</div><div class="line">56. calibrate_delay : 校准 时延.</div><div class="line">57. (pid.c)pidmap_init :  初始化  pid_max 值, 以及 初始化 pid_namespace 结构体.  保留 pid 为0 的位置.</div><div class="line">58. (rmap.c)anon_vma_init : (Anonymous Virtual Memory Access) 匿名虚拟内存区域初始化.  </div><div class="line">59. (drivers/acpi/bus.c)acpi_early_init:     ACPI ？？？  不知道 干什么?</div><div class="line">60. (efi.c)efi_enter_virtual_mode :  也不清楚 EFI 做啥？</div><div class="line">61.  (esprit_64.c)init_espfix_bsp : 调整 进程 esp 寄存器位置, 在 non-init 进程创建之前调用.</div><div class="line">62.  (fork.c)thread_stack_cache_init : 调用 kmem_cache_create 在内核内存区 创建 thread_stack cache.</div><div class="line">63. (cred.c)cred_init : 调用 kmem_cache_create 在内核内存区 创建 cred_jar  cache, 用于 存储 credentials.</div><div class="line">64. (fork.c)fork_init : 进程创建机制 初始化, 调用 kmem_cache_create 在内核内存区 创建 task_struct cache,  set_max_threads, 关键结构体 task_struct</div><div class="line">65. (fork.c)proc_caches_init : 进程创建所需的其它结构体 初始化, 调用 kmem_cache_create 在内核内存区 创建 sighand_cache/signal_cache/files_cache/fs_cache/mm_struct  cache .</div><div class="line">66. (fs/buffer.c)buffer_init : 调用 kmem_cache_create 在内核内存区 创建 buffer_head  cache. 将一定数量的内存区 设置为 buffer.</div><div class="line">67. (security/keys/key.c)key_init : 内核密钥 管理,  调用 kmem_cache_create 在内核内存区 创建 key_jar  cache .    </div><div class="line">68. (security.c)security_init : 内核安全框架. 比较复杂, 没看懂 ?</div><div class="line">69. (debug_core.c)dbg_late_init : kernel debug stuff.</div><div class="line">70. (fs/dcache.c)vfs_caches_init : 创建虚拟文件系统.  主要调用函数有:  dcache_init, inode_init, files_init, files_maxfiles_init, mnt_init(该函数还会调用 kernfs_init/sysfs_init/kobject_create_and_add/init_rootfs/init_mount_tree), bdev_cache_init, chrdev_init.  调用 kmem_cache_create 在内核内存区 创建 names_cache + dentry + inode_cache + filp + mnt_cache + bdev_cache   cache.  调用 alloc_large_system_hash   分配 Dentry cache + Inode-cache + Mount-cache + Mountpoint-cache     HashMap.</div><div class="line">    (mount.c)kernfs_init : 该函数 在内核内存区 创建 kernfs_node_cache  cache.  </div><div class="line">    (kobject.c)kobject_create_and_add : 创建 kobject  fs 对象.</div><div class="line">    (mount.c)sysfs_init : 该函数 调用  register_filesystem 函数, 初始化 file_system_type 对象 sysfs .  register_filesystem 当加载fs对应module时调用该函数.   </div><div class="line">    (do_mounts.c)init_rootfs : 该函数调用  register_filesystem 函数, 初始化 file_system_type 对象 rootfs + tmpfs/ramfs  </div><div class="line">    (namespace.c)init_mount_tree :  设置 rootfs mount tree.</div><div class="line">    (block_dev.c)bdev_cache_init : 注册 block 设备,  注册对象为 file_system_type  bdev .   bd_mount 扫描磁盘, 获得 磁盘 文件系统.      </div><div class="line">    (char_dev.c)chrdev_init :  注册 字符设备.</div><div class="line">71. (mm/filemap.c)pagecache_init :  该函数 主要是初始化 页写回 机制, 主要函数为 (page_writeback.c)page_writeback_init .</div><div class="line">72. (kernel/signal.c)signals_init :  调用 kmem_cache_create 在内核内存区 创建  sigqueue  cache 对象.  </div><div class="line">73. (fs/proc/root.c)proc_root_init :  proc 文件系统初始化, 主要调用  proc_init_inodecache + set_proc_pid_nlink + register_filesystem + proc_self_init + proc_thread_self_init + proc_symlink + proc_net_init + proc_mkdir + proc_create_mount_point + proc_tty_init + proc_sys_init .        </div><div class="line">        (fs/proc/inode.c)proc_init_inodecache :  调用 kmem_cache_create 在内核内存区 创建  proc_inode_cache 对象.</div><div class="line">        (fs/proc/base.c)set_proc_pid_nlink :  主要 调用 pid_entry_nlink 函数,  关键结构体 为 pid_entry . 初始化 2个对象:  tid_base_stuff  + tgid_base_stuff .         </div><div class="line">        (filesystem.c)register_filesystem : 注册 proc  filesystem .  关键 函数为  proc_mount, 该函数会注册 /proc/self 文件夹.  </div><div class="line">        (fs/proc/thread_self.c)proc_self_init + proc_thread_self_init :  初始化 /proc/self 文件夹.  </div><div class="line">        (fs/proc/thread_self.c)proc_symlink :  创建 链接 文件 /proc/mounts  链接  /proc/self/mounts .  </div><div class="line">        (fs/proc/proc_net.c)proc_net_init :   创建  链接 文件 /proc/net  链接  /proc/self/net .  初始化  /proc/self/net  文件夹.</div><div class="line">        proc_mkdir : 创建 sysvipc, fs, driver, bus  文件夹 .  </div><div class="line">        proc_create_mount_point : 创建  /proc/fs/nfsd 文件夹 .</div><div class="line">        proc_tty_init : 创建 /proc/tty 文件夹.</div><div class="line">        (fs/proc/proc_sysctl.c)proc_sys_init :  注册和初始化  /proc/sys (sysctl)  文件系统.   关键函数 ：  __register_sysctl_paths</div><div class="line">74. nsfs_init : 不知道干啥 ???</div><div class="line">75. (kernel/cpuset.c)cpuset_init :  初始化 cpuset 系统, 并且 创建 /sys/fs/cgroup/cpuset 文件夹.  </div><div class="line">76. (kernel/cgroup.c)cgroup_init :  control group 初始化.  </div><div class="line">77. (kernel/taskstats.c)taskstats_init_early : 早期初始化，初始化 taskstats 结构体.</div><div class="line">78. delayacct_init() + check_bugs() + acpi_subsystem_init() + arch_post_acpi_subsys_init() + sfi_init_late()</div><div class="line">79. (main.c)rest_init :  完成 剩下 non-init 的 任务.    包括 :    —&gt; https://danielmaker.github.io/blog/linux/images/start_kernel_call_graph.svg</div><div class="line">            rcu_scheduler_starting :     启动 rcu_scheduler</div><div class="line">            kernel_thread(kernel_init) :  do_fork 启动一个 进程 执行 kernel_init 函数.  PID 为 1 的进程.   —&gt;  kernel_init_freeable函数   +   run_init_process</div><div class="line">            numa_default_policy : 内存分配  numa 策略.</div><div class="line">            kernel_thread(kthreadd) :   执行 kthreadd 函数.  PID 为 2 的 进程.  为spawn所有其它的 thread 进程 .</div><div class="line">            find_task_by_pid_ns</div><div class="line">            init_idle_bootup_task</div><div class="line">            schedule_preempt_disabled</div><div class="line">            cpu_startup_entry            ——&gt;   do_idle  cpu 调度        idle 为 PID 为 0 的进程.</div></pre></td></tr></table></figure></p>
<p>rest_init函数所做内容示意图:<br><img src="/images/start_kernel_call_graph.svg" alt=""></p>
<p>内核代码中 调用 alloc_large_system_hash 函数的位置有不少，会构建一些 大的系统 hash table， 名称分别有：</p>
<ol>
<li>Dentry cache</li>
<li>Inode-cache</li>
<li>Mount-cache</li>
<li>Mountpoint-cache</li>
<li>PV qspinlock</li>
<li>futex</li>
<li>PID</li>
<li>TCP established</li>
<li>TCP bind</li>
<li>UDP  or  UDP-Lite</li>
</ol>
<p>—————————————中断 宏： SAVE_ALL &amp; RESTORE_ALL    用户态和内核态 上下文切换 ————————————<br>中断向量表：    <strong>linux/arch/x86/entry/systemcalls/syscall_32.tbl</strong><br>中断结构体：    <strong>irq_desc</strong></p>
<p>linux/arch/x86/entry/entry_32.S  : 系统调用的代码段,   入口应该是：<br><a href="http://lxr.linux.no/linux+v3.19/arch/x86/kernel/entry_32.S" target="_blank" rel="external">http://lxr.linux.no/linux+v3.19/arch/x86/kernel/entry_32.S</a>      —&gt;      ENTRY(system_call)</p>
<p>Linux 进程 fork 关键代码：<br><a href="http://lxr.linux.no/linux+v3.19/kernel/fork.c#L1185" target="_blank" rel="external">http://lxr.linux.no/linux+v3.19/kernel/fork.c#L1185</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux系统启动源代码分析/" class="archive-article-date">
  	<time datetime="2017-07-19T14:45:54.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Source-Code/">Linux Source Code</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux编译+文件IO" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux编译+文件IO/">Linux编译知识 + 文件操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="编译相关命令"><a href="#编译相关命令" class="headerlink" title="编译相关命令"></a>编译相关命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1. gcc -g -Wall hello_world.c -o hello_world          生成可执行程序</div><div class="line">2. gcc -E hello_world.c &gt; hello_world.i               预处理过程的输出文件, gcc -E 预处理结束之后，编译会自动停止</div><div class="line">3. gcc -S hello_world.c -o hello_world.s               对源代码进行语法分析，产生汇编文件, gcc -S 汇编结束之后，编译会自动停止</div><div class="line">4. gcc -g -Wall -v  hello_world.c -o hello_world    -v查看中间结果输出</div><div class="line">5. readelf -a hello_world                     Linux下可执行程序格式一般为ELF格式， readelf可以读取ELF格式的文件</div><div class="line">6. strace ./hello_world                    strace可以跟踪系统调用，从而可以了解应用程序加载／运行／退出 的过程。</div></pre></td></tr></table></figure>
<p>用户空间的程序默认是通过栈来传递参数的，但对于系统调用来说，内核态和用户态使用的是不同的栈，这使得系统调用的参数只能通过寄存器的方式进行传递。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1. objdump -S thread_safe        可以对运行代码进行反汇编</div></pre></td></tr></table></figure></p>
<ul>
<li>阻塞的系统调用：当进行系统调用时，除非出错或被信号打断，进程将会一直陷入内核态直到调用完成。</li>
<li>非阻塞的系统调用：是指无论I/O操作成功与否，调用都会立刻返回。</li>
</ul>
<h3 id="文件I-O"><a href="#文件I-O" class="headerlink" title="文件I/O"></a>文件I/O</h3><ol>
<li>内核中 进程对应的数据结构是task_struct， 位于内核代码的 include/linux/sched.h 文件中。</li>
<li>内核中 文件表对应的数据结构是files_struct，位于内核代码的 include/linux/fdtable.h 文件中。</li>
<li>数据结构 file，位于内核代码 include/linux/fs.h 文件中。</li>
<li>Linux中的第一个进程init，位于内核代码的 include/linux/init_task.h 以及 fs/file.c 文件中。</li>
<li>所有进程都是由init进程fork出来的，代码位于 kernel/fork.c 文件中，该文件会 调用 include/linux/fdtable.h 以及 fs/file.c 文件中的 dup_fd 函数。</li>
<li>glibc中的open函数，调用内核中的 fs/open.c 文件的do_sys_open 函数，do_sys_open函数会使用get_unused_fd_flags函数，get_unused_fd_flags函数在include/linux/file.h是宏定义，实际调用 fs/file.c 中的alloc_fd函数。</li>
<li>内核会通过fs/open.c文件中的fd_install函数将文件管理结构file与fd结合起来，当用户使用fd与内核交互时，内核可以通过fd得到内部管理文件的结构struct file。</li>
<li>内核在文件close的时候，会关闭该fd，如果当前next_fd小于该fd，则将next_fd的直设置为该fd值。这是内核的文件描述符使用策略，尽可能的使用刚释放的较小的fd。</li>
<li>内核文件include/linux/fs.h中，file_operations 结构体定义了文件操作函数, inode_operations 结构体定义了linux存储inode操作函数。</li>
<li>文件打开但忘记close的时候，可能会出现两种情况：a. 文件描述符始终没有被释放；b. 用于文件管理的某些内存结构没有被释放。<br>a. 内核会扩展文件表，当文件表达到上限时，会报EMFILE错误。<br>b. 未超过上限时，可以申请空的内存；达到上限时，会报VFS: file-max limit reached的错误。</li>
</ol>
<h3 id="ELF文件"><a href="#ELF文件" class="headerlink" title="ELF文件"></a>ELF文件</h3><p>ELF = Executable and Linkable Format<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">readelf  命令 可以读 Linux 可执行文件.</div></pre></td></tr></table></figure></p>
<h3 id="glibc调用-system-call"><a href="#glibc调用-system-call" class="headerlink" title="glibc调用 system_call"></a>glibc调用 system_call</h3><p>一般Linux程序编写都会使用到glibc库, 而最终glibc也只是帮助用户进行系统调用而已, 至于glibc如何进行系统调用的？<br>通过阅读源码发现, 所有的函数都会最终调用glibc的源码中的 <strong>sysdep.h</strong> ,  里面有  <strong>INLINE_SYSCALL</strong> 定义</p>
<h3 id="Linux-创建-thread"><a href="#Linux-创建-thread" class="headerlink" title="Linux 创建 thread"></a>Linux 创建 thread</h3><p>Linux中实际上 thread 也是被当成 process 来创建, process和thread 是一样的, 区别在于系统调用时的传参.<br><img src="/images/Linux_pthread_create_1.png" alt=""></p>
<h3 id="Linux-boot-process"><a href="#Linux-boot-process" class="headerlink" title="Linux boot process"></a>Linux boot process</h3><p>refer： <a href="http://duartes.org/gustavo/blog/post/kernel-boot-process/" target="_blank" rel="external">http://duartes.org/gustavo/blog/post/kernel-boot-process/</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux编译+文件IO/" class="archive-article-date">
  	<time datetime="2017-07-19T14:24:27.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux Kickstart Install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux Kickstart Install/">Linux Kickstart Install(无人值守安装)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Linux-Install"><a href="#Linux-Install" class="headerlink" title="Linux Install"></a>Linux Install</h3><ul>
<li>Linux dd：  driver disk 安装。</li>
<li>Linux ks：  kickstart 安装，无人值守安装。</li>
</ul>
<p>boot:  linux  ks=nfs:192.168.0.254:/var/ftp/pub/ks.cfg</p>
<p><strong>anaconda</strong> 是python写的系统安装工具。</p>
<p>Linux 中有 4个主分区 ＋ 逻辑分区(需要将其中一个主分区变为扩展分区)。</p>
<p>Installation过程中可以切换窗口，Ctrl ＋ Alt ＋ F1,2,3,4,5,6,每个窗口分别有不同的作用。</p>
<h3 id="Linux-Kickstart-Install"><a href="#Linux-Kickstart-Install" class="headerlink" title="Linux Kickstart Install"></a>Linux Kickstart Install</h3><p><strong>anaconda-ks.cfg</strong>       kickstart安装配置文件<br>python —&gt; anaconda —&gt; install Linux<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install pykickstart</div><div class="line">yum install system-config-kickstart          无人值守需要先安装rpm包</div></pre></td></tr></table></figure></p>
<p><strong>/tftpboot/n1.cfg配置文件：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">delay=0</div><div class="line">image=/tftpboot/osimage/rhels7.1-x86_64-install-gss1/vmlinuz</div><div class="line">   label=<span class="string">"Kickstart"</span></div><div class="line">   initrd=/tftpboot/osimage/rhels7.1-x86_64-install-gss1/initrd.img</div><div class="line">   append=<span class="string">"quiet inst.repo=http://%N:80/install/rhels7.1/x86_64 inst.ks=http://%N:80/install/autoinst/cn1 ip=eth0:dhcp  net.ifnames=0 net.ifnames=0  BOOTIF=%B"</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux Kickstart Install/" class="archive-article-date">
  	<time datetime="2017-07-19T13:51:12.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Linux奇形怪状的命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Linux奇形怪状的命令/">Linux一些命令总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="通过Sighup信号让Linux-Daemon重新加载配置文件"><a href="#通过Sighup信号让Linux-Daemon重新加载配置文件" class="headerlink" title="通过Sighup信号让Linux Daemon重新加载配置文件"></a>通过Sighup信号让Linux Daemon重新加载配置文件</h3><p>对于守护进程而言，一般情况下守护进程都是detach from shell，所以接受不到sighup信号，这个信号经常被用作 reload configuration左右。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span>  -s   SIGHUP  <span class="variable">$pid</span></div></pre></td></tr></table></figure></p>
<h3 id="Linux-syslog"><a href="#Linux-syslog" class="headerlink" title="Linux syslog"></a>Linux syslog</h3><p>Linux 系统中的主要log都在/var/log目录下：</p>
<ul>
<li>/var/log/lastlog:  用户登录系统记录日志。</li>
<li>/var/log/secure:  与Linux中身份验证相关的日志文件，比如：ssh。</li>
<li>/var/log/messages:  是Linux中许多应用的首选日志文件。</li>
<li>/var/log/maillog:  邮件相关。</li>
<li>/var/log/cron:  计划任务日志， /etc/cron.d/sysstat。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">klogd  —dmesg               —&gt; /var/<span class="built_in">log</span>/dmesg</div><div class="line">syslogd                     —&gt; /ect/syslog.conf</div><div class="line">两个共同的配置文件 —&gt; /etc/sysconfig/syslog</div></pre></td></tr></table></figure>
<p>redhat 中使用了   <strong>rsyslog</strong> 替代 syslog<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/rsyslog.d/*</div></pre></td></tr></table></figure></p>
<h3 id="Linux-tty-ttyS-pts-X-Window"><a href="#Linux-tty-ttyS-pts-X-Window" class="headerlink" title="Linux tty/ttyS/pts + X-Window"></a>Linux tty/ttyS/pts + X-Window</h3><ul>
<li>tty：是串口的终端模拟器，模拟鼠标／键盘／显示器等设备。</li>
<li>ttyS：Linux下的真正的串口。</li>
<li>pts：虚拟的设备终端，由application（如：X-window，SSH）动态创建。 (X-window中的终端模拟器Teminal 也会创建相应的pts/#)</li>
<li>X-window： 是Linux的图形界面application。</li>
</ul>
<p>w: 显示当前所有的登录用户</p>
<p>多登陆端口通信：  （pts/1向pts/0发送消息）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__pts/1:__  <span class="built_in">echo</span>  aaaaaaaaa  &gt;  /dev/pts/0</div><div class="line">__pts/0:__  aaaaaaaaa</div></pre></td></tr></table></figure></p>
<ul>
<li>Alt＋F7: 打开第一个X-window窗口，Alt+F8 打开第二个</li>
<li>Linux启动的时候，会首先打开6个tty串口模拟器(Alt + F1-6) +++++ 1个X-window application(Alt + F7)。</li>
<li>startx: 启动X-window命令。   startx –:1 (打开第二个X-window)     startx –:2 (打开第三个X-window)         这个命令在pts虚拟终端中无法运行。</li>
<li>skill -9 pts/2  让另一个控制台的人掉线。</li>
</ul>
<p>vim /etc/inittab     可以减少默认启动的tty个数！！！！</p>
<h3 id="Linux-打包及压缩工具"><a href="#Linux-打包及压缩工具" class="headerlink" title="Linux 打包及压缩工具"></a>Linux 打包及压缩工具</h3><p><strong>compress/uncompress</strong>     最古老的Unix压缩工具<br><strong>gzip/gunzip</strong>          最广泛的压缩工具，Linux系统中标准压缩工具，对于文本文件能够达到很高压缩率<br><strong>bzip2/bunzip2</strong>     新版Linux压缩工具，比gzip拥有更高的压缩率<br><strong>tar</strong> 打包(备份)作用，参数：</p>
<ul>
<li>-c:  将文件备份create</li>
<li>-v:  将过程输出verbose</li>
<li>-x:  从一个文件中解出备份extract</li>
<li>-r:  将文件添加入已经存在的文件中</li>
<li>-C: 解出备份指向位置</li>
<li>-z:  gzip压缩</li>
<li>-j:  bzip2压缩<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar xvf/xvf/rvf</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Linux-文件类型-7种-查询inode的命令"><a href="#Linux-文件类型-7种-查询inode的命令" class="headerlink" title="Linux 文件类型(7种) + 查询inode的命令"></a>Linux 文件类型(7种) + 查询inode的命令</h3><p>Linux 下文件类型共有7种：<br>“-“     文件<br>d     文件夹<br>l     链接<br>b     block<br>c     char字符设备<br>s     socket文件<br>p     protocol网络文件</p>
<p>文件分为三个部分进行存储：(目录文件中存储文件名)<br>1.存储文件名(指向inode号)   —&gt;   2.inode(指向块存储单元)   —&gt;  3.block (4k为单位)</p>
<p>inode 存储文件的属性，  可以用 <strong>stat</strong> 命令查看文件inode的内容。</p>
<h3 id="Linux-文件命令"><a href="#Linux-文件命令" class="headerlink" title="Linux 文件命令"></a>Linux 文件命令</h3><p>文本文件的操作命令：</p>
<ul>
<li>cat： 查看文件内容</li>
<li>more： 逐屏查看文件内容</li>
<li>less： 逐行查看文件内容</li>
<li>head：显示文件开头部分内容</li>
<li>tail： 显示文件结尾部分内容</li>
<li>diff： 报告文件差异</li>
<li>uniq： 去除文件中的相邻的重复行</li>
<li>cut： 只显示文件中的某一行                         cut -d: -f1  /etc/passwd</li>
<li>sort：按序重排文本                                sort  -t:  +2  -n  /etc/passwd</li>
<li><p>wc： 统计文件的行，词，字数</p>
</li>
<li><p>which  ls     :   查找命令,  查找 $PATH 路径中的文件</p>
</li>
<li>whereis  ls  :   可以查找命令及相应的man文件, 查找 $PATH 和 $MANPATH 路径</li>
<li><p>locate  ls :      查找所有匹配ls字母的文件，  注意!!!  locate 命令从数据库中查找文件，而不是直接查找系统文件，数据库位置为/var/lib/slocate/slocate.db.        当数据库没有更新的时候，可能会查找不到。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install mlocate     !!!                   </div><div class="line">updatedb 更新locate 的数据库                   </div><div class="line">/etc/cron.daily/mlocate 每天有定时更新数据库的任务</div></pre></td></tr></table></figure>
</li>
<li><p>find</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find  .  -iname  “xxx”  -ok   file  &#123;&#125;  \;        交互执行file命令</div><div class="line">find  .  -iname  “xxx”  -<span class="built_in">exec</span>   file  &#123;&#125;  \;      直接执行file命令</div></pre></td></tr></table></figure>
<ul>
<li>grep</li>
</ul>
<h3 id="Linux-系统服务启动-readhat6-x的init程序-readhat7之后的systemd之后的并非如此"><a href="#Linux-系统服务启动-readhat6-x的init程序-readhat7之后的systemd之后的并非如此" class="headerlink" title="Linux 系统服务启动(readhat6.x的init程序, readhat7之后的systemd之后的并非如此)"></a>Linux 系统服务启动(readhat6.x的init程序, readhat7之后的systemd之后的并非如此)</h3><p>系统服务启动顺序：<br>|-/etc/inittab                    总的配置文件<br>|—–/etc/rc.d/rc.sysinit                    系统初始化文件, 加载许多内容<br>————fsck.ext3   mount  -o  rw.remount   /dev/sda2  /<br>————mount  -a  /etc/fstab<br>|—–/etc/rc.d/rcX.d/*                    X为系统运行级别<br>|———-/etc/rc.d/rcX.d/ServiceXXX1  start               用户定义自启动的service<br>|———-/etc/rc.d/rcX.d/ServiceXXX2  start<br>|—–/etc/rc.d/rc.local          最后访问的文件<br>|<br>|-minigetty   启动   /dev/tty1-6                                   启动tty<br>|———-login    —&gt;  bash     —&gt;  /etc/profile     ~/.bash_profile<br>|-gdm               监控进程是否死掉，重启进程</p>
<ul>
<li>respawn          监控tty进程是否死掉，如果死掉会重启tty进程    respawn与init进程共同死，共同活</li>
<li>chkconfig  service  on/off –level X    将service 启动/关闭 脚本 加入/删除 到/etc/rc.d/rcX.d 目录下</li>
<li>加入到rcX.d 目录之后，可以用        service  Sname   start/stop/restart      来控制service</li>
</ul>
<h3 id="Linux-一些命令"><a href="#Linux-一些命令" class="headerlink" title="Linux 一些命令"></a>Linux 一些命令</h3><p>shutdown -h now／init 0 ／ halt  -p -f ／ poweroff： 关机<br>users： 显示当前系统登录的用户<br>who： 当前登录在本机的用户及来源<br>w： 当前登录本机的用户及运行的程序<br>write： 给当前联机的用户发消息<br>wall： 给所有登录在本机的用户广播消息<br>last： 查看用户的登录日志<br>lastlog： 查看每个用户最后登录的情况<br>finger： 查看用户信息</p>
<h3 id="Linux-网络"><a href="#Linux-网络" class="headerlink" title="Linux 网络"></a>Linux 网络</h3><p><strong>ping -s 1024  www.baidu.com</strong>          -s 可以指定测试包的大小，用于测试不同包大小的带宽。<br><strong>ab -n 1000 -c 1000  www.baidu.com</strong>         ab为 linux压力测试的命令，模拟1000个端口，进行总共1000次请求          (Apache HTTP server benchmarking tool)<br><strong>traceroute  www.baidu.com</strong>                    查询整个转发路径上的访问结点的掉包率<br><strong>mtr  www.baidu.com</strong>                    查看通路的掉包率<br><strong>arping</strong>  查询哪个机器网卡ip地址是多少</p>
<p><strong>top</strong><br><strong>vmstat</strong>          (Report virtual memory statistics)<br><strong>netstat</strong>          (Print network connections, routing tables, interface statistics, masquerade connections, and multicast memberships)<br><strong>netstat</strong> 查看tcp连接时, 如果<br>ESTABLISHED特别多              <strong>CC(Challenge Collapsar)</strong> 攻击, 建立链接攻击<br>ESTABLISHED很少,LISTEN很多     <strong>DDOS</strong> 攻击  sync-flood(泛滥攻击)</p>
<p>抓包工具：</p>
<ul>
<li>iptraf</li>
<li>tcpdump</li>
<li>wireshark</li>
</ul>
<h3 id="Linux-网络内核参数修改"><a href="#Linux-网络内核参数修改" class="headerlink" title="Linux 网络内核参数修改"></a>Linux 网络内核参数修改</h3><p>Linux 内核内核参数：<br>位于 /proc/sys 目录下, 修改内核参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</div><div class="line">sysctl  -w  net.ipv4.icmp_echo_ignore_all=1</div><div class="line">sysctl  -p  <span class="variable">$file</span>     load config from file</div></pre></td></tr></table></figure></p>
<p>输出内核参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl  -a  &gt; /tmp/sysctl.output</div></pre></td></tr></table></figure></p>
<p>从文件中读入内核参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl  -f   /tmp/sysctl.output  -p</div></pre></td></tr></table></figure></p>
<h3 id="rpm包管理"><a href="#rpm包管理" class="headerlink" title="rpm包管理"></a>rpm包管理</h3><ul>
<li><p>解压rpm包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm2cpio *.rpm | cpio -div</div></pre></td></tr></table></figure>
</li>
<li><p>查询rpm包里面内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@vmenable core]<span class="comment"># rpm -qpl *.rpm</span></div><div class="line">/etc/*-release</div><div class="line">/opt/*/swidtag</div><div class="line">/opt/*/swidtag/*.swidtag</div></pre></td></tr></table></figure>
</li>
<li><p>查询rpm包里面的install/uninstall script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@vmenable core]<span class="comment"># rpm -qpl   *.x86_64.rpm  --scripts</span></div><div class="line">preinstall scriptlet (using /bin/sh):</div><div class="line">postinstall scriptlet (using /bin/sh):</div><div class="line">preuninstall program: /bin/sh</div><div class="line">postuninstall scriptlet (using /bin/sh):</div></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Linux奇形怪状的命令/" class="archive-article-date">
  	<time datetime="2017-07-19T13:28:39.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-tags" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/tags/">标签</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Openstack"><a href="#Openstack" class="headerlink" title="Openstack"></a><a href="https://sstar1314.github.io/tags/Openstack/" target="_blank" rel="external">Openstack</a></h4><h4 id="Cassandra"><a href="#Cassandra" class="headerlink" title="Cassandra"></a><a href="https://sstar1314.github.io/tags/Cassandra/" target="_blank" rel="external">Cassandra</a></h4><h4 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a><a href="https://sstar1314.github.io/tags/Hadoop/" target="_blank" rel="external">Hadoop</a></h4><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a><a href="https://sstar1314.github.io/tags/Kafka/" target="_blank" rel="external">Kafka</a></h4><h4 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a><a href="https://sstar1314.github.io/tags/NoSQL/" target="_blank" rel="external">NoSQL</a></h4><h4 id="Spark"><a href="#Spark" class="headerlink" title="Spark"></a><a href="https://sstar1314.github.io/tags/Spark/" target="_blank" rel="external">Spark</a></h4><h4 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a><a href="https://sstar1314.github.io/tags/ZooKeeper/" target="_blank" rel="external">ZooKeeper</a></h4><h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a><a href="https://sstar1314.github.io/tags/etcd/" target="_blank" rel="external">etcd</a></h4><h4 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a><a href="https://sstar1314.github.io/tags/JVM/" target="_blank" rel="external">JVM</a></h4><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a><a href="https://sstar1314.github.io/tags/Docker/" target="_blank" rel="external">Docker</a></h4><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><a href="https://sstar1314.github.io/tags/Linux/" target="_blank" rel="external">Linux</a></h4><h4 id="Linux-Source-Code"><a href="#Linux-Source-Code" class="headerlink" title="Linux Source Code"></a><a href="https://sstar1314.github.io/tags/Linux-Source-Code/" target="_blank" rel="external">Linux Source Code</a></h4><h4 id="Linux-Networking-Internals"><a href="#Linux-Networking-Internals" class="headerlink" title="Linux Networking Internals"></a><a href="https://sstar1314.github.io/tags/Linux-Networking-Internals/" target="_blank" rel="external">Linux Networking Internals</a></h4><h4 id="Linux-Special-File-System"><a href="#Linux-Special-File-System" class="headerlink" title="Linux Special File System"></a><a href="https://sstar1314.github.io/tags/Linux-Special-File-System/" target="_blank" rel="external">Linux Special File System</a></h4><h4 id="Qemu"><a href="#Qemu" class="headerlink" title="Qemu"></a><a href="https://sstar1314.github.io/tags/QEMU/" target="_blank" rel="external">Qemu</a></h4><h4 id="Libvirt"><a href="#Libvirt" class="headerlink" title="Libvirt"></a><a href="https://sstar1314.github.io/tags/Libvirt/" target="_blank" rel="external">Libvirt</a></h4><h4 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a><a href="https://sstar1314.github.io/tags/Maven/" target="_blank" rel="external">Maven</a></h4><h4 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a><a href="https://sstar1314.github.io/tags/kubernetes/" target="_blank" rel="external">kubernetes</a></h4><h4 id="lxc"><a href="#lxc" class="headerlink" title="lxc"></a><a href="https://sstar1314.github.io/tags/lxc/" target="_blank" rel="external">lxc</a></h4><h4 id="lxcfs"><a href="#lxcfs" class="headerlink" title="lxcfs"></a><a href="https://sstar1314.github.io/tags/lxcfs/" target="_blank" rel="external">lxcfs</a></h4>
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/tags/" class="archive-article-date">
  	<time datetime="2017-07-19T09:45:04.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-categories" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/categories/">目录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Openstack"><a href="#Openstack" class="headerlink" title="Openstack"></a><a href="https://sstar1314.github.io/categories/Openstack/" target="_blank" rel="external">Openstack</a></h4><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a><a href="https://sstar1314.github.io/categories/Kafka/" target="_blank" rel="external">Kafka</a></h4><h4 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a><a href="https://sstar1314.github.io/categories/NoSQL/" target="_blank" rel="external">NoSQL</a></h4><h4 id="bigdata"><a href="#bigdata" class="headerlink" title="bigdata"></a><a href="https://sstar1314.github.io/categories/bigdata/" target="_blank" rel="external">bigdata</a></h4><h4 id="分布式协同"><a href="#分布式协同" class="headerlink" title="分布式协同"></a><a href="https://sstar1314.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E5%90%8C/" target="_blank" rel="external">分布式协同</a></h4><h4 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a><a href="https://sstar1314.github.io/categories/Tomcat/" target="_blank" rel="external">Tomcat</a></h4><h4 id="Mesos"><a href="#Mesos" class="headerlink" title="Mesos"></a><a href="https://sstar1314.github.io/categories/Mesos/" target="_blank" rel="external">Mesos</a></h4><h4 id="容器技术"><a href="#容器技术" class="headerlink" title="容器技术"></a><a href="https://sstar1314.github.io/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" target="_blank" rel="external">容器技术</a></h4><h4 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a><a href="https://sstar1314.github.io/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/" target="_blank" rel="external">虚拟化</a></h4><h4 id="Java"><a href="#Java" class="headerlink" title="Java"></a><a href="https://sstar1314.github.io/categories/Java/" target="_blank" rel="external">Java</a></h4><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><a href="https://sstar1314.github.io/categories/Linux/" target="_blank" rel="external">Linux</a></h4>
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/categories/" class="archive-article-date">
  	<time datetime="2017-07-19T09:45:04.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark源码阅读" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark源码阅读/">Spark源码阅读</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spark-源代码-import-进-Eclipse"><a href="#Spark-源代码-import-进-Eclipse" class="headerlink" title="Spark 源代码 import 进 Eclipse"></a>Spark 源代码 import 进 Eclipse</h3><p>参考： <a href="https://cwiki.apache.org/confluence/display/SPARK/Useful+Developer+Tools" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/SPARK/Useful+Developer+Tools</a></p>
<p>到Spark源代码目录下，运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mvn -DskipTests clean package</div><div class="line">mvn eclipse:eclipse</div></pre></td></tr></table></figure></p>
<p>Spark 是由 Scala语言编写，而Scala语言的语法糖太多，对于Scala新手的我来说确实困难，花费时间会较多，先暂时放一放。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark源码阅读/" class="archive-article-date">
  	<time datetime="2017-07-19T08:00:30.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Storm环境安装及配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Storm环境安装及配置/">Storm(流计算)环境安装及配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Storm-集群安装和配置"><a href="#Storm-集群安装和配置" class="headerlink" title="Storm 集群安装和配置"></a>Storm 集群安装和配置</h3><p><strong>Summary of the steps for setting up a Storm cluster:</strong></p>
<ul>
<li>Set up a Zookeeper cluster</li>
<li>Install dependencies on Nimbus and worker machines</li>
<li>Download and extract a Storm release to Nimbus and worker machines</li>
<li>Fill in mandatory configurations into storm.yaml</li>
<li>Launch daemons under supervision using “storm” script and a supervisor of your choice</li>
</ul>
<p><strong>配置：</strong><br><img src="/images/Storm_Config.png" alt=""></p>
<p><strong>源代码入口：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bin/storm nimbus                                   org.apache.storm.daemon.nimbus</div><div class="line">bin/storm supervisor                              org.apache.storm.daemon.supervisor</div><div class="line">bin/storm ui                                             org.apache.storm.ui.core</div></pre></td></tr></table></figure></p>
<p><strong>运行测试案例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/storm   jar   examples/storm-starter/storm-starter-topologies-1.0.2.jar    org.apache.storm.starter.WordCountTopology</div></pre></td></tr></table></figure></p>
<p><strong>nimbus 与 supervisor之间通过zookeeper 进行通信</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 9] ls /storm</div><div class="line">[backpressure, workerbeats, nimbuses, supervisors, errors, logconfigs, storms, assignments, leader-lock, blobstore]</div></pre></td></tr></table></figure></p>
<h3 id="Integration-With-External-Systems-and-Other-Libraries"><a href="#Integration-With-External-Systems-and-Other-Libraries" class="headerlink" title="Integration With External Systems, and Other Libraries"></a>Integration With External Systems, and Other Libraries</h3><ul>
<li>Flux Data Driven Topology Builder</li>
<li>Apache Kafka Integration</li>
<li>Apache HBase Integration</li>
<li>Apache HDFS Integration</li>
<li>Apache Hive Integration</li>
<li>JDBC Integration</li>
<li>Redis Integration</li>
<li>Event Hubs Intergration</li>
<li>Kestrel Intergration</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Storm环境安装及配置/" class="archive-article-date">
  	<time datetime="2017-07-19T07:56:53.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS fsimage viewer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS fsimage viewer/">HDFS Offline Image Viewer (解析fsimage file)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-Offline-Image-Viewer"><a href="#HDFS-Offline-Image-Viewer" class="headerlink" title="HDFS Offline Image Viewer"></a>HDFS Offline Image Viewer</h2><p>The Offiline Image Viewer is a tool to dump the contents of hdfs fsimage files.</p>
<p>command :</p>
<ul>
<li>Web Processor<br>Web processer launches a HTTP server :     <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs oiv -i fsimage</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Users can access the viewer and get information of the fsimage:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs dfs -ls webhdfs://127.0.0.1:5978/</div></pre></td></tr></table></figure></p>
<ul>
<li>XML Processor<br>XML processer  is used to dump all the contents in the fsimage.<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs oiv -p XML -i fsimage -o fsimage.xml</div></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS fsimage viewer/" class="archive-article-date">
  	<time datetime="2017-07-19T07:54:16.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS edits log viewer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS edits log viewer/">HDFS Offline Edits Viewer (解析edits log 文件)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-Offline-Edits-Viewer"><a href="#HDFS-Offline-Edits-Viewer" class="headerlink" title="HDFS Offline Edits Viewer"></a>HDFS Offline Edits Viewer</h2><p>Offline Edits Viewer is a tool to parse the Edits log file.</p>
<p>command:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hdfs oev -i edits -o edits.xml</div></pre></td></tr></table></figure></p>
<p><strong>Hadoop cluster recovery:</strong> This can be done by converting the binary edits to XML, edit it manually and then convert it back to binary.</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS edits log viewer/" class="archive-article-date">
  	<time datetime="2017-07-19T07:52:12.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HBase RESTful" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HBase RESTful/">HBase RESTful API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="启动-HBase-RESTful-服务"><a href="#启动-HBase-RESTful-服务" class="headerlink" title="启动 HBase RESTful 服务"></a>启动 HBase RESTful 服务</h2><p>hbase rest api 服务启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hbase-daemon.sh start rest</div></pre></td></tr></table></figure></p>
<p>Follow these instructions for each HBase host fulfilling the REST server role.</p>
<ul>
<li><p>To start the REST server as a foreground process, use the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/hbase rest start</div></pre></td></tr></table></figure>
</li>
<li><p>To start the REST server as a background process, use the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/hbase-daemon.sh start rest</div></pre></td></tr></table></figure>
</li>
<li><p>To use a different port than the default of 8080, use the -p option.</p>
</li>
<li>To stop a running HBase REST server, use the following command:<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/hbase-daemon.sh stop rest</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Cluster-Wide-Endpoints"><a href="#Cluster-Wide-Endpoints" class="headerlink" title="Cluster-Wide Endpoints"></a>Cluster-Wide Endpoints</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/version/cluster</strong>    GET    Version of HBase running on this cluster<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:8080/version/cluster"</span></div><div class="line">```         </div><div class="line">__/status/cluster__	GET	Cluster status</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:8080/status/cluster"</span></div><div class="line">```         </div><div class="line">__/__	GET	List of all nonsystem tables</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:8080/"</span></div></pre></td></tr></table></figure></p>
<h2 id="Table-Endpoints"><a href="#Table-Endpoints" class="headerlink" title="Table Endpoints"></a>Table Endpoints</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/table/schema</strong>    GET    Describe the schema of the specified table.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/schema"</span></div><div class="line">```         </div><div class="line">__/table/schema__	POST	Create a new table, or replace an existing table<span class="string">'s schema with the provided schema</span></div><div class="line">```bash</div><div class="line">curl -vi -X POST \</div><div class="line">         -H "Accept: text/xml" \</div><div class="line">         -H "Content-Type: text/xml" \</div><div class="line">         -d '&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;&lt;TableSchema name=<span class="string">"users"</span>&gt;&lt;ColumnSchema name=<span class="string">"cf"</span> /&gt;&lt;/TableSchema&gt;<span class="string">' \</span></div><div class="line">         "http://example.com:20550/users/schema"</div><div class="line">```         </div><div class="line">__/table/schema__	UPDATE	Update an existing table with the provided schema fragment</div><div class="line">```bash</div><div class="line">curl -vi -X PUT \</div><div class="line">         -H "Accept: text/xml" \</div><div class="line">         -H "Content-Type: text/xml" \</div><div class="line">         -d '&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;&lt;TableSchema name=<span class="string">"users"</span>&gt;&lt;ColumnSchema name=<span class="string">"cf"</span> KEEP_DELETED_CELLS=<span class="string">"true"</span> /&gt;&lt;/TableSchema&gt;<span class="string">' \</span></div><div class="line">         "http://example.com:20550/users/schema"</div><div class="line">```         </div><div class="line">__/table/schema__	DELETE	Delete the table. You must use thetable/schemaendpoint, not just table/.</div><div class="line">```bash</div><div class="line">curl -vi -X DELETE \</div><div class="line">         -H "Accept: text/xml" \</div><div class="line">         "http://example.com:20550/users/schema"</div><div class="line">```         </div><div class="line">__/table/regions__	GET	List the table regions.</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H "Accept: text/xml" \</div><div class="line">         "http://example.com:20550/users/regions"</div></pre></td></tr></table></figure></p>
<h2 id="Endpoints-for-Get-Operations"><a href="#Endpoints-for-Get-Operations" class="headerlink" title="Endpoints for Get Operations"></a>Endpoints for Get Operations</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/table/row/column:qualifier/timestamp</strong>    GET    Get the value of a single row. Values are Base-64 encoded.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/row1"</span></div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/row1/cf:a/1458586888395"</span></div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/row1/cf:a"</span></div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">          <span class="string">"http://example.com:20550/users/row1/cf:a/"</span></div><div class="line">```          </div><div class="line">__/table/row/column:qualifier?v=number_of_versions__	 	Multi-Get a specified number of versions of a given cell. Values are Base-64 encoded.</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/row1/cf:a?v=2"</span></div></pre></td></tr></table></figure></p>
<h2 id="Endpoints-for-Scan-Operations"><a href="#Endpoints-for-Scan-Operations" class="headerlink" title="Endpoints for Scan Operations"></a>Endpoints for Scan Operations</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/table/scanner/</strong>    PUT    Get a Scanner object. Required by all other Scan operations. Adjust the batch parameter to the number of rows the scan should return in a batch. See the next example for adding filters to your Scanner. The scanner endpoint URL is returned as the Location in the HTTP response. The other examples in this table assume that the Scanner endpoint is<a href="http://example.com:20550/users/scanner/145869072824375522207" target="_blank" rel="external">http://example.com:20550/users/scanner/145869072824375522207</a>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -vi -X PUT \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         -H <span class="string">"Content-Type: text/xml"</span> \</div><div class="line">         -d <span class="string">'&lt;Scanner batch="1"/&gt;'</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/scanner/"</span></div><div class="line">```         </div><div class="line">__/table/scanner/__	PUT	To supply filters to the Scanner object or configure the Scanner <span class="keyword">in</span> any other way, you can create a text file and add your filter to the file. For example, to <span class="built_in">return</span> only rows <span class="keyword">for</span> <span class="built_in">which</span> keys start with u123and use a batch size of 100:</div></pre></td></tr></table></figure></p>
<p><scanner batch="100"><br>  <filter><br>    {<br>      “type”: “PrefixFilter”,<br>      “value”: “u123”<br>    }<br>  </filter><br></scanner><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Pass the file to the -d argument of the curl request.</div><div class="line">```bash</div><div class="line">curl -vi -X PUT \</div><div class="line">         -H &quot;Accept: text/xml&quot; \</div><div class="line">         -H &quot;Content-Type:text/xml&quot; \</div><div class="line">         -d @filter.txt \</div><div class="line">         &quot;http://example.com:20550/users/scanner/&quot;</div><div class="line">```         </div><div class="line">__/table/scanner/scanner_id__	GET	Get the next batch from the scanner. Cell values are byte-encoded. If the scanner is exhausted, HTTP status 204 is returned.</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H &quot;Accept: text/xml&quot; \</div><div class="line">         &quot;http://example.com:20550/users/scanner/145869072824375522207&quot;</div><div class="line">```         </div><div class="line">__/table/scanner/scanner_id__	DELETE	Deletes the scanner and frees the resources it was using.</div><div class="line">```bash</div><div class="line">curl -vi -X DELETE \</div><div class="line">         -H &quot;Accept: text/xml&quot; \</div><div class="line">         &quot;http://example.com:20550/users/scanner/145869072824375522207&quot;</div></pre></td></tr></table></figure></p>
<h2 id="Endpoints-for-Put-Operations"><a href="#Endpoints-for-Put-Operations" class="headerlink" title="Endpoints for Put Operations"></a>Endpoints for Put Operations</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/table/row_key/</strong>    PUT    Write a row to a table. The row, column qualifier, and value must each be Base-64 encoded. To encode a string, you can use the base64command-line utility. To decode the string, usebase64 -d. The payload is in the –data argument, so the/users/fakerowvalue is a placeholder. Insert multiple rows by adding them to the<cellset>element. You can also save the data to be inserted to a file and pass it to the -dparameter with the syntax -d @filename.txt.    XML:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -vi -X PUT \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         -H <span class="string">"Content-Type: text/xml"</span> \</div><div class="line">         -d <span class="string">'&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;&lt;CellSet&gt;&lt;Row key="cm93NQo="&gt;&lt;Cell column="Y2Y6ZQo="&gt;dmFsdWU1Cg==&lt;/Cell&gt;&lt;/Row&gt;&lt;/CellSet&gt;'</span> \</div><div class="line">         <span class="string">"http://example.com:20550/users/fakerow"</span></div><div class="line">curl -vi -X PUT \</div><div class="line">         -H <span class="string">"Accept: text/json"</span> \</div><div class="line">         -H <span class="string">"Content-Type: text/json"</span> \</div><div class="line">         -d <span class="string">'&#123;"Row":[&#123;"key":"cm93NQo=", "Cell": [&#123;"column":"Y2Y6ZQo=", "$":"dmFsdWU1Cg=="&#125;]&#125;]&#125;'</span> \</div><div class="line">         <span class="string">"example.com:20550/users/fakerow"</span></div></pre></td></tr></table></figure></cellset></p>
<h2 id="Namespace-Endpoints"><a href="#Namespace-Endpoints" class="headerlink" title="Namespace Endpoints"></a>Namespace Endpoints</h2><p>Endpoint    HTTP Verb    Description    Example<br><strong>/namespaces</strong>    GET    List all namespaces.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/namespaces/"</span></div><div class="line">```         </div><div class="line">__/namespaces/namespace__	GET	Describe a specific namespace.</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/namespaces/special_ns"</span></div><div class="line">```         </div><div class="line">__/namespaces/namespace__	POST	Create a new namespace.</div><div class="line">```bash</div><div class="line">curl -vi -X POST \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"example.com:20550/namespaces/special_ns"</span></div><div class="line">```         </div><div class="line">__/namespaces/namespace/tables__	GET	List all tables <span class="keyword">in</span> a specific namespace.</div><div class="line">```bash</div><div class="line">curl -vi -X GET \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/namespaces/special_ns/tables"</span></div><div class="line">```         </div><div class="line">__/namespaces/namespace__	PUT	Alter an existing namespace. Currently not used.</div><div class="line">```bash</div><div class="line">curl -vi -X PUT \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"http://example.com:20550/namespaces/special_ns"</span></div><div class="line">```         </div><div class="line">__/namespaces/namespace__	DELETE	Delete a namespace. The namespace must be empty.</div><div class="line">```bash</div><div class="line">curl -vi -X DELETE \</div><div class="line">         -H <span class="string">"Accept: text/xml"</span> \</div><div class="line">         <span class="string">"example.com:20550/namespaces/special_ns"</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HBase RESTful/" class="archive-article-date">
  	<time datetime="2017-07-19T07:37:57.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Hadoop Other Knowledge" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Hadoop Other Knowledge/">Hadoop Other Knowledge</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="HA-enable-QJM"><a href="#HA-enable-QJM" class="headerlink" title="HA enable QJM"></a>HA enable QJM</h3><p>Hadoop Cluster High Availability (HA) enable  QJM (Quorum Journal Manager): <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html</a></p>
<h3 id="HA-enable-shared-storage"><a href="#HA-enable-shared-storage" class="headerlink" title="HA enable shared storage"></a>HA enable shared storage</h3><p>Hadoop Cluster High Availability (HA) enable  using shared storage: <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html</a></p>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>Hadoop Cluster Service Level Authorization (ACL)<br>Hadoop Cluster enable HTTP/Web  ACL</p>
<h3 id="Hadoop-in-Secure-mode"><a href="#Hadoop-in-Secure-mode" class="headerlink" title="Hadoop in Secure mode"></a>Hadoop in Secure mode</h3><p>Integrate with <strong>Kerberos</strong> .</p>
<h3 id="滚动升级"><a href="#滚动升级" class="headerlink" title="滚动升级"></a>滚动升级</h3><p>Rolling Upgrade url link: <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html</a></p>
<p>HDFS Rolling Upgrade url link:  <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html</a></p>
<h3 id="存储策略"><a href="#存储策略" class="headerlink" title="存储策略"></a>存储策略</h3><p>Storage Policy url link: <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html</a></p>
<p>Memory Storage Support url link:  <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/MemoryStorage.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/MemoryStorage.html</a></p>
<h3 id="KMS"><a href="#KMS" class="headerlink" title="KMS"></a>KMS</h3><p>Hadoop KMS(Key Management Server) url link:  <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-kms/index.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-kms/index.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Hadoop Other Knowledge/" class="archive-article-date">
  	<time datetime="2017-07-19T07:11:31.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Yarn RESTful" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Yarn RESTful/">Hadoop Yarn RESTful API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="ResourceManager-API"><a href="#ResourceManager-API" class="headerlink" title="ResourceManager API:"></a>ResourceManager API:</h4><p><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html</a></p>
<h4 id="NodeManager-API"><a href="#NodeManager-API" class="headerlink" title="NodeManager API:"></a>NodeManager API:</h4><p><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html</a></p>
<h4 id="MapReduce-Application-Master-API"><a href="#MapReduce-Application-Master-API" class="headerlink" title="MapReduce Application Master API:"></a>MapReduce Application Master API:</h4><p><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/MapredAppMasterRest.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/MapredAppMasterRest.html</a></p>
<h4 id="History-Server-API"><a href="#History-Server-API" class="headerlink" title="History Server API:"></a>History Server API:</h4><p><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/HistoryServerRest.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/HistoryServerRest.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Yarn RESTful/" class="archive-article-date">
  	<time datetime="2017-07-19T07:02:21.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS ViewFS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS ViewFS/">HDFS ViewFS (Based on Federation)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-ViewFs"><a href="#HDFS-ViewFs" class="headerlink" title="HDFS ViewFs"></a>HDFS ViewFs</h2><p>The View File System (ViewFs) provides a way to manage multiple Hadoop file system namespaces or namespace volumes.</p>
<h3 id="How-The-Clusters-Look"><a href="#How-The-Clusters-Look" class="headerlink" title="How The Clusters Look"></a>How The Clusters Look</h3><p>Suppose there are multiple cluster, each cluster has one or more namenodes. Each namenode has its own namespace, and a namenode belongs to one and only one cluster.</p>
<h3 id="A-Global-Namespace-Per-Cluster-Using-ViewFs"><a href="#A-Global-Namespace-Per-Cluster-Using-ViewFs" class="headerlink" title="A Global Namespace Per Cluster Using ViewFs"></a>A Global Namespace Per Cluster Using ViewFs</h3><p>ViewFs implements the Hadoop file system interface just like HDFS and the local file system. 代码位于Hadoop HDFS src 工程的 ViewFS继承类。<br><img src="/images/Hadoop_ViewFS_1.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>   </div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.default.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span>   </div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>viewfs://clusterX<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS ViewFS/" class="archive-article-date">
  	<time datetime="2017-07-19T06:52:26.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Yarn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Yarn/">Hadoop ResourceManager -- Yarn</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Hadoop-Yarn-architect"><a href="#Hadoop-Yarn-architect" class="headerlink" title="Hadoop Yarn architect"></a>Hadoop Yarn architect</h2><p><img src="/images/Yarn_1.png" alt=""></p>
<h3 id="Hadoop-V1-JobTracker-TaskTracker"><a href="#Hadoop-V1-JobTracker-TaskTracker" class="headerlink" title="Hadoop V1 JobTracker + TaskTracker"></a>Hadoop V1 JobTracker + TaskTracker</h3><p><img src="/images/Hadoop_V1_JobTracker.png" alt=""></p>
<h3 id="Hadoop-V2-ResourceManager-–-Yarn"><a href="#Hadoop-V2-ResourceManager-–-Yarn" class="headerlink" title="Hadoop V2 ResourceManager – Yarn"></a>Hadoop V2 ResourceManager – Yarn</h3><p><img src="/images/Hadoop_V2_ResourceManager.png" alt=""></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Yarn/" class="archive-article-date">
  	<time datetime="2017-07-19T06:46:16.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS RESTful" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS RESTful/">HDFS RESTful API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="HDFS-RESTful-API"><a href="#HDFS-RESTful-API" class="headerlink" title="HDFS RESTful API"></a>HDFS RESTful API</h3><p>Port: 50070  也是 hdfs web portal的端口号.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">webhdfs://&lt;HOST&gt;:&lt;HTTP_PORT&gt;/&lt;PATH&gt;</div><div class="line">hdfs://&lt;HOST&gt;:&lt;RPC_PORT&gt;/&lt;PATH&gt;</div><div class="line">http://&lt;HOST&gt;:&lt;HTTP_PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=...</div></pre></td></tr></table></figure></p>
<h4 id="Authenticaiton"><a href="#Authenticaiton" class="headerlink" title="Authenticaiton"></a>Authenticaiton</h4><ol>
<li><p>Authentication when security is off:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?[user.name=&lt;USER&gt;&amp;]op=…"</span></div></pre></td></tr></table></figure>
</li>
<li><p>Authentication using Kerberos SPNEGO when security is on:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i --negotiate -u : <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=..."</span></div></pre></td></tr></table></figure>
</li>
<li><p>Authentication using Hadoop delegation token when security is on:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?delegation=&lt;TOKEN&gt;&amp;op=..."</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="FileSystem-operations"><a href="#FileSystem-operations" class="headerlink" title="FileSystem operations:"></a>FileSystem operations:</h4><p>List  a  Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i  <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=LISTSTATUS"</span></div></pre></td></tr></table></figure></p>
<p>Status of  a  File/Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -i  <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=GETFILESTATUS"</span></div><div class="line">```   </div><div class="line">Make  a  Directory :  </div><div class="line">```bash</div><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=MKDIRS[&amp;permission=&lt;OCTAL&gt;]"</span></div></pre></td></tr></table></figure></p>
<p>Delete  a  File/Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X DELETE <span class="string">"http://&lt;host&gt;:&lt;port&gt;/webhdfs/v1/&lt;path&gt;?op=DELETE[&amp;recursive=&lt;true|false&gt;]"</span></div></pre></td></tr></table></figure></p>
<p>Rename  a  File/Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=RENAME&amp;destination=&lt;PATH&gt;"</span></div></pre></td></tr></table></figure></p>
<p>Open and Read  a  File :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -L <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=OPEN[&amp;offset=&lt;LONG&gt;][&amp;length=&lt;LONG&gt;][&amp;buffersize=&lt;INT&gt;]"</span></div></pre></td></tr></table></figure></p>
<p>Create and Write to  a  File :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=CREATE</span></div><div class="line">                    [&amp;overwrite=&lt;true|false&gt;][&amp;blocksize=&lt;LONG&gt;][&amp;replication=&lt;SHORT&gt;]</div><div class="line">                    [&amp;permission=&lt;OCTAL&gt;][&amp;buffersize=&lt;INT&gt;]"</div><div class="line">curl -i -X PUT -T &lt;LOCAL_FILE&gt; <span class="string">"http://&lt;DATANODE&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=CREATE..."</span></div></pre></td></tr></table></figure></p>
<p>Append to  a  File :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=APPEND[&amp;buffersize=&lt;INT&gt;]"</span></div><div class="line">curl -i -X POST -T &lt;LOCAL_FILE&gt; <span class="string">"http://&lt;DATANODE&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=APPEND…"</span></div></pre></td></tr></table></figure></p>
<p>Concatenate Files :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=CONCAT&amp;sources=&lt;PATHS&gt;"</span></div></pre></td></tr></table></figure></p>
<h4 id="Other-File-System-Operations"><a href="#Other-File-System-Operations" class="headerlink" title="Other File System Operations :"></a>Other File System Operations :</h4><p>Get Content Summary of  a Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=GETCONTENTSUMMARY"</span></div></pre></td></tr></table></figure></p>
<p>Get File Checksum :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=GETFILECHECKSUM"</span></div></pre></td></tr></table></figure></p>
<p>Get Home Directory :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/?op=GETHOMEDIRECTORY"</span></div></pre></td></tr></table></figure></p>
<p>Set Permission :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=SETPERMISSION[&amp;permission=&lt;OCTAL&gt;]"</span></div></pre></td></tr></table></figure></p>
<p>Set Owner :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=SETOWNER</span></div><div class="line">                              [&amp;owner=&lt;USER&gt;][&amp;group=&lt;GROUP&gt;]"</div></pre></td></tr></table></figure></p>
<p>Set Replication Factor :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=SETREPLICATION</span></div><div class="line">                              [&amp;replication=&lt;SHORT&gt;]"</div></pre></td></tr></table></figure></p>
<p>Set Access or Modification Time :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?op=SETTIMES</span></div><div class="line">                              [&amp;modificationtime=&lt;TIME&gt;][&amp;accesstime=&lt;TIME&gt;]"</div></pre></td></tr></table></figure></p>
<h4 id="Delegation-Token-Operations"><a href="#Delegation-Token-Operations" class="headerlink" title="Delegation Token Operations :"></a>Delegation Token Operations :</h4><p>Get Delegation Token :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/?op=GETDELEGATIONTOKEN&amp;renewer=&lt;USER&gt;"</span></div></pre></td></tr></table></figure></p>
<p>Renew Delegation Token :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/?op=RENEWDELEGATIONTOKEN&amp;token=&lt;TOKEN&gt;"</span></div></pre></td></tr></table></figure></p>
<p>Cancel Delegation Token :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X PUT <span class="string">"http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/?op=CANCELDELEGATIONTOKEN&amp;token=&lt;TOKEN&gt;"</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS RESTful/" class="archive-article-date">
  	<time datetime="2017-07-19T06:30:59.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS Federation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS Federation/">HDFS Federation(联邦)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-Federation-联邦"><a href="#HDFS-Federation-联邦" class="headerlink" title="HDFS Federation(联邦)"></a>HDFS Federation(联邦)</h2><p>在前面的文章介绍过，Hadoop的Federation是将整个文件系统划分为子集，每一个Federation中的NameNode负责管理其中一个子集，整个文件系统由这些子集通过挂载mount的方式构建。 Federation与HA结合使用。</p>
<p>官方doc: <a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/Federation.html" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/Federation.html</a></p>
<h3 id="HDFS-has-two-main-layers"><a href="#HDFS-has-two-main-layers" class="headerlink" title="HDFS has two main layers:"></a>HDFS has two main layers:</h3><p><strong>Namespace :</strong></p>
<pre><code>1. Consists of directories, files and blocks.
2. It supports all the namespace related file system operations such as create, delete, modify and list files and directories.            
</code></pre><p><strong>Block Storage Services ,  this has two parts :</strong></p>
<pre><code>1. Block Management (performed in the Namenode)
  Provides Datanode cluster membership by handling registrations, and periodic heart beats.
  Processes block reports and maintains location of blocks.
  Supports block related operations such as create, delete, modify and get block location.
  Manages replica placement, block replication for under replicated blocks, and deletes blocks that are over replicated.   
2. Storage   -   is provided by Datanodes by storing blocks on the local file system and allowing read/write access.
</code></pre><h3 id="Multiple-Namenodes-Namespaces"><a href="#Multiple-Namenodes-Namespaces" class="headerlink" title="Multiple Namenodes/Namespaces"></a>Multiple Namenodes/Namespaces</h3><p>Federation uses multiple independent Namenodes/namespaces to scale the name service horizontally. <strong>The Namenodes are federated; the Namenodes are independent and do not require coordination with each other.</strong> The Datanodes are used as common storage for blocks by all the Namespaces. Each Datanode registers with all the Namenodes in the cluster. Datanodes send periodic heartbeats and block reports.<br><img src="/images/HDFS_Fedaration_1.png" alt=""></p>
<h3 id="Federation-Configuration"><a href="#Federation-Configuration" class="headerlink" title="Federation Configuration"></a>Federation Configuration</h3><p>Federation configuration is <strong>backward compatible</strong> and allows existing single Namenode configuration to work without any change.<br><strong>Step 1:</strong> Add the dfs.nameservices parameter to your configuration and configure it with a list of comma separated NameServiceIDs. This will be used by the Datanodes to determine the Namenodes in the cluster.<br><strong>Step 2:</strong> For each Namenode and Secondary Namenode/BackupNode/Checkpointer add the following configuration parameters suffixed with the corresponding NameServiceID into the common configuration file:<br><strong>Namenode</strong></p>
<ul>
<li>dfs.namenode.rpc-address</li>
<li>dfs.namenode.servicerpc-address</li>
<li>dfs.namenode.http-address</li>
<li>dfs.namenode.https-address</li>
<li>dfs.namenode.keytab.file</li>
<li>dfs.namenode.name.dir</li>
<li>dfs.namenode.edits.dir</li>
<li>dfs.namenode.checkpoint.dir</li>
<li>dfs.namenode.checkpoint.edits.dir<br><strong>Secondary Namenode</strong></li>
<li>dfs.namenode.secondary.http-address</li>
<li>dfs.secondary.namenode.keytab.file<br><strong>BackupNode</strong></li>
<li>dfs.namenode.backup.address</li>
<li>dfs.secondary.namenode.keytab.file</li>
</ul>
<h4 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml:"></a>hdfs-site.xml:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.nameservices<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>ns1,ns2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.ns1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn-host1:rpc-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.ns1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn-host1:http-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondaryhttp-address.ns1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>snn-host1:http-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.ns2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn-host2:rpc-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.ns2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn-host2:http-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondaryhttp-address.ns2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>snn-host2:http-port<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="Formatting-Namenodes"><a href="#Formatting-Namenodes" class="headerlink" title="Formatting Namenodes"></a>Formatting Namenodes</h4><p>Step 1: Format a Namenode:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/bin/hdfs namenode -format [-clusterId &lt;cluster_id&gt;]</div></pre></td></tr></table></figure></p>
<p>Step 2: Format additional Namenodes<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/bin/hdfs namenode -format -clusterId &lt;cluster_id&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Upgrading-from-an-older-release-and-configuring-federation"><a href="#Upgrading-from-an-older-release-and-configuring-federation" class="headerlink" title="Upgrading from an older release and configuring federation"></a>Upgrading from an older release and configuring federation</h4><p>Older releases only support a single Namenode, after Upgrade the cluster to newer release in order to enable federation.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/bin/hdfs start namenode --config <span class="variable">$HADOOP_CONF_DIR</span>  -upgrade -clusterId &lt;cluster_ID&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Adding-a-new-Namenode-to-an-existing-HDFS-cluster"><a href="#Adding-a-new-Namenode-to-an-existing-HDFS-cluster" class="headerlink" title="Adding a new Namenode to an existing HDFS cluster"></a>Adding a new Namenode to an existing HDFS cluster</h4><p>Perform the following steps:</p>
<ul>
<li>Add dfs.nameservices to the configuration.</li>
<li>Update the configuration with the NameServiceID suffix. Configuration key names changed post release 0.20. You must use the new configuration parameter names in order to use federation.</li>
<li>Add the new Namenode related config to the configuration file.</li>
<li>Propagate the configuration file to the all the nodes in the cluster.</li>
<li>Start the new Namenode and Secondary/Backup.</li>
<li>Refresh the Datanodes to pickup the newly added Namenode by running the following command against all the Datanodes in the cluster:<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/bin/hdfs dfsadmin -refreshNameNodes &lt;datanode_host_name&gt;:&lt;datanode_rpc_port&gt;</div></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS Federation/" class="archive-article-date">
  	<time datetime="2017-07-19T06:04:11.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS Snapshots" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS Snapshots/">HDFS Snapshots</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-Snapshots"><a href="#HDFS-Snapshots" class="headerlink" title="HDFS Snapshots"></a>HDFS Snapshots</h2><p>Snapshots功能非常重要，可以保证HDFS在出现异常情况时可以进行恢复。 Snapshots可以使用在整个HDFS系统上，也可以只对其中的部分文件目录。</p>
<p>HDFS Snapshots are read-only point-in-time copies of file system. Snapshots can be taken on a subtree of the file system or the entire file system.</p>
<p>The HDFS path should be Snapshottable.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Snapshots Paths “.snapshot” is used <span class="keyword">for</span> accessing its snapshots.                hadoop  fs -ls /foo/.snapshot</div><div class="line">Allow Snapshots <span class="built_in">command</span>:                   hdfs  dfsadmin -allowSnapshot &lt;path&gt;</div><div class="line">Disallow Snapshots <span class="built_in">command</span>:             hdfs  dfsadmin  -disallowSnapshot &lt;path&gt;   </div><div class="line">Create Snapshots <span class="built_in">command</span>:                  hdfs dfs -createSnapshot &lt;path&gt; [&lt;snapshotName&gt;]</div><div class="line">Delete Snapshots <span class="built_in">command</span>:                  hdfs dfs -deleteSnapshot &lt;path&gt; [&lt;snapshotName&gt;]</div><div class="line">Rename Snapshots <span class="built_in">command</span>:                  hdfs dfs -renameSnapshot &lt;path&gt; &lt;oldName&gt; &lt;newName&gt;</div><div class="line">Get Snapshottable Directory Listing <span class="built_in">command</span>:           hdfs lsSnapshottableDir</div><div class="line">Get Snapshots Difference Report <span class="built_in">command</span>:                 hdfs snapshotDiff &lt;path&gt; &lt;fromSnapshot&gt; &lt;toSnapshot&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS Snapshots/" class="archive-article-date">
  	<time datetime="2017-07-19T06:00:59.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HDFS安装(三种模式)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/HDFS安装(三种模式)/">HDFS安装(三种模式)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HDFS-分布式文件系统"><a href="#HDFS-分布式文件系统" class="headerlink" title="HDFS 分布式文件系统"></a>HDFS 分布式文件系统</h2><ul>
<li><strong>Hadoop Distributed File System (HDFS™)</strong>: A distributed file system that provides high-throughput access to application data.</li>
</ul>
<h2 id="Hadoop-HDFS-2-x-安装"><a href="#Hadoop-HDFS-2-x-安装" class="headerlink" title="Hadoop HDFS 2.x 安装"></a>Hadoop HDFS 2.x 安装</h2><p>Hadoop HDFS 2.x 包含了3种安装模式：</p>
<ol>
<li>Standalone. 独立模式</li>
<li>Pseudo-Distributed Operation. 伪分布式</li>
<li>Cluster. 集群</li>
</ol>
<h3 id="Standalone"><a href="#Standalone" class="headerlink" title="Standalone"></a>Standalone</h3><p>默认情况下，Hadoop被配置成以非分布式模式运行的一个独立Java进程。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java/openjdk1.8/</div><div class="line"><span class="built_in">cd</span>  hadoop_home/</div><div class="line">mkdir input</div><div class="line">cp etc/hadoop/*.xml input</div><div class="line">bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar grep input output <span class="string">'dfs[a-z.]+'</span></div><div class="line">cat output/*</div></pre></td></tr></table></figure></p>
<h3 id="Pseudo-Distributed-Operation"><a href="#Pseudo-Distributed-Operation" class="headerlink" title="Pseudo-Distributed Operation"></a>Pseudo-Distributed Operation</h3><p>Hadoop可以在单节点上以所谓的伪分布式模式运行，此时每一个Hadoop守护进程都作为一个独立的Java进程运行。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p><strong>不配置Yarn</strong><br><strong>etc/hadoop/core-site.xml:</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>etc/hadoop/hdfs-site.xml:</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>Setup passphraseless ssh login:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ssh localhost</div><div class="line">ssh-keygen -t dsa -P <span class="string">''</span> -f ~/.ssh/id_dsa</div><div class="line">cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys</div><div class="line">chmod 0600 ~/.ssh/authorized_keys</div></pre></td></tr></table></figure></p>
<hr>
<h4 id="伪分布式HDFS初始化及使用命令"><a href="#伪分布式HDFS初始化及使用命令" class="headerlink" title="伪分布式HDFS初始化及使用命令"></a>伪分布式HDFS初始化及使用命令</h4><p>The following instructions are to run a MapReduce job locally.</p>
<ol>
<li><p>Format the filesystem: 初始化!!!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs namenode -format</div></pre></td></tr></table></figure>
</li>
<li><p>Start NameNode daemon and DataNode daemon:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sbin/start-dfs.sh</div></pre></td></tr></table></figure>
</li>
</ol>
<p>The hadoop daemon log output is written to the $(HADOOP_LOG_DIR) directory (defaults to $(HADOOP_HOME)/logs).</p>
<ol>
<li>Browse the web interface for the NameNode; by default it is available at:<br> NameNode - <a href="http://localhost:50070/" target="_blank" rel="external">http://localhost:50070/</a></li>
<li><p>Make the HDFS directories required to execute MapReduce jobs:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bin/hdfs dfs -mkdir /user</div><div class="line">bin/hdfs dfs -mkdir /user/&lt;username&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Copy the input files into the distributed filesystem:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs dfs -put etc/hadoop input</div></pre></td></tr></table></figure>
</li>
<li><p>Run some of the examples provided:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar grep input output <span class="string">'dfs[a-z.]+'</span></div></pre></td></tr></table></figure>
</li>
<li><p>Examine the output files: Copy the output files from the distributed filesystem to the local filesystem and examine them:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bin/hdfs dfs -get output output</div><div class="line">cat output/*</div></pre></td></tr></table></figure>
</li>
</ol>
<p>or<br>View the output files on the distributed filesystem:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/hdfs dfs -cat output/*</div></pre></td></tr></table></figure></p>
<ol>
<li>When you’re done, stop the daemons with:<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sbin/stop-dfs.sh</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="配置Yarn"><a href="#配置Yarn" class="headerlink" title="配置Yarn"></a>配置Yarn</h4><p><strong>配置Yarn on a Single Node</strong><br><strong>etc/hadoop/mapred-site.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>etc/hadoop/yarn-site.xml:</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ol>
<li><p>Start ResourceManager daemon and NodeManager daemon:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sbin/start-yarn.sh</div></pre></td></tr></table></figure>
</li>
<li><p>Browse the web interface for the ResourceManager; by default it is available at:<br>ResourceManager - <a href="http://localhost:8088/" target="_blank" rel="external">http://localhost:8088/</a></p>
</li>
<li>Run a MapReduce job.<br>与不配置Yarn的HDFS使用命令类似，可参考上面的例子。</li>
<li>When you’re done, stop the daemons with:<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sbin/stop-yarn.sh</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Cluster-Setup"><a href="#Cluster-Setup" class="headerlink" title="Cluster Setup"></a>Cluster Setup</h3><p>参考：<a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/ClusterSetup.html" target="_blank" rel="external">http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/ClusterSetup.html</a><br>下载 hadoop2.7.3 版本的压缩包，解压缩到master节点上， 解压路径为 ${Hadoop_Install} .<br>配置 hadoop cluster 中各个节点之间的passwordless 无密码访问。</p>
<h4 id="Configure-Hadoop-Cluster"><a href="#Configure-Hadoop-Cluster" class="headerlink" title="Configure Hadoop Cluster"></a>Configure Hadoop Cluster</h4><p>到 ${Hadoop_Install}/etc/hadoop/ 目录下 编辑配置文件： <strong>core-site.xml</strong>  <strong>hdfs-site.xml</strong>  <strong>mapred-site.xml</strong>  <strong>yarn-site.xml</strong> .<br><strong>core-site.xml :  configure important parameters</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop-nn:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.permissions<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>hdfs-site.xml :  configure for NameNode + DataNode</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/dfs/name/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">final</span>&gt;</span>true<span class="tag">&lt;/<span class="name">final</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/dfs/name<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">final</span>&gt;</span>true<span class="tag">&lt;/<span class="name">final</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.blocksize<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>10240<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>mapred-site.xml :  Configure for MapReduce Applications + MapReduce JobHistory Server</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapred.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>yarn-site.xml :  Configure for ResourceManager + NodeManager + History Server</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.resource-tracker.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop-nn:8025<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop-nn:8035<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop-nn:8050<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="Hadoop-Cluster-Startup"><a href="#Hadoop-Cluster-Startup" class="headerlink" title="Hadoop Cluster Startup"></a>Hadoop Cluster Startup</h4><p><strong>Format a new distributed filesystem:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/bin/hdfs namenode -format &lt;cluster_name&gt;</div></pre></td></tr></table></figure></p>
<p>会生成一个name文件夹，里面存储fsimage和editlog文件，记录整个cluster中的文件系统。<br><strong>Start HDFS NameNode :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/sbin/hadoop-daemon.sh --config <span class="variable">$HADOOP_CONF_DIR</span> --script hdfs start namenode</div></pre></td></tr></table></figure></p>
<p><strong>Start HDFS DataNode :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/sbin/hadoop-daemons.sh --config <span class="variable">$HADOOP_CONF_DIR</span> --script hdfs start datanode</div></pre></td></tr></table></figure></p>
<p><strong>Start all Hadoop slaves * :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hdfs]$ <span class="variable">$HADOOP_PREFIX</span>/sbin/start-dfs.sh</div></pre></td></tr></table></figure></p>
<p><strong>Start  Yarn  ResourceManager :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[yarn]$ <span class="variable">$HADOOP_YARN_HOME</span>/sbin/yarn-daemon.sh --config <span class="variable">$HADOOP_CONF_DIR</span> start resourcemanager</div></pre></td></tr></table></figure></p>
<p><strong>Start  Yarn  NodeManager :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[yarn]$ <span class="variable">$HADOOP_YARN_HOME</span>/sbin/yarn-daemons.sh --config <span class="variable">$HADOOP_CONF_DIR</span> start nodemanager</div></pre></td></tr></table></figure></p>
<p><strong>Start  Yarn  WebAppProxy server if necessary:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[yarn]$ <span class="variable">$HADOOP_YARN_HOME</span>/sbin/yarn-daemon.sh --config <span class="variable">$HADOOP_CONF_DIR</span> start proxyserver</div></pre></td></tr></table></figure></p>
<p><strong>Start all  Yarn  slaves *:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[yarn]$ <span class="variable">$HADOOP_PREFIX</span>/sbin/start-yarn.sh</div></pre></td></tr></table></figure></p>
<p><strong>Start MapReduce JobHistory server :</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[mapred]$ <span class="variable">$HADOOP_PREFIX</span>/sbin/mr-jobhistory-daemon.sh --config <span class="variable">$HADOOP_CONF_DIR</span> start historyserver</div></pre></td></tr></table></figure></p>
<h4 id="Hadoop-Cluster-Web-Interfaces"><a href="#Hadoop-Cluster-Web-Interfaces" class="headerlink" title="Hadoop Cluster Web Interfaces"></a>Hadoop Cluster Web Interfaces</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NameNode     http://hadoop_namenode:50070/</div><div class="line">ResourceManager     http://hadoop_resourcemanager:8088/</div><div class="line">MapReduce JobHistory Server     http://jobhistory_serevr:19888/</div></pre></td></tr></table></figure>
<h4 id="Hadoop-Cluster-exclude-decommision-Datanodes"><a href="#Hadoop-Cluster-exclude-decommision-Datanodes" class="headerlink" title="Hadoop Cluster exclude/decommision Datanodes"></a>Hadoop Cluster exclude/decommision Datanodes</h4><p><strong>configure  hdfs-site.xml :</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.hosts.exclude<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/hdfs_exclude.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>DFS exclude<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Then write the decommission data node(slave2) to <strong>hdfs_exclude.txt</strong> file.<br>Last, force configure reload:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hadoop dfsadmin  -refreshNodes</div><div class="line">hadoop dfsadmin  -report</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/HDFS安装(三种模式)/" class="archive-article-date">
  	<time datetime="2017-07-19T05:40:33.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Hadoop介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Hadoop介绍/">Hadoop介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Hadoop主要包含以下部分"><a href="#Hadoop主要包含以下部分" class="headerlink" title="Hadoop主要包含以下部分"></a>Hadoop主要包含以下部分</h2><ul>
<li><strong>Hadoop Common</strong>: The common utilities that support the other Hadoop modules.</li>
<li><strong>Hadoop Distributed File System (HDFS™)</strong>: A distributed file system that provides high-throughput access to application data.</li>
<li><strong>Hadoop YARN</strong>: A framework for job scheduling and cluster resource management.</li>
<li><strong>Hadoop MapReduce</strong>: A YARN-based system for parallel processing of large data sets.</li>
</ul>
<h2 id="Hadoop生态圈"><a href="#Hadoop生态圈" class="headerlink" title="Hadoop生态圈"></a>Hadoop生态圈</h2><ul>
<li><strong>Ambari™</strong>: 部署服务. A web-based tool for provisioning, managing, and monitoring Apache Hadoop clusters which includes support for Hadoop HDFS, Hadoop MapReduce, Hive, HCatalog, HBase, ZooKeeper, Oozie, Pig and Sqoop. Ambari also provides a dashboard for viewing cluster health such as heatmaps and ability to view MapReduce, Pig and Hive applications visually alongwith features to diagnose their performance characteristics in a user-friendly manner.</li>
<li><strong>Avro™</strong>: 数据序列化. A data serialization system.</li>
<li><strong>Cassandra™</strong>: 分布式NoSQL. A scalable multi-master database with no single points of failure.</li>
<li><strong>Chukwa™</strong>: 数据收集. A data collection system for managing large distributed systems.</li>
<li><strong>HBase™</strong>: 分布式NoSQL. A scalable, distributed database that supports structured data storage for large tables.</li>
<li><strong>Hive™</strong>: 数据仓库. A data warehouse infrastructure that provides data summarization and ad hoc querying.</li>
<li><strong>Mahout™:</strong> 数据挖掘. A Scalable machine learning and data mining library.</li>
<li><strong>Pig™</strong>: 可转化为MapReduce的数据查询. A high-level data-flow language and execution framework for parallel computation.</li>
<li><strong>Spark™</strong>: 内存加速的运算框架. A fast and general compute engine for Hadoop data. Spark provides a simple and expressive programming model that supports a wide range of applications, including ETL, machine learning, stream processing, and graph computation.</li>
<li><strong>Tez™</strong>: A generalized data-flow programming framework, built on Hadoop YARN, which provides a powerful and flexible engine to execute an arbitrary DAG of tasks to process data for both batch and interactive use-cases. Tez is being adopted by Hive™, Pig™ and other frameworks in the Hadoop ecosystem, and also by other commercial software (e.g. ETL tools), to replace Hadoop™ MapReduce as the underlying execution engine.</li>
<li><strong>ZooKeeper™</strong>: 分布式协同框架. A high-performance coordination service for distributed applications.</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Hadoop介绍/" class="archive-article-date">
  	<time datetime="2017-07-19T05:18:07.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ZooKeeper RESTful" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ZooKeeper RESTful/">ZooKeeper RESTful</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Enable-ZooKeeper-RESTful-service："><a href="#Enable-ZooKeeper-RESTful-service：" class="headerlink" title="Enable ZooKeeper RESTful service："></a>Enable ZooKeeper RESTful service：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim  rest.properties</div><div class="line"><span class="built_in">cd</span>   /root/zookeeper-3.4.8/src/contrib/rest</div><div class="line">nohup ant run &amp;    </div><div class="line">curl -H<span class="string">'Accept: application/json'</span> http://localhost:9998/znodes/v1/                    json</div><div class="line">curl -H<span class="string">'Accept: application/xml'</span> http://localhost:9998/znodes/v1/                    xml</div></pre></td></tr></table></figure>
<h3 id="RESTful-用法："><a href="#RESTful-用法：" class="headerlink" title="RESTful 用法："></a>RESTful 用法：</h3><p>#get children of the root node<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:9998/znodes/v1/?view=children</div></pre></td></tr></table></figure></p>
<p>#get “/cluster1/leader” as xml (default is json)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -H<span class="string">'Accept: application/xml'</span> http://localhost:9998/znodes/v1/cluster1/leader</div></pre></td></tr></table></figure></p>
<p>#get the data as text<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/znodes/v1/cluster1/leader?dataformat=utf8"</span></div></pre></td></tr></table></figure></p>
<p>#set a node (data.txt contains the ascii text you want to set on the node)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -T data.txt -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/znodes/v1/cluster1/leader?dataformat=utf8"</span></div></pre></td></tr></table></figure></p>
<p>#create a node<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -d <span class="string">"data1"</span> -H<span class="string">'Content-Type: application/octet-stream'</span> -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/znodes/v1/?op=create&amp;name=cluster2&amp;dataformat=utf8"</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -d <span class="string">"data2"</span> -H<span class="string">'Content-Type: application/octet-stream'</span> -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/znodes/v1/cluster2?op=create&amp;name=leader&amp;dataformat=utf8"</span></div></pre></td></tr></table></figure>
<p>#create a new session<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -d <span class="string">""</span> -H<span class="string">'Content-Type: application/octet-stream'</span> -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/sessions/v1/?op=create&amp;expire=10"</span></div></pre></td></tr></table></figure></p>
<p>#session heartbeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X <span class="string">"PUT"</span> -H<span class="string">'Content-Type: application/octet-stream'</span> -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/sessions/v1/02dfdcc8-8667-4e53-a6f8-ca5c2b495a72"</span></div></pre></td></tr></table></figure></p>
<p>#delete a session<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X <span class="string">"DELETE"</span> -H<span class="string">'Content-Type: application/octet-stream'</span> -w <span class="string">"\n%&#123;http_code&#125;\n"</span> <span class="string">"http://localhost:9998/sessions/v1/02dfdcc8-8667-4e53-a6f8-ca5c2b495a72"</span></div></pre></td></tr></table></figure></p>
<h2 id="service-启动命令"><a href="#service-启动命令" class="headerlink" title="service 启动命令"></a>service 启动命令</h2><p><strong>RestAPI源码入门：</strong><br>RestAPI 入口main函数所在文件： <strong>org.apache.zookeeper.server.jersey.RestMain</strong></p>
<p><strong>ZooKeeper Source Code 解析：</strong><br>1.zkServer 脚本启动命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ZOOMAIN=<span class="string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=<span class="variable">$JMXLOCALONLY</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></div><div class="line"></div><div class="line">nohup <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">$&#123;ZOO_LOG_DIR&#125;</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">$&#123;ZOO_LOG4J_PROP&#125;</span>"</span> \</div><div class="line">        -agentlib:jdwp=transport=dt_socket,server=y,<span class="built_in">suspend</span>=y,address=7778 \                         </div><div class="line">        -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$JVMFLAGS</span> <span class="variable">$ZOOMAIN</span> <span class="string">"<span class="variable">$ZOOCFG</span>"</span> &gt; <span class="string">"<span class="variable">$_ZOO_DAEMON_OUT</span>"</span> 2&gt;&amp;1 &lt; /dev/null &amp;</div></pre></td></tr></table></figure></p>
<p>2.zkCli 脚本启动命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"<span class="variable">$JAVA</span>"</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">$&#123;ZOO_LOG_DIR&#125;</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">$&#123;ZOO_LOG4J_PROP&#125;</span>"</span> \</div><div class="line">     -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$CLIENT_JVMFLAGS</span> <span class="variable">$JVMFLAGS</span> \</div><div class="line">     org.apache.zookeeper.ZooKeeperMain <span class="string">"<span class="variable">$@</span>"</span></div></pre></td></tr></table></figure></p>
<p>由上可知， ZooKeeper的server启动入口函数为 <strong>QuorumPeerMain</strong> ，而client的启动入口函数为 <strong>ZooKeeperMain</strong>。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper RESTful/" class="archive-article-date">
  	<time datetime="2017-07-19T02:45:39.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-分布式协同" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/分布式协同/">分布式协同技术</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="分布式协同技术"><a href="#分布式协同技术" class="headerlink" title="分布式协同技术"></a>分布式协同技术</h2><p>分布式协同技术诞生于分布式系统中，致力于解决各大分布式系统或分布式计算平台点到点的同步问题。 代表性的有 etcd, ZooKeeper, Consul, Doozerd。 其中：</p>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><ul>
<li>golang 语言编写</li>
<li>coreos 公司研发</li>
<li>被mesos kubernetes等 热门分布式平台所应用</li>
<li>支持RESTful api</li>
<li>基于 Raft 算法<h3 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h3></li>
<li>java 语言编写</li>
<li>Apache 基金会maintain</li>
<li>被Hadoop Kafka等 热门分布式平台所应用</li>
<li>支持RESTful api</li>
<li>基于 Paxos 算法</li>
</ul>
<h2 id="分布式协同算法-Raft-和-Paxos"><a href="#分布式协同算法-Raft-和-Paxos" class="headerlink" title="分布式协同算法 Raft 和 Paxos"></a>分布式协同算法 Raft 和 Paxos</h2><p>推荐一个Raft算法动态描述的网站： <a href="https://raft.github.io/" target="_blank" rel="external">https://raft.github.io/</a></p>
<p>至于 Raft 和 Paxos 算法的区别，网上文章有一些，可以阅读一下，但是本人至今没仔细钻研过两个算法的区别，以后如果有时间再补上。</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/分布式协同/" class="archive-article-date">
  	<time datetime="2017-07-19T01:36:10.000Z" itemprop="datePublished"><i class="icon-clock"></i>2017-07-19</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式协同/">分布式协同</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Kubernetes源码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kubectl-go"><a href="#Kubectl-go" class="headerlink" title="Kubectl.go"></a>Kubectl.go</h1><p>1.logs.InitLogs()<br>k8s.io/kubernetes/pkg/util/logs 日志管理代码<br>每30秒刷新一次日志。 使用了github.com/golang/glog</p>
<ol>
<li>NewDefaultClientConfigLoadingRules<br>currentMigrationRules</li>
</ol>
<p>type Factory struct {<br>    clients <em>ClientCache<br>    flags   </em>pflag.FlagSet</p>
<pre><code>// Returns interfaces for dealing with arbitrary runtime.Objects.
Object func() (meta.RESTMapper, runtime.ObjectTyper)
// Returns interfaces for dealing with arbitrary
// runtime.Unstructured. This performs API calls to discover types.
UnstructuredObject func() (meta.RESTMapper, runtime.ObjectTyper, error)
// Returns interfaces for decoding objects - if toInternal is set, decoded objects will be converted
// into their internal form (if possible). Eventually the internal form will be removed as an option,
// and only versioned objects will be returned.
Decoder func(toInternal bool) runtime.Decoder
// Returns an encoder capable of encoding a provided object into JSON in the default desired version.
JSONEncoder func() runtime.Encoder
// ClientSet gives you back an internal, generated clientset
ClientSet func() (*internalclientset.Clientset, error)
// Returns a RESTClient for accessing Kubernetes resources or an error.
RESTClient func() (*restclient.RESTClient, error)
// Returns a client.Config for accessing the Kubernetes server.
ClientConfig func() (*restclient.Config, error)
// Returns a RESTClient for working with the specified RESTMapping or an error. This is intended
// for working with arbitrary resources and is not guaranteed to point to a Kubernetes APIServer.
ClientForMapping func(mapping *meta.RESTMapping) (resource.RESTClient, error)
// Returns a RESTClient for working with Unstructured objects.
UnstructuredClientForMapping func(mapping *meta.RESTMapping) (resource.RESTClient, error)
// Returns a Describer for displaying the specified RESTMapping type or an error.
Describer func(mapping *meta.RESTMapping) (kubectl.Describer, error)
// Returns a Printer for formatting objects of the given type or an error.
Printer func(mapping *meta.RESTMapping, options kubectl.PrintOptions) (kubectl.ResourcePrinter, error)
// Returns a Scaler for changing the size of the specified RESTMapping type or an error
Scaler func(mapping *meta.RESTMapping) (kubectl.Scaler, error)
// Returns a Reaper for gracefully shutting down resources.
Reaper func(mapping *meta.RESTMapping) (kubectl.Reaper, error)
// Returns a HistoryViewer for viewing change history
HistoryViewer func(mapping *meta.RESTMapping) (kubectl.HistoryViewer, error)
// Returns a Rollbacker for changing the rollback version of the specified RESTMapping type or an error
Rollbacker func(mapping *meta.RESTMapping) (kubectl.Rollbacker, error)
// Returns a StatusViewer for printing rollout status.
StatusViewer func(mapping *meta.RESTMapping) (kubectl.StatusViewer, error)
// MapBasedSelectorForObject returns the map-based selector associated with the provided object. If a
// new set-based selector is provided, an error is returned if the selector cannot be converted to a
// map-based selector
MapBasedSelectorForObject func(object runtime.Object) (string, error)
// PortsForObject returns the ports associated with the provided object
PortsForObject func(object runtime.Object) ([]string, error)
// ProtocolsForObject returns the &lt;port, protocol&gt; mapping associated with the provided object
ProtocolsForObject func(object runtime.Object) (map[string]string, error)
// LabelsForObject returns the labels associated with the provided object
LabelsForObject func(object runtime.Object) (map[string]string, error)
// LogsForObject returns a request for the logs associated with the provided object
LogsForObject func(object, options runtime.Object) (*restclient.Request, error)
// PauseObject marks the provided object as paused ie. it will not be reconciled by its controller.
PauseObject func(object runtime.Object) (bool, error)
// ResumeObject resumes a paused object ie. it will be reconciled by its controller.
ResumeObject func(object runtime.Object) (bool, error)
// Returns a schema that can validate objects stored on disk.
Validator func(validate bool, cacheDir string) (validation.Schema, error)
// SwaggerSchema returns the schema declaration for the provided group version kind.
SwaggerSchema func(unversioned.GroupVersionKind) (*swagger.ApiDeclaration, error)
// Returns the default namespace to use in cases where no
// other namespace is specified and whether the namespace was
// overridden.
DefaultNamespace func() (string, bool, error)
// Generators returns the generators for the provided command
Generators func(cmdName string) map[string]kubectl.Generator
// Check whether the kind of resources could be exposed
CanBeExposed func(kind unversioned.GroupKind) error
// Check whether the kind of resources could be autoscaled
CanBeAutoscaled func(kind unversioned.GroupKind) error
// AttachablePodForObject returns the pod to which to attach given an object.
AttachablePodForObject func(object runtime.Object) (*api.Pod, error)
// UpdatePodSpecForObject will call the provided function on the pod spec this object supports,
// return false if no pod spec is supported, or return an error.
UpdatePodSpecForObject func(obj runtime.Object, fn func(*api.PodSpec) error) (bool, error)
// EditorEnvs returns a group of environment variables that the edit command
// can range over in order to determine if the user has specified an editor
// of their choice.
EditorEnvs func() []string
// PrintObjectSpecificMessage prints object-specific messages on the provided writer
PrintObjectSpecificMessage func(obj runtime.Object, out io.Writer)
</code></pre><p>}</p>
<p>const (<br>    RunV1GeneratorName                          = “run/v1”<br>    RunPodV1GeneratorName                       = “run-pod/v1”<br>    ServiceV1GeneratorName                      = “service/v1”<br>    ServiceV2GeneratorName                      = “service/v2”<br>    ServiceNodePortGeneratorV1Name              = “service-nodeport/v1”<br>    ServiceClusterIPGeneratorV1Name             = “service-clusterip/v1”<br>    ServiceLoadBalancerGeneratorV1Name          = “service-loadbalancer/v1”<br>    ServiceAccountV1GeneratorName               = “serviceaccount/v1”<br>    HorizontalPodAutoscalerV1Beta1GeneratorName = “horizontalpodautoscaler/v1beta1”<br>    HorizontalPodAutoscalerV1GeneratorName      = “horizontalpodautoscaler/v1”<br>    DeploymentV1Beta1GeneratorName              = “deployment/v1beta1”<br>    DeploymentBasicV1Beta1GeneratorName         = “deployment-basic/v1beta1”<br>    JobV1Beta1GeneratorName                     = “job/v1beta1”<br>    JobV1GeneratorName                          = “job/v1”<br>    ScheduledJobV2Alpha1GeneratorName           = “scheduledjob/v2alpha1”<br>    NamespaceV1GeneratorName                    = “namespace/v1”<br>    ResourceQuotaV1GeneratorName                = “resourcequotas/v1”<br>    SecretV1GeneratorName                       = “secret/v1”<br>    SecretForDockerRegistryV1GeneratorName      = “secret-for-docker-registry/v1”<br>    SecretForTLSV1GeneratorName                 = “secret-for-tls/v1”<br>    ConfigMapV1GeneratorName                    = “configmap/v1”<br>)</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Kubernetes源码/" class="archive-article-date">
  	<time datetime="2016-12-15T12:28:08.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-15</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Kafka 源码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Kafka 源码/">Kafka 启动＋源代码import进Eclipse</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Kafka-源代码-import进Eclipse"><a href="#Kafka-源代码-import进Eclipse" class="headerlink" title="Kafka 源代码 import进Eclipse"></a>Kafka 源代码 import进Eclipse</h3><p><strong>Eclipse 安装 scala IDE 插件：</strong><br><a href="http://download.scala-ide.org/sdk/lithium/e44/scala211/stable/site" target="_blank" rel="external">http://download.scala-ide.org/sdk/lithium/e44/scala211/stable/site</a></p>
<p><strong>源代码 import进Eclipse</strong></p>
<ul>
<li>1.brew install gradle</li>
<li>2.gradle</li>
<li>3./gradlew eclipse      对应  ./gradlew idea</li>
</ul>
<h3 id="Kafka-启动"><a href="#Kafka-启动" class="headerlink" title="Kafka 启动"></a>Kafka 启动</h3><p>Step 1: Download the code</p>
<p>Download the 0.10.0.0 release and un-tar it.</p>
<blockquote>
<p>tar -xzf kafka_2.11-0.10.0.0.tgz</p>
<p>cd kafka_2.11-0.10.0.0</p>
</blockquote>
<p>Step 2: Start the server</p>
<p>Kafka uses ZooKeeper so you need to first start a ZooKeeper server if you don’t already have one. You can use the convenience script packaged with kafka to get a quick-and-dirty single-node ZooKeeper instance.</p>
<blockquote>
<p>bin/zookeeper-server-start.sh config/zookeeper.properties<br>[2013-04-22 15:01:37,495] INFO Reading configuration from: config/zookeeper.properties (org.apache.zookeeper.server.quorum.QuorumPeerConfig)<br>…</p>
</blockquote>
<p>Now start the Kafka server:</p>
<blockquote>
<p>bin/kafka-server-start.sh config/server.properties<br>[2013-04-22 15:01:47,028] INFO Verifying properties (kafka.utils.VerifiableProperties)<br>[2013-04-22 15:01:47,051] INFO Property socket.send.buffer.bytes is overridden to 1048576 (kafka.utils.VerifiableProperties)<br>…</p>
</blockquote>
<p>Step 3: Create a topic</p>
<p>Let’s create a topic named “test” with a single partition and only one replica:</p>
<blockquote>
<p>bin/kafka-topics.sh –create –zookeeper localhost:2181 –replication-factor 1 –partitions 1 –topic test</p>
</blockquote>
<p>We can now see that topic if we run the list topic command:</p>
<blockquote>
<p>bin/kafka-topics.sh –list –zookeeper localhost:2181</p>
</blockquote>
<p>test</p>
<p>Alternatively, instead of manually creating topics you can also configure your brokers to auto-create topics when a non-existent topic is published to.</p>
<p>Step 4: Send some messages</p>
<p>Kafka comes with a command line client that will take input from a file or from standard input and send it out as messages to the Kafka cluster. By default each line will be sent as a separate message.</p>
<p>Run the producer and then type a few messages into the console to send to the server.</p>
<blockquote>
<p>bin/kafka-console-producer.sh –broker-list localhost:9092 –topic test<br>This is a message</p>
</blockquote>
<p>This is another message</p>
<p>Step 5: Start a consumer</p>
<p>Kafka also has a command line consumer that will dump out messages to standard output.</p>
<blockquote>
<p>bin/kafka-console-consumer.sh –zookeeper localhost:2181 –topic test –from-beginning<br>This is a message<br>This is another message</p>
</blockquote>
<p>If you have each of the above commands running in a different terminal then you should now be able to type messages into the producer terminal and see them appear in the consumer terminal.</p>
<p>All of the command line tools have additional options; running the command with no arguments will display usage information documenting them in more detail.</p>
<p>Step 6: Setting up a multi-broker cluster</p>
<p>So far we have been running against a single broker, but that’s no fun. For Kafka, a single broker is just a cluster of size one, so nothing much changes other than starting a few more broker instances. But just to get feel for it, let’s expand our cluster to three nodes (still all on our local machine).</p>
<p>First we make a config file for each of the brokers:</p>
<blockquote>
<p>cp config/server.properties config/server-1.properties</p>
<p>cp config/server.properties config/server-2.properties</p>
</blockquote>
<p>Now edit these new files and set the following properties:</p>
<p>config/server-1.properties:<br>    broker.id=1<br>    listeners=PLAINTEXT://:9093<br>    log.dir=/tmp/kafka-logs-1</p>
<p>config/server-2.properties:<br>    broker.id=2<br>    listeners=PLAINTEXT://:9094<br>    log.dir=/tmp/kafka-logs-2</p>
<p>The broker.id property is the unique and permanent name of each node in the cluster. We have to override the port and log directory only because we are running these all on the same machine and we want to keep the brokers from all trying to register on the same port or overwrite each others data.</p>
<p>We already have Zookeeper and our single node started, so we just need to start the two new nodes:</p>
<blockquote>
<p>bin/kafka-server-start.sh config/server-1.properties &amp;<br>…<br>bin/kafka-server-start.sh config/server-2.properties &amp;<br>…</p>
</blockquote>
<p>Now create a new topic with a replication factor of three:</p>
<blockquote>
<p>bin/kafka-topics.sh –create –zookeeper localhost:2181 –replication-factor 3 –partitions 1 –topic my-replicated-topic</p>
</blockquote>
<p>Okay but now that we have a cluster how can we know which broker is doing what? To see that run the “describe topics” command:</p>
<blockquote>
<p>bin/kafka-topics.sh –describe –zookeeper localhost:2181 –topic my-replicated-topic<br>Topic:my-replicated-topic      PartitionCount:1        ReplicationFactor:3    Configs:<br>        Topic: my-replicated-topic      Partition: 0    Leader: 1      Replicas: 1,2,0 Isr: 1,2,0</p>
</blockquote>
<p>Here is an explanation of output. The first line gives a summary of all the partitions, each additional line gives information about one partition. Since we have only one partition for this topic there is only one line.</p>
<ul>
<li>“leader” is the node responsible for all reads and writes for the given partition. Each node will be the leader for a randomly selected portion of the partitions.</li>
<li>“replicas” is the list of nodes that replicate the log for this partition regardless of whether they are the leader or even if they are currently alive.</li>
<li>“isr” is the set of “in-sync” replicas. This is the subset of the replicas list that is currently alive and caught-up to the leader.</li>
</ul>
<p>Note that in my example node 1 is the leader for the only partition of the topic.</p>
<p>We can run the same command on the original topic we created to see where it is:</p>
<blockquote>
<p>bin/kafka-topics.sh –describe –zookeeper localhost:2181 –topic test<br>Topic:test      PartitionCount:1        ReplicationFactor:1    Configs:<br>        Topic: test    Partition: 0    Leader: 0      Replicas: 0    Isr: 0</p>
</blockquote>
<p>So there is no surprise there—the original topic has no replicas and is on server 0, the only server in our cluster when we created it.</p>
<p>Let’s publish a few messages to our new topic:</p>
<blockquote>
<p>bin/kafka-console-producer.sh –broker-list localhost:9092 –topic my-replicated-topic<br>…<br>my test message 1<br>my test message 2<br>^C</p>
</blockquote>
<p>Now let’s consume these messages:</p>
<blockquote>
<p>bin/kafka-console-consumer.sh –zookeeper localhost:2181 –from-beginning –topic my-replicated-topic<br>…<br>my test message 1<br>my test message 2<br>^C</p>
</blockquote>
<p>Now let’s test out fault-tolerance. Broker 1 was acting as the leader so let’s kill it:</p>
<blockquote>
<p>ps | grep server-1.properties<br>7564 ttys002    0:15.91 /System/Library/Frameworks/JavaVM.framework/Versions/1.8/Home/bin/java…<br>kill -9 7564</p>
</blockquote>
<p>Leadership has switched to one of the slaves and node 1 is no longer in the in-sync replica set:</p>
<blockquote>
<p>bin/kafka-topics.sh –describe –zookeeper localhost:2181 –topic my-replicated-topic<br>Topic:my-replicated-topic      PartitionCount:1        ReplicationFactor:3    Configs:<br>        Topic: my-replicated-topic      Partition: 0    Leader: 2      Replicas: 1,2,0 Isr: 2,0</p>
</blockquote>
<p>But the messages are still be available for consumption even though the leader that took the writes originally is down:</p>
<blockquote>
<p>bin/kafka-console-consumer.sh –zookeeper localhost:2181 –from-beginning –topic my-replicated-topic<br>…<br>my test message 1<br>my test message 2<br>^C</p>
</blockquote>
<p>Step 7: Use Kafka Connect to import/export data</p>
<p>Writing data from the console and writing it back to the console is a convenient place to start, but you’ll probably want to use data from other sources or export data from Kafka to other systems. For many systems, instead of writing custom integration code you can use Kafka Connect to import or export data. Kafka Connect is a tool included with Kafka that imports and exports data to Kafka. It is an extensible tool that runs connectors, which implement the custom logic for interacting with an external system. In this quickstart we’ll see how to run Kafka Connect with simple connectors that import data from a file to a Kafka topic and export data from a Kafka topic to a file. First, we’ll start by creating some seed data to test with:</p>
<blockquote>
<p>echo -e “foo\nbar” &gt; test.txt</p>
</blockquote>
<p>Next, we’ll start two connectors running in standalone mode, which means they run in a single, local, dedicated process. We provide three configuration files as parameters. The first is always the configuration for the Kafka Connect process, containing common configuration such as the Kafka brokers to connect to and the serialization format for data. The remaining configuration files each specify a connector to create. These files include a unique connector name, the connector class to instantiate, and any other configuration required by the connector.</p>
<blockquote>
<p>bin/connect-standalone.sh config/connect-standalone.properties config/connect-file-source.properties config/connect-file-sink.properties</p>
</blockquote>
<p>These sample configuration files, included with Kafka, use the default local cluster configuration you started earlier and create two connectors: the first is a source connector that reads lines from an input file and produces each to a Kafka topic and the second is a sink connector that reads messages from a Kafka topic and produces each as a line in an output file. During startup you’ll see a number of log messages, including some indicating that the connectors are being instantiated. Once the Kafka Connect process has started, the source connector should start reading lines from</p>
<p>test.txt</p>
<p>and producing them to the topic</p>
<p>connect-test</p>
<p>, and the sink connector should start reading messages from the topic</p>
<p>connect-test</p>
<p>and write them to the file</p>
<p>test.sink.txt</p>
<p>. We can verify the data has been delivered through the entire pipeline by examining the contents of the output file:</p>
<blockquote>
<p>cat test.sink.txt<br>foo<br>bar</p>
</blockquote>
<p>Note that the data is being stored in the Kafka topic</p>
<p>connect-test</p>
<p>, so we can also run a console consumer to see the data in the topic (or use custom consumer code to process it):</p>
<blockquote>
<p>bin/kafka-console-consumer.sh –zookeeper localhost:2181 –topic connect-test –from-beginning<br>{“schema”:{“type”:”string”,”optional”:false},”payload”:”foo”}<br>{“schema”:{“type”:”string”,”optional”:false},”payload”:”bar”}<br>…</p>
</blockquote>
<p>The connectors continue to process data, so we can add data to the file and see it move through the pipeline:</p>
<blockquote>
<p>echo “Another line” &gt;&gt; test.txt</p>
</blockquote>
<p>You should see the line appear in the console consumer output and in the sink file.</p>
<p>Step 8: Use Kafka Streams to process data</p>
<p>Kafka Streams is a client library of Kafka for real-time stream processing and analyzing data stored in Kafka brokers. This quickstart example will demonstrate how to run a streaming application coded in this library. Here is the gist of the WordCountDemo example code (converted to use Java 8 lambda expressions for easy reading).</p>
<p>KTable wordCounts = textLines<br>    // Split each text line, by whitespace, into words.<br>    .flatMapValues(value -&gt; Arrays.asList(value.toLowerCase().split(“\W+”)))</p>
<pre><code>// Ensure the words are available as record keys for the next aggregate operation.
.map((key, value) -&gt; new KeyValue&lt;&gt;(value, value))

// Count the occurrences of each word (record key) and store the results into a table named &quot;Counts&quot;.
.countByKey(&quot;Counts&quot;)
</code></pre><p>It implements the WordCount algorithm, which computes a word occurrence histogram from the input text. However, unlike other WordCount examples you might have seen before that operate on bounded data, the WordCount demo application behaves slightly differently because it is designed to operate on aninfinite, unbounded stream of data. Similar to the bounded variant, it is a stateful algorithm that tracks and updates the counts of words. However, since it must assume potentially unbounded input data, it will periodically output its current state and results while continuing to process more data because it cannot know when it has processed “all” the input data.</p>
<p>We will now prepare input data to a Kafka topic, which will subsequently processed by a Kafka Streams application.</p>
<blockquote>
<p>echo -e “all streams lead to kafka\nhello kafka streams\njoin kafka summit” &gt; file-input.txt</p>
</blockquote>
<p>Next, we send this input data to the input topic named streams-file-input using the console producer (in practice, stream data will likely be flowing continuously into Kafka where the application will be up and running):</p>
<blockquote>
<p>bin/kafka-topics.sh –create \<br>            –zookeeper localhost:2181 \<br>            –replication-factor 1 \<br>            –partitions 1 \<br>            –topic streams-file-input</p>
<p>cat file-input.txt | bin/kafka-console-producer.sh –broker-list localhost:9092 –topic streams-file-input</p>
</blockquote>
<p>We can now run the WordCount demo application to process the input data:</p>
<blockquote>
<p>bin/kafka-run-class.sh org.apache.kafka.streams.examples.wordcount.WordCountDemo</p>
</blockquote>
<p>There won’t be any STDOUT output except log entries as the results are continuously written back into another topic named streams-wordcount-output in Kafka. The demo will run for a few seconds and then, unlike typical stream processing applications, terminate automatically.</p>
<p>We can now inspect the output of the WordCount demo application by reading from its output topic:</p>
<blockquote>
<p>bin/kafka-console-consumer.sh –zookeeper localhost:2181 \<br>            –topic streams-wordcount-output \<br>            –from-beginning \<br>            –formatter kafka.tools.DefaultMessageFormatter \<br>            –property print.key=true \<br>            –property print.value=true \<br>            –property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer \<br>            –property value.deserializer=org.apache.kafka.common.serialization.LongDeserializer</p>
</blockquote>
<p>with the following output data being printed to the console:</p>
<p>all    1<br>streams 1<br>lead    1<br>to      1<br>kafka  1<br>hello  1<br>kafka  2<br>streams 2<br>join    1<br>kafka  3<br>summit  1</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Kafka 源码/" class="archive-article-date">
  	<time datetime="2016-11-10T06:08:52.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka/">Kafka</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Kafka/">Kafka</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Kafka Rest API" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Kafka Rest API/">Kafka Rest API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Kafak-Connect-REST-API"><a href="#Kafak-Connect-REST-API" class="headerlink" title="Kafak Connect  REST API"></a>Kafak Connect  REST API</h3><p>Since Kafka Connect is intended to be run as a service, it also provides a REST API for managing connectors. By default this service runs on port 8083. The following are the currently supported endpoints:</p>
<ul>
<li><code>GET /connectors</code> - return a list of active connectors</li>
<li><code>POST /connectors</code> - create a new connector; the request body should be a JSON object containing a string name field and a object config field with the connector configuration parameters</li>
<li><code>GET /connectors/{name}</code> - get information about a specific connector</li>
<li><code>GET /connectors/{name}/config</code> - get the configuration parameters for a specific connector</li>
<li><code>PUT /connectors/{name}/config</code> - update the configuration parameters for a specific connector</li>
<li><code>GET /connectors/{name}/status</code> - get current status of the connector, including if it is running, failed, paused, etc., which worker it is assigned to, error information if it has failed, and the state of all its tasks</li>
<li><code>GET /connectors/{name}/tasks</code> - get a list of tasks currently running for a connector</li>
<li><code>GET /connectors/{name}/tasks/{taskid}/status</code> - get current status of the task, including if it is running, failed, paused, etc., which worker it is assigned to, and error information if it has failed</li>
<li><code>PUT /connectors/{name}/pause</code> - pause the connector and its tasks, which stops message processing until the connector is resumed</li>
<li><code>PUT /connectors/{name}/resume</code> - resume a paused connector (or do nothing if the connector is not paused)</li>
<li><code>POST /connectors/{name}/restart</code> - restart a connector (typically because it has failed)</li>
<li><code>POST /connectors/{name}/tasks/{taskId}/restart</code> - restart an individual task (typically because it has failed)</li>
<li><code>DELETE /connectors/{name}</code> - delete a connector, halting all tasks and deleting its configuration</li>
</ul>
<p>Kafka Connect also provides a REST API for getting information about connector plugins:</p>
<ul>
<li><code>GET /connector-plugins-</code> return a list of connector plugins installed in the Kafka Connect cluster. Note that the API only checks for connectors on the worker that handles the request, which means you may see inconsistent results, especially during a rolling upgrade if you add new connector jars</li>
<li><code>PUT /connector-plugins/{connector-type}/config/validate</code> - validate the provided configuration values against the configuration definition. This API performs per config validation, returns suggested values and error messages during validation.</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Kafka Rest API/" class="archive-article-date">
  	<time datetime="2016-11-10T05:59:23.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka/">Kafka</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Kafka/">Kafka</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Kafka" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Kafka/">Kafka</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Kafka-具有3大功能"><a href="#Kafka-具有3大功能" class="headerlink" title="Kafka 具有3大功能:"></a>Kafka 具有3大功能:</h3><ul>
<li>1.Publish &amp; Subscribe: to streams of data like a messaging system</li>
<li>2.Process: streams of data efficiently</li>
<li>3.Store: streams of data safely in a distributed replicated cluster</li>
</ul>
<p><img src="/images/Kafka_1.png" alt=""></p>
<p><img src="/images/Kafka_2.png" alt=""></p>
<h3 id="Producer-amp-Consumer-导图"><a href="#Producer-amp-Consumer-导图" class="headerlink" title="Producer &amp; Consumer 导图"></a>Producer &amp; Consumer 导图</h3><p><img src="/images/Kafka_3.png" alt=""></p>
<p><img src="/images/Kafka_4.png" alt=""></p>
<p><img src="/images/Kafka_5.png" alt=""></p>
<h3 id="Kafka-four-core-APIs"><a href="#Kafka-four-core-APIs" class="headerlink" title="Kafka four core APIs"></a>Kafka four core APIs</h3><p>Kafka has four core APIs:</p>
<ul>
<li>The Producer API allows an application to publish a stream records to one or more Kafka topics.</li>
<li>The Consumer API allows an application to subscribe to one or more topics and process the stream of records produced to them.</li>
<li>The Streams API allows an application to act as a stream processor, consuming an input stream from one or more topics and producing an output stream to one or more output topics, effectively transforming the input streams to output streams.</li>
<li>The Connector API allows building and running reusable producers or consumers that connect Kafka topics to existing applications or data systems.</li>
</ul>
<h3 id="Producer-APIs"><a href="#Producer-APIs" class="headerlink" title="Producer APIs"></a>Producer APIs</h3><p><em>kafka.producer.SyncProducer and kafka.producer.async.AsyncProducer.</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/* Sends the data, partitioned by key to the topic using either the */</span></div><div class="line">  <span class="comment">/* synchronous or the asynchronous producer */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(kafka.javaapi.producer.ProducerData&lt;K,V&gt; producerData)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/* Sends a list of data, partitioned by key to the topic using either */</span></div><div class="line">  <span class="comment">/* the synchronous or the asynchronous producer */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(java.util.List&lt;kafka.javaapi.producer.ProducerData&lt;K,V&gt;&gt; producerData)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/* Closes the producer and cleans up */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><p><strong>can handle queueing/buffering of multiple producer requests and asynchronous dispatch of the batched data</strong><br><code>kafka.producer.Producer</code> provides the ability to batch multiple produce requests (producer.type=async), before serializing and dispatching them to the appropriate kafka broker partition. The size of the batch can be controlled by a few config parameters. As events enter a queue, they are buffered in a queue, until either queue.time or batch.size is reached. A background thread (<code>kafka.producer.async.ProducerSendThread</code>) dequeues the batch of data and lets the <code>kafka.producer.EventHandler</code> serialize and send the data to the appropriate kafka broker partition. A custom event handler can be plugged in through the event.handler config parameter. At various stages of this producer queue pipeline, it is helpful to be able to inject callbacks, either for plugging in custom logging/tracing code or custom monitoring logic. This is possible by implementing the <code>kafka.producer.async.CallbackHandler</code> interface and setting <code>callback.handlerconfig</code> parameter to that class.</p>
</li>
<li><p><strong>handles the serialization of data through a user-specified Encoder:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">interface Encoder&lt;T&gt; &#123;</div><div class="line">  public Message toMessage(T data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>The default is the no-op <code>kafka.serializer.DefaultEncoder</code></p>
<ul>
<li><strong>provides software load balancing through an optionally user-specified Partitioner:</strong></li>
</ul>
<p>The routing decision is influenced by the kafka.producer.Partitioner.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">interface Partitioner&lt;T&gt; &#123;</div><div class="line">   int partition(T key, int numPartitions);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Consumer-APIs"><a href="#Consumer-APIs" class="headerlink" title="Consumer APIs"></a>Consumer APIs</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleConsumer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/* Send fetch request to a broker and get back a set of messages. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> ByteBufferMessageSet <span class="title">fetch</span><span class="params">(FetchRequest request)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/* Send a list of fetch requests to a broker and get back a response set. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> MultiFetchResponse <span class="title">multifetch</span><span class="params">(List&lt;FetchRequest&gt; fetches)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Get a list of valid offsets (up to maxSize) before the given time.</div><div class="line">   * The result is a list of offsets, in descending order.</div><div class="line">   * <span class="doctag">@param</span> time: time in millisecs,</div><div class="line">   *              if set to OffsetRequest$.MODULE$.LATEST_TIME(), get from the latest offset available.</div><div class="line">   *              if set to OffsetRequest$.MODULE$.EARLIEST_TIME(), get from the earliest offset available.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">long</span>[] getOffsetsBefore(String topic, <span class="keyword">int</span> partition, <span class="keyword">long</span> time, <span class="keyword">int</span> maxNumOffsets);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* create a connection to the cluster */</span></div><div class="line">ConsumerConnector connector = Consumer.create(consumerConfig);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ConsumerConnector</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * This method is used to get a list of KafkaStreams, which are iterators over</div><div class="line">   * MessageAndMetadata objects from which you can obtain messages and their</div><div class="line">   * associated metadata (currently only topic).</div><div class="line">   *  Input: a map of &lt;topic, #streams&gt;</div><div class="line">   *  Output: a map of &lt;topic, list of message streams&gt;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> Map&lt;String,List&lt;KafkaStream&gt;&gt; createMessageStreams(Map&lt;String,Int&gt; topicCountMap);</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * You can also obtain a list of KafkaStreams, that iterate over messages</div><div class="line">   * from topics that match a TopicFilter. (A TopicFilter encapsulates a</div><div class="line">   * whitelist or a blacklist which is a standard Java regex.)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;KafkaStream&gt; <span class="title">createMessageStreamsByFilter</span><span class="params">(</span></span></div><div class="line">      TopicFilter topicFilter, <span class="keyword">int</span> numStreams);</div><div class="line"></div><div class="line">  <span class="comment">/* Commit the offsets of all messages consumed so far. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">commitOffsets</span><span class="params">()</span></span></div><div class="line"></div><div class="line">  <span class="comment">/* Shut down the connector */</span></div><div class="line">  <span class="keyword">public</span> <span class="title">shutdown</span><span class="params">()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Kafka-ZooKeeper文件目录"><a href="#Kafka-ZooKeeper文件目录" class="headerlink" title="Kafka ZooKeeper文件目录"></a>Kafka ZooKeeper文件目录</h3><p><strong>Broker Node Registry:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/brokers/ids/[0...N] --&gt; &#123;&quot;jmx_port&quot;:...,&quot;timestamp&quot;:...,&quot;endpoints&quot;:[...],&quot;host&quot;:...,&quot;version&quot;:...,&quot;port&quot;:...&#125; (ephemeral node)</div></pre></td></tr></table></figure></p>
<p><strong>Broker Topic Registry:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/brokers/topics/[topic]/partitions/[0...N]/state --&gt; &#123;&quot;controller_epoch&quot;:...,&quot;leader&quot;:...,&quot;version&quot;:...,&quot;leader_epoch&quot;:...,&quot;isr&quot;:[...]&#125; (ephemeral node)</div></pre></td></tr></table></figure></p>
<p><strong>Consumer Id Registry:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/consumers/[group_id]/ids/[consumer_id] --&gt; &#123;&quot;version&quot;:...,&quot;subscription&quot;:&#123;...:...&#125;,&quot;pattern&quot;:...,&quot;timestamp&quot;:...&#125; (ephemeral node)</div></pre></td></tr></table></figure></p>
<p><strong>Consumer Offsets:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/consumers/[group_id]/offsets/[topic]/[partition_id] --&gt; offset_counter_value ((persistent node)</div></pre></td></tr></table></figure></p>
<p><strong>Partition Owner registry:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/consumers/[group_id]/owners/[topic]/[partition_id] --&gt; consumer_node_id (ephemeral node)</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Kafka/" class="archive-article-date">
  	<time datetime="2016-11-10T05:43:33.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka/">Kafka</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Kafka/">Kafka</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-etcd介绍及源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/etcd介绍及源码分析/">etcd介绍及源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="etcd-相关网站"><a href="#etcd-相关网站" class="headerlink" title="etcd 相关网站"></a>etcd 相关网站</h3><p><a href="https://coreos.com/etcd/docs/latest/" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/</a><br><a href="https://coreos.com/etcd/docs/latest/api.html" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/api.html</a><br><a href="https://coreos.com/etcd/docs/latest/libraries-and-tools.html" target="_blank" rel="external">https://coreos.com/etcd/docs/latest/libraries-and-tools.html</a></p>
<h3 id="Eclipse安装golang语言plugin："><a href="#Eclipse安装golang语言plugin：" class="headerlink" title="Eclipse安装golang语言plugin："></a>Eclipse安装golang语言plugin：</h3><p>Installation Requirements:</p>
<ul>
<li>Java VM version 8 or later.</li>
<li>Eclipse 4.6 (Neon) or later.</li>
<li>CDT 9.0 or later (this will be installed or updated automatically as part of the steps below).</li>
</ul>
<p>Instructions:</p>
<ul>
<li>Use your existing Eclipse, or download a new Eclipse package from <a href="http://www.eclipse.org/downloads/" target="_blank" rel="external">http://www.eclipse.org/downloads/</a>.<ul>
<li>For an Eclipse package without any other IDEs or extras (such a VCS tools), download the “Platform Runtime Binary”.</li>
</ul>
</li>
<li>Start Eclipse, go to Help -&gt; Install New Software…</li>
<li>Click the Add… button, then enter the Update Site URL: <a href="http://goclipse.github.io/releases/" target="_blank" rel="external">http://goclipse.github.io/releases/</a> in the Location field, click OK.</li>
<li>Select the recently added update site in the Work with: dropdown. Type GoClipse in the filter box. Now the Goclipse feature should appear below.</li>
<li>Select the GoClipse feature, and complete the wizard.<ul>
<li>Dependencies such as CDT will automatically be added during installation.</li>
</ul>
</li>
<li>Restart Eclipse.</li>
<li>Follow the instructions from the User Guide’s Configuration section to configure the required external tools. It is recommended you read the rest of the guide too.</li>
</ul>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><p><strong>客户端：client.go</strong></p>
<p>etcdmain/main.go  Main():<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">—&gt; etcdmain/etcd.go  startEtcdOrProxyV2():</div><div class="line">          —&gt; etcdmain/config.go  cfg := newConfig():               etcd初始化对象配置</div><div class="line">          —&gt; etcdmain/config.go  cfg.parse(Args[1:]):               解析etcd启动参数</div><div class="line">          —&gt; etcdmain/etcd.go  setupLogging(cfg)</div><div class="line">          —&gt; etcdmain/etcd.go  which := identifyDataDirOrDie(cfg.Dir)       分析Dir参数，解析etcd启动方式，如果Dir参数为空，也会走下面2个分支</div><div class="line">                    —&gt; case dirMember:</div><div class="line">                              —&gt; etcdmain/etcd.go  startEtcd(&amp;cfg.Config)</div><div class="line">                                        —&gt; embed/etcd.go  e, err := embed.StartEtcd(cfg)                         启动etcd服务</div><div class="line">                                                  —&gt; embed/config.go  cfg.Validate()                                             验证config值</div><div class="line">                                                  —&gt; embed/etcd.go  e.Peers := startPeerListeners(cfg)</div><div class="line">                                                            —&gt; plns = make([]net.Listener, len(cfg.LPUrls))</div><div class="line">                                                            —&gt; for i, u := range cfg.LPUrls</div><div class="line">                                                                      —&gt; pkg/transport/listener.go  tlscfg = cfg.PeerTLSInfo.ServerConfig()               CA file config</div><div class="line">                                                                      —&gt; rafthttp/util.go  plns[i] = rafthttp.NewListener(u, tlscfg)</div><div class="line">                                                                                —&gt; transport/timeout_listener.go  transport.NewTimeoutListener(u.Host, u.Scheme, tlscfg, ConnReadTimeout, ConnWriteTimeout)</div><div class="line">                                                                                          —&gt; pkg/transport/listener.go  ln := newListener(u.Host, u.Scheme)</div><div class="line">                                                                                                    —&gt; unix_listener.go       if (u.Scheme == “unix” | “unixs”)     return NewUnixListener(u.Host)               unix socket via unix://laddr</div><div class="line">                                                                                                    —&gt; dial.go                         else      return net.Listen(“tcp”, u.Host)                                        tcp socket</div><div class="line">                                                                                          —&gt; transport/timeout_listener.go  ln = &amp;rwTimeoutListener&#123;&#125;</div><div class="line">                                                                                          —&gt; pkg/transport/listener.go  ln = wrapTLS(u.Host, u.Scheme, tlscfg, ln)</div><div class="line">                                                                                                    —&gt; tls.go  tlscfg.NewListener(ln, tlscfg)                                                  创建listener，该listener接受inner连接               tls：Transport Layer Security 传输层安全协议</div><div class="line">                                                  —&gt; embed/etcd.go  e.sctxs := startClientListeners(cfg)</div><div class="line">                                                            —&gt; if  cfg.ClientAutoTLS &amp;&amp; cfg.ClientTLSInfo.Empty()     cfg.ClientTLSInfo = transport.SelfCert(path.Join(cfg.Dir, “fixtures/client"), cfg.LCurls)               配置tls信息</div><div class="line">                                                            —&gt; sctxs = make(map[string] *serveCtx)</div><div class="line">                                                            —&gt; sctx.l = net.Listen(proto, cfg.LCurls)                         proto=“tcp|unix|unixs"      创建socket 进行listen</div><div class="line">                                                            —&gt; sctx.l = transport.LimitListener(sctx.l, int(fdLimit - reservedInternalFDNum))                    设置listen limit上限值</div><div class="line">                                                            —&gt; pkg/transport/keepalive_listener.go  sctx.l = transport.NewKeepAliveListener(sctx.l, “tcp”, cfg)                                             创建socket</div><div class="line">                                                                      —&gt; newTLSKeepaliveListener(sctx.l, cfg)</div><div class="line">                                                  —&gt; e.Clients = append(e.Clients, e.sctxs.l)</div><div class="line">                                                  —&gt; srvcfg := &amp;etcdserver.ServerConfig&#123;cfg&#125;</div><div class="line">                                                  —&gt; etcdserver/server.go  e.Server = etcdserver.NewServer(srvcfg)</div><div class="line">                                                            —&gt; store/store.go  st := store.New(StoreClusterPrefix, StoreKeysPrefix)</div><div class="line">                                                                      —&gt; store/store.go  s := newStore(namespaces ...)</div><div class="line">                                                                                —&gt; s := new(store)</div><div class="line">                                                                                —&gt; s.Root = newDir(s, “/“, s.CurrentIndex, Permanent)</div><div class="line">                                                                                —&gt; for namespace := range namespaces        s.Root.Add(newDir(s, namespace, s.CurrentIndex, s.Root, Permanent))</div><div class="line">                                                                                —&gt; s.Stats = newStats()</div><div class="line">                                                                                —&gt; s.WatcherHub = newWatchHub(1000)</div><div class="line">                                                                                —&gt; s.ttlKeyHeap = newTtlKeyHeap()</div><div class="line">                                                                                —&gt; s.readonlySet =  types.NewUnsafeSet(append(namespaces, “/“) ...)</div><div class="line">                                                                      —&gt; s.clock = clockwork.NewRealClock()</div><div class="line">                                                            —&gt; haveWAL := wal.Exist(cfg.WALDir())</div><div class="line">                                                            —&gt; ss := snap.New(cfg.SnapDir())</div><div class="line">                                                            —&gt; bepath := path.Join(cfg.SnapDir(), databaseFilename)</div><div class="line">                                                            —&gt; mvcc/backend/backend.go  be := backend.NewDefaultBackend(bepath)</div><div class="line">                                                                      —&gt; newBackend(bepath, defaultBatchInterval, defaultBatchLimit)</div><div class="line">                                                                                —&gt; db := bolt.Open(bepath, 0600, boltOpenOptions)</div><div class="line">                                                                                —&gt; b := &amp;backend&#123;&#125;</div><div class="line">                                                                                —&gt; mvcc/backend/batch_tx.go  b.batchTx = newBatchTx(b)</div><div class="line">                                                                                          —&gt; tx := &amp;batchTx&#123;b&#125;</div><div class="line">                                                                                          —&gt; tx.Commit()</div><div class="line">                                                                                —&gt; go b.run()</div><div class="line">                                                                                          —&gt; t := time.NewTimer(b.batchInterval)</div><div class="line">                                                                                          —&gt; for</div><div class="line">                                                                                                    —&gt; select</div><div class="line">                                                                                                              —&gt; case &lt;- t,C:</div><div class="line">                                                                                                              —&gt; case &lt;- b.stopc:</div><div class="line">                                                                                                                        —&gt; b.batchTx.CommitAndStop()</div><div class="line">                                                                                                    —&gt; b.batchTx.Commit()</div><div class="line">                                                                                                    —&gt; b.Reset(b.batchInterval)</div><div class="line">                                                            —&gt; rafthttp/util.go  prt := rafthttp.NewRoundTripper(cfg.PeerTLSInfo, cfg.peerDialTimeout())</div><div class="line">                                                                      —&gt; pkg/transport/timeout_transport.go  transport.NewTimoutTransport(cfg.PeerTLSInfo, cfg.peerDialTimeout())</div><div class="line">                                                                                —&gt; tr := NewTransport(info, dialtimeoutd)</div><div class="line">                                                                                —&gt; tr.Dial =(&amp;rwTimeoutDialer&#123;&#125;).Dial</div><div class="line">                                                            —&gt; swith</div><div class="line">                                                                      —&gt; case !haveWAL &amp;&amp; !cfg.NewCluster</div><div class="line">                                                                                —&gt; cfg.VerifyJoinExisting()</div><div class="line">                                                                                —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitialClusterToken, cfg.InitialPeerURLsMap)</div><div class="line">                                                                                —&gt; existingCluster = GetClusterFromRemotePeers(getRemotePeerURLs(cl, cfg.Name), prt)</div><div class="line">                                                                                —&gt; membership.ValidateClusterAndAssignIDs(cl, existingCluster)</div><div class="line">                                                                                —&gt; isCompatibleWithCluster(cl, cl.MemberByName(cfg.Name).ID, prt)</div><div class="line">                                                                                —&gt; remotes = existingCluster.Members()</div><div class="line">                                                                                —&gt; cl.SetID(existingCluster.ID())</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cfg.Print()</div><div class="line">                                                                                —&gt; id, n, s, w = startNode(cfg, cl)</div><div class="line">                                                                      —&gt; case !haveWAL &amp;&amp; cfg.NewCluster</div><div class="line">                                                                                —&gt; cfg.VerifyBootstrape()</div><div class="line">                                                                                —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitialClusterToken, cfg.InitialPeerURLsMap)</div><div class="line">                                                                                —&gt; m := cl.MemberByName(cfg.Name)</div><div class="line">                                                                                —&gt; isMemberBootstrapped(cl, cfg.Name, prt, cfg.bootstrapTimeout())</div><div class="line">                                                                                —&gt; if cfg.ShouldDiscover()</div><div class="line">                                                                                          —&gt; str = discovery.JoinCluster(cfg.DiscoveryURL, cfg.DiscoveryProxy, m.ID, cfg.InitialPeerURLsMap.String())</div><div class="line">                                                                                          —&gt; urlsmap = types.NewURLsMap(str)</div><div class="line">                                                                                          —&gt; checkDuplicateURL(urlsmap)</div><div class="line">                                                                                          —&gt; cl = membership.NewClusterFromURLsMap(cfg.InitoalClusterToken, urlsmap)</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cfg.PrintWithInitial()</div><div class="line">                                                                                —&gt; id, n, s, w = startNode(cfg, cl, cl.MemberIDs())</div><div class="line">                                                                      —&gt; case haveWAL:</div><div class="line">                                                                                —&gt; fileutil.IsDirWriteable(cfg.MemberDir())</div><div class="line">                                                                                —&gt; fileutil.IsDirWriteable(cfg.WALDir())</div><div class="line">                                                                                —&gt; snapshot = ss.Load()</div><div class="line">                                                                                —&gt; st.Recovery(snapshot.Data)</div><div class="line">                                                                                —&gt; cfg.Print()</div><div class="line">                                                                                —&gt; if !cfg.ForceNewCluster</div><div class="line">                                                                                          —&gt; id, cl, n, s, w = restartNode(cfg, snapshot)</div><div class="line">                                                                                —&gt; else</div><div class="line">                                                                                          —&gt; id, cl, n, s, w = restartAsStandaloneNode(cfg, snapshot)</div><div class="line">                                                                                —&gt; cl.SetStore(st)</div><div class="line">                                                                                —&gt; cl.SetBackend(be)</div><div class="line">                                                                                —&gt; cl.Recover()</div><div class="line">                                                            —&gt; sstats := &amp;stats.ServerStats&#123;&#125;</div><div class="line">                                                            —&gt; sstats.Initialize()</div><div class="line">                                                            —&gt; lstats := stats.NewLeaderStats(id.String())</div><div class="line">                                                            —&gt; srv = &amp;EtcdServer&#123;&#125;</div><div class="line">                                                            —&gt; srv.applyV2 = &amp;applierV2store&#123;&#125;</div><div class="line">                                                            —&gt; srv.be = be</div><div class="line">                                                            —&gt; srv.lessor = lease.NewLessor(srv.be)</div><div class="line">                                                            —&gt; srv.kv = mvcc.New(src.be, srv.lessor, &amp;srv.consistIndex)</div><div class="line">                                                            —&gt; srv.consistIndex.setConsistentIndex(srv.kv.ConsistentIndex())</div><div class="line">                                                            —&gt; srv.authStore = auth.NewAuthStore(srv.be)</div><div class="line">                                                            —&gt; h := cfg.AutoCompactionRetention</div><div class="line">                                                            —&gt; srv.compactor = compactor.NewPeriodic(h, srv,kv, srv)</div><div class="line">                                                            —&gt; tr := &amp;rafthttp.Transport&#123;&#125;</div><div class="line">                                                            —&gt; tr.Start()</div><div class="line">                                                            —&gt; for m := range  remotes      tr.AddRemote(m.ID, m.PeerURLs)</div><div class="line">                                                            —&gt; for m := range  cl.Members()      tr.AddPeer(m.ID, m.PeerURLs)</div><div class="line">                                                            —&gt; srv.r.transport = tr</div><div class="line">                                                  —&gt; etcdserver/server.go  e.Server.Start()</div><div class="line">                                        —&gt; interrupt_unix.go  osutil.RegisterInterruptHandler(e.Server.Stop)               向系统注册中断事件</div><div class="line">                    —&gt; case dirProxy:</div><div class="line">                              —&gt; etcdmain/etcd.go  startProxy(&amp;cfg.Config)</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/etcd介绍及源码分析/" class="archive-article-date">
  	<time datetime="2016-11-10T05:31:40.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/etcd/">etcd</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ZooKeeper源码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ZooKeeper源码/">ZooKeeper源码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ZooKeeper-Eclipse-编译："><a href="#ZooKeeper-Eclipse-编译：" class="headerlink" title="ZooKeeper Eclipse 编译："></a>ZooKeeper Eclipse 编译：</h2><p>1.源码下载：git clone <a href="https://github.com/apache/zookeeper.git" target="_blank" rel="external">https://github.com/apache/zookeeper.git</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout branch-3.4  (zookeeper版本选择3.4.8进行学习)</div></pre></td></tr></table></figure></p>
<p>2.通过Eclipse新建一个Java project, 将project prosition 设置为source code download的位置，java project 创建成果之后，右键build.xml run as Ant build，会自动下载build project的jar包。<br>多个文件目录下都有build.xml文件，都可以尝试run as Ant build，下载build project所需要的jar包。<br>3.运行build.xml之后，jar包或许仍不完整，需要自己下载jar包，目录截图如下：<br><img src="/images/ZooKeeper_Code_1.png" alt=""><br>4.至此，zookeeper java工程的编译任务完成。</p>
<h3 id="Linux-下同样需要ant编译："><a href="#Linux-下同样需要ant编译：" class="headerlink" title="Linux 下同样需要ant编译："></a>Linux 下同样需要ant编译：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get install openjdk-7-jdk</div><div class="line"><span class="built_in">cd</span> /root/zookeeper-3.4.8</div><div class="line">ant</div></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p><strong>RestAPI源码入门：</strong><br>RestAPI 入口main函数所在文件： org.apache.zookeeper.server.jersey.RestMain</p>
<p><strong>ZooKeeper Source Code 解析：</strong><br>1.zkServer 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nohup &quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line">-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=7778 \                         （此行是用作java remote debug使用的，是我后加的）</div><div class="line">-cp &quot;$CLASSPATH&quot; $JVMFLAGS $ZOOMAIN &quot;$ZOOCFG&quot; &gt; &quot;$_ZOO_DAEMON_OUT&quot; 2&gt;&amp;1 &lt; /dev/null &amp;</div><div class="line"> ZOOMAIN=&quot;-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;</div></pre></td></tr></table></figure></p>
<p>2.zkCli 脚本启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \</div><div class="line"> -cp &quot;$CLASSPATH&quot; $CLIENT_JVMFLAGS $JVMFLAGS \</div><div class="line"> org.apache.zookeeper.ZooKeeperMain &quot;$@&quot;</div></pre></td></tr></table></figure></p>
<p>由上可知， ZooKeeper的server启动入口函数为 <strong>QuorumPeerMain</strong> ，而client的启动入口函数为 <strong>ZooKeeperMain</strong>。</p>
<h3 id="QuorumPeerMain解析源码："><a href="#QuorumPeerMain解析源码：" class="headerlink" title="QuorumPeerMain解析源码："></a>QuorumPeerMain解析源码：</h3><p>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line">—&gt; QuorumPeerMain main = new QuorumPeerMain()</div><div class="line">—&gt; main.initializeAndRun(args)</div><div class="line">          —&gt; QuorumPeerConfig config = new QuorumPeerConfig()</div><div class="line">          —&gt; config.parse(args)</div><div class="line">                    —&gt; parseProperties(cfg)</div><div class="line">          —&gt; DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config)</div><div class="line">          —&gt; purgeMgr.start()</div><div class="line">                    —&gt; timer = new Timer(“PurgeTask<span class="string">")</span></div><div class="line">                    —&gt; TimerTask task = new PurgeTask(dataLogDir, snapDir)     —&gt; PurgeTxnLog.purge(dataLogDir, snapDir)</div><div class="line">                    —&gt; timer.scheduleAtFixedRate(task)</div><div class="line">          —&gt; runFromConfig(config)</div><div class="line">                    —&gt; ServerCnxnFactory cnxnFactory =  ServerCnxnFactory.createFactory()               NIOServerCnxnfactory</div><div class="line">                    —&gt; cnxnFactory.configure</div><div class="line">                              —&gt; thread = new ZooKeeperThread (Runnable)     参数Runnable是一个线程，传入的是cnxnFactory</div><div class="line">                              —&gt; ServerSocketChannel.open()</div><div class="line">                    —&gt; quorumPeer = new QuorumPeer()          是一个线程</div><div class="line">                    —&gt; quorumPeer.setZKDatabase (new ZKDatabase(quorumPeer.getTxnFactory()) )</div><div class="line">                              —&gt; new ZKDatabase()</div><div class="line">                                        —&gt; dataTree = new DataTree()</div><div class="line">                    —&gt; quorumPeer.start()</div><div class="line">                              —&gt; loadDataBase()</div><div class="line">                                        —&gt; zkDb.loadDataBase()</div><div class="line">                                                  —&gt; zxid = snapLog.restore(dataTree, listener)</div><div class="line">                                                            —&gt; processTransaction (hdr, dt, txnLog.itor)</div><div class="line">                                                                      —&gt; switch (hdr)</div><div class="line">                                                                                —&gt; OpCode.createSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                                                                                    —&gt; switch (header.getType())</div><div class="line">                                                                                                              —&gt; OpCode.create</div><div class="line">                                                                                                              —&gt; OpCode.delete</div><div class="line">                                                                                                              —&gt; OpCode.setData</div><div class="line">                                                                                                              —&gt; OpCode.setACL</div><div class="line">                                                                                                              —&gt; OpCode.closeSession</div><div class="line">                                                                                                              —&gt; OpCode.error</div><div class="line">                                                                                                              —&gt; OpCode.check</div><div class="line">                                                                                                              —&gt; OpCode.multi</div><div class="line">                                                                                —&gt; OpCode.closeSession</div><div class="line">                                                                                          —&gt; dt.processTxn (itor.getTxn)</div><div class="line">                                        —&gt; currentEpoch = readLongFromFile(“currentEpoch")</div><div class="line">                                        —&gt; acceptedEpoch = readLongFromFile(“acceptEpoch<span class="string">")</span></div><div class="line">                              —&gt; cnxnFactory.start()</div><div class="line">                                        —&gt; thread.start()</div><div class="line">                              —&gt; startLeaderElection()</div><div class="line">                              —&gt; super.start()</div><div class="line"></div><div class="line">NIOServerCnxnfactory.run()</div><div class="line">     —&gt; while (! ServerSockChannel.socket().isClosed())</div><div class="line">               —&gt; selector.select(1000)</div><div class="line">               —&gt; selectedList = selector.selectedKeys()</div><div class="line">               —&gt; for (SelectedKey k : selectedList)</div><div class="line">                         —&gt; if ( k.readyOps() &amp; SelectionKey.OP_ACCEPT != 0)</div><div class="line">                                   —&gt; socketChannel = ((ServerSocketChannel) key.channel()).accept()</div><div class="line">                                   —&gt; NIOServerCnxn cnxn =  createConnection(socketChannel, k)</div><div class="line">                         —&gt; else if (k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE) != 0)</div><div class="line">                                   —&gt; NIOServerCnxn cnxn = (NIOServerCnxn) k.attachment()</div><div class="line">                                   —&gt; cnxn.doIO(k)</div><div class="line">                                             —&gt; if (k.isReadable())</div><div class="line">                                                       —&gt; socketChannel.read (incomingBuffer)</div><div class="line">                                                       —&gt; zkServer.processPacket (incomingBuffer)</div><div class="line">                                                                 —&gt; OpCode.auth                                             解析incomingBuffer，判断请求类型</div><div class="line">                                                                 —&gt; OpCode.sasl</div><div class="line">                                                                 —&gt; req = new Request (incomingBuffer, ServerCnxn)</div><div class="line">                                                                 —&gt; processRequest(req)</div><div class="line">                                                                           —&gt; submittedRequest.add(req)</div><div class="line">                                             —&gt; if (k.isWritable())</div><div class="line">                                                       —&gt; if (outgoingBuffer.size() &gt; 0)</div><div class="line">                                                                 —&gt; sockChannel.write(outgoingBuffer)</div><div class="line">               —&gt; selector.clear()</div><div class="line"></div><div class="line">quorumPeer.run()</div><div class="line">     —&gt; jmxQuorumBean = new QuorumBean(this)</div><div class="line">     —&gt; MBeanRegistry.getInstance().register(jmxQuorumBean)</div><div class="line">     —&gt; while (running)</div><div class="line">               —&gt; switch (peerState)</div><div class="line">                         —&gt; case LOOKING:</div><div class="line">                                   —&gt; if (readOnly)</div><div class="line">                                             —&gt; roZk = new ReadOnlyZooKeeperServer (logFactory, this, new ZooKeeperServer.BasicDataTreeBuilder(), this.zkDb)</div><div class="line">                                             —&gt; roZkMgr = new Thread()</div><div class="line">                                             —&gt; roZkMgr.start()</div><div class="line">                                                       —&gt; roZk.startup()</div><div class="line">                                                                 —&gt; registerJMX()</div><div class="line">                                                                 —&gt; startSessionTracker()</div><div class="line">                                                                 —&gt; setupRequestProcessors()</div><div class="line">                                                                 —&gt; state = RUNNING</div><div class="line">                                   —&gt; setBCVote</div><div class="line">                                   —&gt; setCurrentVote</div><div class="line">                         —&gt; case OBSERVING:</div><div class="line">                                   —&gt; setObserver (makeObserver (logFactory) )</div><div class="line">                                             —&gt; new ZooKeeperServer.BasicDataTreeBuilder()</div><div class="line">                                             —&gt; new ObserverZooKeeperServer(logFactory, zkDatabase)</div><div class="line">                                             —&gt; new Observer()</div><div class="line">                                   —&gt; observer.observeLeader()</div><div class="line">                                             —&gt; zk.registerJMX</div><div class="line">                                             —&gt; addr = findLeader()</div><div class="line">                                             —&gt; connectToLeader (addr)          socket连接leader</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                                       —&gt; synchronized (zk)</div><div class="line">                                                                 —&gt; zk.getZKDatabase.deserializeSnapshot(leaderIs)</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case FOLLOWING:</div><div class="line">                                   —&gt; setFollower( makeFollower(logFactory) )</div><div class="line">                                   —&gt; follower.followLeader()</div><div class="line">                                             —&gt; connectToLeader()</div><div class="line">                                             —&gt; syncWithLeader()</div><div class="line">                                             —&gt; while (self.isRunning())</div><div class="line">                                                       —&gt; readPacket(qp)</div><div class="line">                                                       —&gt; processPacket(qp)</div><div class="line">                                                                 —&gt; switch (qp.getType())</div><div class="line">                                                                           —&gt; case Leader.PING</div><div class="line">                                                                           —&gt; case Leader.PROPOSAL</div><div class="line">                                                                           —&gt; case Leader.COMMIT</div><div class="line">                                                                           —&gt; …...</div><div class="line">                         —&gt; case LEADING:</div><div class="line">                                   —&gt; setLeader ( makeLeader(logFactory) )</div><div class="line">                                   —&gt; leader.lead()</div><div class="line">                                             —&gt; zk.registerJMX()</div><div class="line">                                             —&gt; cnxAccepter = new LearnerAcceptor()</div><div class="line">                                             —&gt; cnxAccepter.run()</div><div class="line">                                                       —&gt; LearnerHandler.run()</div><div class="line">                                             —&gt; zk.setZxid(ZxidUtils.makeZxid(epoch))</div><div class="line">                                             —&gt; startZkServer()</div><div class="line">                                                       —&gt; zk.startup ()</div><div class="line">                                                                 —&gt; CommitProcessor.run()                     处理已完成的客户端请求</div><div class="line">                                                                 —&gt; PrepRequestProcessor.run()               处理未完成客户端请求</div><div class="line">                                                                           —&gt; while (true)</div><div class="line">                                                                                     —&gt; request = submittedRequests.take()</div><div class="line">                                                                                     —&gt; pRequest (request)</div><div class="line">                                                                                               —&gt; switch (request.type)</div><div class="line">                                                                                                         —&gt; case OpCode.create:          pRequest2Txn(处理所有的请求)</div><div class="line">                                                                                                         —&gt; case OpCode.delete:          pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setData:       pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.setACL:        pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.check:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; case OpCode.multi:           pRequest2Txn</div><div class="line">                                                                                                         —&gt; …...</div><div class="line">                                   —&gt; setLeader(null)</div><div class="line"></div><div class="line">QuorumPeer :</div><div class="line">    public Follower follower;          Follower extends Leader</div><div class="line">    public Leader leader;</div><div class="line">    public Observer observer;          Obsearver extends Learner</div><div class="line"></div><div class="line">class Leader &#123;</div><div class="line">    final LeaderZooKeeperServer zk;</div><div class="line">    final QuorumPeer self;</div><div class="line">    private boolean quorumFormed = false;</div><div class="line">    // the follower acceptor thread</div><div class="line">    LearnerCnxAcceptor cnxAcceptor;</div><div class="line">    // list of all the followers</div><div class="line">    private final HashSet&lt;LearnerHandler&gt; learners = new HashSet&lt;LearnerHandler&gt;();</div><div class="line">&#125;</div><div class="line">class Follower extends Learner&#123;</div><div class="line">    private long lastQueued;</div><div class="line">    // This is the same object as this.zk, but we cache the downcast op</div><div class="line">    final FollowerZooKeeperServer fzk;</div><div class="line">&#125;</div><div class="line">class Learner &#123;</div><div class="line">    QuorumPeer self;</div><div class="line">    LearnerZooKeeperServer zk;</div><div class="line">    protected BufferedOutputStream bufferedOutput;</div><div class="line">    protected Socket sock;</div><div class="line">    protected InputArchive leaderIs;</div><div class="line">    protected OutputArchive leaderOs;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br><strong>ZooKeeperMain解析源码：</strong><br>main函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">—&gt; main = new ZooKeeperMain</div><div class="line">             —&gt; parseOptions (-server, -timeout, -<span class="built_in">readonly</span>)</div><div class="line">             —&gt; connectToZk</div><div class="line">                         —&gt; zk = new ZooKeeper</div><div class="line">                                        —&gt; new ConnectStringParser (属性：chrootPath, serverAddress)</div><div class="line">                                        —&gt; new StaticHostProvider (属性：serverAddress)</div><div class="line">                                        —&gt; getClientCnxnSocket (返回 ClientCnxnSocket的子类ClientCnxnSocketNIO对象 (属性：selector, sockKey) )</div><div class="line">                                        —&gt; new ClientCnxn (参数：chrootPath, hostProvider, zookeeper, watchManager, clientCnxnSocket, 属性：authInfo, pendingQueue, outgoingQueue, zookeeper, clientWatchManager)</div><div class="line">                                                        —&gt;  SendThread (参数：ClientCnxnSocketNIO对象，属性：clientCnxnSocket, lastPingSentNs, isFirstConnect)</div><div class="line">                                                        —&gt;  EventThread (属性： waitingEvents, sessionState)</div><div class="line">                                        —&gt; ClientCnxn.start()</div><div class="line">—&gt; main.run()</div><div class="line">          —&gt; processCmd (cl)</div><div class="line">                    —&gt; processZKCmd (co)</div><div class="line">                              —&gt; cmd equals create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                              —&gt; zk.  create/delete/rmr/<span class="built_in">set</span>/aget/get/ls/ls2/getAcl/setAcl/<span class="built_in">stat</span>/listquota/setquota/delquota</div><div class="line">                                        —&gt; cnxn. submitRequest (request, response)</div><div class="line">                                                  —&gt; queuePacket (request, response)</div><div class="line">                                                            —&gt; synchronized (outgoingQueue)</div><div class="line">                                                                      —&gt; outgoingQueue.add ( new Packet(request, response) )</div><div class="line">                                                            —&gt; sendThread.getClientCnxnScoket().wakeupCnxn()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>SendThred run函数：</strong><br>属性： state: socket连接状态，isFirstConnect: socket连接是否为第一次初始化连接，zookeeerSaslClient: SASL用户认证机制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">     —&gt; <span class="keyword">while</span> (state.isAlive)</div><div class="line">                    |—&gt; <span class="keyword">if</span> (! clientCnxnSocket.isConnected)</div><div class="line">                    |           —&gt;  startConnect</div><div class="line">                    |                    —&gt;  state = CONNECTING</div><div class="line">                    |                    —&gt; zookeeerSaslClient 认证</div><div class="line">                    |                    —&gt; ClientCnxnSocketNIO.connect</div><div class="line">                    |                              —&gt; SocketChannel.register(selector, OP_CONNECT)</div><div class="line">                    |                              —&gt; sock.connect(addr)</div><div class="line">                    |                              <span class="keyword">if</span> (immediateConnect)</div><div class="line">                    |                                        —&gt; sendThread.primeConnection</div><div class="line">                    |                                                  —&gt; new ConnectRequest(lastZxid)</div><div class="line">                    |                                                  —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                            <span class="keyword">if</span> (! disabledAutoWatchReset)</div><div class="line">                    |                                                                      —&gt; 将zookeeper 的属性 dataWatches, existWatchs, childWatchs 组装成 SetWatchs (递增Zxid)</div><div class="line">                    |                                                                      —&gt; new RequestHeader (Xid=-8, OpCode.setWatches)</div><div class="line">                    |                                                                      —&gt; new Packet, 将requestHeader和setWatchs 一起组装成Packet</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (packet)</div><div class="line">                    |                                                            <span class="keyword">for</span> (id : authInfo)</div><div class="line">                    |                                                                      —&gt; outgoingQueue.addFirst (new Packet(new RequestHeader(Xid=-4, OpCode.auth), new AuthPacket(id.schema, id.data)))</div><div class="line">          |                               outgoingQueue.addFirst (new Packet(ConnectRequest))</div><div class="line">                    |                                                            clientCnxnSocket.enableReadWriteOnly()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (zookeeperSaslClient != null)</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getSaslState == ZookeeperSaslClient.SaslState.INITIAL)</div><div class="line">                    |                               —&gt; zookeeperSaslClient.initialize</div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.AuthFailed)</div><div class="line">                    |                               —&gt; state = States.AUTH_FAILED</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (zookeeperSaslClient.getKeeperState == KeeperState.SaslAuthenticated)</div><div class="line">                    |                               —&gt; sendAuthEvent = <span class="literal">true</span></div><div class="line">                    |                    —&gt; <span class="keyword">if</span> (sendAuthEvent == <span class="literal">true</span>)</div><div class="line">                    |                               —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, zookeeperSaslClient.getKeeperState) )</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state.isConnected)</div><div class="line">                    |          —&gt; <span class="keyword">if</span> (clientCnxnSocket.getIdleSend  &gt;  MAX_SEND_PING_INTERVAL)</div><div class="line">                    |                    —&gt; sendPing</div><div class="line">                    |                              —&gt;  queuePacket (new RequestHeader (Xid=-2, OpCode.ping) )</div><div class="line">                    |                                        —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                                                  —&gt; new Packet (RequestHeader)</div><div class="line">                    |                                                  —&gt; <span class="keyword">if</span> (RequestHeader != OpCode.closeSession)</div><div class="line">                    |                                                            —&gt; outgoingQueue.add(packet)</div><div class="line">                    |                                        —&gt; sendThread.getClientCnxnSocket().wakeupCnxn()</div><div class="line">                    |—&gt; <span class="keyword">if</span> (state == States.CONNECTEDREADONLY)</div><div class="line">                    |          —&gt; pingRwServer()</div><div class="line">                    |                    —&gt; new Socket</div><div class="line">                    |                    —&gt; new BufferedReader (new InputStreamReader(socket.getInputStream() ) )</div><div class="line">                    |                    —&gt; BufferedReader.readLine()</div><div class="line">                    |—&gt; clientCnxnSocket.doTransport (pendingQueue, outgoingQueue)</div><div class="line">                    |          —&gt; synchronize (clientCnxnSocket)</div><div class="line">                    |                    —&gt; selected = selector.selectedKeys()</div><div class="line">                    |          —&gt; <span class="keyword">for</span> (SelectionKey key : selected)</div><div class="line">                    |                     —&gt; <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_CONNECT) != 0)</div><div class="line">                    |                              —&gt; <span class="keyword">if</span> ((SocketChannel)key.channel().finishConnect() )</div><div class="line">                    |                                         —&gt; sendThread.primeConnection</div><div class="line">                    |                    —&gt; <span class="keyword">else</span> <span class="keyword">if</span> ((key.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != 0)</div><div class="line">                    |                              —&gt; doIO (pendingQueue, outgoingQueue)</div><div class="line">                    |                                        —&gt; socketChannel = socketKey.channel()</div><div class="line">                    |                                        —&gt; <span class="keyword">if</span> (socketKey.isReadable())</div><div class="line">                    |                                                  —&gt; socketChannel.read(incomingBuffer)</div><div class="line">                    |                                                            —&gt; <span class="keyword">if</span> (! initialized)</div><div class="line">                    |                                                                      —&gt; readConnectResult()</div><div class="line">                    |                                                                                —&gt; ConnectResponse response = new ConnectResponse()</div><div class="line">                    |                                                                                —&gt; response.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)) , “connect<span class="string">")</span></div><div class="line">                    |                                                                                —&gt; sendThread.onConnectd(response.getTimeout, response.getSessionId, response.getPasswd)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent(new WatchedEvent(Watcher.Event.EventType.None, eventState)  )</div><div class="line">                    |                                                                      —&gt; enableRead()</div><div class="line">                    |                                                            —&gt; else</div><div class="line">                    |                                                                      —&gt; sendThread.readResponse(incomingBuffer)</div><div class="line">                    |                                                                                —&gt; ReplyHeader replyHeader = new ReplyHeader()</div><div class="line">                    |                                                                                —&gt; replyHeader.deserialize (BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “header")</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -2)    pings</div><div class="line">                    |                                                                                          —&gt; debug</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -4)    AuthPacket</div><div class="line">                    |                                                                                          —&gt; <span class="keyword">if</span> (replyHeader.getErr() == KeeperException.Code.AUTHFAILED)</div><div class="line">                    |                                                                                                    —&gt; eventThread.queueEvent (new WatchedEvent(Watcher.Event.EventType.None, Watcher.Event.KeeperState.AuthFailed) )</div><div class="line">                    |                                                                                —&gt; <span class="keyword">if</span> (replyHeader.getXid == -1)    notification</div><div class="line">                    |                                                                                          —&gt; WatcherEvent event = new WatcherEvent()</div><div class="line">                    |                                                                                          —&gt; event.deserialize(BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer)), “response<span class="string">")</span></div><div class="line">                    |                                                                                          —&gt; event.setPath (chrootPath)</div><div class="line">                    |                                                                                          —&gt; WatchedEvent we = new WatchedEvent(event)</div><div class="line">                    |                                                                                          —&gt; eventThread.queueEvent (we)</div><div class="line">                    |                                                                      —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                                —&gt; packet = pendingQueue.remove()</div><div class="line">                    |                                                                      —&gt; packet.replyHeader.setXid/setErr/setZxid</div><div class="line">                    |                                                                      —&gt; finishPacket (packet)</div><div class="line">                    |                                                                                —&gt; eventThread.queuePacket(packet)</div><div class="line">                    |                                                                                          —&gt; waitingEvents.add (packet)</div><div class="line">                    |                                        —&gt; if (socketKey.isWritable())</div><div class="line">                    |                                                  —&gt; Packet packet = findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress)</div><div class="line">                    |                                                  —&gt; packet.createBB          byteBuffer</div><div class="line">                    |                                                  —&gt; socketChannel.write(packet.bb)</div><div class="line">                    |                                                  —&gt; outgoingQueue.removeFirstOccurrence(packet)</div><div class="line">                    |                                                  —&gt; if (packet.hasRemaining)</div><div class="line">                    |                                                            —&gt; synchronized (pendingQueue)</div><div class="line">                    |                                                                      —&gt; pendingQueue.add(packet)</div><div class="line">                    |          —&gt; if (sendThread.getZkState().isConnected)</div><div class="line">                    |                    —&gt; synchronized (outgoingQueue)</div><div class="line">                    |                              —&gt; if (findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != null )</div><div class="line">                    |                                        —&gt; enableWrite()</div></pre></td></tr></table></figure></p>
<p>==============================================================================================================================<br><strong>EventThred run函数：</strong><br>属性： waitingEvents<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">run</div><div class="line">      —&gt; isRunning = <span class="literal">true</span></div><div class="line">      —&gt; <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">               —&gt; event = waitingEvents.take()</div><div class="line">                         —&gt; <span class="keyword">if</span> (event == eventOfDeath)</div><div class="line">                                   —&gt; wasKilled = <span class="literal">true</span></div><div class="line">                         —&gt; <span class="keyword">else</span></div><div class="line">                                   —&gt; processEvent(event)</div><div class="line">                                        —&gt; <span class="keyword">if</span> (event instanceof WatcherSetEventPair)</div><div class="line">                                                       —&gt; <span class="keyword">for</span> (Watcher watcher : ((WatcherSetEventPair)event).watchers )</div><div class="line">                                                                 —&gt; watcher.process( ((WatcherSetEventPair)event).event )</div><div class="line">                                             —&gt; <span class="keyword">else</span></div><div class="line">                                                       —&gt; Packet p = (Packet) event</div><div class="line">                                                       —&gt; <span class="keyword">if</span> (p.response instanceof ExistsResponse || p.response instanceof SetDataResponse || p.response instanceof SetACLResponse)</div><div class="line">                                                                 —&gt; StatCallback cb = (StatCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult ( clientPath, ((ExistsResponse/SetDataResponse/SetACLResponse) p.response).getStat )</div><div class="line">                                                                           —&gt; decOutstanding ()</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetDataResponse)</div><div class="line">                                                                 —&gt; DataCallback cb = (DataCallback) p.cb</div><div class="line">                                                                 —&gt; GetDataResponse response = (GetDataResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getData(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetACLResponse)</div><div class="line">                                                                 —&gt; ACLCallback cb = (ACLCallback) p.cb</div><div class="line">                                                                 —&gt; GetACLResponse response = (GetACLResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getAcl(), response.getStat())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildrenResponse)</div><div class="line">                                                                 —&gt; ChildrenCallback cb = (ChildrenCallback) p.cb</div><div class="line">                                                                 —&gt; GetChildrenResponse response = (GetChildrenResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof GetChildren2Response)</div><div class="line">                                                                 —&gt; Children2Callback cb = (Children2Callback) p.cb</div><div class="line">                                                                 —&gt; GetChildren2Response response = (GetChildren2Response) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getChildren())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof CreateResponse)</div><div class="line">                                                                 —&gt; StringCallback cb = (StringCallback) p.cb</div><div class="line">                                                                 —&gt; CreateResponse response = (CreateResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getPath())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.response instanceof MultiResponse)</div><div class="line">                                                                 —&gt; MultiCallback cb = (MultiCallback) p.cb</div><div class="line">                                                                 —&gt; MultiResponse response = (MultiResponse) p.response</div><div class="line">                                                                 —&gt; cb.processResult (clientPath, response.getResultList())</div><div class="line">                                                       —&gt; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb instanceof VoidCallback)</div><div class="line">                                                                 —&gt; VoidCallback cb = (VoidCallback) p.cb</div><div class="line">                                                                 —&gt; cb.processResult (clientPath)</div></pre></td></tr></table></figure></p>
<p><strong>ClinetCnxn是核心函数：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ClientCnxn</span><span class="params">(String chrootPath, HostProvider hostProvider, intsessionTimeout, ZooKeeper zooKeeper,</span></span></div><div class="line">            ClientWatchManager watcher, ClientCnxnSocket clientCnxnSocket,</div><div class="line">            <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly) &#123;</div><div class="line">        <span class="keyword">this</span>.zooKeeper = zooKeeper;</div><div class="line">        <span class="keyword">this</span>.watcher = watcher;</div><div class="line">        <span class="keyword">this</span>.hostProvider = hostProvider;</div><div class="line">        <span class="keyword">this</span>.chrootPath = chrootPath;</div><div class="line"></div><div class="line">        sendThread = <span class="keyword">new</span> SendThread(clientCnxnSocket);</div><div class="line">        eventThread = <span class="keyword">new</span> EventThread();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">enum</span> States &#123;</div><div class="line">        CONNECTING, ASSOCIATING, CONNECTED, CONNECTEDREADONLY,</div><div class="line">        CLOSED, AUTH_FAILED, NOT_CONNECTED;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAlive</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> != CLOSED &amp;&amp; <span class="keyword">this</span> != AUTH_FAILED;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span> == CONNECTED || <span class="keyword">this</span> == CONNECTEDREADONLY;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        Packet(RequestHeader requestHeader, ReplyHeader replyHeader,</div><div class="line">               Record request, Record response,</div><div class="line">               WatchRegistration watchRegistration, <span class="keyword">boolean</span> readOnly) &#123;</div><div class="line">            <span class="keyword">this</span>.requestHeader = requestHeader;</div><div class="line">            <span class="keyword">this</span>.replyHeader = replyHeader;</div><div class="line">            <span class="keyword">this</span>.request = request;</div><div class="line">            <span class="keyword">this</span>.response = response;</div><div class="line">            <span class="keyword">this</span>.readOnly = readOnly;</div><div class="line">            <span class="keyword">this</span>.watchRegistration = watchRegistration;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataTree</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">/* Rather than fight it, let root have an alias */</span></div><div class="line">        nodes.put(<span class="string">""</span>, root);</div><div class="line">        nodes.put(rootZookeeper, root);</div><div class="line"></div><div class="line">        <span class="comment">/** add the proc node and quota node */</span></div><div class="line">        root.addChild(procChildZookeeper);</div><div class="line">        nodes.put(procZookeeper, procDataNode);</div><div class="line"></div><div class="line">        procDataNode.addChild(quotaChildZookeeper);</div><div class="line">        nodes.put(quotaZookeeper, quotaDataNode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></div><div class="line">        <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</div><div class="line">    &#123;</div><div class="line">        request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</div><div class="line">                                    zks.getTime(), type);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (type) &#123;</div><div class="line">            <span class="keyword">case</span> OpCode.create:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CreateRequest createRequest = (CreateRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, createRequest);</div><div class="line">                String path = createRequest.getPath();</div><div class="line">                <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span> || failCreate) &#123;</div><div class="line">                    LOG.info(<span class="string">"Invalid path "</span> + path + <span class="string">" with session 0x"</span> +</div><div class="line">                            Long.toHexString(request.sessionId));</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                List&lt;ACL&gt; listACL = removeDuplicates(createRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                String parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                ChangeRecord parentRecord = getRecordForPath(parentPath);</div><div class="line"></div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.CREATE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> parentCVersion = parentRecord.stat.getCversion();</div><div class="line">                CreateMode createMode =</div><div class="line">                    CreateMode.fromFlag(createRequest.getFlags());</div><div class="line">                <span class="keyword">if</span> (createMode.isSequential()) &#123;</div><div class="line">                    path = path + String.format(Locale.ENGLISH, <span class="string">"%010d"</span>, parentCVersion);</div><div class="line">                &#125;</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (getRecordForPath(path) != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NodeExistsException(path);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</div><div class="line">                    <span class="comment">// ignore this one</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">boolean</span> ephemeralParent = parentRecord.stat.getEphemeralOwner() != <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (ephemeralParent) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoChildrenForEphemeralsException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> newCversion = parentRecord.stat.getCversion()+<span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CreateTxn(path, createRequest.getData(),</div><div class="line">                        listACL,</div><div class="line">                        createMode.isEphemeral(), newCversion);</div><div class="line">                StatPersisted s = <span class="keyword">new</span> StatPersisted();</div><div class="line">                <span class="keyword">if</span> (createMode.isEphemeral()) &#123;</div><div class="line">                    s.setEphemeralOwner(request.sessionId);</div><div class="line">                &#125;</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount++;</div><div class="line">                parentRecord.stat.setCversion(newCversion);</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path, s,</div><div class="line">                        <span class="number">0</span>, listACL));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.delete:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                DeleteRequest deleteRequest = (DeleteRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, deleteRequest);</div><div class="line">                path = deleteRequest.getPath();</div><div class="line">                lastSlash = path.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">                <span class="keyword">if</span> (lastSlash == -<span class="number">1</span> || path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span></div><div class="line">                        || zks.getZKDatabase().isSpecialPath(path)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException(path);</div><div class="line">                &#125;</div><div class="line">                parentPath = path.substring(<span class="number">0</span>, lastSlash);</div><div class="line">                parentRecord = getRecordForPath(parentPath);</div><div class="line">                ChangeRecord nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, parentRecord.acl, ZooDefs.Perms.DELETE,</div><div class="line">                        request.authInfo);</div><div class="line">                <span class="keyword">int</span> version = deleteRequest.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; nodeRecord.stat.getVersion() != version) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (nodeRecord.childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NotEmptyException(path);</div><div class="line">                &#125;</div><div class="line">                request.txn = <span class="keyword">new</span> DeleteTxn(path);</div><div class="line">                parentRecord = parentRecord.duplicate(request.hdr.getZxid());</div><div class="line">                parentRecord.childCount--;</div><div class="line">                addChangeRecord(parentRecord);</div><div class="line">                addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(), path,</div><div class="line">                        <span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setData:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetDataRequest setDataRequest = (SetDataRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setDataRequest);</div><div class="line">                path = setDataRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.WRITE,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setDataRequest.getVersion();</div><div class="line">                <span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetDataTxn(path, setDataRequest.getData(), version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setVersion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.setACL:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                SetACLRequest setAclRequest = (SetACLRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, setAclRequest);</div><div class="line">                path = setAclRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                listACL = removeDuplicates(setAclRequest.getAcl());</div><div class="line">                <span class="keyword">if</span> (!fixupACL(request.authInfo, listACL)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.InvalidACLException(path);</div><div class="line">                &#125;</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.ADMIN,</div><div class="line">                        request.authInfo);</div><div class="line">                version = setAclRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getAversion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> SetACLTxn(path, listACL, version);</div><div class="line">                nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</div><div class="line">                nodeRecord.stat.setAversion(version);</div><div class="line">                addChangeRecord(nodeRecord);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.createSession:</div><div class="line">                request.request.rewind();</div><div class="line">                <span class="keyword">int</span> to = request.request.getInt();</div><div class="line">                request.txn = <span class="keyword">new</span> CreateSessionTxn(to);</div><div class="line">                request.request.rewind();</div><div class="line">                zks.sessionTracker.addSession(request.sessionId, to);</div><div class="line">                zks.setOwner(request.sessionId, request.getOwner());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.closeSession:</div><div class="line">                <span class="comment">// We don't want to do this check since the session expiration thread</span></div><div class="line">                <span class="comment">// queues up this operation without being the session owner.</span></div><div class="line">                <span class="comment">// this request is the last of the session so it should be ok</span></div><div class="line">                <span class="comment">//zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span></div><div class="line">                HashSet&lt;String&gt; es = zks.getZKDatabase()</div><div class="line">                        .getEphemerals(request.sessionId);</div><div class="line">                <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123;</div><div class="line">                    <span class="keyword">for</span> (ChangeRecord c : zks.outstandingChanges) &#123;</div><div class="line">                        <span class="keyword">if</span> (c.stat == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Doing a delete</span></div><div class="line">                            es.remove(c.path);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.stat.getEphemeralOwner() == request.sessionId) &#123;</div><div class="line">                            es.add(c.path);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">for</span> (String path2Delete : es) &#123;</div><div class="line">                        addChangeRecord(<span class="keyword">new</span> ChangeRecord(request.hdr.getZxid(),</div><div class="line">                                path2Delete, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    zks.sessionTracker.setSessionClosing(request.sessionId);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                LOG.info(<span class="string">"Processed session termination for sessionid: 0x"</span></div><div class="line">                        + Long.toHexString(request.sessionId));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> OpCode.check:</div><div class="line">                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</div><div class="line">                CheckVersionRequest checkVersionRequest = (CheckVersionRequest)record;</div><div class="line">                <span class="keyword">if</span>(deserialize)</div><div class="line">                    ByteBufferInputStream.byteBuffer2Record(request.request, checkVersionRequest);</div><div class="line">                path = checkVersionRequest.getPath();</div><div class="line">                validatePath(path, request.sessionId);</div><div class="line">                nodeRecord = getRecordForPath(path);</div><div class="line">                checkACL(zks, nodeRecord.acl, ZooDefs.Perms.READ,</div><div class="line">                        request.authInfo);</div><div class="line">                version = checkVersionRequest.getVersion();</div><div class="line">                currentVersion = nodeRecord.stat.getVersion();</div><div class="line">                <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</div><div class="line">                &#125;</div><div class="line">                version = currentVersion + <span class="number">1</span>;</div><div class="line">                request.txn = <span class="keyword">new</span> CheckVersionTxn(path, version);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(QuorumPacket qp)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">        <span class="keyword">switch</span> (qp.getType()) &#123;</div><div class="line">        <span class="keyword">case</span> Leader.PING:</div><div class="line">            ping(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.PROPOSAL:</div><div class="line">            LOG.warn(<span class="string">"Ignoring proposal"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.COMMIT:</div><div class="line">            LOG.warn(<span class="string">"Ignoring commit"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.UPTODATE:</div><div class="line">            LOG.error(<span class="string">"Received an UPTODATE message after Observer started"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.REVALIDATE:</div><div class="line">            revalidate(qp);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.SYNC:</div><div class="line">            ((ObserverZooKeeperServer)zk).sync();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Leader.INFORM:</div><div class="line">            TxnHeader hdr = <span class="keyword">new</span> TxnHeader();</div><div class="line">            Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);</div><div class="line">            Request request = <span class="keyword">new</span> Request (<span class="keyword">null</span>, hdr.getClientId(),</div><div class="line">                                           hdr.getCxid(),</div><div class="line">                                           hdr.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">            request.txn = txn;</div><div class="line">            request.hdr = hdr;</div><div class="line">            ObserverZooKeeperServer obs = (ObserverZooKeeperServer)zk;</div><div class="line">            obs.commitRequest(request);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">switch</span> (packetType) &#123;</div><div class="line">        <span class="keyword">case</span> DIFF:</div><div class="line">            <span class="keyword">return</span> <span class="string">"DIFF"</span>;</div><div class="line">        <span class="keyword">case</span> TRUNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"TRUNC"</span>;</div><div class="line">        <span class="keyword">case</span> SNAP:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SNAP"</span>;</div><div class="line">        <span class="keyword">case</span> OBSERVERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"OBSERVERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> NEWLEADER:</div><div class="line">            <span class="keyword">return</span> <span class="string">"NEWLEADER"</span>;</div><div class="line">        <span class="keyword">case</span> FOLLOWERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"FOLLOWERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> UPTODATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UPTODATE"</span>;</div><div class="line">        <span class="keyword">case</span> LEADERINFO:</div><div class="line">            <span class="keyword">return</span> <span class="string">"LEADERINFO"</span>;</div><div class="line">        <span class="keyword">case</span> ACKEPOCH:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACKEPOCH"</span>;</div><div class="line">        <span class="keyword">case</span> REQUEST:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REQUEST"</span>;</div><div class="line">        <span class="keyword">case</span> PROPOSAL:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PROPOSAL"</span>;</div><div class="line">        <span class="keyword">case</span> ACK:</div><div class="line">            <span class="keyword">return</span> <span class="string">"ACK"</span>;</div><div class="line">        <span class="keyword">case</span> COMMIT:</div><div class="line">            <span class="keyword">return</span> <span class="string">"COMMIT"</span>;</div><div class="line">        <span class="keyword">case</span> PING:</div><div class="line">            <span class="keyword">return</span> <span class="string">"PING"</span>;</div><div class="line">        <span class="keyword">case</span> REVALIDATE:</div><div class="line">            <span class="keyword">return</span> <span class="string">"REVALIDATE"</span>;</div><div class="line">        <span class="keyword">case</span> SYNC:</div><div class="line">            <span class="keyword">return</span> <span class="string">"SYNC"</span>;</div><div class="line">        <span class="keyword">case</span> INFORM:</div><div class="line">            <span class="keyword">return</span> <span class="string">"INFORM"</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">"UNKNOWN"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper源码/" class="archive-article-date">
  	<time datetime="2016-11-10T05:15:34.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-10</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ZooKeeper简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ZooKeeper简介/">ZooKeeper简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ZooKeeper导图"><a href="#ZooKeeper导图" class="headerlink" title="ZooKeeper导图"></a>ZooKeeper导图</h2><p><strong>ZooKeeper 服务:</strong><br><img src="/images/ZooKeeper_1.png" alt=""></p>
<p><strong>ZooKeeper 名字空间:</strong><br><img src="/images/ZooKeeper_2.png" alt=""></p>
<h2 id="推荐一本书"><a href="#推荐一本书" class="headerlink" title="推荐一本书"></a>推荐一本书</h2><p>《ZooKeeper分布式过程协同技术详解》</p>
<h2 id="基于-Paxos-算法"><a href="#基于-Paxos-算法" class="headerlink" title="基于 Paxos 算法"></a>基于 Paxos 算法</h2><p>wiki: <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science" target="_blank" rel="external">https://en.wikipedia.org/wiki/Paxos_(computer_science</a>)</p>
<h2 id="ZooKeeper-支持的api"><a href="#ZooKeeper-支持的api" class="headerlink" title="ZooKeeper 支持的api"></a>ZooKeeper 支持的api</h2><p><strong>ZooKeeper API:</strong><br>1.create /path data<br>2.delete /path<br>3.exists /path<br>4.setData /path data<br>5.getData /path<br>6.getChildren /path</p>
<h2 id="单点ZooKeeper-与-ZooKeeper集群"><a href="#单点ZooKeeper-与-ZooKeeper集群" class="headerlink" title="单点ZooKeeper 与 ZooKeeper集群"></a>单点ZooKeeper 与 ZooKeeper集群</h2><p><strong>ZooKeeper服务器的两种工作模式： 独立模式(standalone)和仲裁模式(quorum)</strong><br><strong>独立模式(standalone)</strong>: 单独的ZooKeeper服务器。<br><strong>仲裁模式(quorum)</strong>: ZooKeeper集合(ZooKeeper ensemble)。 仲裁模式中，为减少ZooKeeper Server数据同步的延迟，法定人数 的概念被使用，法定人数的大小设置非常重要。</p>
<p><strong>仲裁模式试验：</strong><br><strong>configure 文件：</strong><br><em>z1.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z1/data</div><div class="line">clientPort=2181</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>z2.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z2/data</div><div class="line">clientPort=2182</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>z3.cfg</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/root/zookeeper-3.4.8/conf/z3/data</div><div class="line">clientPort=2183</div><div class="line">server.1=127.0.0.1:2222:2223</div><div class="line">server.2=127.0.0.1:3333:3334</div><div class="line">server.3=127.0.0.1:4444:4445</div></pre></td></tr></table></figure></p>
<p><em>启动3个节点命令：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z1/z1.cfg</div><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z2/z2.cfg</div><div class="line">/root/zookeeper-3.4.8/bin/zkServer.sh  start  z3/z3.cfg</div></pre></td></tr></table></figure></p>
<p><em>连接集群：</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</div></pre></td></tr></table></figure></p>
<p>创建 <strong>ephemeral</strong> 节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create -e /master &quot;master.example.com&quot;</div></pre></td></tr></table></figure></p>
<p>创建 <strong>sequential</strong> 节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create -s /master/task-  “cmd&quot;</div></pre></td></tr></table></figure></p>
<p><strong>WatchedEvent</strong> 数据结构包含以下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ZooKeeper会话状态(KeeperState)：Disconnected, SyncConnected, AuthFailed, ConnectedReadOnly, SaslAuthenticated, Expired.</div><div class="line">事件类型(EventType)：NodeCreated, NodeDeleted, NodeDataChanged, NodeChildrenChanged, None.</div><div class="line">如果事件类型不是None时，返回一个znode路径.</div><div class="line">Watch监视点设置：</div><div class="line">NodeCreated：通过exists调用设置监视点。</div><div class="line">NodeDeleted：通过exists或getData调用设置监视点。</div><div class="line">NodeDataChanged：通过exists或getData调用设置监视点。</div><div class="line">NodeChildrenChanged：通过getChildren调用设置监视点。</div></pre></td></tr></table></figure></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/ZooKeeper简介/" class="archive-article-date">
  	<time datetime="2016-11-09T03:08:50.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/分布式协同/">分布式协同</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Spark Streaming SQL MLlib GraphX" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/Spark Streaming SQL MLlib GraphX/">Spark Streaming/SQL/MLlib/GraphX</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spark-Streaming-SQL-MLlib-GraphX"><a href="#Spark-Streaming-SQL-MLlib-GraphX" class="headerlink" title="Spark Streaming/SQL/MLlib/GraphX"></a>Spark Streaming/SQL/MLlib/GraphX</h2><p>Spark 这一大数据分析框架，包含了：</p>
<ul>
<li>流计算： Streaming</li>
<li>图计算： GraphX</li>
<li>数据挖掘： MLlib</li>
<li>SQL</li>
</ul>
<h2 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h2><p>参考： <a href="http://spark.apache.org/docs/latest/streaming-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/streaming-programming-guide.html</a></p>
<p><img src="/images/Spark_Streaming_1.png" alt=""></p>
<p><img src="/images/Spark_Streaming_2.png" alt=""></p>
<p><img src="/images/Spark_Streaming_3.png" alt=""></p>
<p><img src="/images/Spark_Streaming_4.png" alt=""></p>
<h3 id="Spark-Streaming-Example"><a href="#Spark-Streaming-Example" class="headerlink" title="Spark Streaming Example"></a>Spark Streaming Example</h3><p><strong>StreamingContext:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark._</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming._</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming.<span class="type">StreamingContext</span>._ <span class="comment">// not necessary since Spark 1.3</span></div><div class="line"><span class="comment">// Create a local StreamingContext with two working thread and batch interval of 1 second.</span></div><div class="line"><span class="comment">// The master requires 2 cores to prevent from a starvation scenario.</span></div><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local[2]"</span>).setAppName(<span class="string">"NetworkWordCount"</span>)</div><div class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p><strong>socket:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create a DStream that will connect to hostname:port, like localhost:9999</span></div><div class="line"><span class="keyword">val</span> lines = ssc.socketTextStream(<span class="string">"localhost"</span>, <span class="number">9999</span>)</div><div class="line"><span class="comment">// Split each line into words</span></div><div class="line"><span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</div><div class="line"><span class="keyword">import</span> org.apache.spark.streaming.<span class="type">StreamingContext</span>._ <span class="comment">// not necessary since Spark 1.3</span></div><div class="line"><span class="comment">// Count each word in each batch</span></div><div class="line"><span class="keyword">val</span> pairs = words.map(word =&gt; (word, <span class="number">1</span>))</div><div class="line"><span class="keyword">val</span> wordCounts = pairs.reduceByKey(_ + _)</div><div class="line"><span class="comment">// Print the first ten elements of each RDD generated in this DStream to the console</span></div><div class="line">wordCounts.print()</div><div class="line">ssc.start()             <span class="comment">// Start the computation</span></div><div class="line">ssc.awaitTermination()  <span class="comment">// Wait for the computation to terminate</span></div></pre></td></tr></table></figure></p>
<p><strong>往9999端口里面输入：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ nc -lk 9999</div><div class="line">$ ./bin/run-example streaming.NetworkWordCount localhost 9999</div></pre></td></tr></table></figure></p>
<h2 id="Spark-GraphX"><a href="#Spark-GraphX" class="headerlink" title="Spark GraphX"></a>Spark GraphX</h2><p>参考： <a href="http://spark.apache.org/docs/latest/graphx-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/graphx-programming-guide.html</a></p>
<p><img src="/images/Spark_GraphX_1.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark._</div><div class="line"><span class="keyword">import</span> org.apache.spark.graphx._</div><div class="line"><span class="comment">// To make some of the examples work we will also need RDD</span></div><div class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VertexProperty</span>(<span class="params"></span>)</span></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProperty</span>(<span class="params">val name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">VertexProperty</span></span></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductProperty</span>(<span class="params">val name: <span class="type">String</span>, val price: <span class="type">Double</span></span>) <span class="keyword">extends</span> <span class="title">VertexProperty</span></span></div><div class="line"><span class="comment">// The graph might then have the type:</span></div><div class="line"><span class="keyword">var</span> graph: <span class="type">Graph</span>[<span class="type">VertexProperty</span>, <span class="type">String</span>] = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Graph</span>[<span class="type">VD</span>, <span class="type">ED</span>] </span>&#123;</div><div class="line">  <span class="keyword">val</span> vertices: <span class="type">VertexRDD</span>[<span class="type">VD</span>]</div><div class="line">  <span class="keyword">val</span> edges: <span class="type">EdgeRDD</span>[<span class="type">ED</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/Spark_GraphX_2.png" alt=""></p>
<p><strong>构建graph的代码：</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> userGraph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>]</div><div class="line"></div><div class="line"><span class="comment">// Assume the SparkContext has already been constructed</span></div><div class="line"><span class="keyword">val</span> sc: <span class="type">SparkContext</span></div><div class="line"><span class="comment">// Create an RDD for the vertices</span></div><div class="line"><span class="keyword">val</span> users: <span class="type">RDD</span>[(<span class="type">VertexId</span>, (<span class="type">String</span>, <span class="type">String</span>))] =</div><div class="line">  sc.parallelize(<span class="type">Array</span>((<span class="number">3</span>L, (<span class="string">"rxin"</span>, <span class="string">"student"</span>)), (<span class="number">7</span>L, (<span class="string">"jgonzal"</span>, <span class="string">"postdoc"</span>)),</div><div class="line">                       (<span class="number">5</span>L, (<span class="string">"franklin"</span>, <span class="string">"prof"</span>)), (<span class="number">2</span>L, (<span class="string">"istoica"</span>, <span class="string">"prof"</span>))))</div><div class="line"><span class="comment">// Create an RDD for edges</span></div><div class="line"><span class="keyword">val</span> relationships: <span class="type">RDD</span>[<span class="type">Edge</span>[<span class="type">String</span>]] =</div><div class="line">  sc.parallelize(<span class="type">Array</span>(<span class="type">Edge</span>(<span class="number">3</span>L, <span class="number">7</span>L, <span class="string">"collab"</span>),    <span class="type">Edge</span>(<span class="number">5</span>L, <span class="number">3</span>L, <span class="string">"advisor"</span>),</div><div class="line">                       <span class="type">Edge</span>(<span class="number">2</span>L, <span class="number">5</span>L, <span class="string">"colleague"</span>), <span class="type">Edge</span>(<span class="number">5</span>L, <span class="number">7</span>L, <span class="string">"pi"</span>)))</div><div class="line"><span class="comment">// Define a default user in case there are relationship with missing user</span></div><div class="line"><span class="keyword">val</span> defaultUser = (<span class="string">"John Doe"</span>, <span class="string">"Missing"</span>)</div><div class="line"><span class="comment">// Build the initial Graph</span></div><div class="line"><span class="keyword">val</span> graph = <span class="type">Graph</span>(users, relationships, defaultUser)</div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>] <span class="comment">// Constructed from above</span></div><div class="line"><span class="comment">// Count all users which are postdocs</span></div><div class="line">graph.vertices.filter &#123; <span class="keyword">case</span> (id, (name, pos)) =&gt; pos == <span class="string">"postdoc"</span> &#125;.count</div><div class="line"><span class="comment">// Count all the edges where src &gt; dst</span></div><div class="line">graph.edges.filter(e =&gt; e.srcId &gt; e.dstId).count</div><div class="line">graph.edges.filter &#123; <span class="keyword">case</span> <span class="type">Edge</span>(src, dst, prop) =&gt; src &gt; dst &#125;.count</div><div class="line"></div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>] <span class="comment">// Constructed from above</span></div><div class="line"><span class="comment">// Use the triplets view to create an RDD of facts.</span></div><div class="line"><span class="keyword">val</span> facts: <span class="type">RDD</span>[<span class="type">String</span>] =</div><div class="line">  graph.triplets.map(triplet =&gt;</div><div class="line">    triplet.srcAttr._1 + <span class="string">" is the "</span> + triplet.attr + <span class="string">" of "</span> + triplet.dstAttr._1)</div><div class="line">facts.collect.foreach(println(_))</div></pre></td></tr></table></figure></p>
<p><strong>Graph  Operators:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[(<span class="type">String</span>, <span class="type">String</span>), <span class="type">String</span>]</div><div class="line"><span class="comment">// Use the implicit GraphOps.inDegrees operator</span></div><div class="line"><span class="keyword">val</span> inDegrees: <span class="type">VertexRDD</span>[<span class="type">Int</span>] = graph.inDegrees</div></pre></td></tr></table></figure></p>
<p><strong>Shortest Path:</strong><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.spark.graphx.&#123;<span class="type">Graph</span>, <span class="type">VertexId</span>&#125;</div><div class="line"><span class="keyword">import</span> org.apache.spark.graphx.util.<span class="type">GraphGenerators</span></div><div class="line"></div><div class="line"><span class="comment">// A graph with edge attributes containing distances</span></div><div class="line"><span class="keyword">val</span> graph: <span class="type">Graph</span>[<span class="type">Long</span>, <span class="type">Double</span>] =</div><div class="line">  <span class="type">GraphGenerators</span>.logNormalGraph(sc, numVertices = <span class="number">100</span>).mapEdges(e =&gt; e.attr.toDouble)</div><div class="line"><span class="keyword">val</span> sourceId: <span class="type">VertexId</span> = <span class="number">42</span> <span class="comment">// The ultimate source</span></div><div class="line"><span class="comment">// Initialize the graph such that all vertices except the root have distance infinity.</span></div><div class="line"><span class="keyword">val</span> initialGraph = graph.mapVertices((id, _) =&gt;</div><div class="line">    <span class="keyword">if</span> (id == sourceId) <span class="number">0.0</span> <span class="keyword">else</span> <span class="type">Double</span>.<span class="type">PositiveInfinity</span>)</div><div class="line"><span class="keyword">val</span> sssp = initialGraph.pregel(<span class="type">Double</span>.<span class="type">PositiveInfinity</span>)(</div><div class="line">  (id, dist, newDist) =&gt; math.min(dist, newDist), <span class="comment">// Vertex Program</span></div><div class="line">  triplet =&gt; &#123;  <span class="comment">// Send Message</span></div><div class="line">    <span class="keyword">if</span> (triplet.srcAttr + triplet.attr &lt; triplet.dstAttr) &#123;</div><div class="line">      <span class="type">Iterator</span>((triplet.dstId, triplet.srcAttr + triplet.attr))</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="type">Iterator</span>.empty</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  (a, b) =&gt; math.min(a, b) <span class="comment">// Merge Message</span></div><div class="line">)</div><div class="line">println(sssp.vertices.collect.mkString(<span class="string">"\n"</span>))</div></pre></td></tr></table></figure></p>
<h2 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h2><p>参考： <a href="http://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/sql-programming-guide.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">val jdbcDF = spark.read</div><div class="line">  .format(&quot;jdbc&quot;)</div><div class="line">  .option(&quot;url&quot;, &quot;jdbc:postgresql:dbserver&quot;)</div><div class="line">  .option(&quot;dbtable&quot;, &quot;schema.tablename&quot;)</div><div class="line">  .option(&quot;user&quot;, &quot;username&quot;)</div><div class="line">  .option(&quot;password&quot;, &quot;password&quot;)</div><div class="line">  .load()</div></pre></td></tr></table></figure>
<p><strong>Running the Thrift JDBC/ODBC server:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">./sbin/start-thriftserver.sh</div><div class="line">export HIVE_SERVER2_THRIFT_PORT=&lt;listening-port&gt;</div><div class="line">export HIVE_SERVER2_THRIFT_BIND_HOST=&lt;listening-host&gt;</div><div class="line">./sbin/start-thriftserver.sh \</div><div class="line">  --master &lt;master-uri&gt; \</div><div class="line">  ...</div></pre></td></tr></table></figure></p>
<p><strong>Running the Spark SQL CLI:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-sql</div></pre></td></tr></table></figure></p>
<h2 id="Spark-MLlib"><a href="#Spark-MLlib" class="headerlink" title="Spark MLlib"></a>Spark MLlib</h2><p>参考： <a href="http://spark.apache.org/docs/latest/ml-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/ml-guide.html</a></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/Spark Streaming SQL MLlib GraphX/" class="archive-article-date">
  	<time datetime="2016-11-09T02:44:54.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Xia, MingXing
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: false
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Cassandra/" style="font-size: 10px;">Cassandra</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Hadoop/" style="font-size: 20px;">Hadoop</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Kafka/" style="font-size: 12.5px;">Kafka</a> <a href="/tags/Libvirt/" style="font-size: 10px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 12.5px;">Linux</a> <a href="/tags/Linux-Networking-Internals/" style="font-size: 15px;">Linux Networking Internals</a> <a href="/tags/Linux-Source-Code/" style="font-size: 10px;">Linux Source Code</a> <a href="/tags/Linux-Special-File-System/" style="font-size: 10px;">Linux Special File System</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/Mesos/" style="font-size: 10px;">Mesos</a> <a href="/tags/NoSQL/" style="font-size: 10px;">NoSQL</a> <a href="/tags/Openstack/" style="font-size: 10px;">Openstack</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Spring/" style="font-size: 12.5px;">Spring</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/ZooKeeper/" style="font-size: 12.5px;">ZooKeeper</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/lxc/" style="font-size: 10px;">lxc</a> <a href="/tags/lxcfs/" style="font-size: 10px;">lxcfs</a> <a href="/tags/介绍/" style="font-size: 10px;">介绍</a> <a href="/tags/分布式协同/" style="font-size: 10px;">分布式协同</a> <a href="/tags/大数据/" style="font-size: 17.5px;">大数据</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">平均每天保证几小时的学习时间，用一万小时定律激励自己</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>